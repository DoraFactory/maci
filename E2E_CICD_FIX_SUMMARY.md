# E2E CI/CD 测试修复总结

## 问题描述

E2E 测试在 CI/CD 环境中失败，主要错误：

1. **WASM 文件找不到**
   ```
   Error: WASM file not found: /home/runner/work/maci/maci/artifacts/cw_amaci-aarch64.wasm
   Error: WASM file not found: /home/runner/work/maci/maci/artifacts/cw_api_maci-aarch64.wasm
   ```

2. **Rust test vectors 未生成**
   ```
   Error: Rust test vectors not found. They should be auto-generated by pretest:poseidon hook.
   ```

## 最终解决方案

**选择使用 macOS M1/M2 runner 运行 e2e 测试**

我们提供了两种解决方案，最终选择了方案二：

### 方案一：架构自动检测（已实现但未采用）
- 在代码中添加架构检测逻辑
- 动态选择 `x86_64` 或 `aarch64` 后缀的 WASM 文件
- 优点：可以在任何平台运行
- 缺点：增加了代码复杂度

### 方案二：统一使用 ARM64 架构（最终选择）✅
- 将 CI runner 从 `ubuntu-latest` 改为 `macos-14`
- 本地和 CI 都使用 ARM64 架构编译
- 优点：简单直接，与本地开发环境完全一致
- 缺点：macOS runners 费用略高于 Linux runners

**为什么选择方案二：**
1. **简单性**：不需要修改代码逻辑
2. **一致性**：本地（Mac M1）和 CI 环境完全相同，减少"本地能跑，CI 不行"的问题
3. **可维护性**：架构统一，更容易调试和维护
4. **性能**：M1/M2 芯片性能优秀，编译和测试速度不会变慢

## 问题根因

### 1. 架构不匹配问题

**问题**：
- CI 环境使用 `ubuntu-latest` (x86_64 架构)
- `rust-optimizer` 在 x86_64 上生成 `*-x86_64.wasm` 文件
- 本地开发使用 Mac M1 (ARM64 架构)，生成 `*-aarch64.wasm` 文件
- 代码中硬编码了 `aarch64` 后缀，导致 CI 找不到文件

**解决方案**：
- **将 CI runner 改为 `macos-14`（Apple Silicon M1/M2）**
- 统一使用 ARM64 架构编译和测试
- 保持架构自动检测代码，以便将来支持其他平台

### 2. Poseidon Test Vectors 未生成

**问题**：
- CI 中没有构建 Rust test vector 生成器
- 没有执行生成 test vectors 的步骤

**解决方案**：
- 在 CI 中添加构建步骤
- 在测试前生成 test vectors

## 修复详情

### 修复 1：更改 CI Runner 为 macOS M1/M2

**文件**：`.github/workflows/test.yml`

**修改内容**：

```yaml
e2e-tests:
  name: E2E Tests
  runs-on: macos-14  # 从 ubuntu-latest 改为 macos-14 (Apple Silicon M1/M2)
  timeout-minutes: 60
```

**效果**：
- CI 环境使用 ARM64 架构
- 生成的 WASM 文件后缀为 `aarch64`
- 与本地 Mac M1/M2 开发环境完全一致

### 修复 2：ContractLoader 架构自动检测（备用方案）

**文件**：`e2e/src/setup/contractLoader.ts`

虽然最终选择统一使用 ARM64，但我们仍保留了架构自动检测功能，以便将来需要时可以支持多平台：

1. 添加 `architecture` 属性：
```typescript
export class ContractLoader {
  private artifactsDir: string;
  private cache: WasmBytecodeCache;
  private architecture: string;  // 新增

  constructor(artifactsDir?: string) {
    this.artifactsDir = artifactsDir || path.resolve(__dirname, '..', '..', '..', 'artifacts');
    this.cache = {};
    // 自动检测架构
    this.architecture = process.arch === 'arm64' ? 'aarch64' : 'x86_64';
  }
}
```

2. 更新所有 WASM 文件路径使用动态架构：
```typescript
// AMACI 合约
const wasmPath = path.join(this.artifactsDir, `cw_amaci-${this.architecture}.wasm`);

// API-MACI 合约
const wasmPath = path.join(this.artifactsDir, `cw_api_maci-${this.architecture}.wasm`);

// Registry 合约
const wasmPath = path.join(this.artifactsDir, `cw_amaci_registry-${this.architecture}.wasm`);

// API-SaaS 合约
const wasmPath = path.join(this.artifactsDir, `cw_api_saas-${this.architecture}.wasm`);
```

**效果**：
- macOS ARM64 (M1/M2)：自动查找 `*-aarch64.wasm`
- Linux/Windows x86_64：自动查找 `*-x86_64.wasm`
- 代码具有良好的可移植性

### 修复 3：添加 Poseidon Test Vectors 生成步骤

在 `e2e-tests` job 中添加两个新步骤：

```yaml
- name: Build Rust test vector generator
  working-directory: ./crates/maci-utils
  run: cargo build --bin generate_test_vectors --release

- name: Generate Poseidon test vectors
  working-directory: ./e2e
  run: pnpm run generate:vectors
```

**位置**：在 `Run e2e tests` 步骤之前

**完整流程**（在 macOS-14 runner 上）：
1. 构建合约 (rust-optimizer) → 生成 `*-aarch64.wasm`
2. 验证 WASM artifacts
3. 安装 Node.js 依赖
4. 构建 SDK 和 Circuits
5. 下载/设置 circuits
6. **构建 Rust test vector 生成器** (新增)
7. **生成 Poseidon test vectors** (新增)
8. 运行 e2e 测试

## 技术细节

### process.arch 值映射

| process.arch | 目标架构 | WASM 后缀 |
|--------------|---------|-----------|
| `arm64`      | ARM64   | `aarch64` |
| `x64`        | x86_64  | `x86_64`  |
| `ia32`       | x86_64  | `x86_64`  |
| 其他         | x86_64  | `x86_64`  |

### Rust Optimizer 行为

`cosmwasm/rust-optimizer:0.15.1` 根据构建平台生成不同后缀的文件：

- **在 x86_64 平台**（ubuntu-latest）：生成 `*-x86_64.wasm`
- **在 ARM64 平台**（macos-14, 本地 Mac M1/M2）：生成 `*-aarch64.wasm`

**当前 CI 配置**：使用 `macos-14` runner，生成 `*-aarch64.wasm` 文件

### Test Vectors 生成流程

1. `cargo build --bin generate_test_vectors --release`
   - 编译 Rust 二进制文件
   - 位置：`crates/maci-utils/src/bin/generate_test_vectors.rs`

2. `pnpm run generate:vectors`
   - 执行：`ts-node poseidon-test/generate-vectors.ts`
   - 调用 Rust 二进制生成 test vectors
   - 输出：`e2e/poseidon-test/test-vectors-rust.json`

3. 测试使用生成的 vectors
   - 文件：`tests/poseidon-consistency.e2e.test.ts`
   - 验证 Rust 和 JavaScript Poseidon 实现的一致性

## 验证

修复后，CI 应该能够：

1. ✅ 在 macOS-14 (M1/M2) runner 上正确构建合约
2. ✅ 正确找到 `*-aarch64.wasm` 文件
3. ✅ 成功生成 Poseidon test vectors
4. ✅ 通过所有 e2e 测试

本地测试（macOS ARM64）：
1. ✅ 正确找到 `*-aarch64.wasm` 文件
2. ✅ 测试继续正常工作
3. ✅ **与 CI 环境完全一致，无架构差异**

## 测试命令

### 本地测试
```bash
# 构建合约
docker run --rm -v "$(pwd)":/code \
  --mount type=volume,source="$(basename "$(pwd)")_cache",target=/target \
  --mount type=volume,source=registry_cache,target=/usr/local/cargo/registry \
  cosmwasm/rust-optimizer:0.15.1

# 安装依赖
pnpm install

# 构建依赖
cd packages/sdk && pnpm build && cd ../..
cd packages/circuits && pnpm build && cd ../..

# 设置 circuits
cd e2e
pnpm setup-circuits

# 构建 test vector 生成器
cd ../crates/maci-utils
cargo build --bin generate_test_vectors --release
cd ../../e2e

# 生成 test vectors
pnpm run generate:vectors

# 运行测试
pnpm test
```

### CI 测试
推送到 GitHub，CI 会自动运行所有测试。

## 相关文件

### 修改的文件
1. **`.github/workflows/test.yml`** - 主要修改：将 e2e-tests runner 改为 `macos-14`
2. **`e2e/src/setup/contractLoader.ts`** - 添加架构自动检测（备用）

### 新建的文件
- `E2E_CICD_FIX_SUMMARY.md` (本文档)

### 相关文件
- `e2e/poseidon-test/generate-vectors.ts` - Test vector 生成脚本
- `crates/maci-utils/src/bin/generate_test_vectors.rs` - Rust 生成器
- `e2e/package.json` - 定义了 `generate:vectors` 脚本
- `tests/poseidon-consistency.e2e.test.ts` - 使用 test vectors 的测试

## 后续建议

1. **监控 CI 运行**
   - 确认第一次 CI 运行成功
   - 检查所有测试都能通过
   - 注意 macOS runners 的使用分钟数（可能有配额限制）

2. **成本考虑**
   - macOS runners 费用是 Linux runners 的 10 倍
   - 如果需要节省成本，可以考虑：
     - 只在 main 分支运行 e2e 测试
     - 使用架构检测方案（已实现），切换回 ubuntu-latest
   - 当前优先考虑开发体验和稳定性

3. **文档更新**
   - 在 README 中说明 CI 使用 macOS M1 runner
   - 建议本地开发也使用 Mac M1/M2 以保持一致性

4. **备用方案**
   - 如果需要切换回 Linux runner：
     - 已实现的架构检测代码可以直接使用
     - 只需将 `runs-on: macos-14` 改回 `runs-on: ubuntu-latest`

5. **性能优化**
   - 考虑缓存 Rust 构建产物（已配置）
   - 可以缓存生成的 test vectors
   - M1/M2 芯片编译速度快，可能不需要额外优化

## 总结

**核心解决方案：统一架构**

通过将 CI 环境从 `ubuntu-latest` 改为 `macos-14`（Apple Silicon M1/M2），我们实现了：

1. ✅ **架构统一**：本地和 CI 都使用 ARM64 架构
2. ✅ **WASM 一致性**：都生成 `*-aarch64.wasm` 文件
3. ✅ **环境一致性**：消除"本地能跑，CI 不行"的问题
4. ✅ **Poseidon test vectors**：在测试前正确生成

**技术实现：**
- 主要修改：CI runner 改为 `macos-14`
- 备用方案：保留架构自动检测代码，支持将来跨平台需求
- 完善流程：添加 test vectors 生成步骤

**权衡考虑：**
- **优点**：简单、稳定、与本地开发环境完全一致
- **注意**：macOS runners 成本较高，但优先保证开发体验

这个方案为团队提供了最佳的开发和测试体验，同时保留了灵活性以应对未来需求变化。

