# CI/CD è‡ªåŠ¨åŒ–æµ‹è¯•é…ç½®å®Œæˆ

## æ¦‚è¿°

å·²æˆåŠŸä¸ºé¡¹ç›®æ·»åŠ  GitHub Actions CI/CD é…ç½®ï¼Œå®ç°æ¯æ¬¡ä»£ç æäº¤æ—¶è‡ªåŠ¨è¿è¡Œä¸‰ç±»æµ‹è¯•ã€‚

## é…ç½®æ–‡ä»¶

**æ–‡ä»¶ä½ç½®**: `.github/workflows/test.yml`

## å·¥ä½œæµç¨‹

### è§¦å‘æ¡ä»¶
- âœ… æ‰€æœ‰åˆ†æ”¯çš„ `push` äº‹ä»¶
- âœ… æ‰€æœ‰åˆ†æ”¯çš„ `pull_request` äº‹ä»¶

### ä¸‰ä¸ªå¹¶è¡Œæµ‹è¯•ä»»åŠ¡

#### 1ï¸âƒ£ Contract Testsï¼ˆåˆçº¦æµ‹è¯•ï¼‰

**æµ‹è¯•å†…å®¹**: Rust åˆçº¦å•å…ƒæµ‹è¯•

**å…³é”®æ­¥éª¤**:
- è®¾ç½® Rust 1.79.0 å·¥å…·é“¾
- é…ç½® wasm32-unknown-unknown target
- è¿è¡Œ `cargo test --lib -- --nocapture`

**é¢„è®¡æ—¶é•¿**: ~10-20 åˆ†é’Ÿ

**ç¼“å­˜ä¼˜åŒ–**:
- Cargo registry
- Cargo git index  
- Cargo build artifacts

---

#### 2ï¸âƒ£ E2E Testsï¼ˆç«¯åˆ°ç«¯æµ‹è¯•ï¼‰

**æµ‹è¯•å†…å®¹**: å®Œæ•´çš„ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•

**å…³é”®æ­¥éª¤**:
1. ä½¿ç”¨ Docker + rust-optimizer ç¼–è¯‘åˆçº¦ WASM æ–‡ä»¶
2. ä¸‹è½½ circuit zkey æ–‡ä»¶ï¼ˆçº¦ 100MBï¼Œé¦–æ¬¡è¿è¡Œï¼‰
3. è®¾ç½® Node.js å’Œ pnpm ç¯å¢ƒ
4. è¿è¡Œå®Œæ•´çš„ e2e æµ‹è¯•å¥—ä»¶

**é¢„è®¡æ—¶é•¿**: 
- é¦–æ¬¡è¿è¡Œ: ~60 åˆ†é’Ÿï¼ˆåŒ…å«ç¼–è¯‘å’Œä¸‹è½½ï¼‰
- åç»­è¿è¡Œ: ~20-30 åˆ†é’Ÿï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰

**ç¼“å­˜ä¼˜åŒ–**:
- Cargo æ„å»ºç¼“å­˜
- pnpm ä¾èµ–ç¼“å­˜
- Circuit æ–‡ä»¶ç¼“å­˜ï¼ˆzkey/wasmï¼Œçº¦ 100MBï¼‰

**ä¾èµ–è¯´æ˜**:
- éœ€è¦ç¼–è¯‘åˆçº¦ WASM æ–‡ä»¶ï¼ˆartifacts ç›®å½•è¢« gitignoreï¼‰
- éœ€è¦ä¸‹è½½ circuit zkey æ–‡ä»¶ï¼ˆä» S3ï¼‰
- ä½¿ç”¨ `cosmwasm/rust-optimizer:0.16.0` Docker é•œåƒ

---

#### 3ï¸âƒ£ Circuits Testsï¼ˆç”µè·¯æµ‹è¯•ï¼‰

**æµ‹è¯•å†…å®¹**: ZK ç”µè·¯å•å…ƒæµ‹è¯•

**å…³é”®æ­¥éª¤**:
- è®¾ç½® Node.js 18 å’Œ pnpm ç¯å¢ƒ
- å®‰è£… circuits ä¾èµ–
- è¿è¡Œ `pnpm test`

**é¢„è®¡æ—¶é•¿**: ~10-15 åˆ†é’Ÿ

**ç¼“å­˜ä¼˜åŒ–**:
- pnpm ä¾èµ–ç¼“å­˜

---

## æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥

1. **Rust æ„å»ºç¼“å­˜**
   - Registry: `~/.cargo/registry`
   - Git index: `~/.cargo/git`
   - Build artifacts: `target/`

2. **Node.js ä¾èµ–ç¼“å­˜**
   - pnpm store directory

3. **Circuit æ–‡ä»¶ç¼“å­˜**
   - è·¯å¾„: `e2e/circuits/`
   - å¤§å°: ~100MB
   - é¿å…æ¯æ¬¡éƒ½ä» S3 ä¸‹è½½

### å¹¶è¡Œæ‰§è¡Œ

ä¸‰ä¸ªæµ‹è¯•ä»»åŠ¡å®Œå…¨å¹¶è¡Œæ‰§è¡Œï¼Œä¸äº’ç›¸é˜»å¡ï¼Œæœ€å¤§åŒ–åˆ©ç”¨ GitHub Actions çš„èµ„æºã€‚

---

## ä½¿ç”¨æ–¹æ³•

### è‡ªåŠ¨è§¦å‘

å½“ä½ æ¨é€ä»£ç åˆ°ä»»ä½•åˆ†æ”¯æˆ–åˆ›å»º Pull Request æ—¶ï¼ŒGitHub Actions ä¼šè‡ªåŠ¨è§¦å‘æµ‹è¯•ï¼š

```bash
git add .
git commit -m "Your changes"
git push origin your-branch
```

### æŸ¥çœ‹æµ‹è¯•ç»“æœ

1. è¿›å…¥ GitHub ä»“åº“é¡µé¢
2. ç‚¹å‡»é¡¶éƒ¨çš„ "Actions" æ ‡ç­¾
3. é€‰æ‹©å¯¹åº”çš„ workflow run
4. æŸ¥çœ‹ä¸‰ä¸ªå¹¶è¡Œä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€

### æœ¬åœ°æµ‹è¯•ï¼ˆæäº¤å‰ï¼‰

åœ¨æäº¤ä»£ç å‰ï¼Œå»ºè®®å…ˆåœ¨æœ¬åœ°è¿è¡Œæµ‹è¯•ï¼š

```bash
# 1. åˆçº¦æµ‹è¯•
cargo test --lib -- --nocapture

# 2. E2E æµ‹è¯•
cd e2e
pnpm install
pnpm setup-circuits  # é¦–æ¬¡è¿è¡Œéœ€è¦ä¸‹è½½ circuits
pnpm test

# 3. Circuits æµ‹è¯•
cd packages/circuits
pnpm install
pnpm test
```

---

## é‡è¦è¯´æ˜

### E2E æµ‹è¯•çš„ç‰¹æ®Šè¦æ±‚

E2E æµ‹è¯•éœ€è¦ä¸¤ä¸ªå‰ç½®æ­¥éª¤ï¼š

1. **ç¼–è¯‘åˆçº¦ WASM æ–‡ä»¶**
   - åŸå› : `artifacts/` ç›®å½•è¢« `.gitignore` å¿½ç•¥
   - æ–¹æ³•: ä½¿ç”¨ `cosmwasm/rust-optimizer` Docker é•œåƒç¼–è¯‘
   - æ—¶é—´: ~15-20 åˆ†é’Ÿï¼ˆé¦–æ¬¡ï¼‰

2. **ä¸‹è½½ circuit zkey æ–‡ä»¶**
   - åŸå› : zkey æ–‡ä»¶è¾ƒå¤§ï¼ˆ~100MBï¼‰ï¼Œä¸æäº¤åˆ° git
   - æ–¹æ³•: ä» S3 ä¸‹è½½ï¼ˆ`pnpm setup-circuits`ï¼‰
   - æ—¶é—´: ~5-10 åˆ†é’Ÿï¼ˆé¦–æ¬¡ï¼‰
   - æ–‡ä»¶: 
     - `maci-2-1-1-5/*.wasm` å’Œ `*.zkey`
     - `amaci-2-1-1-5/*.wasm` å’Œ `*.zkey`
     - `vkeys-*.json`

### é¦–æ¬¡è¿è¡Œæ³¨æ„äº‹é¡¹

ç¬¬ä¸€æ¬¡è¿è¡Œ CI æ—¶ï¼Œç”±äºæ²¡æœ‰ç¼“å­˜ï¼Œä¼šæ¯”è¾ƒæ…¢ï¼š
- ä¸‹è½½ä¾èµ–
- ç¼–è¯‘åˆçº¦
- ä¸‹è½½ circuit æ–‡ä»¶

**é¢„è®¡é¦–æ¬¡æ€»æ—¶é•¿**: ~60 åˆ†é’Ÿ

åç»­è¿è¡Œä¼šä½¿ç”¨ç¼“å­˜ï¼Œé€Ÿåº¦ä¼šæ˜¾è‘—æå‡åˆ° **~20-30 åˆ†é’Ÿ**ã€‚

---

## æ•…éšœæ’æŸ¥

### åˆçº¦æµ‹è¯•å¤±è´¥
- æ£€æŸ¥ Rust ä»£ç è¯­æ³•é”™è¯¯
- æŸ¥çœ‹æµ‹è¯•æ—¥å¿—ä¸­çš„å…·ä½“é”™è¯¯
- ç¡®è®¤ Rust å·¥å…·é“¾ç‰ˆæœ¬ (1.79.0)

### E2E æµ‹è¯•å¤±è´¥

**å¯èƒ½åŸå› **:
1. åˆçº¦ç¼–è¯‘å¤±è´¥
   - æ£€æŸ¥ rust-optimizer æ­¥éª¤çš„æ—¥å¿—
   - ç¡®è®¤ Docker æ­£å¸¸è¿è¡Œ

2. Circuit æ–‡ä»¶ä¸‹è½½å¤±è´¥
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - ç¡®è®¤ S3 URL å¯è®¿é—®

3. æµ‹è¯•ç”¨ä¾‹å¤±è´¥
   - æŸ¥çœ‹å…·ä½“æµ‹è¯•æ—¥å¿—
   - æ£€æŸ¥æ˜¯å¦æ˜¯ä¸šåŠ¡é€»è¾‘é”™è¯¯

### Circuits æµ‹è¯•å¤±è´¥
- æ£€æŸ¥ Node.js å†…å­˜æ˜¯å¦è¶³å¤Ÿ
- æŸ¥çœ‹å…·ä½“æµ‹è¯•ç”¨ä¾‹çš„é”™è¯¯ä¿¡æ¯

### ç¼“å­˜é—®é¢˜

å¦‚æœç¼“å­˜å¯¼è‡´é—®é¢˜ï¼ˆå¦‚ä¾èµ–ç‰ˆæœ¬å†²çªï¼‰ï¼š

1. è¿›å…¥ GitHub ä»“åº“
2. Settings -> Actions -> Caches
3. æ‰¾åˆ°å¹¶åˆ é™¤ç›¸å…³ç¼“å­˜
4. é‡æ–°è¿è¡Œ workflow

---

## ç»´æŠ¤å»ºè®®

### å®šæœŸæ£€æŸ¥

- âœ… Rust å·¥å…·é“¾ç‰ˆæœ¬æ›´æ–°
- âœ… Node.js ç‰ˆæœ¬æ›´æ–°
- âœ… pnpm ç‰ˆæœ¬æ›´æ–°
- âœ… GitHub Actions ç‰ˆæœ¬æ›´æ–°
- âœ… Docker é•œåƒç‰ˆæœ¬æ›´æ–°

### æ›´æ–°æµç¨‹

1. **æ›´æ–° Rust å·¥å…·é“¾**
   ```toml
   # rust-toolchain.toml
   [toolchain]
   channel = "1.79.0"  # æ›´æ–°è¿™é‡Œ
   ```

2. **æ›´æ–° Node.js ç‰ˆæœ¬**
   ```yaml
   # .github/workflows/test.yml
   - uses: actions/setup-node@v4
     with:
       node-version: '18'  # æ›´æ–°è¿™é‡Œ
   ```

3. **æ›´æ–° pnpm ç‰ˆæœ¬**
   ```yaml
   # .github/workflows/test.yml
   - uses: pnpm/action-setup@v4
     with:
       version: 9.12.3  # æ›´æ–°è¿™é‡Œ
   ```

---

## æŠ€æœ¯ç»†èŠ‚

### Rust Optimizer

ä½¿ç”¨ CosmWasm å®˜æ–¹çš„ rust-optimizer é•œåƒï¼š

```bash
cosmwasm/rust-optimizer:0.16.0
```

**åŠŸèƒ½**:
- ç¼–è¯‘ Rust ä»£ç ä¸º wasm32-unknown-unknown
- ä¼˜åŒ– WASM æ–‡ä»¶å¤§å°
- ç”Ÿæˆ checksums.txt

**è¾“å‡º**:
- `artifacts/*.wasm` - ä¼˜åŒ–åçš„åˆçº¦æ–‡ä»¶

### Circuit Files

Circuit æ–‡ä»¶ä» S3 ä¸‹è½½ï¼š

```
https://vota-zkey.s3.ap-southeast-1.amazonaws.com/
â”œâ”€â”€ maci_2-1-1-5_v3_zkeys.tar.gz
â”œâ”€â”€ amaci_2-1-1-5_v3_zkeys.tar.gz
â”œâ”€â”€ add-new-key_2-1-1-5.wasm
â””â”€â”€ add-new-key_2-1-1-5.zkey
```

**é…ç½®**: 2-1-1-5
- State tree depth: 2 (max 25 voters)
- Int state tree depth: 1
- Vote option tree depth: 1 (max 5 options)
- Message batch size: 5

---

## ç›¸å…³æ–‡æ¡£

- `.github/workflows/README.md` - Workflow è¯¦ç»†è¯´æ˜
- `e2e/README.md` - E2E æµ‹è¯•æ¡†æ¶æ–‡æ¡£
- `e2e/QUICKSTART.md` - E2E å¿«é€Ÿå¼€å§‹æŒ‡å—
- `contracts/*/README.md` - å„åˆçº¦è¯´æ˜æ–‡æ¡£

---

## æ€»ç»“

âœ… **å·²å®Œæˆ**:
- GitHub Actions workflow é…ç½®
- ä¸‰ä¸ªå¹¶è¡Œæµ‹è¯•ä»»åŠ¡ï¼ˆåˆçº¦ã€E2Eã€Circuitsï¼‰
- å®Œå–„çš„ç¼“å­˜ç­–ç•¥
- è‡ªåŠ¨ç¼–è¯‘åˆçº¦ WASM
- è‡ªåŠ¨ä¸‹è½½ circuit æ–‡ä»¶

âœ… **ä¼˜åŠ¿**:
- æ¯æ¬¡æäº¤è‡ªåŠ¨æµ‹è¯•
- å¹¶è¡Œæ‰§è¡Œï¼Œé€Ÿåº¦å¿«
- æ™ºèƒ½ç¼“å­˜ï¼ŒèŠ‚çœæ—¶é—´
- å®Œæ•´çš„æµ‹è¯•è¦†ç›–

ğŸ¯ **ä¸‹ä¸€æ­¥**:
1. æ¨é€ä»£ç åˆ° GitHub
2. æŸ¥çœ‹ Actions é¡µé¢
3. ç­‰å¾…é¦–æ¬¡è¿è¡Œå®Œæˆï¼ˆçº¦ 60 åˆ†é’Ÿï¼‰
4. åç»­æäº¤å°†äº«å—ç¼“å­˜åŠ é€Ÿ

---

**é…ç½®å®Œæˆæ—¥æœŸ**: 2025-11-16
**é…ç½®ç‰ˆæœ¬**: v1.0

