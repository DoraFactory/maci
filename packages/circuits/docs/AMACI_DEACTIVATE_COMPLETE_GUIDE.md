# AMACI Deactivate æœºåˆ¶å®Œæ•´æŒ‡å—

> æœ¬æ–‡æ¡£å…¨é¢ä»‹ç» AMACI (Anonymous MACI) çš„ Deactivate æœºåˆ¶ï¼ŒåŒ…æ‹¬æŠ€æœ¯åŸç†ã€å®ç°ç»†èŠ‚ã€æµç¨‹å›¾ç¤ºå’Œæµ‹è¯•è¦†ç›–ã€‚

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [AMACI vs MACI å¯¹æ¯”](#amaci-vs-maci-å¯¹æ¯”)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [Deactivate å®Œæ•´æµç¨‹](#deactivate-å®Œæ•´æµç¨‹)
5. [çŠ¶æ€è½¬æ¢å›¾](#çŠ¶æ€è½¬æ¢å›¾)
6. [çŠ¶æ€ç»„åˆè¯¦è§£](#çŠ¶æ€ç»„åˆè¯¦è§£) â­ æ–°å¢
   - å››ç§ d1/d2 ä¸ ActiveStateTree ç»„åˆ
   - çŠ¶æ€äº§ç”Ÿæ–¹å¼ä¸äº¤äº’åˆ†æ
   - å®‰å…¨æ€§åˆ†æä¸æœ€ä½³å®è·µ
7. [å…³é”®æ•°æ®ç»“æ„](#å…³é”®æ•°æ®ç»“æ„)
8. [å®‰å…¨æœºåˆ¶](#å®‰å…¨æœºåˆ¶)
   - Nullifier é˜²é‡æ”¾
   - ECDH ç»‘å®š
   - åŒå±‚éªŒè¯
   - Circuit çº¦æŸ
   - **é”™è¯¯æ¶ˆæ¯å¤„ç†çš„å®‰å…¨æ€§** â­ æ–°å¢
8. [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
9. [æµ‹è¯•è¦†ç›–](#æµ‹è¯•è¦†ç›–)
10. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
    - Q7: é”™è¯¯ deactivate message çš„å¤„ç† â­ æ–°å¢
    - Q8: å¥‡æ•° d1/d2 è´¦æˆ·èƒ½å¦å†æ¬¡ deactivate â­ æ–°å¢

---

## æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ AMACIï¼Ÿ

AMACI (Anonymous MACI) æ˜¯ MACI çš„å¢å¼ºç‰ˆæœ¬ï¼Œæ·»åŠ äº†**åŒ¿åå¯†é’¥æ›´æ¢**åŠŸèƒ½ã€‚ç”¨æˆ·å¯ä»¥ï¼š
- æ­£å¸¸æŠ•ç¥¨
- **Deactivateï¼ˆåœç”¨ï¼‰** å½“å‰å¯†é’¥
- é€šè¿‡ **AddNewKey** è·å¾—æ–°å¯†é’¥
- ä½¿ç”¨æ–°å¯†é’¥ç»§ç»­æŠ•ç¥¨

è¿™æ ·å¯ä»¥å®ç°å¯†é’¥æ›´æ¢çš„åŒæ—¶ä¿æŒæŠ•ç¥¨çš„åŒ¿åæ€§ã€‚

### æ ¸å¿ƒåˆ›æ–°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AMACI æ ¸å¿ƒç‰¹æ€§                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. 10å­—æ®µ StateLeaf (vs MACIçš„5å­—æ®µ)                 â”‚
â”‚ 2. ActiveStateTree - å¿«é€Ÿæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ´»è·ƒ             â”‚
â”‚ 3. DeactivateTree - å­˜å‚¨ Operator ç”Ÿæˆçš„ c1/c2       â”‚
â”‚ 4. ElGamal åŠ å¯† - éšç§ä¿æŠ¤çš„çŠ¶æ€æ ‡è®°                  â”‚
â”‚ 5. é‡éšæœºåŒ– - AddNewKey æ—¶å°† c1/c2 è½¬ä¸º d1/d2        â”‚
â”‚ 6. åŒå±‚éªŒè¯ - ActiveStateTree + d1/d2 è§£å¯†æ£€æŸ¥       â”‚
â”‚ 7. Nullifier æœºåˆ¶ - é˜²æ­¢ deactivate æ•°æ®é‡ç”¨          â”‚
â”‚ 8. å¥‡å¶æ€§ç¼–ç  - ä¼˜é›…çš„é”™è¯¯æ¶ˆæ¯å¤„ç† â­                â”‚
â”‚    â€¢ æ­£ç¡®æ¶ˆæ¯ â†’ å¶æ•° c1c2 â†’ å¯ç”¨äº AddNewKey         â”‚
â”‚    â€¢ é”™è¯¯æ¶ˆæ¯ â†’ å¥‡æ•° c1c2 â†’ æ— æ³•åˆ›å»ºå¯ç”¨è´¦æˆ·         â”‚
â”‚    â€¢ é˜²æ­¢é€šè¿‡é”™è¯¯æ¶ˆæ¯è¿›è¡Œ Sybil æ”»å‡»                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## AMACI vs MACI å¯¹æ¯”

### StateLeaf ç»“æ„å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  MACI StateLeaf (5å­—æ®µ)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  pubKey[2]     : ç”¨æˆ·å…¬é’¥ (x, y)                     â”‚
â”‚  balance       : æŠ•ç¥¨é¢åº¦                            â”‚
â”‚  voTreeRoot    : æŠ•ç¥¨é€‰é¡¹æ ‘æ ¹                         â”‚
â”‚  nonce         : é˜²é‡æ”¾è®¡æ•°å™¨                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 AMACI StateLeaf (10å­—æ®µ)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  pubKey[2]     : ç”¨æˆ·å…¬é’¥ (x, y)                     â”‚
â”‚  balance       : æŠ•ç¥¨é¢åº¦                            â”‚
â”‚  voTreeRoot    : æŠ•ç¥¨é€‰é¡¹æ ‘æ ¹                         â”‚
â”‚  nonce         : é˜²é‡æ”¾è®¡æ•°å™¨                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ–°å¢å­—æ®µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚  d1[2]         : ElGamal å¯†æ–‡ç¬¬ä¸€éƒ¨åˆ† (æ°¸ä¹…çŠ¶æ€)      â”‚
â”‚  d2[2]         : ElGamal å¯†æ–‡ç¬¬äºŒéƒ¨åˆ† (æ°¸ä¹…çŠ¶æ€)      â”‚
â”‚  xIncrement    : ElGamal éšæœºæ•°å¢é‡                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ‘ç»“æ„å¯¹æ¯”

> Hash5(0, 0, 0, 0, 0)

```
MACI æ ‘ç»“æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StateTree  â”‚  â† å”¯ä¸€çš„çŠ¶æ€æ ‘
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AMACI æ ‘ç»“æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StateTree  â”‚   â”‚ ActiveStateTree  â”‚   â”‚DeactivateTreeâ”‚
â”‚  (å®Œæ•´çŠ¶æ€)  â”‚   â”‚  (å¿«é€ŸæŸ¥è¯¢çŠ¶æ€)  â”‚   â”‚  (c1/c2æ•°æ®) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                      â”‚
       â”œâ”€â”€â”€â”€ 10å­—æ®µ â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€ å•å€¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ Hash â”€â”€â”€â”€â”€â”
       â”‚                   â”‚                      â”‚              â”‚
   å®Œæ•´ä¿¡æ¯            0=active              Operatorç”Ÿæˆçš„   â”‚
   (d1/d2æ˜¯          é0=inactive           c1/c2åŠ å¯†æ•°æ®    â”‚
   é‡éšæœºåŒ–çš„)                                               â”‚
                                           ç”¨äº AddNewKey é‡éšæœºåŒ–ä¸º d1/d2 â†â”˜
```

---

## æ ¸å¿ƒç»„ä»¶

### 1. ElGamal åŠ å¯†ç³»ç»Ÿ

```
åŠ å¯†ï¼ˆencryptOdevityï¼‰:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è¾“å…¥: 
  - isOdd: boolean (true=å¥‡æ•°/deactivated, false=å¶æ•°/active)
  - coordPubKey: [x, y]
  - salt: bigint

è¿‡ç¨‹:
  1. random = Poseidon([salt])
  2. sharedKey = coordPubKey * random
  3. c1 = G * random  (ä¸´æ—¶å…¬é’¥)
  4. c2 = sharedKey + G * (isOdd ? 1 : 0)
  5. xIncrement = random

è¾“å‡º:
  { c1: {x, y}, c2: {x, y}, xIncrement }

è§£å¯†ï¼ˆdecryptï¼‰:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è¾“å…¥:
  - coordPrivKey: bigint
  - c1: {x, y}
  - c2: {x, y}
  - xIncrement: bigint

è¿‡ç¨‹:
  1. sharedKey = c1 * coordPrivKey
  2. plainPoint = c2 - sharedKey
  3. result = discreteLog(plainPoint)

è¾“å‡º:
  result (0=å¶æ•°/active, 1=å¥‡æ•°/deactivated)

åˆ¤æ–­:
  result % 2 === 0  â†’  Active âœ“
  result % 2 === 1  â†’  Deactivated âœ—
```

### 2. ActiveStateTree

```
ä½œç”¨: å¿«é€ŸæŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å¤„äºæ´»è·ƒçŠ¶æ€

ç»“æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Index  â”‚  Value  â”‚     å«ä¹‰         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    0    â”‚    0    â”‚  ç”¨æˆ·0: Active   â”‚
â”‚    1    â”‚    0    â”‚  ç”¨æˆ·1: Active   â”‚
â”‚    2    â”‚  1234n  â”‚  ç”¨æˆ·2: Inactive â”‚
â”‚    3    â”‚    0    â”‚  ç”¨æˆ·3: Active   â”‚
â”‚   ...   â”‚   ...   â”‚      ...         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ›´æ–°æ—¶æœº:
  - SignUp:      è®¾ç½®ä¸º 0 (active)
  - Deactivate:  è®¾ç½®ä¸º é0 (hash of deactivate data)
  - AddNewKey:   æ–°è´¦æˆ·è®¾ç½®ä¸º 0 (active)

åœ¨ç”µè·¯ä¸­çš„éªŒè¯:
  circuit ProcessMessages {
    // è·å– activeStateLeaf
    signal activeStateLeaf = activeStateLeaves[msgIdx];
    
    // éªŒè¯ Merkle proof
    activeStatePath[msgIdx] = QuinBatchLeavesExists(
      activeStateTree.depth
    )(
      activeStateRoot,
      activeStateLeaves,
      activeStateLeavesPathElements
    );
    
    // æ£€æŸ¥æ˜¯å¦ active
    isActive = IsZero()(activeStateLeaf);  // 0 = active
  }
```

### 3. DeactivateTree

```
ä½œç”¨: å­˜å‚¨ Operator ç¬¬ä¸€æ¬¡ç”Ÿæˆçš„ c1/c2 åŠ å¯†æ•°æ®

âš ï¸ é‡è¦æ¦‚å¿µæ¾„æ¸…:
  â€¢ DeactivateTree å­˜å‚¨çš„æ˜¯ Operator ç”Ÿæˆçš„ c1/c2ï¼ˆç¬¬ä¸€æ¬¡åŠ å¯†ï¼‰
  â€¢ é‡éšæœºåŒ–å‘ç”Ÿåœ¨ AddNewKey æ—¶ï¼Œç”±ç”¨æˆ·æ‰§è¡Œ
  â€¢ ç”¨æˆ·ä» DeactivateTree è·å– c1/c2ï¼Œç„¶åè°ƒç”¨ rerandomize() ç”Ÿæˆ d1/d2
  â€¢ d1/d2ï¼ˆé‡éšæœºåŒ–åï¼‰å­˜å…¥æ–°çš„ StateTree leaf ä¸­

æ•°æ®æµç¨‹:
  processDeactivateMessages:
    Operator ç”Ÿæˆ c1/c2 â†’ å­˜å…¥ DeactivateTree
  
  AddNewKey:
    ç”¨æˆ·å–å‡º c1/c2 â†’ rerandomize() â†’ ç”Ÿæˆ d1/d2 â†’ å­˜å…¥ StateTree

ç»“æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Index  â”‚        Value (Hash)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    0    â”‚  Poseidon([c1[0], c1[1], c2[0],     â”‚
â”‚         â”‚            c2[1], sharedKeyHash])    â”‚
â”‚    1    â”‚  Poseidon([c1, c2, sharedKeyHash])  â”‚
â”‚   ...   â”‚              ...                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•°æ®æ¥æº:
  ç”¨æˆ·å‘é€ deactivate æ¶ˆæ¯åï¼Œoperator è¿›è¡Œ:
  1. éªŒè¯ç­¾å
  2. ç”Ÿæˆ c1/c2 åŠ å¯†æ•°æ®ï¼ˆä½¿ç”¨ç¡®å®šæ€§éšæœºå¯†é’¥ï¼‰
     - å¦‚æœæ¶ˆæ¯æœ‰æ•ˆ: ç”Ÿæˆå¶æ•°åŠ å¯† (even)
     - å¦‚æœæ¶ˆæ¯æ— æ•ˆ: ç”Ÿæˆå¥‡æ•°åŠ å¯† (odd)
  3. å­˜å…¥ DeactivateTree: poseidon([c1, c2, sharedKeyHash])
  
AddNewKey ä½¿ç”¨:
  ç”¨æˆ·ä» DeactivateTree è·å– c1/c2 å:
  1. è°ƒç”¨ rerandomize(coordPubKey, {c1, c2}, randomVal)
     ä»£ç : const { d1, d2 } = rerandomize(coordPubKey, { c1, c2 }, randomVal);
  2. ç”Ÿæˆé‡éšæœºåŒ–çš„ d1/d2
  3. d1/d2 å­˜å…¥æ–°çš„ StateTree leaf ä¸­
  4. æäº¤ ZK proof:
     - deactivateLeaf (ä» DeactivateTree)
     - Merkle proof (è¯æ˜ leaf å­˜åœ¨)
     - Nullifier (é˜²æ­¢é‡å¤ä½¿ç”¨)
     - ECDH sharedKey (ç»‘å®šåˆ°ç”¨æˆ·)
     - d1/d2 (é‡éšæœºåŒ–åçš„æ•°æ®)
```

### 4. åŒå±‚éªŒè¯æœºåˆ¶

```
ä¸ºä»€ä¹ˆéœ€è¦ä¸¤å±‚æ£€æŸ¥ï¼Ÿ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Layer 1: ActiveStateTree Check (åŠ¨æ€ï¼Œå¿«é€Ÿ)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ£€æŸ¥ç‚¹: ProcessMessages ç”µè·¯
ä½œç”¨: å¿«é€Ÿåˆ¤æ–­ç”¨æˆ·å½“å‰æ˜¯å¦ inactive
å®ç°: activeStateLeaf === 0 ? active : inactive
æ›´æ–°: æ¯æ¬¡ processDeactivateMessages æ—¶æ›´æ–°

Layer 2: d1/d2 Decrypt Check (é™æ€ï¼Œé˜²å¾¡)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ£€æŸ¥ç‚¹: StateLeafTransformer ç”µè·¯
ä½œç”¨: éªŒè¯ç”¨æˆ·å†å²çŠ¶æ€ï¼Œé˜²æ­¢æ•°æ®ç¯¡æ”¹
å®ç°: decrypt(d1, d2) % 2 === 0 ? active : deactivated
æ›´æ–°: ä»…åœ¨ SignUp å’Œ AddNewKey æ—¶è®¾ç½®

åŒå±‚éªŒè¯è¡¨:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ActiveState    â”‚ d1/d2è§£å¯† â”‚  æŠ•ç¥¨    â”‚  è¯´æ˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0 (active)     â”‚ å¶æ•°(âœ“)   â”‚ æ¥å— âœ“  â”‚ æ­£å¸¸   â”‚
â”‚ é0 (inactive) â”‚ å¶æ•°(âœ“)   â”‚ æ‹’ç» âœ—  â”‚ å·²åœç”¨ â”‚
â”‚ 0 (active)     â”‚ å¥‡æ•°(âœ—)   â”‚ æ‹’ç» âœ—  â”‚ æ•°æ®æŸåâ”‚
â”‚ é0 (inactive) â”‚ å¥‡æ•°(âœ—)   â”‚ æ‹’ç» âœ—  â”‚ å·²åœç”¨ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸¤å±‚æ£€æŸ¥å¿…é¡»åŒæ—¶é€šè¿‡ï¼ŒæŠ•ç¥¨æ‰ä¼šè¢«æ¥å—ï¼
```

---

## Deactivate å®Œæ•´æµç¨‹

### æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AMACI å®Œæ•´ç”Ÿå‘½å‘¨æœŸ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬ä¸€é˜¶æ®µ: åˆå§‹æ³¨å†Œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. SignUp â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Contract: signup(pubKey)                            â”‚
â”‚   â†’ StateLeaf åˆ›å»º:                                 â”‚
â”‚      - pubKey = user's pubKey                       â”‚
â”‚      - balance = initial balance                    â”‚
â”‚      - d1, d2 = [0,0,0,0] (ä»£è¡¨ active)            â”‚
â”‚   â†’ ActiveStateTree[idx] = 0 (active)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬äºŒé˜¶æ®µ: æŠ•ç¥¨
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Vote   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User: buildVotePayload()                            â”‚
â”‚   â†’ åŠ å¯†æŠ•ç¥¨å†…å®¹                                     â”‚
â”‚   â†’ ç­¾åæ¶ˆæ¯                                         â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Operator: processMessages()                         â”‚
â”‚   â†’ è§£å¯†æ¶ˆæ¯                                         â”‚
â”‚   â†’ éªŒè¯ç­¾å                                         â”‚
â”‚   â†’ æ£€æŸ¥ activeStateTree[idx] === 0? âœ“             â”‚
â”‚   â†’ æ£€æŸ¥ decrypt(d1,d2) % 2 === 0? âœ“               â”‚
â”‚   â†’ æ›´æ–° balance, voTreeRoot                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬ä¸‰é˜¶æ®µ: åœç”¨å¯†é’¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Deactivate  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User: buildVotePayload({ vc: 0 })                   â”‚
â”‚   â†’ vc = 0 è¡¨ç¤º deactivate è¯·æ±‚                     â”‚
â”‚   â†’ ç­¾åæ¶ˆæ¯                                         â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Operator: processDeactivateMessages()               â”‚
â”‚   â†’ è§£å¯†æ¶ˆæ¯                                         â”‚
â”‚   â†’ éªŒè¯ç­¾å                                         â”‚
â”‚   â†’ ç”Ÿæˆç¡®å®šæ€§éšæœºå¯†é’¥:                              â”‚
â”‚      randomKey = genStaticRandomKey(privKey,        â”‚
â”‚                    20040n, newActiveState[i])       â”‚
â”‚   â†’ å¦‚æœç­¾åæœ‰æ•ˆ:                                    â”‚
â”‚       â€¢ ç”Ÿæˆ even åŠ å¯† c1/c2 (å¶æ•°)                  â”‚
â”‚       â€¢ å­˜å…¥ DeactivateTree                          â”‚
â”‚       â€¢ æ›´æ–° ActiveStateTree[idx] = hash(data)  âœ—  â”‚
â”‚   â†’ å¦‚æœç­¾åæ— æ•ˆ:                                    â”‚
â”‚       â€¢ ç”Ÿæˆ odd åŠ å¯† c1/c2 (å¥‡æ•°)                   â”‚
â”‚       â€¢ å­˜å…¥ DeactivateTree (ä½†ä¸å¯ç”¨)              â”‚
â”‚       â€¢ ActiveStateTree ä¿æŒä¸å˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬å››é˜¶æ®µ: æ·»åŠ æ–°å¯†é’¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. AddNewKey   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User: ç”Ÿæˆ AddNewKey Proof                          â”‚
â”‚   â†’ æ–°å¯†é’¥å¯¹ (newPubKey, newPrivKey)                â”‚
â”‚   â†’ ä» DeactivateTree è·å– c1/c2                    â”‚
â”‚   â†’ é‡éšæœºåŒ–: d1/d2 = rerandomize(coordPubKey,     â”‚
â”‚                         {c1, c2}, randomVal)        â”‚
â”‚   â†’ Merkle proof (è¯æ˜ c1/c2 å­˜åœ¨)                  â”‚
â”‚   â†’ Nullifier = Poseidon([privKey, SALT])          â”‚
â”‚   â†’ ECDH sharedKey (ç»‘å®šç”¨æˆ·èº«ä»½)                   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Circuit: AddNewKey Verification                     â”‚
â”‚   âœ“ Nullifier æœªä½¿ç”¨è¿‡                              â”‚
â”‚   âœ“ c1/c2 åœ¨ DeactivateTree ä¸­                      â”‚
â”‚   âœ“ Merkle proof æœ‰æ•ˆ                               â”‚
â”‚   âœ“ ECDH sharedKey æ­£ç¡®                             â”‚
â”‚   âœ“ d1/d2 é‡éšæœºåŒ–è®¡ç®—æ­£ç¡®                          â”‚
â”‚   âœ— ä¸æ£€æŸ¥ d1/d2 çš„å¥‡å¶æ€§!                          â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Contract: add_new_key(proof)                        â”‚
â”‚   â†’ éªŒè¯ proof                                       â”‚
â”‚   â†’ è®°å½• nullifier (é˜²é‡æ”¾)                         â”‚
â”‚   â†’ åˆ›å»ºæ–° StateLeaf:                                â”‚
â”‚       â€¢ pubKey = newPubKey                          â”‚
â”‚       â€¢ balance = old balance                       â”‚
â”‚       â€¢ d1, d2 = é‡éšæœºåŒ–åçš„æ•°æ®ï¼ˆä» proofï¼‰       â”‚
â”‚   â†’ ActiveStateTree[new_idx] = 0 (active)  âœ“      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬äº”é˜¶æ®µ: ä½¿ç”¨æ–°å¯†é’¥æŠ•ç¥¨
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Vote with New Key â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½¿ç”¨æ–°å¯†é’¥è¿›è¡ŒæŠ•ç¥¨ (å›åˆ°ç¬¬äºŒé˜¶æ®µ)                   â”‚
â”‚   â†’ ActiveStateTree[new_idx] === 0  âœ“              â”‚
â”‚   â†’ decrypt(d1,d2) % 2 === 0  âœ“                    â”‚
â”‚   â†’ åŒå±‚æ£€æŸ¥éƒ½é€šè¿‡ï¼ŒæŠ•ç¥¨æˆåŠŸ!                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æ—¶åˆ»çŠ¶æ€å¿«ç…§ï¼ˆå¸¦å…·ä½“æ•°å€¼ï¼‰

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æ—¶åˆ» T1: SignUp å
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç”¨æˆ·ä¿¡æ¯:
  privKey: 12345n
  pubKey: [
    10457101036533406547632367118273992368554162664806683215399215148255484599592n,
    12345678901234567890123456789012345678901234567890123456789012345678n
  ]

StateTree[0]:
  pubKey: [
    10457101036533406547632367118273992368554162664806683215399215148255484599592n,
    12345678901234567890123456789012345678901234567890123456789012345678n
  ]
  balance: 100
  voTreeRoot: 0
  nonce: 0
  d1: [0, 0]        â† ä»£è¡¨ active (å¶æ•°)
  d2: [0, 0]        â† ä»£è¡¨ active (å¶æ•°)
  xIncrement: 0

StateLeaf Hash è®¡ç®—:
  layer1 = poseidon5([pubKey[0], pubKey[1], 100, 0, 0])
         = 567891234...n
  layer2 = poseidon5([0, 0, 0, 0, 0])
         = 14655542659562014735865511769057053982292279840403315552050801315682099828156n
  stateLeafHash = poseidon2([layer1, layer2])
                = 890123456...n

ActiveStateTree[0]: 0  â† active âœ“

DeactivateTree[0]: 0   â† ç©º

ç”¨æˆ·å¯ä»¥æŠ•ç¥¨: âœ“

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æ—¶åˆ» T2: Vote å
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
StateTree[0]:
  pubKey: [x0, y0]
  balance: 90        â† å‡å°‘
  voTreeRoot: 0x...  â† æ›´æ–°
  nonce: 1           â† å¢åŠ 
  d1: [0, 0]         â† ä¸å˜
  d2: [0, 0]         â† ä¸å˜
  xIncrement: 0

ActiveStateTree[0]: 0  â† ä»ç„¶ active âœ“

DeactivateTree[0]: 0   â† ä¸å˜

ç”¨æˆ·å¯ä»¥æŠ•ç¥¨: âœ“

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æ—¶åˆ» T3: Deactivate å
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Operator å¤„ç†:
  processedDMsgCount: 0
  batchSize: 5
  deactivateIndex0: 0
  
  newActiveState[0] = 0 + 0 + 1 = 1

  randomKey = genStaticRandomKey(coordPrivKey, 20040, 1)
            = poseidon([coordPrivKey, 20040n, 1n])
            = 18273645192837465928374659283746592837465928374659283746592837465n

  deactivate = encryptOdevity(false, coordPubKey, randomKey)
  // false è¡¨ç¤ºç”Ÿæˆå¶æ•°ï¼ˆactiveï¼‰çš„åŠ å¯†ï¼Œä¸º AddNewKey å‡†å¤‡

  deactivate.c1: [
    7234567890123456789012345678901234567890123456789012345678901234n,
    9876543210987654321098765432109876543210987654321098765432109876n
  ]
  deactivate.c2: [
    5555555555555555555555555555555555555555555555555555555555555554n,  â† å¶æ•°
    6666666666666666666666666666666666666666666666666666666666666666n   â† å¶æ•°
  ]
  deactivate.xIncrement: 18273645192837465928374659283746592837465928374659283746592837465n

  dLeaf = [c1[0], c1[1], c2[0], c2[1], poseidon(sharedKey)]
  dLeafHash = poseidon(dLeaf)
            = 12345678901234567890123456789012345678901234567890123456789012345n

StateTree[0]:
  pubKey: [10457...592n, 12345...678n]
  balance: 90        â† ä¸å˜
  voTreeRoot: 0x...  â† ä¸å˜
  nonce: 1           â† ä¸å˜
  d1: [0, 0]         â† ä¸å˜ (é‡è¦!)
  d2: [0, 0]         â† ä¸å˜ (é‡è¦!)
  xIncrement: 0

ActiveStateTree[0]: 1  â† inactive âœ— (newActiveState[0])

DeactivateTree[0]: 12345678901234567890123456789012345678901234567890123456789012345n
                   â†‘ å­˜å…¥ Operator ç”Ÿæˆçš„å¶æ•° c1/c2ï¼ˆå¯ç”¨äº AddNewKey é‡éšæœºåŒ–ï¼‰

ç”¨æˆ·å¯ä»¥æŠ•ç¥¨: âœ— (ActiveStateTree check å¤±è´¥)

è§£å¯†éªŒè¯ deactivate æ•°æ®:
  decrypt(coordPrivKey, deactivate.c1, deactivate.c2, xIncrement)
  = 0 (å¶æ•°) â† å¯ç”¨äº AddNewKey âœ“

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æ—¶åˆ» T4: AddNewKey å
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ–°å¯†é’¥å¯¹:
  newPrivKey: 99999n
  newPubKey: [
    8765432109876543210987654321098765432109876543210987654321098765n,
    1111111111111111111111111111111111111111111111111111111111111111n
  ]

AddNewKey ç”µè·¯éªŒè¯:
  nullifier = poseidon([oldPrivKey, 1444992409218394441042n])
            = poseidon([12345n, 1444992409218394441042n])
            = 9876543210123456789012345678901234567890123456789012345678901234n
  
  sharedKey = ECDH(oldPrivKey, coordPubKey)
            = 4444444444444444444444444444444444444444444444444444444444444444n
  
  deactivateLeaf åœ¨ DeactivateTree[0] ä¸­ âœ“
  Merkle proof æœ‰æ•ˆ âœ“
  nullifier æœªä½¿ç”¨è¿‡ âœ“

StateTree[0]: (æ—§è´¦æˆ·ï¼ŒçŠ¶æ€åŒ T3)
  [çŠ¶æ€æœªå˜åŒ–]

StateTree[3]: (æ–°è´¦æˆ·)
  pubKey: [
    8765432109876543210987654321098765432109876543210987654321098765n,
    1111111111111111111111111111111111111111111111111111111111111111n
  ]
  balance: 90             â† ç»§æ‰¿ä½™é¢
  voTreeRoot: 0x...       â† ç»§æ‰¿æŠ•ç¥¨æ ‘
  nonce: 1                â† ç»§æ‰¿ nonce
  d1: [
    7234567890123456789012345678901234567890123456789012345678901234n,
    9876543210987654321098765432109876543210987654321098765432109876n
  ]  â† ä» c1 é‡éšæœºåŒ–è€Œæ¥ï¼Œä¿æŒå¶æ•°
  d2: [
    5555555555555555555555555555555555555555555555555555555555555554n,
    6666666666666666666666666666666666666666666666666666666666666666n
  ]  â† ä» c2 é‡éšæœºåŒ–è€Œæ¥ï¼Œä¿æŒå¶æ•°
  xIncrement: 18273645192837465928374659283746592837465928374659283746592837465n

ActiveStateTree[0]: 1          â† æ—§è´¦æˆ·ä» inactive âœ—
ActiveStateTree[3]: 0          â† æ–°è´¦æˆ· active âœ“

DeactivateTree[0]: 12345...345n  â† å·²ä½¿ç”¨

Nullifiers: [9876543210123456789012345678901234567890123456789012345678901234n]
            â†‘ è®°å½• nullifierï¼Œé˜²æ­¢é‡å¤ä½¿ç”¨

éªŒè¯æ–°è´¦æˆ·çš„ d1/d2:
  decrypt(coordPrivKey, d1, d2, xIncrement)
  = 0 (å¶æ•°) â† å¯ä»¥æŠ•ç¥¨ âœ“

åŒå±‚æ£€æŸ¥:
  Layer 1: ActiveStateTree[3] === 0 âœ“
  Layer 2: decrypt(d1, d2) % 2 === 0 âœ“
  
  âœ æ–°ç”¨æˆ·å¯ä»¥æŠ•ç¥¨: âœ“
  âœ æ—§ç”¨æˆ·ä¸èƒ½æŠ•ç¥¨: âœ— (ActiveStateTree[0] = 1)
```

---

## çŠ¶æ€è½¬æ¢å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç”¨æˆ·çŠ¶æ€è½¬æ¢å›¾                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   å¼€å§‹    â”‚
           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ signup()
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  REGISTERED  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   (å¯æŠ•ç¥¨)   â”‚                â”‚
         â”‚              â”‚                â”‚
         â”‚ â€¢ ActiveTree â”‚                â”‚
         â”‚    = 0       â”‚                â”‚
         â”‚ â€¢ d1/d2 å¶æ•° â”‚                â”‚
         â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜                â”‚
            â”‚        â”‚                   â”‚
            â”‚vote()  â”‚ deactivate()      â”‚ addNewKey()
            â”‚        â”‚                   â”‚ (æ–°è´¦æˆ·)
            â–¼        â–¼                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
         â”‚  REGISTERED  â”‚                â”‚
         â”‚   (å·²æŠ•ç¥¨)   â”‚                â”‚
         â”‚              â”‚                â”‚
         â”‚ â€¢ balance â†“  â”‚                â”‚
         â”‚ â€¢ voTree âœ“   â”‚                â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
                â”‚                        â”‚
                â”‚ deactivate()           â”‚
                â–¼                        â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
         â”‚ DEACTIVATED  â”‚                â”‚
         â”‚  (ä¸å¯æŠ•ç¥¨)  â”‚                â”‚
         â”‚              â”‚                â”‚
         â”‚ â€¢ ActiveTree â”‚                â”‚
         â”‚    â‰  0       â”‚                â”‚
         â”‚ â€¢ d1/d2 ä¸å˜ â”‚                â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
                â”‚                        â”‚
                â”‚ addNewKey()            â”‚
                â”‚ (æäº¤proof)            â”‚
                â”‚                        â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ³¨æ„:
  â€¢ æ—§è´¦æˆ·ä¿æŒ DEACTIVATED çŠ¶æ€
  â€¢ æ–°è´¦æˆ·ä» REGISTERED çŠ¶æ€å¼€å§‹
  â€¢ ä¸¤ä¸ªè´¦æˆ·ç‹¬ç«‹å­˜åœ¨ï¼Œä½™é¢å’ŒæŠ•ç¥¨å†å²è¢«ç»§æ‰¿
```

### ä¸‰æ£µæ ‘çš„å®Œæ•´è§†å›¾ï¼ˆå¸¦å…·ä½“æ•°å€¼ï¼‰

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        æ—¶åˆ» T1: SignUp å
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

StateTree (10å­—æ®µå®Œæ•´çŠ¶æ€):
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Idx â”‚                      StateLeaf                         â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  0  â”‚ pubKey: [10457...592n, 12345...678n]                   â”‚
â”‚     â”‚ balance: 100                                           â”‚
â”‚     â”‚ voTreeRoot: 0                                          â”‚
â”‚     â”‚ nonce: 0                                               â”‚
â”‚     â”‚ d1: [0, 0]  â† active (å¶æ•°)                            â”‚
â”‚     â”‚ d2: [0, 0]  â† active (å¶æ•°)                            â”‚
â”‚     â”‚ xIncrement: 0                                          â”‚
â”‚     â”‚ Hash: 890123456...n                                    â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1  â”‚ [ç©º]                                                    â”‚
â”‚  2  â”‚ [ç©º]                                                    â”‚
â”‚  3  â”‚ [ç©º]                                                    â”‚
â”‚ ... â”‚ ...                                                     â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Root: 123456789...n

ActiveStateTree (å•å€¼å¿«é€ŸæŸ¥è¯¢):
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Idx â”‚   Value   â”‚              å«ä¹‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  0  â”‚     0     â”‚ Active âœ“ (å¯æŠ•ç¥¨)                       â”‚
â”‚  1  â”‚     0     â”‚ Active âœ“                                â”‚
â”‚  2  â”‚     0     â”‚ Active âœ“                                â”‚
â”‚  3  â”‚     0     â”‚ Active âœ“                                â”‚
â”‚ ... â”‚    ...    â”‚ ...                                      â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Root: 14655542659562014735865511769057053982292279840403315552050801315682099828156n

DeactivateTree (Operator ç”Ÿæˆçš„ c1/c2):
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Idx â”‚   Hash    â”‚              å«ä¹‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  0  â”‚     0     â”‚ ç©º                                       â”‚
â”‚  1  â”‚     0     â”‚ ç©º                                       â”‚
â”‚  2  â”‚     0     â”‚ ç©º                                       â”‚
â”‚ ... â”‚    ...    â”‚ ...                                      â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Root: 14655542659562014735865511769057053982292279840403315552050801315682099828156n

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     æ—¶åˆ» T3: Deactivate å
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

StateTree (çŠ¶æ€æœªå˜):
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Idx â”‚                      StateLeaf                         â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  0  â”‚ pubKey: [10457...592n, 12345...678n]                   â”‚
â”‚     â”‚ balance: 90  â† æŠ•ç¥¨åå‡å°‘                              â”‚
â”‚     â”‚ voTreeRoot: 0x...                                      â”‚
â”‚     â”‚ nonce: 1  â† å¢åŠ                                        â”‚
â”‚     â”‚ d1: [0, 0]  â† ä¸å˜ï¼                                   â”‚
â”‚     â”‚ d2: [0, 0]  â† ä¸å˜ï¼                                   â”‚
â”‚     â”‚ xIncrement: 0                                          â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Root: 234567890...n  (å›  balance/nonce æ”¹å˜è€Œå˜åŒ–)

ActiveStateTree (è´¦æˆ·0è¢«æ ‡è®°ä¸º inactive):
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Idx â”‚   Value   â”‚              å«ä¹‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  0  â”‚     1     â”‚ Inactive âœ— (ä¸å¯æŠ•ç¥¨) â† æ”¹å˜ï¼          â”‚
â”‚  1  â”‚     0     â”‚ Active âœ“                                â”‚
â”‚  2  â”‚     0     â”‚ Active âœ“                                â”‚
â”‚  3  â”‚     0     â”‚ Active âœ“                                â”‚
â”‚ ... â”‚    ...    â”‚ ...                                      â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Root: 98765432...n  (å› è´¦æˆ·0æ”¹å˜è€Œå˜åŒ–)

DeactivateTree (å­˜å…¥å¶æ•°æ•°æ®):
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Idx â”‚         Hash            â”‚         åŸå§‹æ•°æ®          â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  0  â”‚ 12345678901234...345n   â”‚ c1: [7234...234n,         â”‚
â”‚     â”‚                         â”‚      9876...876n]         â”‚
â”‚     â”‚                         â”‚ c2: [5555...554n, â† å¶æ•°  â”‚
â”‚     â”‚                         â”‚      6666...666n]  â† å¶æ•° â”‚
â”‚     â”‚                         â”‚ sharedKey: 4444...444n    â”‚
â”‚     â”‚                         â”‚ âœ å¯ç”¨äº AddNewKey âœ“     â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1  â”‚     0                   â”‚ ç©º                         â”‚
â”‚  2  â”‚     0                   â”‚ ç©º                         â”‚
â”‚ ... â”‚    ...                  â”‚ ...                        â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Root: 45678901...n  (å› ç´¢å¼•0æ”¹å˜è€Œå˜åŒ–)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                      æ—¶åˆ» T4: AddNewKey å
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

StateTree (æ·»åŠ æ–°è´¦æˆ·):
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Idx â”‚                      StateLeaf                         â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  0  â”‚ [æ—§è´¦æˆ·ï¼ŒçŠ¶æ€åŒ T3]                                    â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3  â”‚ pubKey: [8765...765n, 1111...111n]  â† æ–°å¯†é’¥ï¼         â”‚
â”‚     â”‚ balance: 90  â† ç»§æ‰¿                                    â”‚
â”‚     â”‚ voTreeRoot: 0x...  â† ç»§æ‰¿                              â”‚
â”‚     â”‚ nonce: 1  â† ç»§æ‰¿                                       â”‚
â”‚     â”‚ d1: [7234...234n, 9876...876n]  â† ç»§æ‰¿ï¼ˆå¶æ•°ï¼‰        â”‚
â”‚     â”‚ d2: [5555...554n, 6666...666n]  â† ç»§æ‰¿ï¼ˆå¶æ•°ï¼‰        â”‚
â”‚     â”‚ xIncrement: 18273...465n                               â”‚
â”‚     â”‚ Hash: 567890123...n                                    â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Root: 678901234...n  (å› æ·»åŠ è´¦æˆ·3è€Œå˜åŒ–)

ActiveStateTree (æ–°è´¦æˆ·æ ‡è®°ä¸º active):
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Idx â”‚   Value   â”‚              å«ä¹‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  0  â”‚     1     â”‚ Inactive âœ— (æ—§è´¦æˆ·)                     â”‚
â”‚  1  â”‚     0     â”‚ Active âœ“                                â”‚
â”‚  2  â”‚     0     â”‚ Active âœ“                                â”‚
â”‚  3  â”‚     0     â”‚ Active âœ“ (æ–°è´¦æˆ·) â† æ–°å¢ï¼              â”‚
â”‚ ... â”‚    ...    â”‚ ...                                      â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Root: 789012345...n  (å› è´¦æˆ·3æ”¹å˜è€Œå˜åŒ–)

DeactivateTree (çŠ¶æ€æœªå˜):
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Idx â”‚         Hash            â”‚         è¯´æ˜              â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  0  â”‚ 12345678901234...345n   â”‚ å·²ä½¿ç”¨ (nullifier è®°å½•)   â”‚
â”‚  1  â”‚     0                   â”‚ ç©º                         â”‚
â”‚ ... â”‚    ...                  â”‚ ...                        â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Root: 45678901...n  (æœªå˜åŒ–)

Nullifiers (é˜²é‡æ”¾):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9876543210123456...234n  â† å·²ä½¿ç”¨       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ActiveStateTree æ›´æ–°æ—¶åºå›¾

```
æ—¶é—´è½´: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶

äº‹ä»¶:   SignUp    Vote    Deactivate   AddNewKey    Vote(new)
        â”‚         â”‚       â”‚            â”‚            â”‚
        â–¼         â–¼       â–¼            â–¼            â–¼

Active  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
State   â”‚    è´¦æˆ·0         â”‚            â”‚  è´¦æˆ·3
Tree    â”‚                  â”‚            â”‚
        â”‚  0 (active)      â”‚  1         â”‚  0 (active)
        â”‚        â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â—       â”‚  â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â—
        â”‚                  inactive     â”‚  active
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        â”œâ”€ å¯æŠ•ç¥¨ â”€â”€â”¼â”€ å¯æŠ•ç¥¨ â”€â”¼ ä¸å¯æŠ•ç¥¨ â”¼â”€â”€â”€â”€ å¯æŠ•ç¥¨ â”€â”€â”€â”€â”€â”€â”€â”€â–¶
                                           (æ–°å¯†é’¥)
```

---

## çŠ¶æ€ç»„åˆè¯¦è§£

### å››ç§ d1/d2 ä¸ ActiveStateTree ç»„åˆ

AMACI ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·çŠ¶æ€ç”±ä¸¤ä¸ªå…³é”®å› ç´ å†³å®šï¼š
1. **d1/d2 çš„å¥‡å¶æ€§** - å­˜å‚¨åœ¨ StateTree ä¸­ï¼Œé€šè¿‡è§£å¯†åˆ¤æ–­
2. **ActiveStateTree çš„å€¼** - ç‹¬ç«‹çš„æ ‘ï¼Œ0è¡¨ç¤ºactiveï¼Œé0è¡¨ç¤ºinactive

è¿™ä¸¤ä¸ªå› ç´ ç»„åˆäº§ç”Ÿ **4 ç§å¯èƒ½çš„çŠ¶æ€**ï¼Œæ¯ç§çŠ¶æ€éƒ½æœ‰å…¶ç‰¹å®šçš„äº§ç”Ÿæ–¹å¼å’Œå«ä¹‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          çŠ¶æ€ç»„åˆ ä¸ æŠ•ç¥¨èƒ½åŠ› å¯¹ç…§è¡¨                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ çŠ¶æ€   â”‚ d1/d2 å¥‡å¶æ€§ â”‚ ActiveStateTreeâ”‚ èƒ½æŠ•ç¥¨   â”‚ å«ä¹‰     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ çŠ¶æ€1  â”‚ å¶æ•° (âœ“)     â”‚ 0 (active)     â”‚ âœ… èƒ½    â”‚ æ­£å¸¸å¯ç”¨ â”‚
â”‚ çŠ¶æ€2  â”‚ å¶æ•° (âœ“)     â”‚ é0 (inactive) â”‚ âŒ ä¸èƒ½  â”‚ å·²åœç”¨   â”‚
â”‚ çŠ¶æ€3  â”‚ å¥‡æ•° (âœ—)     â”‚ 0 (active)     â”‚ âŒ ä¸èƒ½  â”‚ å¼‚å¸¸è´¦æˆ· â”‚
â”‚ çŠ¶æ€4  â”‚ å¥‡æ•° (âœ—)     â”‚ é0 (inactive) â”‚ âŒ ä¸èƒ½  â”‚ åŒé‡åœç”¨ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ³¨: åªæœ‰çŠ¶æ€1å¯ä»¥æŠ•ç¥¨ï¼Œéœ€è¦åŒå±‚æ£€æŸ¥éƒ½é€šè¿‡
```

### çŠ¶æ€1: d1/d2å¶æ•° + ActiveStateTree=0 âœ…

**å«ä¹‰**: æ­£å¸¸å¯æŠ•ç¥¨çŠ¶æ€

> **ç”¨æˆ· signup å’Œä½¿ç”¨æ­£ç¡®çš„ deactivate leaf è¿›è¡Œ addNewKeyï¼Œä»¥åŠé”™è¯¯çš„ deactivateï¼ˆæ—§è´¦æˆ·çŠ¶æ€ï¼‰**

**äº§ç”Ÿæ–¹å¼**:

```
æ–¹å¼ A: åˆå§‹ SignUp
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆçº¦è°ƒç”¨: signup(pubKey, balance)                      â”‚
â”‚   â†’ d1/d2 è®¾ç½®ä¸º [0, 0, 0, 0] (ä»£è¡¨å¶æ•°/active)       â”‚
â”‚   â†’ ActiveStateTree[idx] = 0                           â”‚
â”‚   â†’ ç»“æœ: ç”¨æˆ·å¯ä»¥æ­£å¸¸æŠ•ç¥¨ âœ…                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä»£ç ä½ç½®: operator.ts updateStateTree()
  updateStateTree(leafIdx, pubKey, balance, [0n, 0n, 0n, 0n])
  // c = [0,0,0,0] æ—¶ï¼Œd1=[0,0], d2=[0,0]

æ–¹å¼ B: æˆåŠŸçš„ AddNewKeyï¼ˆä½¿ç”¨æ­£ç¡®çš„ deactivate æ•°æ®ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ææ¡ä»¶:                                               â”‚
â”‚   - æ—§è´¦æˆ·æˆåŠŸ deactivateï¼ˆç”Ÿæˆäº†å¶æ•° c1/c2ï¼‰         â”‚
â”‚   - DeactivateTree ä¸­å­˜å‚¨äº†å¶æ•°æ•°æ®                    â”‚
â”‚                                                         â”‚
â”‚ æµç¨‹:                                                   â”‚
â”‚   1. ä» DeactivateTree è·å–å¶æ•° c1/c2                  â”‚
â”‚   2. é‡éšæœºåŒ–: d1/d2 = rerandomize(coordPubKey,        â”‚
â”‚                        {c1, c2}, randomVal)            â”‚
â”‚      â””â”€ é‡éšæœºåŒ–ä¿æŒå¥‡å¶æ€§: å¶æ•° â†’ å¶æ•°               â”‚
â”‚   3. åˆçº¦è®¾ç½® ActiveStateTree[new_idx] = 0            â”‚
â”‚   4. æ–°è´¦æˆ· d1/d2 = å¶æ•°ï¼ˆç»§æ‰¿è‡ª c1/c2ï¼‰              â”‚
â”‚   â†’ ç»“æœ: æ–°è´¦æˆ·å¯ä»¥æ­£å¸¸æŠ•ç¥¨ âœ…                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ–¹å¼ C: é”™è¯¯çš„ Deactivate è¢«ç³»ç»Ÿæ‹’ç»
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœºæ™¯: ç”¨æˆ·å‘é€ç­¾åé”™è¯¯/å·²deactivateçš„æ¶ˆæ¯              â”‚
â”‚                                                         â”‚
â”‚ æµç¨‹:                                                   â”‚
â”‚   1. checkDeactivateCommand() æ£€æµ‹åˆ°é”™è¯¯               â”‚
â”‚      â””â”€ è¿”å› 'signature error' / 'deactivated'        â”‚
â”‚   2. processDeactivateMessages() å¤„ç†:                 â”‚
â”‚      â€¢ d1/d2 ä¿æŒä¸å˜ (ä»æ˜¯å¶æ•°) â­                    â”‚
â”‚      â€¢ ActiveStateTree ä¸æ›´æ–° (ä»æ˜¯ 0) â­             â”‚
â”‚      â€¢ DeactivateTree å­˜å…¥å¥‡æ•° c1/c2 (ä¸å¯ç”¨)         â”‚
â”‚   â†’ ç»“æœ: åŸè´¦æˆ·å—ä¿æŠ¤ï¼Œä»å¯æŠ•ç¥¨ âœ…                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®ä»£ç : operator.ts processDeactivateMessages()
  if (!error) {
    // åªæœ‰æ­£ç¡®çš„æ¶ˆæ¯æ‰æ›´æ–° ActiveStateTree
    this.activeStateTree.updateLeaf(stateIdx, newActiveState[i]);
  }
  // é”™è¯¯æ¶ˆæ¯ä¸æ›´æ–° â†’ ä¿æŠ¤åŸè´¦æˆ·
```

### çŠ¶æ€2: d1/d2å¶æ•° + ActiveStateTree=é0 âœ—

**å«ä¹‰**: å·²åœç”¨ä½†æ•°æ®æ­£å¸¸ï¼ˆä¸èƒ½æŠ•ç¥¨ï¼Œä½†å¯ä»¥ AddNewKeyï¼‰

> **æˆåŠŸçš„ Deactivate**

**äº§ç”Ÿæ–¹å¼**:

```
å”¯ä¸€æ–¹å¼: æˆåŠŸçš„ Deactivate
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æ“ä½œ:                                               â”‚
â”‚   - å‘é€ deactivate æ¶ˆæ¯ (vc=0)                        â”‚
â”‚   - ç­¾åæ­£ç¡®ï¼Œnonce æ­£ç¡®                                â”‚
â”‚                                                         â”‚
â”‚ Operator å¤„ç†: processDeactivateMessages()              â”‚
â”‚   1. éªŒè¯ç­¾åé€šè¿‡ âœ“                                     â”‚
â”‚   2. ç”Ÿæˆå¶æ•°çš„ c1/c2                                   â”‚
â”‚      deactivate = encryptOdevity(                       â”‚
â”‚        false,  // false = ç”Ÿæˆå¶æ•°                     â”‚
â”‚        coordPubKey,                                     â”‚
â”‚        randomKey                                        â”‚
â”‚      )                                                  â”‚
â”‚   3. æ›´æ–° ActiveStateTree[idx] = newActiveState[i]     â”‚
â”‚      â””â”€ newActiveState[i] = processedDMsgCount+i+1     â”‚
â”‚      â””â”€ é0å€¼ï¼Œæ ‡è®°ä¸º inactive â­                      â”‚
â”‚   4. d1/d2 ä¸å˜ï¼ˆä»æ˜¯å¶æ•°ï¼‰â­â­ å…³é”®ç‚¹                  â”‚
â”‚   5. å­˜å…¥ DeactivateTree:                              â”‚
â”‚      hash([c1[0], c1[1], c2[0], c2[1], sharedKeyHash]) â”‚
â”‚                                                         â”‚
â”‚ ç»“æœ:                                                   â”‚
â”‚   âŒ ç”¨æˆ·ä¸èƒ½æŠ•ç¥¨ (ActiveStateTree check å¤±è´¥)         â”‚
â”‚   âœ… ä½†å¯ä»¥ç”¨å¶æ•° c1/c2 è¿›è¡Œ AddNewKey                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®ä»£ç : operator.ts ç¬¬1080-1142è¡Œ
  const error = this.checkDeactivateCommand(cmd, subStateTreeLength);
  
  const randomKey = this.genStaticRandomKey(
    coordPrivKey, 20040n, newActiveState[i]
  );
  
  const deactivate = this.encryptOdevity(
    !!error,  // error=null â†’ false â†’ å¶æ•°
    coordPubKey,
    randomKey
  );
  
  if (!error) {
    // æ­£ç¡®æ¶ˆæ¯ï¼šæ›´æ–° ActiveStateTree
    this.activeStateTree.updateLeaf(stateIdx, newActiveState[i]);
    this.deactivateTree.updateLeaf(deactivateIndex0 + i, poseidon(dLeaf));
    newDeactivate.push(dLeaf);
  }
  // æ³¨æ„ï¼šd1/d2 å®Œå…¨ä¸æ›´æ–°ï¼

é‡è¦è¯´æ˜:
  â€¢ d1/d2 æ˜¯ StateLeaf çš„æ°¸ä¹…å­—æ®µï¼Œåªåœ¨ SignUp/AddNewKey æ—¶è®¾ç½®
  â€¢ Deactivate æ“ä½œä¸æ”¹å˜ StateLeafï¼Œåªæ›´æ–° ActiveStateTree
  â€¢ è¿™ç§è®¾è®¡ä¿è¯äº†æ•°æ®çš„ä¸å¯å˜æ€§å’Œå¯è¿½æº¯æ€§
```

### çŠ¶æ€3: d1/d2å¥‡æ•° + ActiveStateTree=0 âš ï¸

**å«ä¹‰**: å¼‚å¸¸çŠ¶æ€ï¼ˆè´¦æˆ·è¡¨é¢æ´»è·ƒï¼Œä½†å®é™…ä¸å¯ç”¨ï¼‰

> **ç”¨æˆ·åœ¨ deactivate çš„æ—¶å€™ï¼Œä¸Šä¼ äº†é”™è¯¯çš„ deactivate messageï¼Œå¯¼è‡´ operator åœ¨ process deactivate message çš„æ—¶å€™ï¼Œæä¾›äº†å¥‡æ•°çš„deactivate c1/c2 å¹¶ä¸”ä¸æ›´æ–° active state treeï¼Œç„¶åç”¨æˆ·ä½¿ç”¨äº†è¿™ä¸ªå¥‡æ•°çš„deactivate è¿›è¡Œäº† addNewKeyã€‚ï¼ˆæ–°ç”¨æˆ·çš„çŠ¶æ€ä¼šå˜æˆè¿™æ ·å­ï¼Œè€è´¦æˆ·çš„çŠ¶æ€ä¼šä¿æŒçŠ¶æ€1çš„æƒ…å†µã€‚ï¼‰**

**äº§ç”Ÿæ–¹å¼**:

```
æ–¹å¼: AddNewKey ä½¿ç”¨äº†é”™è¯¯ deactivate çš„å¥‡æ•°æ•°æ®
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ææ¡ä»¶:                                               â”‚
â”‚   - æ—§è´¦æˆ· deactivate å¤±è´¥ï¼ˆä¾‹å¦‚ç­¾åé”™è¯¯ï¼‰             â”‚
â”‚   - DeactivateTree ä¸­å­˜å‚¨äº†å¥‡æ•° c1/c2                  â”‚
â”‚   - ç”¨æˆ·ä¸çŸ¥æƒ…ï¼Œç”¨è¿™ä¸ªæ•°æ®è¿›è¡Œ AddNewKey               â”‚
â”‚                                                         â”‚
â”‚ æµç¨‹:                                                   â”‚
â”‚   1. ä» DeactivateTree è·å–å¥‡æ•° c1/c2 âš ï¸               â”‚
â”‚   2. é‡éšæœºåŒ–: d1/d2 = rerandomize(coordPubKey,        â”‚
â”‚                        {å¥‡æ•°c1, å¥‡æ•°c2}, randomVal)    â”‚
â”‚      â””â”€ é‡éšæœºåŒ–ä¿æŒå¥‡å¶æ€§: å¥‡æ•° â†’ å¥‡æ•° âš ï¸            â”‚
â”‚   3. åˆçº¦è®¾ç½® ActiveStateTree[new_idx] = 0 âœ“          â”‚
â”‚   4. æ–°è´¦æˆ· d1/d2 = å¥‡æ•°ï¼ˆç»§æ‰¿è‡ªå¥‡æ•° c1/c2ï¼‰âŒ        â”‚
â”‚                                                         â”‚
â”‚ ç»“æœçŠ¶æ€:                                               â”‚
â”‚   - ActiveStateTree[new_idx] = 0 (çœ‹èµ·æ¥ active)       â”‚
â”‚   - d1/d2 = å¥‡æ•° (å®é™… deactivated)                    â”‚
â”‚                                                         â”‚
â”‚ æŠ•ç¥¨æ—¶çš„åŒé‡æ£€æŸ¥:                                       â”‚
â”‚   Layer 1: ActiveStateTree check                       â”‚
â”‚     âœ“ as = activeStateTree.leaf(idx) = 0              â”‚
â”‚     âœ“ isActive1 = (as === 0) = true â†’ é€šè¿‡            â”‚
â”‚                                                         â”‚
â”‚   Layer 2: d1/d2 decrypt check (StateLeafTransformer) â”‚
â”‚     âœ— result = decrypt(d1, d2)                         â”‚
â”‚     âœ— isActive2 = (result % 2 === 0) = false          â”‚
â”‚     âœ— å› ä¸º result = 1 (å¥‡æ•°)                           â”‚
â”‚                                                         â”‚
â”‚   Final: isValid = isActive1 AND isActive2 = false    â”‚
â”‚   â†’ æŠ•ç¥¨è¢«æ‹’ç» âŒâŒ                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®ä»£ç : operator.ts checkCommandNow() ç¬¬1517-1530è¡Œ
  // Layer 1: ActiveStateTree æ£€æŸ¥
  const as = this.activeStateTree!.leaf(stateIdx) || 0n;
  if (as !== 0n) {
    return 'inactive';
  }
  
  // Layer 2: d1/d2 è§£å¯†æ£€æŸ¥
  const deactivate = decrypt(signer.getFormatedPrivKey(), {
    c1: { x: s.d1[0], y: s.d1[1] },
    c2: { x: s.d2[0], y: s.d2[1] },
    xIncrement: 0n
  });
  if (deactivate % 2n === 1n) {
    return 'deactivated';  // â† è¿™é‡Œä¼šæ‹’ç» â­
  }

å®‰å…¨ä¿éšœ:
  âœ… è™½ç„¶ ActiveStateTree æ˜¾ç¤º active
  âœ… ä½† d1/d2 æ£€æŸ¥ä¼šæ•è·å¼‚å¸¸
  âœ… é˜²æ­¢å¼‚å¸¸è´¦æˆ·å‚ä¸æŠ•ç¥¨
  âœ… åŒå±‚éªŒè¯çš„é˜²å¾¡çºµæ·±ä½“ç°
```

### çŠ¶æ€4: d1/d2å¥‡æ•° + ActiveStateTree=é0 âŒ

**å«ä¹‰**: ç†è®ºä¸Šä¸åº”è¯¥å‡ºç°ï¼ˆåŒé‡åœç”¨çŠ¶æ€ï¼‰

**äº§ç”Ÿæ–¹å¼**:

```
ç†è®ºæ–¹å¼ï¼ˆå®é™…ä¸ä¼šå‘ç”Ÿï¼‰: å¥‡æ•°è´¦æˆ·å°è¯•å†æ¬¡ deactivate
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ææ¡ä»¶:                                               â”‚
â”‚   - è´¦æˆ·å¤„äºçŠ¶æ€3 (d1/d2å¥‡æ•° + AS=0)                   â”‚
â”‚   - ç”¨æˆ·å°è¯•å‘é€ deactivate æ¶ˆæ¯                        â”‚
â”‚                                                         â”‚
â”‚ æµç¨‹:                                                   â”‚
â”‚   1. checkDeactivateCommand() æ£€æŸ¥                     â”‚
â”‚      const deactivate = decrypt(coordPrivKey, {        â”‚
â”‚        c1: { x: s.d1[0], y: s.d1[1] },                â”‚
â”‚        c2: { x: s.d2[0], y: s.d2[1] }                 â”‚
â”‚      });                                               â”‚
â”‚                                                         â”‚
â”‚      if (deactivate % 2n === 1n) {                     â”‚
â”‚        return 'deactivated';  // â† è¢«æ‹’ç» â­           â”‚
â”‚      }                                                  â”‚
â”‚                                                         â”‚
â”‚   2. processDeactivateMessages() æ£€æµ‹åˆ° error          â”‚
â”‚      â€¢ ç”Ÿæˆæ–°çš„å¥‡æ•° c1/c2 (encryptOdevity(true, ...)) â”‚
â”‚      â€¢ ä¸æ›´æ–° ActiveStateTree (å› ä¸ºæœ‰error) â­         â”‚
â”‚      â€¢ åªæ›´æ–° DeactivateTree (åˆæ˜¯å¥‡æ•°)                â”‚
â”‚                                                         â”‚
â”‚ ç»“æœ:                                                   â”‚
â”‚   - ActiveStateTree ä¿æŒ 0 (ä¸å˜)                      â”‚
â”‚   - d1/d2 ä¿æŒå¥‡æ•° (ä¸å˜)                              â”‚
â”‚   - ä»æ˜¯çŠ¶æ€3ï¼Œä¸æ˜¯çŠ¶æ€4                               â”‚
â”‚   â†’ çŠ¶æ€4 å®é™…ä¸ä¼šå‡ºç° âœ…                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸ºä»€ä¹ˆçŠ¶æ€4ä¸ä¼šå‘ç”Ÿ:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  åŸå›  1: checkDeactivateCommand çš„å¥‡æ•°æ£€æµ‹
    â€¢ åœ¨å¤„ç† deactivate æ¶ˆæ¯å‰å°±æ£€æµ‹ d1/d2
    â€¢ å¥‡æ•°è´¦æˆ·ä¼šè¢«æ ‡è®°ä¸º 'deactivated' é”™è¯¯
    
  åŸå›  2: æœ‰ error æ—¶ä¸æ›´æ–° ActiveStateTree
    â€¢ if (!error) { æ›´æ–° ActiveStateTree }
    â€¢ æœ‰ error æ—¶è·³è¿‡æ›´æ–°
    â€¢ ä¿æŒ ActiveStateTree = 0
  
  åŸå›  3: å¥‡å¶æ€§æ— é™å¾ªç¯
    â€¢ å¥‡æ•° d1/d2 â†’ deactivate è¢«æ‹’ç» â†’ ç”Ÿæˆå¥‡æ•° c1/c2
    â€¢ å¥‡æ•° c1/c2 â†’ AddNewKey â†’ å¥‡æ•° d1/d2
    â€¢ æ— æ³•é€ƒè„±å¥‡æ•°çŠ¶æ€
    
  ç»“è®º: çŠ¶æ€4 æ˜¯ç†è®ºä¸Šçš„ç»„åˆï¼Œä½†ç³»ç»Ÿè®¾è®¡ç¡®ä¿å®ƒä¸ä¼šå‘ç”Ÿ

å®‰å…¨æ„ä¹‰:
  âœ… é˜²æ­¢åˆ›å»ºå¤šä¸ªå¯ç”¨è´¦æˆ·
  âœ… å¥‡æ•°è´¦æˆ·æ°¸ä¹…ä¸å¯ç”¨
  âœ… æ— æ³•é€šè¿‡ä»»ä½•æ–¹å¼ç»•è¿‡æ£€æŸ¥
```

### å®Œæ•´çŠ¶æ€è½¬æ¢å›¾ï¼ˆå¸¦æ‰€æœ‰çŠ¶æ€ï¼‰

```
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   SignUp / åˆå§‹åŒ–   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  çŠ¶æ€1: d1/d2å¶æ•° + AS=0         â”‚
              â”‚         âœ… å¯æŠ•ç¥¨                â”‚
              â”‚  äº§ç”Ÿ: SignUp, AddNewKey(å¶æ•°)   â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                  â”‚
    æ­£ç¡®deactivate â”‚                  â”‚ é”™è¯¯deactivate
    (ç­¾åæ­£ç¡®)     â”‚                  â”‚ (è¢«æ‹’ç»ï¼ŒçŠ¶æ€ä¸å˜)
                   â”‚                  â”‚
                   â–¼                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚ çŠ¶æ€2: d1/d2å¶æ•° + ASâ‰ 0     â”‚  â”‚
    â”‚       âœ— å·²åœç”¨              â”‚  â”‚
    â”‚ äº§ç”Ÿ: Deactivate æˆåŠŸ        â”‚  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
         â”‚                            â”‚
         â”‚ AddNewKey                  â”‚
         â”‚ (ä½¿ç”¨å¶æ•°c1/c2) âœ“          â”‚
         â–¼                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚ çŠ¶æ€1: d1/d2å¶æ•° + AS=0     â”‚â—„â”€â”˜
    â”‚      âœ… æ–°è´¦æˆ·å¯æŠ•ç¥¨         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
         â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
         â•‘   é”™è¯¯è·¯å¾„ï¼ˆåº”é¿å…ï¼Œä½†ç³»ç»Ÿèƒ½å¤„ç†ï¼‰â•‘
         â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ çŠ¶æ€1æˆ–2 (ä»»æ„æ­£å¸¸çŠ¶æ€)      â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Deactivate å¤±è´¥
         â”‚ (ç­¾åé”™è¯¯/å·²deactivate)
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ DeactivateTree å­˜å…¥å¥‡æ•°c1/c2 â”‚
    â”‚ (åŸè´¦æˆ·çŠ¶æ€ä¸å˜)             â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ ç”¨æˆ·ä¸çŸ¥æƒ…
         â”‚ AddNewKey(ä½¿ç”¨å¥‡æ•°c1/c2) âš ï¸
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ çŠ¶æ€3: d1/d2å¥‡æ•° + AS=0     â”‚
    â”‚       âš ï¸ å¼‚å¸¸ä¸å¯ç”¨          â”‚
    â”‚ äº§ç”Ÿ: AddNewKey(å¥‡æ•°æ•°æ®)    â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ å°è¯•æŠ•ç¥¨ â†’ è¢«Layer2æ‹’ç» âŒ
         â”‚ å°è¯•deactivate â†’ è¢«æ£€æµ‹ä¸ºå¥‡æ•° âŒ
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ çŠ¶æ€3: æ°¸ä¹…ä¸å¯ç”¨            â”‚
    â”‚ (æ— é™å¾ªç¯ï¼Œæ— æ³•é€ƒè„±)         â”‚
    â”‚                              â”‚
    â”‚ æ³¨: çŠ¶æ€4ä¸ä¼šå‡ºç°            â”‚
    â”‚ (ç³»ç»Ÿè®¾è®¡ä¿è¯)               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å›¾ä¾‹:
  âœ… = å¯ä»¥æŠ•ç¥¨
  âœ— = ä¸èƒ½æŠ•ç¥¨ï¼ˆæ­£å¸¸åœç”¨ï¼‰
  âš ï¸ = ä¸èƒ½æŠ•ç¥¨ï¼ˆå¼‚å¸¸çŠ¶æ€ï¼‰
  âŒ = åŒé‡åœç”¨ï¼ˆç†è®ºä¸å­˜åœ¨ï¼‰
```

### å…³é”®äº¤äº’æ€»ç»“è¡¨

```typescript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// äº¤äº’ 1: SignUp
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è¾“å…¥: æ— ï¼ˆæ–°ç”¨æˆ·ï¼‰
// è¾“å‡º: çŠ¶æ€1 (d1/d2å¶æ•° + AS=0)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
operator.updateStateTree(idx, pubKey, balance, [0n, 0n, 0n, 0n]);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// äº¤äº’ 2: æ­£ç¡®çš„ Deactivate
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è¾“å…¥: çŠ¶æ€1 (d1/d2å¶æ•° + AS=0)
// è¾“å‡º: çŠ¶æ€2 (d1/d2å¶æ•° + ASâ‰ 0)
// æ”¹å˜: ActiveStateTree[idx]: 0 â†’ é0
//      d1/d2: ä¿æŒä¸å˜
//      DeactivateTree: å­˜å…¥å¶æ•° c1/c2
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
operator.pushDeactivateMessage(ciphertext, encPubKey);
await operator.processDeactivateMessages({
  inputSize: 1,
  subStateTreeLength: 5 ** stateTreeDepth
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// äº¤äº’ 3: é”™è¯¯çš„ Deactivateï¼ˆç³»ç»Ÿæ‹’ç»ï¼Œä¿æŠ¤ç”¨æˆ·ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è¾“å…¥: çŠ¶æ€1 (d1/d2å¶æ•° + AS=0)
// è¾“å‡º: çŠ¶æ€1 (ä¿æŒä¸å˜) â† ç³»ç»Ÿä¿æŠ¤
// æ”¹å˜: ActiveStateTree: ä¸å˜ï¼ˆä»æ˜¯0ï¼‰
//      d1/d2: ä¸å˜ï¼ˆä»æ˜¯å¶æ•°ï¼‰
//      DeactivateTree: å­˜å…¥å¥‡æ•° c1/c2ï¼ˆæ ‡è®°ä¸ºä¸å¯ç”¨ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
operator.pushDeactivateMessage(é”™è¯¯çš„æ¶ˆæ¯, encPubKey);
await operator.processDeactivateMessages({...});
// checkDeactivateCommand() è¿”å› error
// â†’ ä¸æ›´æ–° ActiveStateTree
// â†’ åŸè´¦æˆ·å—ä¿æŠ¤ âœ…

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// äº¤äº’ 4: AddNewKeyï¼ˆä½¿ç”¨å¶æ•°æ•°æ®ï¼‰âœ… æ¨è
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è¾“å…¥: æ—§è´¦æˆ·çŠ¶æ€2 (d1/d2å¶æ•° + ASâ‰ 0)
// è¾“å‡º: æ–°è´¦æˆ·çŠ¶æ€1 (d1/d2å¶æ•° + AS=0)
// ç»§æ‰¿: balance, voTree, nonce
// æ–°å¢: pubKey (æ–°å¯†é’¥), d1/d2 (ä»å¶æ•°c1/c2é‡éšæœºåŒ–)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const payload = await operator.buildAddNewKeyPayload({
  stateTreeDepth: 2,
  operatorPubkey: coordPubKey,
  deactivates: [å¶æ•°æ•°æ®],  // ä» DeactivateTree è·å–
  wasmFile,
  zkeyFile
});
contract.add_new_key({
  proof: payload.proof,
  d: payload.d,  // [d1[0], d1[1], d2[0], d2[1]] - å¶æ•°
  nullifier: payload.nullifier
});
// â†’ æ–°è´¦æˆ· d1/d2 = å¶æ•°ï¼ˆç»§æ‰¿å¥‡å¶æ€§ï¼‰
// â†’ æ–°è´¦æˆ· ActiveStateTree = 0
// â†’ å¯ä»¥æ­£å¸¸æŠ•ç¥¨ âœ…

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// äº¤äº’ 5: AddNewKeyï¼ˆä½¿ç”¨å¥‡æ•°æ•°æ®ï¼‰âš ï¸ ä¸æ¨èï¼ˆä¼šå¤±è´¥ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è¾“å…¥: æ—§è´¦æˆ·çŠ¶æ€1 (d1/d2å¶æ•° + AS=0ï¼Œä½†deactivateå¤±è´¥)
// è¾“å‡º: æ–°è´¦æˆ·çŠ¶æ€3 (d1/d2å¥‡æ•° + AS=0) âš ï¸ ä¸å¯ç”¨
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const payload = await operator.buildAddNewKeyPayload({
  stateTreeDepth: 2,
  operatorPubkey: coordPubKey,
  deactivates: [å¥‡æ•°æ•°æ®],  // ä»å¤±è´¥çš„ deactivate è·å–
  wasmFile,
  zkeyFile
});
contract.add_new_key({
  proof: payload.proof,
  d: payload.d,  // [d1[0], d1[1], d2[0], d2[1]] - å¥‡æ•° âš ï¸
  nullifier: payload.nullifier
});
// â†’ æ–°è´¦æˆ· d1/d2 = å¥‡æ•°ï¼ˆç»§æ‰¿å¥‡æ•°ç‰¹æ€§ï¼‰
// â†’ æ–°è´¦æˆ· ActiveStateTree = 0
// â†’ çœ‹èµ·æ¥ activeï¼Œä½†æŠ•ç¥¨æ—¶è¢« Layer2 æ‹’ç» âŒ
// â†’ æ— æ³•é€šè¿‡ä»»ä½•æ–¹å¼ä¿®å¤ âŒ

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æŠ•ç¥¨éªŒè¯: åŒå±‚æ£€æŸ¥
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åªæœ‰çŠ¶æ€1å¯ä»¥é€šè¿‡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const error = operator.checkCommandNow(cmd);
// Layer 1: ActiveStateTree check
//   if (activeStateTree.leaf(idx) !== 0) return 'inactive';
// Layer 2: d1/d2 decrypt check
//   if (decrypt(d1, d2) % 2 === 1) return 'deactivated';
// 
// çŠ¶æ€1: Layer1âœ“ + Layer2âœ“ â†’ æŠ•ç¥¨æˆåŠŸ
// çŠ¶æ€2: Layer1âœ— â†’ æŠ•ç¥¨å¤±è´¥ï¼ˆå·²åœç”¨ï¼‰
// çŠ¶æ€3: Layer1âœ“ + Layer2âœ— â†’ æŠ•ç¥¨å¤±è´¥ï¼ˆå¼‚å¸¸è´¦æˆ·ï¼‰
// çŠ¶æ€4: (ä¸å­˜åœ¨)
```

### çŠ¶æ€å®‰å…¨æ€§åˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŒå±‚æ£€æŸ¥æœºåˆ¶                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 1: ActiveStateTree æ£€æŸ¥ï¼ˆåŠ¨æ€ï¼Œå¿«é€Ÿï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ä½œç”¨: å¿«é€Ÿè¯†åˆ«å·² deactivate çš„ç”¨æˆ·
æ£€æŸ¥: activeStateTree.leaf(stateIdx) === 0?
æ›´æ–°: processDeactivateMessages() æˆåŠŸæ—¶æ›´æ–°ä¸ºé0

è¦†ç›–çŠ¶æ€:
  çŠ¶æ€1 (å¶æ•°+0):   âœ“ é€šè¿‡
  çŠ¶æ€2 (å¶æ•°+é0): âœ— æ‹’ç»
  çŠ¶æ€3 (å¥‡æ•°+0):   âœ“ é€šè¿‡ï¼ˆéœ€Layer2æ‹¦æˆªï¼‰
  çŠ¶æ€4 (å¥‡æ•°+é0): âœ— æ‹’ç»ï¼ˆç†è®ºä¸å­˜åœ¨ï¼‰

Layer 2: d1/d2 è§£å¯†æ£€æŸ¥ï¼ˆé™æ€ï¼Œé˜²å¾¡ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ä½œç”¨: éªŒè¯è´¦æˆ·æ•°æ®å®Œæ•´æ€§ï¼Œé˜²å¾¡å¼‚å¸¸
æ£€æŸ¥: decrypt(d1, d2) % 2 === 0?
æ›´æ–°: ä»…åœ¨ SignUp å’Œ AddNewKey æ—¶è®¾ç½®

è¦†ç›–çŠ¶æ€:
  çŠ¶æ€1 (å¶æ•°+0):   âœ“ é€šè¿‡
  çŠ¶æ€2 (å¶æ•°+é0): âœ“ é€šè¿‡ï¼ˆä½†Layer1å·²æ‹’ç»ï¼‰
  çŠ¶æ€3 (å¥‡æ•°+0):   âœ— æ‹’ç» â­ å…³é”®ä¿æŠ¤
  çŠ¶æ€4 (å¥‡æ•°+é0): âœ— æ‹’ç»

æœ€ç»ˆåˆ¤æ–­: isValid = Layer1 AND Layer2
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åªæœ‰ä¸¤å±‚éƒ½é€šè¿‡ï¼ŒæŠ•ç¥¨æ‰è¢«æ¥å—

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŠ¶æ€   â”‚ Layer1  â”‚ Layer2  â”‚ æœ€ç»ˆ    â”‚ è¯´æ˜         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ çŠ¶æ€1  â”‚ âœ“ é€šè¿‡  â”‚ âœ“ é€šè¿‡  â”‚ âœ… é€šè¿‡ â”‚ å”¯ä¸€å¯æŠ•ç¥¨   â”‚
â”‚ çŠ¶æ€2  â”‚ âœ— æ‹’ç»  â”‚ âœ“ é€šè¿‡  â”‚ âŒ æ‹’ç» â”‚ å·²æ­£å¸¸åœç”¨   â”‚
â”‚ çŠ¶æ€3  â”‚ âœ“ é€šè¿‡  â”‚ âœ— æ‹’ç»  â”‚ âŒ æ‹’ç» â”‚ å¼‚å¸¸è¢«æ•è·   â”‚
â”‚ çŠ¶æ€4  â”‚ âœ— æ‹’ç»  â”‚ âœ— æ‹’ç»  â”‚ âŒ æ‹’ç» â”‚ ç†è®ºä¸å­˜åœ¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®‰å…¨ä¿éšœ:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… é”™è¯¯æ¶ˆæ¯ä¸ä¼šç ´ååŸè´¦æˆ·
   â€¢ çŠ¶æ€1 + é”™è¯¯deactivate â†’ çŠ¶æ€1ï¼ˆä¿æŒä¸å˜ï¼‰
   â€¢ ç³»ç»Ÿè‡ªåŠ¨ä¿æŠ¤ç”¨æˆ·

âœ… å¼‚å¸¸è´¦æˆ·æ— æ³•æŠ•ç¥¨
   â€¢ çŠ¶æ€3 è™½ç„¶ AS=0ï¼Œä½†è¢« Layer2 æ‹¦æˆª
   â€¢ åŒå±‚éªŒè¯çš„é˜²å¾¡çºµæ·±

âœ… ä¸å¯èƒ½åŒæ—¶æ‹¥æœ‰ä¸¤ä¸ªå¯ç”¨è´¦æˆ·
   â€¢ æ­£ç¡®deactivate: çŠ¶æ€1â†’çŠ¶æ€2, æ–°è´¦æˆ·çŠ¶æ€1 (è€ä¸èƒ½æ–°èƒ½)
   â€¢ é”™è¯¯deactivate: ä¿æŒçŠ¶æ€1, æ–°è´¦æˆ·çŠ¶æ€3 (è€èƒ½æ–°ä¸èƒ½)
   â€¢ æ•°å­¦è¯æ˜: æœ€å¤šä¸€ä¸ªå¯ç”¨

âœ… å¥‡æ•°è´¦æˆ·æ°¸ä¹…ä¸å¯ç”¨
   â€¢ æ— æ³•æŠ•ç¥¨ï¼ˆLayer2 æ‹’ç»ï¼‰
   â€¢ æ— æ³•deactivateï¼ˆcheckDeactivateCommand æ‹’ç»ï¼‰
   â€¢ æ— æ³•åˆ›å»ºå¯ç”¨åä»£ï¼ˆå¥‡å¶æ€§ä¼ é€’ï¼‰
   â€¢ é˜²æ­¢ Sybil æ”»å‡»
```


---

## å…³é”®æ•°æ®ç»“æ„

### StateLeaf Hash è®¡ç®—

```typescript
// AMACI StateLeaf åŒå±‚ Poseidon Hash
function hashStateLeaf(leaf: StateLeaf): bigint {
  // Layer 1: åŸºæœ¬ä¿¡æ¯ (5ä¸ªå­—æ®µ)
  const layer1 = poseidon5([
    leaf.pubKey[0],
    leaf.pubKey[1],
    leaf.balance,
    leaf.voTreeRoot,
    leaf.nonce
  ]);
  
  // Layer 2: Deactivate ç›¸å…³ (5ä¸ªå­—æ®µ)
  const layer2 = poseidon5([
    leaf.d1[0],
    leaf.d1[1],
    leaf.d2[0],
    leaf.d2[1],
    leaf.xIncrement
  ]);
  
  // æœ€ç»ˆ hash: ä¸¤å±‚ hash çš„ hash
  return poseidon2([layer1, layer2]);
}
```

### InputHash è®¡ç®—

```typescript
// MACI InputHash (6ä¸ªå­—æ®µ)
function maciInputHash(...): bigint {
  return poseidon([
    packedVals,
    coordPubKeyHash,
    batchStartHash,
    batchEndHash,
    currentStateRoot,
    newStateRoot
    // åªæœ‰6ä¸ªå­—æ®µ
  ]);
}

// AMACI InputHash (7ä¸ªå­—æ®µ)
function amaciInputHash(...): bigint {
  return poseidon([
    packedVals,
    coordPubKeyHash,
    batchStartHash,
    batchEndHash,
    currentStateRoot,
    newStateRoot,
    deactivateCommitment  // â† æ–°å¢!
  ]);
}

// deactivateCommitment è®¡ç®—
function calcDeactivateCommitment(
  activeStateRoot: bigint,
  deactivateRoot: bigint
): bigint {
  return poseidon2([activeStateRoot, deactivateRoot]);
}
```

### genStaticRandomKey å’Œ newActiveState

```typescript
// ç”¨äºç”Ÿæˆç¡®å®šæ€§çš„éšæœºå¯†é’¥
function genStaticRandomKey(
  privKey: bigint,
  salt: bigint,  // å›ºå®šå€¼: 20040n
  index: bigint  // é€’å¢çš„åºåˆ—å·
): bigint {
  return poseidon([privKey, salt, index]);
}

// processDeactivateMessages ä¸­çš„å®é™…ä½¿ç”¨
const newActiveState = [];

// ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ– newActiveState ä¸ºé€’å¢çš„è®¡æ•°å™¨
for (let i = 0; i < batchSize; i++) {
  newActiveState[i] = BigInt(processedDMsgCount + i + 1);
}

// ç¬¬äºŒæ­¥ï¼šå¤„ç†æ¯ä¸ª deactivate æ¶ˆæ¯
for (let i = 0; i < batchSize; i++) {
  const cmd = commands[i];
  const error = checkDeactivateCommand(cmd, subStateTreeLength);
  
  // ä½¿ç”¨ newActiveState[i] ä½œä¸ºç´¢å¼•ç”Ÿæˆç¡®å®šæ€§éšæœºå¯†é’¥
  const randomKey = genStaticRandomKey(
    coordPrivKey,
    20040n,           // å›ºå®š salt
    newActiveState[i] // ä½¿ç”¨è®¡æ•°å™¨ä½œä¸ºç´¢å¼•
  );
  
  // ç”¨è¿™ä¸ªéšæœºå¯†é’¥ç”Ÿæˆ c1/c2 åŠ å¯†æ•°æ®
  const deactivate = encryptOdevity(
    !!error,        // æœ‰é”™è¯¯ -> å¥‡æ•°ï¼Œæ— é”™è¯¯ -> å¶æ•°
    coordPubKey,
    randomKey       // ç¡®å®šæ€§çš„éšæœºå¯†é’¥
  );
  
  if (!error) {
    // æ­£ç¡®çš„æ¶ˆæ¯ï¼šæ›´æ–° ActiveStateTreeï¼ˆæ ‡è®°ä¸º inactiveï¼‰
    activeStateTree.updateLeaf(stateIdx, newActiveState[i]);
    deactivateTree.updateLeaf(deactivateIndex + i, poseidon(dLeaf));
  } else {
    // é”™è¯¯çš„æ¶ˆæ¯ï¼šä¸æ›´æ–° ActiveStateTreeï¼ˆä¿æŠ¤åŸè´¦æˆ·ï¼‰
    // åªå­˜å…¥å¥‡æ•°çš„ c1c2 åˆ° DeactivateTree
    deactivateTree.updateLeaf(deactivateIndex + i, poseidon(dLeaf));
  }
}
```

**å…³é”®ç‚¹**ï¼š
- `newActiveState[i]` æ˜¯**é€’å¢çš„è®¡æ•°å™¨**ï¼Œä¸æ˜¯ hash ç»“æœ
- å®ƒæœ‰ä¸¤ä¸ªä½œç”¨ï¼š
  1. ä½œä¸º ActiveStateTree çš„æ–°å€¼ï¼ˆéé›¶ï¼Œè¡¨ç¤º inactiveï¼‰
  2. ä½œä¸º `genStaticRandomKey` çš„ç´¢å¼•å‚æ•°ï¼ˆç¡®ä¿æ¯æ¬¡ç”Ÿæˆä¸åŒçš„éšæœºå¯†é’¥ï¼‰

### âš ï¸ å¸¸è§è¯¯è§£ vs æ­£ç¡®ç†è§£

```
âŒ é”™è¯¯ç†è§£ï¼ˆä¹‹å‰æ–‡æ¡£çš„æè¿°ï¼‰:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
newActiveState[i] = poseidon([randomKey, oldData])

é—®é¢˜:
  - newActiveState ä¸æ˜¯ hash çš„ç»“æœ
  - è¿™æ ·ä¼šå¯¼è‡´å¾ªç¯ä¾èµ–ï¼ˆrandomKey ä¾èµ– newActiveStateï¼‰
  - æ— æ³•ç”Ÿæˆç¡®å®šæ€§çš„éšæœºå¯†é’¥

âœ“ æ­£ç¡®ç†è§£ï¼ˆå®é™…ä»£ç å®ç°ï¼‰:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ­¥éª¤ 1: åˆå§‹åŒ–ä¸ºé€’å¢è®¡æ•°å™¨
newActiveState[i] = BigInt(processedDMsgCount + i + 1)

// æ­¥éª¤ 2: ä½¿ç”¨è®¡æ•°å™¨ä½œä¸ºç´¢å¼•ç”Ÿæˆéšæœºå¯†é’¥
randomKey = genStaticRandomKey(coordPrivKey, 20040, newActiveState[i])

// æ­¥éª¤ 3: ä½¿ç”¨éšæœºå¯†é’¥åŠ å¯†
deactivate = encryptOdevity(!!error, coordPubKey, randomKey)

æ•°æ®æµ:
  processedDMsgCount â†’ newActiveState â†’ randomKey â†’ deactivate
         â”‚                                              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€ é€’å¢è®¡æ•° â”€â”€â”€â”€â”€â”€â”                    â”‚
                                  â”‚                    â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
         â–¼                                              â–¼
  ActiveStateTree[stateIdx] = newActiveState[i]   DeactivateTree
  (æ ‡è®°ä¸º inactive)                              (å­˜å‚¨ c1/c2)

ä¼˜åŠ¿:
  âœ“ ç®€å•æ˜äº†çš„é€’å¢è®¡æ•°å™¨
  âœ“ ç¡®ä¿æ¯ä¸ªæ¶ˆæ¯ä½¿ç”¨ä¸åŒçš„éšæœºå¯†é’¥
  âœ“ ä¾¿äºè·Ÿè¸ªå¤„ç†è¿›åº¦
  âœ“ æä¾›ç¡®å®šæ€§çš„éšæœºæ•°ç”Ÿæˆ
```

### processDeactivateMessages å®Œæ•´æµç¨‹å›¾

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              processDeactivateMessages å®Œæ•´æµç¨‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è¾“å…¥:
  - messages: deactivate æ¶ˆæ¯æ‰¹æ¬¡
  - batchSize: æ‰¹æ¬¡å¤§å° (å¦‚ 5)
  - processedDMsgCount: å·²å¤„ç†çš„æ¶ˆæ¯æ•° (å¦‚ 100)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 1: åˆå§‹åŒ– newActiveState è®¡æ•°å™¨                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
for (let i = 0; i < batchSize; i++) {
  newActiveState[i] = processedDMsgCount + i + 1;
}
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ newActiveState = [101, 102, 103, 104, 105]             â”‚
â”‚                   â†‘    â†‘    â†‘    â†‘    â†‘                â”‚
â”‚                   é€’å¢çš„è®¡æ•°å™¨åºåˆ—                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 2: å¤„ç†æ¯ä¸ªæ¶ˆæ¯ (å¾ªç¯ batchSize æ¬¡)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
for (let i = 0; i < batchSize; i++) {

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ­¥éª¤ 2.1: éªŒè¯æ¶ˆæ¯                                   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  error = checkDeactivateCommand(commands[i]);
  // æ£€æŸ¥: ç­¾åã€ç´¢å¼•ã€æ˜¯å¦å·² deactivate ç­‰
  
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ­¥éª¤ 2.2: ç”Ÿæˆç¡®å®šæ€§éšæœºå¯†é’¥                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  randomKey = genStaticRandomKey(
    coordPrivKey,
    20040n,
    newActiveState[i]  â† ä½¿ç”¨è®¡æ•°å™¨ä½œä¸ºç´¢å¼•
  );
  // randomKey = poseidon([coordPrivKey, 20040n, newActiveState[i]])
  
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ­¥éª¤ 2.3: åŠ å¯† deactivate æ ‡å¿—                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  deactivate = encryptOdevity(
    !!error,      â† æœ‰é”™è¯¯: true (å¥‡æ•°), æ— é”™è¯¯: false (å¶æ•°)
    coordPubKey,
    randomKey
  );
  
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ­¥éª¤ 2.4: æ ¹æ®éªŒè¯ç»“æœæ›´æ–°æ ‘                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  if (!error) {
    // æ­£ç¡®æ¶ˆæ¯ â†’ æ›´æ–°ä¸¤æ£µæ ‘
    activeStateTree.updateLeaf(stateIdx, newActiveState[i]);
    deactivateTree.updateLeaf(deactivateIndex + i, hash(dLeaf));
  } else {
    // é”™è¯¯æ¶ˆæ¯ â†’ åªæ›´æ–° DeactivateTree
    deactivateTree.updateLeaf(deactivateIndex + i, hash(dLeaf));
  }
}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 3: è¾“å‡ºç»“æœ                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
è¿”å›:
  - newDeactivateRoot: æ–°çš„ DeactivateTree æ ¹
  - newActiveStateRoot: æ–°çš„ ActiveStateTree æ ¹
  - deactivateCommitment: poseidon([activeRoot, deactivateRoot])
  - proof: ZK proof
```

### æ•°æ®æµå›¾ç¤ºï¼ˆå¸¦å…·ä½“ç¤ºä¾‹ï¼‰

```
processDeactivateMessages æ•°æ®æµ:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è¾“å…¥: deactivate æ¶ˆæ¯æ‰¹æ¬¡ (batchSize = 5)
processedDMsgCount = 100

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: åˆå§‹åŒ– newActiveState                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
newActiveState[0] = 100 + 0 + 1 = 101
newActiveState[1] = 100 + 1 + 1 = 102
newActiveState[2] = 100 + 2 + 1 = 103
newActiveState[3] = 100 + 3 + 1 = 104
newActiveState[4] = 100 + 4 + 1 = 105

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: å¤„ç†æ¶ˆæ¯ i=0 (å‡è®¾ç­¾åæ­£ç¡®)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
stateIdx = 5  // ç”¨æˆ·åœ¨ StateTree ä¸­çš„ä½ç½®
error = null  // ç­¾åéªŒè¯é€šè¿‡

randomKey = genStaticRandomKey(coordPrivKey, 20040, 101)
          = poseidon([coordPrivKey, 20040n, 101n])
          = 12345678901234567890n  // ç¤ºä¾‹å€¼

deactivate = encryptOdevity(false, coordPubKey, randomKey)
           = {
               c1: [c1x, c1y],  // å¶æ•°ç‚¹
               c2: [c2x, c2y],  // å¶æ•°ç‚¹
               xIncrement: randomKey
             }

dLeaf = [c1x, c1y, c2x, c2y, poseidon(sharedKey)]

æ›´æ–°æ ‘:
  activeStateTree[5] = 101  â† æ ‡è®°ä¸º inactive
  deactivateTree[0] = poseidon(dLeaf)  â† å­˜å…¥å¶æ•° c1/c2

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: å¤„ç†æ¶ˆæ¯ i=1 (å‡è®¾ç­¾åé”™è¯¯)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
stateIdx = 5^2 - 1 = 24  // é”™è¯¯æ—¶ä½¿ç”¨æœ€å¤§ç´¢å¼•
error = 'signature error'

randomKey = genStaticRandomKey(coordPrivKey, 20040, 102)
          = poseidon([coordPrivKey, 20040n, 102n])
          = 98765432109876543210n  // ç¤ºä¾‹å€¼

deactivate = encryptOdevity(true, coordPubKey, randomKey)
           = {
               c1: [c1x, c1y],  // å¥‡æ•°ç‚¹
               c2: [c2x, c2y],  // å¥‡æ•°ç‚¹
               xIncrement: randomKey
             }

dLeaf = [c1x, c1y, c2x, c2y, poseidon(sharedKey)]

æ›´æ–°æ ‘:
  activeStateTree[?] = ä¸æ›´æ–°  â† ä¿æŠ¤åŸè´¦æˆ·
  deactivateTree[1] = poseidon(dLeaf)  â† å­˜å…¥å¥‡æ•° c1/c2ï¼ˆä¸å¯ç”¨ï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»“æœ: DeactivateTree çŠ¶æ€                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
DeactivateTree:
  [0]: hash(å¶æ•° c1c2) â† å¯ç”¨äº AddNewKey é‡éšæœºåŒ–ä¸º d1/d2 âœ“
  [1]: hash(å¥‡æ•° c1c2) â† ä¸å¯ç”¨ï¼ˆé‡éšæœºåŒ–åä»æ˜¯å¥‡æ•° d1/d2ï¼‰âœ—
  [2]: hash(...)
  [3]: hash(...)
  [4]: hash(...)
```

---

## å®‰å…¨æœºåˆ¶

### 1. Nullifier é˜²é‡æ”¾

```
ç›®çš„: é˜²æ­¢ç”¨æˆ·å¤šæ¬¡ä½¿ç”¨åŒä¸€ä¸ª deactivate data è¿›è¡Œ AddNewKey

æœºåˆ¶:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Nullifier = Poseidon([privKey, NULLIFIER_SALT])    â”‚
â”‚                                                    â”‚
â”‚ NULLIFIER_SALT = 1444992409218394441042n          â”‚
â”‚                  (å›ºå®šçš„é­”æ•°)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å­˜å‚¨: åˆçº¦ç»´æŠ¤ä¸€ä¸ª NULLIFIERS map
  NULLIFIERS: Map<Nullifier, bool>

AddNewKey æµç¨‹:
  1. è®¡ç®— nullifier = Poseidon([oldPrivKey, SALT])
  2. æ£€æŸ¥ NULLIFIERS[nullifier] æ˜¯å¦å­˜åœ¨
  3. å¦‚æœå­˜åœ¨ â†’ æ‹’ç» (NewKeyExist é”™è¯¯)
  4. å¦‚æœä¸å­˜åœ¨ â†’ è®°å½• nullifier, ç»§ç»­

å®‰å…¨æ€§:
  âœ“ åŒä¸€ä¸ª privKey åªèƒ½ç”Ÿæˆç›¸åŒçš„ nullifier
  âœ“ ä¸åŒ privKey ç”Ÿæˆä¸åŒçš„ nullifier  
  âœ“ æ— æ³•ä» nullifier åæ¨ privKey (å•å‘æ€§)
  âœ“ å³ä½¿ deactivate data è¢«å…¬å¼€ï¼Œä¹Ÿæ— æ³•é‡ç”¨
```

### 2. ECDH ç»‘å®š

```
ç›®çš„: ç¡®ä¿ deactivate data åªèƒ½è¢«åŸå§‹ç”¨æˆ·ä½¿ç”¨

æœºåˆ¶:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sharedKey = Poseidon([                             â”‚
â”‚   ECDH(oldPrivKey, coordPubKey).x                  â”‚
â”‚ ])                                                 â”‚
â”‚                                                    â”‚
â”‚ åœ¨ AddNewKey proof ä¸­éªŒè¯:                         â”‚
â”‚   æäº¤çš„ sharedKey å¿…é¡»æ­£ç¡®                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AddNewKey ç”µè·¯éªŒè¯:
  signal sharedKey_computed = ECDH(oldPrivKey, coordPubKey);
  sharedKey_computed === sharedKey_input;

å®‰å…¨æ€§:
  âœ“ åªæœ‰çŸ¥é“ oldPrivKey çš„ç”¨æˆ·æ‰èƒ½è®¡ç®—æ­£ç¡®çš„ sharedKey
  âœ“ æ”»å‡»è€…æ— æ³•ä½¿ç”¨åˆ«äººçš„ deactivate data
  âœ“ å³ä½¿ deactivateLeaf æ˜¯å…¬å¼€çš„
```

### 3. åŒå±‚éªŒè¯

```
ä¸ºä»€ä¹ˆéœ€è¦ä¸¤å±‚éªŒè¯ï¼Ÿ

åœºæ™¯1: é˜²æ­¢ Operator ç¯¡æ”¹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ”»å‡»: Operator æ¶æ„ä¿®æ”¹ ActiveStateTree
      è®©å·² deactivate çš„ç”¨æˆ·çœ‹èµ·æ¥æ˜¯ active

é˜²å¾¡: StateLeafTransformer æ£€æŸ¥ d1/d2
      decrypt(d1, d2) % 2 === 0 âœ“
      
      å³ä½¿ ActiveStateTree è¢«ç¯¡æ”¹ï¼Œ
      d1/d2 æ£€æŸ¥ä¹Ÿä¼šå¤±è´¥!

åœºæ™¯2: é˜²æ­¢æ•°æ®æŸå
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
é—®é¢˜: é“¾ä¸ŠåŒæ­¥æ•°æ®æ—¶ï¼Œd1/d2 å¯èƒ½è¢«é”™è¯¯è®¾ç½®ä¸ºå¥‡æ•°

é˜²å¾¡: å³ä½¿ ActiveStateTree æ˜¾ç¤º active (0)
      d1/d2 æ£€æŸ¥ä¼šæ•è·åˆ°å¥‡æ•°å€¼å¹¶æ‹’ç»

åœºæ™¯3: é˜²å¾¡çºµæ·±
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ActiveStateTree  â†’  ä¸»è¦é˜²çº¿ (åŠ¨æ€ï¼Œå¿«é€Ÿ)
d1/d2 Check      â†’  å¤‡ç”¨é˜²çº¿ (é™æ€ï¼Œé˜²å¾¡)

ä¸¤å±‚éƒ½å¿…é¡»é€šè¿‡ï¼Œæ‰èƒ½æŠ•ç¥¨!
```

### 4. Circuit çº¦æŸ

```
ProcessMessages ç”µè·¯çº¦æŸ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ¶ˆæ¯é“¾å®Œæ•´æ€§                              â”‚
â”‚    âœ“ batchStartHash â†’ ... â†’ batchEndHash    â”‚
â”‚                                              â”‚
â”‚ 2. çŠ¶æ€æ ‘ä¸€è‡´æ€§                              â”‚
â”‚    âœ“ currentStateRoot åŒ¹é…                   â”‚
â”‚    âœ“ newStateRoot æ­£ç¡®è®¡ç®—                   â”‚
â”‚                                              â”‚
â”‚ 3. ActiveStateTree éªŒè¯                      â”‚
â”‚    âœ“ activeStateLeaf åœ¨ activeStateRoot ä¸­  â”‚
â”‚    âœ“ Merkle proof æœ‰æ•ˆ                       â”‚
â”‚    âœ“ activeStateLeaf === 0 (active)         â”‚
â”‚                                              â”‚
â”‚ 4. StateLeaf d1/d2 éªŒè¯                      â”‚
â”‚    âœ“ decrypt(d1, d2, xIncrement)            â”‚
â”‚    âœ“ result % 2 === 0 (å¶æ•°)                â”‚
â”‚                                              â”‚
â”‚ 5. DeactivateCommitment                      â”‚
â”‚    âœ“ commitment = hash(activeRoot, deactRoot)â”‚
â”‚    âœ“ åŒ…å«åœ¨ InputHash ä¸­                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AddNewKey ç”µè·¯çº¦æŸ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Nullifier çº¦æŸ                            â”‚
â”‚    âœ“ nullifier = Poseidon([privKey, SALT])  â”‚
â”‚    âœ“ (åˆçº¦å±‚æ£€æŸ¥æœªä½¿ç”¨è¿‡)                    â”‚
â”‚                                              â”‚
â”‚ 2. DeactivateLeaf (c1/c2) å­˜åœ¨æ€§             â”‚
â”‚    âœ“ c1/c2 åœ¨ DeactivateTree ä¸­              â”‚
â”‚    âœ“ Merkle proof æœ‰æ•ˆ                       â”‚
â”‚                                              â”‚
â”‚ 3. ECDH ç»‘å®š                                 â”‚
â”‚    âœ“ sharedKey = ECDH(oldPrivKey, coordPub)  â”‚
â”‚                                              â”‚
â”‚ 4. é‡éšæœºåŒ–æ­£ç¡®æ€§                            â”‚
â”‚    âœ“ d1/d2 = rerandomize(coordPubKey,        â”‚
â”‚              {c1, c2}, randomVal)            â”‚
â”‚    âœ“ é‡éšæœºåŒ–è®¡ç®—æ­£ç¡®                        â”‚
â”‚                                              â”‚
â”‚ 5. æ³¨æ„: ä¸éªŒè¯ d1/d2 å¥‡å¶æ€§!                â”‚
â”‚    (åœ¨ ProcessMessages ä¸­éªŒè¯)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. é”™è¯¯æ¶ˆæ¯å¤„ç†çš„å®‰å…¨æ€§

```
ç›®çš„: ç¡®ä¿é”™è¯¯çš„ deactivate æ¶ˆæ¯ä¸ä¼šç ´åç³»ç»Ÿå®Œæ•´æ€§
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

processDeactivateMessages çš„å®¹é”™è®¾è®¡:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ // æ­¥éª¤ 1: åˆå§‹åŒ– newActiveState è®¡æ•°å™¨            â”‚
â”‚ for (let i = 0; i < batchSize; i++) {              â”‚
â”‚   newActiveState[i] = processedDMsgCount + i + 1; â”‚
â”‚ }                                                  â”‚
â”‚                                                    â”‚
â”‚ // æ­¥éª¤ 2: å¤„ç†æ¯ä¸ª deactivate æ¶ˆæ¯                â”‚
â”‚ for (let i = 0; i < batchSize; i++) {              â”‚
â”‚   const cmd = commands[i];                         â”‚
â”‚   const error = checkDeactivateCommand(cmd);       â”‚
â”‚                                                    â”‚
â”‚   // ç”Ÿæˆç¡®å®šæ€§éšæœºå¯†é’¥                            â”‚
â”‚   const randomKey = genStaticRandomKey(           â”‚
â”‚     coordPrivKey,                                  â”‚
â”‚     20040n,                                        â”‚
â”‚     newActiveState[i]  // ä½¿ç”¨è®¡æ•°å™¨ä½œä¸ºç´¢å¼•      â”‚
â”‚   );                                               â”‚
â”‚                                                    â”‚
â”‚   if (!error) {                                    â”‚
â”‚     // æ­£ç¡®çš„æ¶ˆæ¯: ç”Ÿæˆå¶æ•° c1c2                   â”‚
â”‚     const deactivate = encryptOdevity(            â”‚
â”‚       false,  // å¶æ•° â†’ active                    â”‚
â”‚       coordPubKey,                                 â”‚
â”‚       randomKey                                    â”‚
â”‚     );                                             â”‚
â”‚                                                    â”‚
â”‚     // æ›´æ–° ActiveStateTree (æ ‡è®°ä¸º inactive)      â”‚
â”‚     activeStateTree.updateLeaf(                   â”‚
â”‚       stateIdx,                                    â”‚
â”‚       newActiveState[i]  // ä½¿ç”¨è®¡æ•°å™¨å€¼          â”‚
â”‚     );                                             â”‚
â”‚     deactivateTree.updateLeaf(idx, hash(dLeaf));  â”‚
â”‚   } else {                                         â”‚
â”‚     // é”™è¯¯çš„æ¶ˆæ¯: ç”Ÿæˆå¥‡æ•° c1c2                   â”‚
â”‚     const deactivate = encryptOdevity(            â”‚
â”‚       true,   // å¥‡æ•° â†’ deactivated               â”‚
â”‚       coordPubKey,                                 â”‚
â”‚       randomKey  // ç›¸åŒçš„ç¡®å®šæ€§éšæœºå¯†é’¥          â”‚
â”‚     );                                             â”‚
â”‚                                                    â”‚
â”‚     // ä¸æ›´æ–° ActiveStateTree (ä¿æŠ¤åŸè´¦æˆ·)        â”‚
â”‚     // åªæ›´æ–° DeactivateTree (å­˜å…¥å¥‡æ•°æ ‡è®°)       â”‚
â”‚     if (messages[i].ciphertext[0] !== 0n) {       â”‚
â”‚       deactivateTree.updateLeaf(idx, hash(dLeaf));â”‚
â”‚     }                                              â”‚
â”‚   }                                                â”‚
â”‚ }                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

checkDeactivateCommand çš„æ£€æŸ¥å±‚çº§:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç©ºå‘½ä»¤æ£€æŸ¥                                      â”‚
â”‚    if (!cmd) return 'empty command';              â”‚
â”‚                                                    â”‚
â”‚ 2. ç´¢å¼•æº¢å‡ºæ£€æŸ¥                                    â”‚
â”‚    if (cmd.stateIdx >= subStateTreeLength)        â”‚
â”‚      return 'state leaf index overflow';          â”‚
â”‚                                                    â”‚
â”‚ 3. å·² deactivate æ£€æŸ¥ï¼ˆå…³é”®ï¼ï¼‰                   â”‚
â”‚    const deactivate = decrypt(coordPrivKey, {     â”‚
â”‚      c1: { x: s.d1[0], y: s.d1[1] },             â”‚
â”‚      c2: { x: s.d2[0], y: s.d2[1] }              â”‚
â”‚    });                                            â”‚
â”‚    if (deactivate % 2n === 1n)                    â”‚
â”‚      return 'deactivated';  // â† é˜²æ­¢é‡å¤ deact  â”‚
â”‚                                                    â”‚
â”‚ 4. ç­¾åéªŒè¯                                        â”‚
â”‚    const verified = verifySignature(...);         â”‚
â”‚    if (!verified) return 'signature error';       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®‰å…¨ä¿éšœæœºåˆ¶:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ä¿éšœ 1: åŸè´¦æˆ·ä¸å—å½±å“
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åœºæ™¯: ç”¨æˆ·å‘é€ç­¾åé”™è¯¯çš„ deactivate æ¶ˆæ¯

ç»“æœ:
  âœ… ActiveStateTree ä¸å˜ (ä»ä¸º 0/active)
  âœ… StateTree.d1/d2 ä¸å˜ (ä»ä¸ºå¶æ•°/active)
  âœ… ç”¨æˆ·å¯ä»¥ç»§ç»­ä½¿ç”¨åŸè´¦æˆ·æŠ•ç¥¨
  âŒ DeactivateTree å­˜å…¥å¥‡æ•° c1c2 (æ— æ³•ç”¨äº AddNewKey)

é˜²æ­¢: æ¶æ„/é”™è¯¯æ¶ˆæ¯ç ´åç°æœ‰è´¦æˆ·

ä¿éšœ 2: é˜²æ­¢åˆ›å»ºå¤šä¸ªå¯ç”¨è´¦æˆ·
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åœºæ™¯: ç”¨æˆ·å°è¯•ç”¨é”™è¯¯æ¶ˆæ¯çš„å¥‡æ•° c1c2 è¿›è¡Œ AddNewKey

æµç¨‹:
  1. AddNewKey æˆåŠŸåˆ›å»ºæ–°è´¦æˆ·
     - ActiveStateTree[new] = 0 (active) âœ…
     - d1/d2 = å¥‡æ•° (deactivated) âŒ
     
  2. æ–°è´¦æˆ·å°è¯•æŠ•ç¥¨æ—¶è¢«æ‹’ç»
     - æ£€æŸ¥ 1: ActiveStateTree[new] === 0 â†’ é€šè¿‡ âœ…
     - æ£€æŸ¥ 2: decrypt(d1,d2) % 2 === 0 â†’ å¤±è´¥ âŒ
     
  3. æ–°è´¦æˆ·å°è¯•å†æ¬¡ deactivate è¢«æ‹’ç»
     - checkDeactivateCommand æ£€æµ‹åˆ° d1/d2 æ˜¯å¥‡æ•°
     - è¿”å› 'deactivated' é”™è¯¯
     - åˆç”Ÿæˆå¥‡æ•° c1c2 (æ— é™å¾ªç¯)

ç»“æœ:
  âœ… åªæœ‰åŸè´¦æˆ·å¯ç”¨
  âŒ æ–°è´¦æˆ·æ— æ³•æŠ•ç¥¨
  âŒ æ— æ³•é€šè¿‡æ–°è´¦æˆ·å†åˆ›å»ºå¯ç”¨è´¦æˆ·

é˜²æ­¢: Sybil æ”»å‡»ï¼ˆä¸€äººå¤šç¥¨ï¼‰

ä¿éšœ 3: å¥‡å¶æ€§ä¼ é€’é“¾
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å¥‡æ•° d1/d2 è´¦æˆ·çš„ä¼ æ’­é“¾:

  é”™è¯¯æ¶ˆæ¯ â†’ å¥‡æ•° c1c2 â†’ DeactivateTree
       â†“
  AddNewKey (rerandomize ä¿æŒå¥‡å¶æ€§)
       â†“
  æ–°è´¦æˆ·: d1/d2 = å¥‡æ•°
       â†“
  å°è¯• deactivate â†’ checkDeactivateCommand æ£€æµ‹åˆ°å¥‡æ•°
       â†“
  è¿”å› 'deactivated' é”™è¯¯ â†’ åˆç”Ÿæˆå¥‡æ•° c1c2
       â†“
  AddNewKey (rerandomize) â†’ åˆæ˜¯å¥‡æ•° d1/d2
       â†“
  (æ— é™å¾ªç¯ï¼Œæ— æ³•é€ƒè„±)

ç‰¹æ€§:
  âœ… rerandomize ä¿æŒå¥‡å¶æ€§ä¸å˜
  âœ… ä¸€æ—¦æ˜¯å¥‡æ•°ï¼Œæ°¸è¿œæ˜¯å¥‡æ•°
  âœ… æ— æ³•é€šè¿‡ä»»ä½•æ–¹å¼åˆ›å»ºå¯ç”¨çš„åç»­è´¦æˆ·

é˜²æ­¢: é€šè¿‡é”™è¯¯æ•°æ®ç»•è¿‡å®‰å…¨æ£€æŸ¥

çŠ¶æ€è½¬æ¢è¡¨:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¶ˆæ¯ç±»å‹   â”‚ActiveTreeâ”‚ d1/d2   â”‚èƒ½æŠ•ç¥¨   â”‚èƒ½ Deactivate â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚æ­£ç¡® deact  â”‚é0(âœ—)    â”‚å¶æ•°(âœ“)  â”‚ä¸èƒ½(âœ—) â”‚èƒ½(âœ“)        â”‚
â”‚é”™è¯¯ deact  â”‚0(âœ“)      â”‚å¶æ•°(âœ“)  â”‚èƒ½(âœ“)   â”‚èƒ½(âœ“)        â”‚
â”‚AddNewKey(æ­£)â”‚0(âœ“)      â”‚å¶æ•°(âœ“)  â”‚èƒ½(âœ“)   â”‚èƒ½(âœ“)        â”‚
â”‚AddNewKey(é”™)â”‚0(âœ“)      â”‚å¥‡æ•°(âœ—)  â”‚ä¸èƒ½(âœ—) â”‚ä¸èƒ½(âœ—)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®‰å…¨æ€§è¯æ˜:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å®šç† 1: é”™è¯¯æ¶ˆæ¯ä¸ä¼šç ´ååŸè´¦æˆ·
  è¯æ˜: å½“ error å­˜åœ¨æ—¶ï¼ŒprocessDeactivateMessages ä¸æ›´æ–°
       ActiveStateTreeï¼ŒåŸè´¦æˆ·çš„æ‰€æœ‰çŠ¶æ€ä¿æŒä¸å˜ã€‚
       âˆ´ åŸè´¦æˆ·ä»å¯æ­£å¸¸ä½¿ç”¨ âœ“

å®šç† 2: ä¸å¯èƒ½åŒæ—¶æ‹¥æœ‰ä¸¤ä¸ªå¯ç”¨è´¦æˆ·
  è¯æ˜: 
    æƒ…å†µ A: deactivate æˆåŠŸ
      â†’ old: ActiveTree = é0, d1/d2 = å¶æ•° â†’ ä¸èƒ½æŠ•ç¥¨
      â†’ new: ActiveTree = 0, d1/d2 = å¶æ•° â†’ èƒ½æŠ•ç¥¨
      â†’ ç»“æœ: åªæœ‰ new å¯ç”¨ âœ“
      
    æƒ…å†µ B: deactivate å¤±è´¥
      â†’ old: ActiveTree = 0, d1/d2 = å¶æ•° â†’ èƒ½æŠ•ç¥¨
      â†’ new: ActiveTree = 0, d1/d2 = å¥‡æ•° â†’ ä¸èƒ½æŠ•ç¥¨
      â†’ ç»“æœ: åªæœ‰ old å¯ç”¨ âœ“
      
    âˆ´ ä»»ä½•æƒ…å†µä¸‹æœ€å¤šåªæœ‰ä¸€ä¸ªå¯ç”¨è´¦æˆ· âœ“

å®šç† 3: å¥‡æ•° d1/d2 è´¦æˆ·ä¸å¯ä¿®å¤
  è¯æ˜: 
    è®¾è´¦æˆ· A çš„ d1/d2 = å¥‡æ•°
    
    1. A ä¸èƒ½æŠ•ç¥¨ (d1/d2 æ£€æŸ¥å¤±è´¥)
    2. A ä¸èƒ½ deactivate (checkDeactivateCommand æ£€æµ‹åˆ°å¥‡æ•°)
    3. å³ä½¿ A å¼ºè¡Œ deactivateï¼Œç”Ÿæˆçš„ c1c2 ä»æ˜¯å¥‡æ•°
    4. ç”¨è¿™ä¸ªå¥‡æ•° c1c2 çš„ AddNewKey åˆ›å»ºçš„è´¦æˆ· B
       B çš„ d1/d2 ä¹Ÿæ˜¯å¥‡æ•° (rerandomize ä¿æŒå¥‡å¶æ€§)
    5. B é‡å¤ A çš„çŠ¶æ€ (æ­¥éª¤ 1-4)
    
    âˆ´ å¥‡æ•° d1/d2 è´¦æˆ·åŠå…¶æ‰€æœ‰åä»£éƒ½ä¸å¯ç”¨ âœ“
```

---

## ä»£ç ç¤ºä¾‹

### å®Œæ•´çš„ Deactivate â†’ AddNewKey æµç¨‹

```typescript
import { 
  OperatorClient, 
  VoterClient,
  encryptOdevity,
  decrypt,
  genKeypair
} from '@dorafactory/maci-sdk';

// ============================================
// ç¬¬ä¸€æ­¥: åˆå§‹åŒ–
// ============================================
const operator = new OperatorClient({
  network: 'testnet',
  secretKey: 123456n
});

operator.initMaci({
  stateTreeDepth: 2,
  intStateTreeDepth: 1,
  voteOptionTreeDepth: 2,
  batchSize: 5,
  maxVoteOptions: 5,
  numSignUps: 10,
  isQuadraticCost: true,
  isAmaci: true  // â† AMACI æ¨¡å¼
});

// ============================================
// ç¬¬äºŒæ­¥: ç”¨æˆ·æ³¨å†Œ
// ============================================
const voter = new VoterClient({ 
  network: 'testnet', 
  secretKey: 999n 
});

operator.initStateTree(
  0,  // stateIdx
  voter.getPubkey().toPoints(),
  100  // initial balance
);

// æ­¤æ—¶:
// - ActiveStateTree[0] = 0 (active)
// - StateLeaf.d1 = [0, 0] (active)
// - StateLeaf.d2 = [0, 0] (active)

// ============================================
// ç¬¬ä¸‰æ­¥: æŠ•ç¥¨
// ============================================
const coordPubKey = operator.getPubkey().toPoints();

const votePayload = voter.buildVotePayload({
  stateIdx: 0,
  operatorPubkey: coordPubKey,
  selectedOptions: [{ idx: 0, vc: 10 }]
});

votePayload.forEach((p) => {
  const message = p.msg.map((m) => BigInt(m));
  const encPubKey = p.encPubkeys.map((k) => BigInt(k)) as [bigint, bigint];
  operator.pushMessage(message, encPubKey);
});

operator.endVotePeriod();
await operator.processMessages();

console.log('âœ… æŠ•ç¥¨æˆåŠŸ');

// ============================================
// ç¬¬å››æ­¥: Deactivate
// ============================================
const deactivatePayload = voter.buildVotePayload({
  stateIdx: 0,
  operatorPubkey: coordPubKey,
  selectedOptions: [{ idx: 0, vc: 0 }]  // â† vc=0 è¡¨ç¤º deactivate
});

deactivatePayload.forEach((p) => {
  const message = p.msg.map((m) => BigInt(m));
  const encPubKey = p.encPubkeys.map((k) => BigInt(k)) as [bigint, bigint];
  operator.pushDeactivateMessage(message, encPubKey);
});

await operator.processDeactivateMessages({
  inputSize: 1,
  subStateTreeLength: 5 ** 2  // 5^stateTreeDepth
});

// æ­¤æ—¶:
// - ActiveStateTree[0] â‰  0 (inactive)
// - DeactivateTree[0] = hash(é‡éšæœºåŒ–çš„æ•°æ®)
// - StateLeaf.d1/d2 ä¸å˜

console.log('âœ… Deactivate å®Œæˆ');
console.log('ActiveStateTree[0]:', operator.activeStateTree!.leaf(0));

// ============================================
// ç¬¬äº”æ­¥: AddNewKey (æ¨¡æ‹Ÿ)
// ============================================
// åœ¨çœŸå®åœºæ™¯ä¸­ï¼Œç”¨æˆ·ä¼š:
// 1. ç”Ÿæˆæ–°å¯†é’¥å¯¹
// 2. ä» DeactivateTree è·å–æ•°æ®
// 3. ç”Ÿæˆ ZK proof
// 4. æäº¤åˆ°åˆçº¦

const newKeypair = genKeypair();
const coordPrivKey = operator.getSigner().getFormatedPrivKey();

// ç”Ÿæˆå¶æ•°åŠ å¯†æ•°æ® (active)
const newAccountData = encryptOdevity(
  false,  // false = å¶æ•° = active
  coordPubKey,
  123456n  // random salt
);

// åˆ›å»ºæ–°è´¦æˆ·
operator.initStateTree(
  3,  // æ–°çš„ stateIdx
  [newKeypair.pubKey[0], newKeypair.pubKey[1]],
  100,  // ç»§æ‰¿ä½™é¢
  [
    newAccountData.c1.x,
    newAccountData.c1.y,
    newAccountData.c2.x,
    newAccountData.c2.y
  ]
);

// æ­¤æ—¶:
// - ActiveStateTree[3] = 0 (active)
// - StateLeaf[3].d1/d2 = ç»§æ‰¿çš„æ•°æ® (å¶æ•°)

console.log('âœ… AddNewKey å®Œæˆ');
console.log('ActiveStateTree[3]:', operator.activeStateTree!.leaf(3));

// éªŒè¯æ–°è´¦æˆ·çš„ d1/d2 æ˜¯å¶æ•°
const newStateLeaf = operator.stateLeaves.get(3)!;
const decrypted = decrypt(coordPrivKey, {
  c1: { x: newStateLeaf.d1[0], y: newStateLeaf.d1[1] },
  c2: { x: newStateLeaf.d2[0], y: newStateLeaf.d2[1] },
  xIncrement: 0n
});

console.log('d1/d2 è§£å¯†ç»“æœ:', decrypted.toString());
console.log('æ˜¯å¦å¶æ•°:', decrypted % 2n === 0n);

// ============================================
// ç¬¬å…­æ­¥: ä½¿ç”¨æ–°å¯†é’¥æŠ•ç¥¨
// ============================================
const newVoter = new VoterClient({ 
  network: 'testnet', 
  secretKey: newKeypair.privKey 
});

const newVotePayload = newVoter.buildVotePayload({
  stateIdx: 3,  // æ–°è´¦æˆ·çš„ index
  operatorPubkey: coordPubKey,
  selectedOptions: [{ idx: 1, vc: 15 }]
});

newVotePayload.forEach((p) => {
  const message = p.msg.map((m) => BigInt(m));
  const encPubKey = p.encPubkeys.map((k) => BigInt(k)) as [bigint, bigint];
  operator.pushMessage(message, encPubKey);
});

operator.endVotePeriod();
await operator.processMessages();

console.log('âœ… ä½¿ç”¨æ–°å¯†é’¥æŠ•ç¥¨æˆåŠŸ');

// ============================================
// éªŒè¯æœ€ç»ˆçŠ¶æ€
// ============================================
console.log('\næœ€ç»ˆçŠ¶æ€:');
console.log('æ—§è´¦æˆ· (idx=0):');
console.log('  - ActiveStateTree:', operator.activeStateTree!.leaf(0));
console.log('  - çŠ¶æ€: Inactive âœ—');
console.log('æ–°è´¦æˆ· (idx=3):');
console.log('  - ActiveStateTree:', operator.activeStateTree!.leaf(3));
console.log('  - çŠ¶æ€: Active âœ“');
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆ d1/d2 åœ¨ Deactivate åä¸å˜ï¼Ÿ

**A:** d1/d2 ä»£è¡¨è´¦æˆ·çš„**æ°¸ä¹…çŠ¶æ€**ï¼Œåªåœ¨ SignUp å’Œ AddNewKey æ—¶è®¾ç½®ã€‚

```
è®¾è®¡ç†ç”±:
  1. ä¸å¯å˜æ€§: d1/d2 æ˜¯ StateLeaf hash çš„ä¸€éƒ¨åˆ†
     æ”¹å˜ d1/d2 éœ€è¦æ”¹å˜æ•´ä¸ª StateLeaf
     
  2. é˜²å¾¡å±‚: d1/d2 ä½œä¸ºå¤‡ç”¨æ£€æŸ¥æœºåˆ¶
     å³ä½¿ ActiveStateTree è¢«ç¯¡æ”¹
     d1/d2 ä»ç„¶å¯ä»¥æ£€æµ‹åˆ°å¼‚å¸¸
     
  3. éšç§ä¿æŠ¤: d1/d2 çš„å€¼ä¸ç›´æ¥æ­ç¤ºçŠ¶æ€
     éœ€è¦ coordPrivKey æ‰èƒ½è§£å¯†
     
  4. ç®€åŒ–é€»è¾‘: Deactivate åªéœ€æ›´æ–° ActiveStateTree
     ä¸éœ€è¦æ›´æ–° StateTree
```

### Q2: AddNewKey ä¸ºä»€ä¹ˆä¸æ£€æŸ¥ d1/d2 çš„å¥‡å¶æ€§ï¼Ÿ

**A:** æ£€æŸ¥ç”± ProcessMessages ç”µè·¯è´Ÿè´£ã€‚

```
åŸå› :
  1. èŒè´£åˆ†ç¦»:
     - AddNewKey: éªŒè¯èº«ä»½ã€é˜²é‡æ”¾ã€æ•°æ®ç»§æ‰¿
     - ProcessMessages: éªŒè¯æŠ•ç¥¨èµ„æ ¼
     
  2. çµæ´»æ€§:
     - AddNewKey å¯ä»¥ç»§æ‰¿ä»»ä½• d1/d2
     - æŠ•ç¥¨æ—¶æ‰æ£€æŸ¥æ˜¯å¦ active
     
  3. æ•°æ®ä¸€è‡´æ€§:
     - d1/d2 å¯èƒ½æ˜¯å¶æ•°ï¼ˆæ­£å¸¸ï¼‰æˆ–å¥‡æ•°ï¼ˆå¼‚å¸¸ï¼‰
     - å³ä½¿æ˜¯å¥‡æ•°ï¼ŒAddNewKey ä¹Ÿèƒ½ç»§æ‰¿
     - ä½†æŠ•ç¥¨æ—¶ä¼šè¢«æ‹’ç»ï¼ˆåŒé‡æ£€æŸ¥ï¼‰
     
ç¤ºä¾‹:
  å¦‚æœé“¾åŒæ­¥æ—¶å‡ºé”™ï¼Œå¯¼è‡´æŸä¸ªè´¦æˆ·çš„ d1/d2 æ˜¯å¥‡æ•°
  â†’ AddNewKey ä»ç„¶å¯ä»¥ç»§æ‰¿
  â†’ ä½†è¯¥è´¦æˆ·æ— æ³•æŠ•ç¥¨ï¼ˆè¢« d1/d2 check æ‹’ç»ï¼‰
```

### Q3: c1/c2 å’Œ d1/d2 æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A:** c1/c2 æ˜¯ä¸´æ—¶çš„ï¼Œd1/d2 æ˜¯æ°¸ä¹…çš„ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚      c1/c2       â”‚      d1/d2       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ›´æ–°æ—¶æœº    â”‚ ProcessMessages  â”‚ SignUp/AddNewKey â”‚
â”‚ ä½œç”¨åŸŸ      â”‚ ä¸´æ—¶ï¼ˆæ‰¹æ¬¡å†…ï¼‰   â”‚ æ°¸ä¹…ï¼ˆè´¦æˆ·ç”Ÿå‘½ï¼‰  â”‚
â”‚ ç”¨é€”        â”‚ éªŒè¯å½“å‰æ“ä½œ     â”‚ éªŒè¯è´¦æˆ·çŠ¶æ€     â”‚
â”‚ å­˜å‚¨ä½ç½®    â”‚ ä¸å­˜å‚¨           â”‚ StateTree        â”‚
â”‚ æ£€æŸ¥ä½ç½®    â”‚ ProcessMessages  â”‚ ProcessMessages  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸¤è€…éƒ½æ˜¯å¶æ•°:
  - c1/c2 % 2 === 0 âœ“
  - d1/d2 % 2 === 0 âœ“
  
å¦‚æœä»»ä½•ä¸€ä¸ªæ˜¯å¥‡æ•°ï¼ŒæŠ•ç¥¨è¢«æ‹’ç»ã€‚
```

### Q4: ä¸ºä»€ä¹ˆéœ€è¦ ActiveStateTreeï¼Ÿ

**A:** æä¾›å¿«é€Ÿçš„çŠ¶æ€æŸ¥è¯¢ï¼Œæ— éœ€è§£å¯†ã€‚

```
å¯¹æ¯”:

æ–¹æ¡ˆA: åªä½¿ç”¨ d1/d2
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
é—®é¢˜: 
  - éœ€è¦è§£å¯†æ‰èƒ½çŸ¥é“çŠ¶æ€
  - è®¡ç®—å¼€é”€å¤§
  - æ— æ³•å¿«é€Ÿåˆ¤æ–­

æ–¹æ¡ˆB: ä½¿ç”¨ ActiveStateTree
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ä¼˜ç‚¹:
  - ä¸€æ¬¡æŸ¥è¯¢å³çŸ¥çŠ¶æ€ (0 = active)
  - æ— éœ€è§£å¯†
  - æ”¯æŒå¿«é€Ÿè¿‡æ»¤
  
æ–¹æ¡ˆC: åŒæ—¶ä½¿ç”¨ (AMACI çš„é€‰æ‹©)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ä¼˜ç‚¹:
  - ActiveStateTree æä¾›å¿«é€ŸæŸ¥è¯¢
  - d1/d2 æä¾›é˜²å¾¡å±‚
  - åŒé‡ä¿æŠ¤
```

### Q5: Operator èƒ½å¦æ¶æ„æ“ä½œï¼Ÿ

**A:** ä¸èƒ½ã€‚æ‰€æœ‰æ“ä½œéƒ½è¢«ç”µè·¯çº¦æŸéªŒè¯ã€‚

```
åœºæ™¯åˆ†æ:

åœºæ™¯1: Operator ç¯¡æ”¹ ActiveStateTree
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ”»å‡»: è®© inactive ç”¨æˆ·çœ‹èµ·æ¥æ˜¯ active
é˜²å¾¡: ç”µè·¯éªŒè¯ Merkle proof
     å¦‚æœ Operator æä¾›å‡çš„ activeStateLeaf
     Merkle proof éªŒè¯ä¼šå¤±è´¥ âœ—

åœºæ™¯2: Operator è·³è¿‡ deactivate æ¶ˆæ¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ”»å‡»: ä¸å¤„ç†æŸäº› deactivate è¯·æ±‚
é˜²å¾¡: æ¶ˆæ¯é“¾å®Œæ•´æ€§æ£€æŸ¥
     batchStartHash â†’ ... â†’ batchEndHash
     è·³è¿‡æ¶ˆæ¯ä¼šç ´åé“¾çš„å®Œæ•´æ€§ âœ—

åœºæ™¯3: Operator ä¿®æ”¹ DeactivateTree
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ”»å‡»: æä¾›å‡çš„ deactivateLeaf
é˜²å¾¡: Merkle proof + Nullifier
     - Merkle proof éªŒè¯ leaf å­˜åœ¨æ€§
     - Nullifier é˜²æ­¢ä¼ªé€  âœ—

åœºæ™¯4: Operator ä¸æ›´æ–° ActiveStateTree
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ”»å‡»: ä¸æ ‡è®°ç”¨æˆ·ä¸º inactive
ç»“æœ: 
  - é“¾ä¸‹è®¡ç®—é”™è¯¯
  - ä½†æœ€ç»ˆ ZK proof ä¼šå¤±è´¥
  - æ— æ³•æäº¤åˆ°é“¾ä¸Š âœ—

ç»“è®º: æ‰€æœ‰å…³é”®æ“ä½œéƒ½æœ‰ç”µè·¯çº¦æŸä¿æŠ¤
```

### Q7: å¦‚æœç”¨æˆ·ä¸Šä¼ äº†é”™è¯¯çš„ deactivate message ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

**A:** ç³»ç»Ÿä¼šå®‰å…¨å¤„ç†é”™è¯¯ï¼Œä½†ä¼šå¯¼è‡´ AddNewKey å¤±è´¥ã€‚

```
åœºæ™¯: ç”¨æˆ·ä¸Šä¼ ç­¾åé”™è¯¯/nonce é”™è¯¯/å·² deactivate çš„æ¶ˆæ¯
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

åˆå§‹çŠ¶æ€:
  Old Voter (stateIdx=5):
    pubKey: [10457...592n, 12345...678n]
    balance: 100
    ActiveStateTree[5] = 0 (active) âœ“
    d1/d2 = [0, 0] (active) âœ“

æ­¥éª¤ 1: Operator å¤„ç†é”™è¯¯æ¶ˆæ¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
processedDMsgCount = 10
newActiveState[0] = 10 + 0 + 1 = 11

const error = checkDeactivateCommand(cmd);
// error = 'signature error' / 'deactivated' / etc.

if (error) {
  // ç”Ÿæˆç¡®å®šæ€§éšæœºå¯†é’¥ï¼ˆä½¿ç”¨ç›¸åŒçš„è®¡æ•°å™¨ï¼‰
  randomKey = genStaticRandomKey(coordPrivKey, 20040, 11)
            = poseidon([coordPrivKey, 20040n, 11n])
            = 55555555555555555555555555555555555555555555555555555555555555n
  
  // ç”Ÿæˆå¥‡æ•°çš„ c1c2ï¼ˆæ ‡è®°ä¸º deactivatedï¼‰
  const deactivate = encryptOdevity(true, coordPubKey, randomKey);
  //                                 â†‘ true è¡¨ç¤ºç”Ÿæˆå¥‡æ•°
  
  deactivate.c1: [
    1234567890123456789012345678901234567890123456789012345678901234n,
    2345678901234567890123456789012345678901234567890123456789012345n
  ]
  deactivate.c2: [
    3333333333333333333333333333333333333333333333333333333333333333n,  â† å¥‡æ•°
    4444444444444444444444444444444444444444444444444444444444444445n   â† å¥‡æ•°
  ]
  deactivate.xIncrement: 55555...555n
  
  dLeaf = [c1[0], c1[1], c2[0], c2[1], poseidon(sharedKey)]
  dLeafHash = poseidon(dLeaf)
            = 98765432109876543210987654321098765432109876543210987654321098n
  
  // å…³é”®ï¼šä¸æ›´æ–° ActiveStateTree
  // ActiveStateTree[5] ä¿æŒåŸå€¼ï¼ˆ0 = activeï¼‰
  
  // åªæ›´æ–° DeactivateTreeï¼ˆå­˜å…¥å¥‡æ•° c1c2ï¼‰
  deactivateTree.updateLeaf(0, dLeafHash);
}

ç»“æœ - ä¸‰æ£µæ ‘çš„çŠ¶æ€:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
StateTree[5]: (æœªå˜åŒ–)
  pubKey: [10457...592n, 12345...678n]
  balance: 100
  d1: [0, 0]  â† ä¸å˜
  d2: [0, 0]  â† ä¸å˜

ActiveStateTree[5]: 0  â† ä¸å˜ï¼ä»ç„¶ active âœ“

DeactivateTree[0]: 98765432109876543210987654321098765432109876543210987654321098n
                   â†‘ å­˜å…¥å¥‡æ•°æ•°æ®

éªŒè¯:
  decrypt(coordPrivKey, deactivate.c1, deactivate.c2, xIncrement)
  = 1 (å¥‡æ•°) â† æ ‡è®°ä¸º deactivated âœ—

ç»“è®º:
  âœ… Old Voter è´¦æˆ·æœªå—å½±å“
     - ActiveStateTree[5] = 0 (ä»ç„¶ active)
     - StateTree[5].d1/d2 = [0,0] (ä»ç„¶ active)
     - âœ å¯ä»¥ç»§ç»­æŠ•ç¥¨ âœ…
     
  âŒ DeactivateTree ä¸­å­˜å…¥äº†å¥‡æ•° c1c2
     - å¦‚æœç”¨æˆ·ç”¨è¿™ä¸ªæ•°æ®è¿›è¡Œ AddNewKey
     - æ–°è´¦æˆ·ä¼šç»§æ‰¿å¥‡æ•° d1/d2
     - âœ æ–°è´¦æˆ·æ— æ³•æŠ•ç¥¨ âŒ

æ­¥éª¤ 2: å¦‚æœç”¨æˆ·ç”¨å¥‡æ•° c1c2 è¿›è¡Œ AddNewKey
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å‡è®¾ç”¨æˆ·ä¸çŸ¥é“é”™è¯¯ï¼Œç”¨ DeactivateTree[0] çš„æ•°æ®è¿›è¡Œ AddNewKey

New Voter å¯†é’¥:
  newPrivKey: 77777n
  newPubKey: [
    6789012345678901234567890123456789012345678901234567890123456789n,
    7890123456789012345678901234567890123456789012345678901234567890n
  ]

AddNewKey åˆ›å»ºæ–°è´¦æˆ·:
  StateTree[10]:
    pubKey: [6789...789n, 7890...890n]
    balance: 100  â† ç»§æ‰¿
    voTreeRoot: 0
    nonce: 0
    d1: [1234...234n, 2345...345n]  â† ç»§æ‰¿å¥‡æ•° c1 âŒ
    d2: [3333...333n, 4444...445n]  â† ç»§æ‰¿å¥‡æ•° c2 âŒ
    xIncrement: 55555...555n

  ActiveStateTree[10] = 0  â† æ–°è´¦æˆ·é»˜è®¤ active âœ…

éªŒè¯ d1/d2:
  decrypt(coordPrivKey, d1, d2, xIncrement)
  = 1 (å¥‡æ•°) â† deactivated âŒ

å½“ New Voter å°è¯•æŠ•ç¥¨æ—¶ï¼ˆProcessMessages ç”µè·¯ï¼‰:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è¾“å…¥:
  stateIdx: 10
  message: vote for option 0, vc: 10

ç”µè·¯æ£€æŸ¥:
  1. ActiveStateTree æ£€æŸ¥:
     activeStateLeaf = activeStateLeaves[10] = 0
     isActive = IsZero()(0) = 1  â† é€šè¿‡ âœ“
  
  2. d1/d2 è§£å¯†æ£€æŸ¥ (StateLeafTransformer):
     decrypt(coordPrivKey, d1, d2, xIncrement)
     result = 1
     isActive2 = IsZero()(result % 2) = IsZero(1) = 0  â† å¤±è´¥ âœ—
  
  3. æœ€ç»ˆæ£€æŸ¥:
     isValid = isActive AND isActive2 = 1 AND 0 = 0  â† å¤±è´¥ âœ—

ç»“æœ:
  âœ æŠ•ç¥¨è¢«æ‹’ç» âŒ
  âœ æ–°è´¦æˆ·æ— æ³•ä½¿ç”¨ âŒ

ä¸‰æ£µæ ‘çš„æœ€ç»ˆçŠ¶æ€:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
StateTree:
  [5]: Old Voter (d1/d2 å¶æ•°) âœ“
  [10]: New Voter (d1/d2 å¥‡æ•°) âœ—

ActiveStateTree:
  [5]: 0 (active) âœ“
  [10]: 0 (active) âœ“  â† è™½ç„¶æ˜¯ 0ï¼Œä½† d1/d2 æ£€æŸ¥ä¼šå¤±è´¥

ç³»ç»Ÿä¿éšœ:
  âœ… Old Voter [5]: å¯æŠ•ç¥¨
  âœ… New Voter [10]: ä¸å¯æŠ•ç¥¨ï¼ˆåŒé‡æ£€æŸ¥æœºåˆ¶ï¼‰
  âœ… ç³»ç»Ÿä¸­åªæœ‰ä¸€ä¸ªå¯ç”¨è´¦æˆ·

å®‰å…¨ä¿éšœ:
  âœ… é”™è¯¯æ¶ˆæ¯ä¸ä¼šç ´å Old Voter è´¦æˆ·
  âœ… Old Voter ä»ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨
  âœ… æ–°è´¦æˆ·è™½ç„¶åˆ›å»ºæˆåŠŸï¼Œä½†æ— æ³•æŠ•ç¥¨
  âœ… é˜²æ­¢äº†é€šè¿‡é”™è¯¯æ¶ˆæ¯åˆ›å»ºå¤šä¸ªå¯ç”¨è´¦æˆ·
```

**æœ€ä½³å®è·µ**ï¼š
```typescript
// ç”¨æˆ·åº”è¯¥åœ¨ AddNewKey å‰éªŒè¯ deactivate æ˜¯å¦æˆåŠŸ
const activeState = await queryActiveStateTree(oldStateIdx);
if (activeState !== 0n) {
  console.log('âœ… Deactivate æˆåŠŸï¼Œå¯ä»¥è¿›è¡Œ AddNewKey');
} else {
  console.log('âŒ Deactivate å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¹¶é‡æ–°å‘é€');
}
```

### Q8: ç”¨å¥‡æ•° d1/d2 çš„è´¦æˆ·èƒ½å¦å†æ¬¡ deactivateï¼Ÿ

**A:** ä¸èƒ½ã€‚ç³»ç»Ÿä¼šæ£€æµ‹åˆ°è´¦æˆ·å·²ç» deactivated å¹¶æ‹’ç»ã€‚

```
åœºæ™¯: New Voter1 (d1/d2 å¥‡æ•°) å°è¯•å†æ¬¡ deactivate
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

åˆå§‹çŠ¶æ€:
  Old Voter (stateIdx=5):
    ActiveStateTree[5] = 0 (active) âœ…
    d1/d2 = å¶æ•° (active) âœ…
    âœ å¯ä»¥æŠ•ç¥¨ âœ…
    
  New Voter1 (stateIdx=10) - é€šè¿‡é”™è¯¯ deactivate åˆ›å»º:
    ActiveStateTree[10] = 0 (active) âœ…
    d1/d2 = å¥‡æ•° (deactivated) âŒ
    âœ ä¸èƒ½æŠ•ç¥¨ âŒ

ç”¨æˆ·å°è¯•: New Voter1 å‘é€ deactivate æ¶ˆæ¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ­¥éª¤ 1: checkDeactivateCommand æ£€æŸ¥
  
  const deactivate = decrypt(coordPrivKey, {
    c1: { x: s.d1[0], y: s.d1[1] },
    c2: { x: s.d2[0], y: s.d2[1] },
    xIncrement: 0n
  });
  
  if (deactivate % 2n === 1n) {
    return 'deactivated';  // â† åœ¨è¿™é‡Œè¢«æ‹’ç»ï¼
  }

æ­¥éª¤ 2: processDeactivateMessages å¤„ç†é”™è¯¯
  
  const error = checkDeactivateCommand(cmd);
  // error = 'deactivated'
  
  // ç”Ÿæˆæ–°çš„å¥‡æ•° c1c2ï¼ˆå› ä¸ºæœ‰ errorï¼‰
  const deactivate = encryptOdevity(!!error, ...);  // true â†’ å¥‡æ•°
  
  // ä¸æ›´æ–° ActiveStateTreeï¼ˆå› ä¸ºæœ‰ errorï¼‰
  // åªæ›´æ–° DeactivateTreeï¼ˆåˆæ˜¯å¥‡æ•° c1c2ï¼‰

æ­¥éª¤ 3: å¦‚æœç”¨è¿™ä¸ªæ–°çš„å¥‡æ•° c1c2 åˆ›å»º New Voter2
  
  New Voter2 (stateIdx=15):
    ActiveStateTree[15] = 0 (active) âœ…
    d1/d2 = å¥‡æ•° (deactivated) âŒ  // åˆæ˜¯å¥‡æ•°ï¼
    âœ ä¸èƒ½æŠ•ç¥¨ âŒ

ç»“æœ: æ— é™å¾ªç¯ï¼Œæ— æ³•åˆ›å»ºå¯ç”¨è´¦æˆ·
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å¥‡æ•° d1/d2 â†’ deactivate è¢«æ‹’ç» â†’ ç”Ÿæˆå¥‡æ•° c1/c2 
    â†‘                                      â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€ AddNewKey (rerandomize) â”€â”€â”€â”€â”˜

é˜²æ­¢çš„æ”»å‡»:
  âœ… æ— æ³•é€šè¿‡é”™è¯¯æ¶ˆæ¯åˆ›å»ºå¤šä¸ª active è´¦æˆ·
  âœ… æ— æ³•ç»•è¿‡ deactivate æœºåˆ¶ä¿æŒå¤šä¸ªèº«ä»½
  âœ… é˜²æ­¢ Sybil æ”»å‡»ï¼ˆä¸€äººå¤šç¥¨ï¼‰

æ­£ç¡®çš„åšæ³•:
  å¦‚æœç¬¬ä¸€æ¬¡ deactivate å¤±è´¥:
    âœ Old Voter ä»ç„¶å¯ç”¨ï¼Œç»§ç»­ç”¨æ—§è´¦æˆ·æŠ•ç¥¨
    âœ é‡æ–°å‘é€æ­£ç¡®çš„ deactivate æ¶ˆæ¯
    âœ ç¡®ä¿ ActiveStateTree è¢«æ­£ç¡®æ›´æ–°åå† AddNewKey
```

**çŠ¶æ€æ±‡æ€»è¡¨**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è´¦æˆ·     â”‚ ActiveStateTree â”‚ d1/d2 è§£å¯†  â”‚ èƒ½æŠ•ç¥¨  â”‚ èƒ½ Deactivate  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Old (5)  â”‚ 0 (active) âœ…   â”‚ å¶æ•° âœ…     â”‚ èƒ½ âœ…  â”‚ èƒ½ âœ…          â”‚
â”‚ New1(10) â”‚ 0 (active) âœ…   â”‚ å¥‡æ•° âŒ     â”‚ ä¸èƒ½ âŒâ”‚ ä¸èƒ½ âŒ        â”‚
â”‚ New2(15) â”‚ 0 (active) âœ…   â”‚ å¥‡æ•° âŒ     â”‚ ä¸èƒ½ âŒâ”‚ ä¸èƒ½ âŒ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç³»ç»Ÿä¸­åªæœ‰ Old Voter ä¸€ä¸ªå¯ç”¨çš„ active è´¦æˆ·ã€‚
```

### Q9: ç”¨æˆ·èƒ½å¦åœ¨å®¢æˆ·ç«¯è‡ªè¡Œæ£€æŸ¥ c1/c2 çš„å¥‡å¶æ€§ï¼ˆæ­£ç¡®æ€§ï¼‰ï¼Ÿ

**A:** ä¸èƒ½ã€‚c1/c2 ä¸æ˜¯ç”¨æˆ·ç”Ÿæˆçš„ï¼Œè€Œæ˜¯ coordinator å¤„ç†æ¶ˆæ¯æ—¶ç”Ÿæˆçš„ã€‚

```
å…³é”®è®¤çŸ¥:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç”¨æˆ·å‘é€çš„ä¸æ˜¯ c1/c2ï¼Œè€Œæ˜¯åŠ å¯†çš„ deactivate æ¶ˆæ¯
c1/c2 æ˜¯ coordinator åœ¨ processDeactivateMessages æ—¶æ ¹æ®
æ¶ˆæ¯éªŒè¯ç»“æœåŠ¨æ€ç”Ÿæˆçš„

æ—¶é—´çº¿:
  T1: ç”¨æˆ·ç”Ÿæˆå¹¶å‘é€ deactivate message
      â†“ (åŒ…å«: åŠ å¯†çš„å‘½ä»¤ã€ç­¾åã€ä¸´æ—¶å…¬é’¥)
  T2: Coordinator æ¥æ”¶å¹¶éªŒè¯æ¶ˆæ¯
      â†“ (éªŒè¯ç­¾åã€nonceã€çŠ¶æ€ç­‰)
  T3: Coordinator æ ¹æ®éªŒè¯ç»“æœç”Ÿæˆ c1/c2
      â†“ æ­£ç¡® â†’ å¶æ•° c1/c2
      â†“ é”™è¯¯ â†’ å¥‡æ•° c1/c2
  T4: c1/c2 å­˜å…¥ DeactivateTree
```

#### ä¸ºä»€ä¹ˆç”¨æˆ·æ— æ³•æ£€æŸ¥ï¼Ÿ

```
åŸå›  1: æ—¶é—´å·®
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶ï¼Œc1/c2 è¿˜ä¸å­˜åœ¨
   ç”¨æˆ· â”€â”€å‘é€æ¶ˆæ¯â”€â”€> åˆçº¦ â”€â”€ç­‰å¾…â”€â”€> Coordinator
                                    â†“
                                  ç”Ÿæˆ c1/c2

åœ¨å‘é€é˜¶æ®µï¼Œæ ¹æœ¬æ²¡æœ‰ c1/c2 å¯ä»¥æ£€æŸ¥

åŸå›  2: ç”Ÿæˆä¾èµ–
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
c1/c2 çš„ç”Ÿæˆä¾èµ–äºï¼š
  â€¢ Coordinator çš„ç§é’¥
  â€¢ æ¶ˆæ¯éªŒè¯çš„ç»“æœ (ç­¾åæ˜¯å¦æ­£ç¡®ç­‰)
  â€¢ ç¡®å®šæ€§éšæœºå¯†é’¥ (åŸºäº processedDMsgCount)

const randomKey = genStaticRandomKey(
  coordPrivKey,           // â† ç”¨æˆ·æ²¡æœ‰
  20040n,
  newActiveState[i]       // â† ä¾èµ–å¤„ç†é¡ºåº
);

const deactivate = encryptOdevity(
  !!error,                // â† ä¾èµ–éªŒè¯ç»“æœ
  coordPubKey,
  randomKey
);

ç”¨æˆ·æ— æ³•é¢„å…ˆçŸ¥é“è¿™äº›ä¿¡æ¯

åŸå›  3: è§£å¯†éœ€è¦ coordinator ç§é’¥
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å³ä½¿ç”¨æˆ·è·å¾—äº† c1/c2ï¼Œä¹Ÿæ— æ³•è§£å¯†éªŒè¯ï¼š

const decrypted = decrypt(
  coordPrivKey,           // â† ç”¨æˆ·æ²¡æœ‰
  { c1, c2, xIncrement }
);

åªæœ‰ coordinator èƒ½è§£å¯†å¹¶æ£€æŸ¥å¥‡å¶æ€§
```

#### ç”¨æˆ·èƒ½åšä»€ä¹ˆï¼Ÿ

```typescript
// âœ… å‘é€å‰ï¼šå®¢æˆ·ç«¯éªŒè¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function validateDeactivateMessage({
  maciKeypair,
  stateIdx,
  operatorPubKey,
  contractAddress
}) {
  // 1. éªŒè¯æ¶ˆæ¯ç­¾å
  console.log('âœ“ éªŒè¯æ¶ˆæ¯ç­¾å...');
  const payload = batchGenMessage(
    stateIdx,
    maciKeypair,
    operatorPubKey,
    [[0, 0]]
  );
  
  const { msg, encPubkeys } = payload[0];
  
  // éªŒè¯æ¶ˆæ¯æ ¼å¼
  if (msg.length !== 7) {
    throw new Error('âŒ æ¶ˆæ¯æ ¼å¼é”™è¯¯ï¼šé•¿åº¦å¿…é¡»ä¸º 7');
  }
  
  // éªŒè¯å­—æ®µèŒƒå›´
  const SNARK_FIELD_SIZE = BigInt(
    '21888242871839275222246405745257275088548364400416034343698204186575808495617'
  );
  
  for (let i = 0; i < msg.length; i++) {
    if (BigInt(msg[i]) >= SNARK_FIELD_SIZE) {
      throw new Error(`âŒ å­—æ®µ ${i} è¶…å‡ºèŒƒå›´`);
    }
  }
  
  console.log('âœ… æ¶ˆæ¯æ ¼å¼éªŒè¯é€šè¿‡');
  
  // 2. éªŒè¯ stateIdx æ­£ç¡®
  console.log('âœ“ éªŒè¯ stateIdx...');
  const currentStateIdx = await queryStateIdx(maciKeypair.pubKey, contractAddress);
  
  if (stateIdx !== currentStateIdx) {
    throw new Error(`âŒ stateIdx ä¸åŒ¹é…: æœŸæœ› ${currentStateIdx}, å®é™… ${stateIdx}`);
  }
  
  console.log('âœ… stateIdx éªŒè¯é€šè¿‡');
  
  // 3. éªŒè¯è´¦æˆ·çŠ¶æ€ï¼ˆç¡®ä¿æœªè¢« deactivateï¼‰
  console.log('âœ“ éªŒè¯è´¦æˆ·çŠ¶æ€...');
  const activeState = await queryActiveState(stateIdx, contractAddress);
  
  if (activeState !== 0n) {
    throw new Error('âŒ è´¦æˆ·å·²ç» deactivatedï¼Œæ— æ³•å†æ¬¡ deactivate');
  }
  
  console.log('âœ… è´¦æˆ·çŠ¶æ€éªŒè¯é€šè¿‡');
  
  // 4. éªŒè¯ nonceï¼ˆå¯é€‰ï¼Œå–å†³äºå®ç°ï¼‰
  console.log('âœ“ éªŒè¯ nonce...');
  // deactivate æ¶ˆæ¯é€šå¸¸ä½¿ç”¨ nonce = 0
  // å¦‚æœç³»ç»Ÿè¦æ±‚ä¸åŒï¼Œè¿™é‡Œéœ€è¦é¢å¤–æ£€æŸ¥
  
  return {
    isValid: true,
    message: { data: msg },
    encPubKey: {
      x: encPubkeys[0],
      y: encPubkeys[1]
    }
  };
}

// âœ… å‘é€åï¼šç­‰å¾…å¹¶éªŒè¯ç»“æœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function verifyDeactivateSuccess({
  stateIdx,
  contractAddress,
  operatorPubKey,
  oldKeypair,
  timeout = 60000  // 60ç§’è¶…æ—¶
}) {
  console.log('â³ ç­‰å¾… coordinator å¤„ç† deactivate æ¶ˆæ¯...');
  
  const startTime = Date.now();
  
  // è½®è¯¢æ£€æŸ¥ ActiveStateTree æ˜¯å¦æ›´æ–°
  while (Date.now() - startTime < timeout) {
    const activeState = await queryActiveState(stateIdx, contractAddress);
    
    if (activeState !== 0n) {
      console.log('âœ… Deactivate æˆåŠŸï¼');
      console.log(`ActiveStateTree[${stateIdx}] = ${activeState} (inactive)`);
      
      // å¯é€‰ï¼šæŸ¥è¯¢ DeactivateTree ä¸­çš„æ•°æ®
      try {
        const deactivateLeaf = await queryDeactivateLeaf(stateIdx, contractAddress);
        console.log('DeactivateTree æ•°æ®:', deactivateLeaf);
        
        // å¦‚æœæ˜¯ operatorï¼Œå¯ä»¥éªŒè¯å¥‡å¶æ€§
        // æ™®é€šç”¨æˆ·æ²¡æœ‰ coordPrivKeyï¼Œæ— æ³•éªŒè¯
        
        return {
          success: true,
          activeState,
          deactivateLeaf
        };
      } catch (e) {
        console.warn('âš ï¸ æ— æ³•æŸ¥è¯¢ DeactivateTree:', e.message);
        // å³ä½¿æŸ¥è¯¢å¤±è´¥ï¼Œåªè¦ ActiveStateTree æ›´æ–°äº†å°±ç®—æˆåŠŸ
        return {
          success: true,
          activeState
        };
      }
    }
    
    // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
    await new Promise(resolve => setTimeout(resolve, 2000));
  }
  
  // è¶…æ—¶
  console.error('âŒ éªŒè¯è¶…æ—¶ï¼šActiveStateTree æœªæ›´æ–°');
  console.log('å¯èƒ½çš„åŸå› :');
  console.log('  - æ¶ˆæ¯ç­¾åé”™è¯¯');
  console.log('  - Nonce ä¸åŒ¹é…');
  console.log('  - Coordinator å°šæœªå¤„ç†');
  console.log('  - è´¦æˆ·å·²ç» deactivated');
  
  return {
    success: false,
    error: 'timeout'
  };
}

// âœ… å®Œæ•´çš„å®‰å…¨æµç¨‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function safeDeactivateFlow({
  maciKeypair,
  stateIdx,
  operatorPubKey,
  contractAddress,
  signer
}) {
  try {
    // æ­¥éª¤ 1: å‘é€å‰éªŒè¯
    console.log('=== æ­¥éª¤ 1: å‘é€å‰éªŒè¯ ===');
    const validation = await validateDeactivateMessage({
      maciKeypair,
      stateIdx,
      operatorPubKey,
      contractAddress
    });
    
    if (!validation.isValid) {
      throw new Error('æ¶ˆæ¯éªŒè¯å¤±è´¥');
    }
    
    // æ­¥éª¤ 2: å‘é€æ¶ˆæ¯
    console.log('\n=== æ­¥éª¤ 2: å‘é€ Deactivate æ¶ˆæ¯ ===');
    const txResult = await publishDeactivateMessage(
      signer,
      contractAddress,
      validation.message,
      validation.encPubKey
    );
    
    console.log('âœ… æ¶ˆæ¯å·²å‘é€ï¼Œäº¤æ˜“å“ˆå¸Œ:', txResult.transactionHash);
    
    // æ­¥éª¤ 3: ç­‰å¾…å¹¶éªŒè¯
    console.log('\n=== æ­¥éª¤ 3: ç­‰å¾… Coordinator å¤„ç† ===');
    const result = await verifyDeactivateSuccess({
      stateIdx,
      contractAddress,
      operatorPubKey,
      oldKeypair: maciKeypair
    });
    
    if (!result.success) {
      console.error('âŒ Deactivate å¤±è´¥');
      console.log('å»ºè®®: æ£€æŸ¥æ¶ˆæ¯å‚æ•°å¹¶é‡æ–°å‘é€');
      return { success: false };
    }
    
    // æ­¥éª¤ 4: å‡†å¤‡ AddNewKeyï¼ˆå¯é€‰ï¼‰
    console.log('\n=== æ­¥éª¤ 4: å¯ä»¥è¿›è¡Œ AddNewKey ===');
    console.log('æç¤º: ç°åœ¨å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ AddNewKey åŠŸèƒ½');
    console.log('     æ–°è´¦æˆ·å°†ç»§æ‰¿æ—§è´¦æˆ·çš„ä½™é¢å’ŒæŠ•ç¥¨å†å²');
    
    return {
      success: true,
      activeState: result.activeState,
      deactivateLeaf: result.deactivateLeaf
    };
    
  } catch (error) {
    console.error('âŒ æµç¨‹å¤±è´¥:', error.message);
    return { success: false, error: error.message };
  }
}
```

#### æœ€ä½³å®è·µå»ºè®®

```
æ¨èåšæ³•:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1. å‘é€å‰éªŒè¯
   âœ… æ£€æŸ¥æ¶ˆæ¯æ ¼å¼
   âœ… éªŒè¯ stateIdx
   âœ… ç¡®è®¤è´¦æˆ·çŠ¶æ€

2. æ­£ç¡®å‘é€
   âœ… ä½¿ç”¨æ­£ç¡®çš„ç§é’¥ç­¾å
   âœ… ä½¿ç”¨å½“å‰çš„ nonce
   âœ… é€‰æ‹©æ­£ç¡®çš„ coordinator å…¬é’¥

3. ç­‰å¾…ç¡®è®¤
   âœ… è½®è¯¢ ActiveStateTree
   âœ… ç¡®è®¤çŠ¶æ€å·²æ›´æ–°ä¸º inactive
   âœ… è¶…æ—¶å¤„ç†

4. AddNewKey å‰å†æ¬¡æ£€æŸ¥
   âœ… éªŒè¯ ActiveStateTree[oldIdx] â‰  0
   âœ… æŸ¥è¯¢ DeactivateTree æ•°æ®ï¼ˆå¦‚å¯èƒ½ï¼‰
   âœ… ç¡®ä¿æ•°æ®å¯ç”¨

ä¸è¦åš:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âŒ ä¸è¦å°è¯•é¢„æµ‹ c1/c2 çš„å€¼
   â†’ c1/c2 ä¾èµ– coordinator çš„å¤„ç†ç»“æœ

âŒ ä¸è¦åœ¨æœªç¡®è®¤å‰å°±è¿›è¡Œ AddNewKey
   â†’ å¯èƒ½ä½¿ç”¨åˆ°é”™è¯¯çš„å¥‡æ•° c1/c2

âŒ ä¸è¦ä¾èµ–å®¢æˆ·ç«¯çš„"çŒœæµ‹"
   â†’ å§‹ç»ˆé€šè¿‡é“¾ä¸ŠçŠ¶æ€éªŒè¯

âŒ ä¸è¦å‡è®¾æ¶ˆæ¯ä¸€å®šæˆåŠŸ
   â†’ å®ç°è¶…æ—¶å’Œé”™è¯¯å¤„ç†
```

#### å¯¹æ¯”ï¼šç”¨æˆ· vs Coordinator

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç”¨æˆ·èƒ½åšä»€ä¹ˆ vs ä¸èƒ½åšä»€ä¹ˆ                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ“ä½œ               â”‚ ç”¨æˆ·            â”‚ Coordinator       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”Ÿæˆ deactivate    â”‚ âœ… èƒ½           â”‚ âœ… èƒ½             â”‚
â”‚ message            â”‚                 â”‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ éªŒè¯æ¶ˆæ¯æ ¼å¼       â”‚ âœ… èƒ½           â”‚ âœ… èƒ½             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ éªŒè¯ç­¾å           â”‚ âœ… èƒ½           â”‚ âœ… èƒ½             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”Ÿæˆ c1/c2         â”‚ âŒ ä¸èƒ½         â”‚ âœ… èƒ½             â”‚
â”‚                    â”‚ (æ—¶é—´å·®+ä¾èµ–)   â”‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ£€æŸ¥ c1/c2 å¥‡å¶æ€§  â”‚ âŒ ä¸èƒ½         â”‚ âœ… èƒ½             â”‚
â”‚                    â”‚ (éœ€è¦ç§é’¥è§£å¯†)  â”‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æŸ¥è¯¢ ActiveState   â”‚ âœ… èƒ½           â”‚ âœ… èƒ½             â”‚
â”‚                    â”‚ (å‘é€å)        â”‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æŸ¥è¯¢ Deactivate    â”‚ âš ï¸ éƒ¨åˆ†èƒ½      â”‚ âœ… èƒ½             â”‚
â”‚ Tree               â”‚ (ä»… hash)       â”‚ (å«åŸå§‹æ•°æ®)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·çš„ç­–ç•¥: 
  â€¢ å‘é€å‰ï¼šç¡®ä¿æ¶ˆæ¯æ­£ç¡®
  â€¢ å‘é€åï¼šéªŒè¯çŠ¶æ€æ›´æ–°
  â€¢ AddNewKeyå‰ï¼šå†æ¬¡ç¡®è®¤
```

#### æ•…éšœæ’æŸ¥

```
é—®é¢˜ 1: å‘é€äº†æ¶ˆæ¯ä½† ActiveStateTree æœªæ›´æ–°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
å¯èƒ½åŸå› :
  âŒ æ¶ˆæ¯ç­¾åé”™è¯¯
     â†’ æ£€æŸ¥: æ˜¯å¦ä½¿ç”¨æ­£ç¡®çš„ç§é’¥
  âŒ Nonce ä¸åŒ¹é…
     â†’ æ£€æŸ¥: deactivate é€šå¸¸ä½¿ç”¨ nonce=0
  âŒ è´¦æˆ·å·² deactivated
     â†’ æ£€æŸ¥: æŸ¥è¯¢å½“å‰ ActiveStateTree çŠ¶æ€
  âŒ Coordinator å°šæœªå¤„ç†
     â†’ ç­‰å¾…: ç»™ coordinator æ›´å¤šæ—¶é—´

è§£å†³æ–¹æ¡ˆ:
  1. æŸ¥è¯¢å½“å‰è´¦æˆ·çŠ¶æ€
  2. æ£€æŸ¥æ¶ˆæ¯å‚æ•°
  3. é‡æ–°å‘é€ï¼ˆå¦‚æœç¡®è®¤å¤±è´¥ï¼‰

é—®é¢˜ 2: AddNewKey åæ–°è´¦æˆ·æ— æ³•æŠ•ç¥¨
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
å¯èƒ½åŸå› :
  âŒ ä½¿ç”¨äº†å¥‡æ•° c1/c2 æ•°æ®
     â†’ åŸå› : åŸå§‹ deactivate æ¶ˆæ¯æœ‰é”™è¯¯
  
éªŒè¯æ–¹æ³•:
  å¦‚æœä½ æ˜¯ operatorï¼Œå¯ä»¥è§£å¯†æ£€æŸ¥:
  
  const decrypted = decrypt(coordPrivKey, {
    c1: { x: newStateLeaf.d1[0], y: newStateLeaf.d1[1] },
    c2: { x: newStateLeaf.d2[0], y: newStateLeaf.d2[1] },
    xIncrement: 0n
  });
  
  console.log('d1/d2 å¥‡å¶æ€§:', decrypted % 2n === 0n ? 'å¶æ•° âœ…' : 'å¥‡æ•° âŒ');

è§£å†³æ–¹æ¡ˆ:
  âš ï¸ å¥‡æ•° d1/d2 è´¦æˆ·æ— æ³•ä¿®å¤
  âœ… ä½¿ç”¨åŸè´¦æˆ·ï¼ˆå¦‚æœä»ç„¶ activeï¼‰
  âœ… é‡æ–°å‘é€æ­£ç¡®çš„ deactivate æ¶ˆæ¯
  âœ… ç”¨æ­£ç¡®çš„æ•°æ®å†æ¬¡ AddNewKey

é—®é¢˜ 3: å¦‚ä½•ç¡®ä¿ deactivate ä¸€å®šæˆåŠŸï¼Ÿ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
å»ºè®®æµç¨‹:
  1. ä½¿ç”¨ validateDeactivateMessage é¢„æ£€æŸ¥
  2. å‘é€æ¶ˆæ¯å¹¶è®°å½•äº¤æ˜“å“ˆå¸Œ
  3. ä½¿ç”¨ verifyDeactivateSuccess è½®è¯¢éªŒè¯
  4. åªæœ‰ç¡®è®¤æˆåŠŸåæ‰è¿›è¡Œ AddNewKey
  5. å®ç°å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
```

#### è®¾è®¡å“²å­¦

```
ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

åŸåˆ™ 1: è´£ä»»åˆ†ç¦»
  â€¢ ç”¨æˆ·: ç”Ÿæˆæ­£ç¡®çš„æ¶ˆæ¯
  â€¢ Coordinator: éªŒè¯å¹¶ç”Ÿæˆ c1/c2
  â€¢ Circuit: ç¡®ä¿æ­£ç¡®æ€§

åŸåˆ™ 2: å®‰å…¨ä¼˜å…ˆ
  â€¢ ç”¨æˆ·æ— æ³•é¢„æµ‹ c1/c2 â†’ é˜²æ­¢ä½œå¼Š
  â€¢ é”™è¯¯æ¶ˆæ¯ç”Ÿæˆå¥‡æ•° â†’ è‡ªåŠ¨éš”ç¦»
  â€¢ å¥‡æ•°æ•°æ®æ— æ³•ä¼ æ’­ â†’ é˜²æ­¢ Sybil

åŸåˆ™ 3: å¯éªŒè¯æ€§
  â€¢ æ‰€æœ‰æ“ä½œéƒ½æœ‰ ZK proof
  â€¢ é“¾ä¸ŠçŠ¶æ€å¯æŸ¥è¯¢
  â€¢ äº‹åå¯å®¡è®¡

å¥½å¤„:
  âœ… ç®€åŒ–ç”¨æˆ·ç«¯é€»è¾‘
  âœ… é›†ä¸­å®‰å…¨æ£€æŸ¥åˆ° coordinator
  âœ… åˆ©ç”¨ ZK proof ç¡®ä¿æ­£ç¡®æ€§
  âœ… è‡ªåŠ¨é˜²æ­¢æ¶æ„è¡Œä¸º
  âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†ï¼ˆå¥‡å¶æ€§æœºåˆ¶ï¼‰
```

### Q10: ç”¨æˆ·èƒ½å¦åœ¨ AddNewKey ä¹‹å‰æäº¤å¤šæ¬¡ deactivate messageï¼Ÿæœ€ç»ˆçŠ¶æ€ä¼šæ˜¯ä»€ä¹ˆï¼Ÿ

**A:** å¯ä»¥æäº¤å¤šæ¬¡ï¼Œæ‰€æœ‰æˆåŠŸçš„æ¶ˆæ¯éƒ½ä¼šåœ¨ DeactivateTree ä¸­ä¿ç•™ï¼ˆä¸åŒç´¢å¼•ä½ç½®ï¼‰ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ä»»æ„ä¸€ä¸ªè¿›è¡Œ AddNewKeyï¼Œä½† nullifier æœºåˆ¶ç¡®ä¿åªèƒ½ add ä¸€æ¬¡ã€‚

#### æ ¸å¿ƒæœºåˆ¶

```
å…³é”®ç‚¹:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1. åˆçº¦ä¸é˜»æ­¢å¤šæ¬¡æäº¤
   - publish_deactivate_message æ²¡æœ‰é‡å¤æ£€æŸ¥
   - åªè¦åœ¨æŠ•ç¥¨æœŸå†…ï¼Œå¯ä»¥å‘é€ä»»æ„å¤šä¸ªæ¶ˆæ¯

2. æŒ‰é¡ºåºå¤„ç†æ‰€æœ‰æ¶ˆæ¯
   - processDeactivateMessages æ‰¹é‡å¤„ç†
   - æ¯ä¸ªæ¶ˆæ¯ç‹¬ç«‹éªŒè¯
   - é”™è¯¯æ¶ˆæ¯è¢«è·³è¿‡ï¼Œä¸å½±å“åç»­æ¶ˆæ¯

3. æ¯ä¸ªæ¶ˆæ¯åœ¨ DeactivateTree å æ®ä¸åŒä½ç½®ï¼ˆè¿½åŠ å¼å­˜å‚¨ï¼‰
   - ActiveStateTree: æœ€åä¸€æ¬¡æ­£ç¡®æ¶ˆæ¯æ›´æ–°çš„å€¼ï¼ˆè¦†ç›–å¼æ›´æ–°ï¼‰
   - DeactivateTree: æ¯ä¸ªæ¶ˆæ¯å æ®é€’å¢ç´¢å¼•ï¼ˆè¿½åŠ å¼å­˜å‚¨ï¼‰
   - StateTree: ä¸å— deactivate å½±å“
   - **å…³é”®**: æ‰€æœ‰æˆåŠŸçš„ deactivate è®°å½•éƒ½ä¿ç•™ï¼Œç”¨æˆ·å¯é€‰æ‹©ä»»æ„ä¸€ä¸ª

4. ä¸èƒ½æ’¤é”€ deactivate
   - ä¸€æ—¦ ActiveStateTree è¢«æ ‡è®°ä¸º inactive
   - æ— æ³•é€šè¿‡åç»­æ¶ˆæ¯æ¢å¤ä¸º active
   - åªèƒ½é€šè¿‡ AddNewKey åˆ›å»ºæ–°è´¦æˆ·
```

#### å¤„ç†é€»è¾‘è¯¦è§£

```typescript
// processDeactivateMessages çš„å¤„ç†æµç¨‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

for (let i = 0; i < batchSize; i++) {
  const cmd = commands[i];
  const error = checkDeactivateCommand(cmd, subStateTreeLength);
  
  // ç”Ÿæˆ c1/c2ï¼ˆæ— è®ºæ¶ˆæ¯æ˜¯å¦æœ‰æ•ˆï¼‰
  const randomKey = genStaticRandomKey(
    coordPrivKey,
    20040n,
    newActiveState[i]
  );
  
  const deactivate = encryptOdevity(
    !!error,        // æœ‰é”™è¯¯ â†’ å¥‡æ•°ï¼Œæ— é”™è¯¯ â†’ å¶æ•°
    coordPubKey,
    randomKey
  );
  
  // å…³é”®ï¼šæ ¹æ®éªŒè¯ç»“æœå†³å®šæ˜¯å¦æ›´æ–° ActiveStateTree
  if (!error) {
    // âœ… æ­£ç¡®æ¶ˆæ¯ï¼šæ›´æ–° ActiveStateTreeï¼ˆåŒä¸€ stateIdxï¼Œè¦†ç›–å¼ï¼‰
    activeStateTree.updateLeaf(stateIdx, newActiveState[i]);
    // DeactivateTree ä½¿ç”¨é€’å¢ç´¢å¼•ï¼ˆè¿½åŠ å¼ï¼‰
    deactivateTree.updateLeaf(deactivateIndex + i, poseidon(dLeaf));
  } else {
    // âŒ é”™è¯¯æ¶ˆæ¯ï¼šä¸æ›´æ–° ActiveStateTreeï¼Œåªæ›´æ–° DeactivateTree
    deactivateTree.updateLeaf(deactivateIndex + i, poseidon(dLeaf));
  }
}

// ç»“æœï¼š
// - ActiveStateTree: ä¿å­˜æœ€åä¸€ä¸ªæœ‰æ•ˆæ¶ˆæ¯çš„çŠ¶æ€ï¼ˆè¦†ç›–å¼ï¼ŒåŒä¸€ stateIdxï¼‰
// - DeactivateTree: æ‰€æœ‰æ¶ˆæ¯éƒ½ä¿ç•™åœ¨ä¸åŒç´¢å¼•ï¼ˆè¿½åŠ å¼ï¼ŒdeactivateIndex + iï¼‰
// - å…³é”®åŒºåˆ«: ActiveStateTree è¦†ç›–æ›´æ–°ï¼ŒDeactivateTree è¿½åŠ å­˜å‚¨
```

#### æ‰€æœ‰å¯èƒ½çš„æƒ…å†µçŸ©é˜µ

```
ç¬¦å·è¯´æ˜:
  âœ“ = æ­£ç¡®çš„ deactivate æ¶ˆæ¯ï¼ˆç­¾åæ­£ç¡®ã€nonce æ­£ç¡®ç­‰ï¼‰
  âœ— = é”™è¯¯çš„ deactivate æ¶ˆæ¯ï¼ˆç­¾åé”™è¯¯ã€å·² deactivate ç­‰ï¼‰
  [å¶æ•°(n)] = åœ¨ DeactivateTree ç´¢å¼• n å¤„å­˜å‚¨çš„å¶æ•°æ•°æ®ï¼ˆå¯ç”¨ï¼‰
  [å¥‡æ•°(n)] = åœ¨ DeactivateTree ç´¢å¼• n å¤„å­˜å‚¨çš„å¥‡æ•°æ•°æ®ï¼ˆä¸å¯ç”¨ï¼‰

â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚åºå·â”‚æ¶ˆæ¯åºåˆ—  â”‚æœ€ç»ˆ ActiveTree  â”‚æœ€ç»ˆ DeactTree          â”‚èƒ½å¦ AddNewKeyâ”‚ è¯´æ˜            â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ âœ“        â”‚ é0 (inactive)  â”‚ [å¶æ•°(1)]              â”‚ âœ“ ä½¿ç”¨ç´¢å¼•1  â”‚ æ­£å¸¸ deactivate â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2  â”‚ âœ—        â”‚ 0 (active)      â”‚ [å¥‡æ•°(1)]              â”‚ âœ— æ•°æ®ä¸å¯ç”¨ â”‚ å¤±è´¥ï¼Œè´¦æˆ·ä¿æŠ¤  â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3  â”‚ âœ“âœ“       â”‚ é0 (inactive)  â”‚ [å¶æ•°(1), å¶æ•°(2)]     â”‚ âœ“ å¯é€‰1æˆ–2   â”‚ ä¸¤ä¸ªéƒ½å¯ç”¨ï¼    â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4  â”‚ âœ“âœ—       â”‚ é0 (inactive)  â”‚ [å¶æ•°(1), å¥‡æ•°(2)]     â”‚ âœ“ ä½¿ç”¨ç´¢å¼•1  â”‚ ç´¢å¼•1ä»å¯ç”¨     â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5  â”‚ âœ—âœ“       â”‚ é0 (inactive)  â”‚ [å¥‡æ•°(1), å¶æ•°(2)]     â”‚ âœ“ ä½¿ç”¨ç´¢å¼•2  â”‚ ç¬¬2æ¬¡æˆåŠŸå¯ç”¨   â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 6  â”‚ âœ—âœ—       â”‚ 0 (active)      â”‚ [å¥‡æ•°(1), å¥‡æ•°(2)]     â”‚ âœ— éƒ½ä¸å¯ç”¨   â”‚ ä¸¤æ¬¡éƒ½å¤±è´¥      â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 7  â”‚ âœ“âœ“âœ“      â”‚ é0 (inactive)  â”‚ [å¶æ•°(1),å¶æ•°(2),å¶æ•°(3)]â”‚ âœ“ å¯é€‰1/2/3  â”‚ ä¸‰ä¸ªéƒ½å¯ç”¨ï¼    â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 8  â”‚ âœ“âœ—âœ“      â”‚ é0 (inactive)  â”‚ [å¶æ•°(1),å¥‡æ•°(2),å¶æ•°(3)]â”‚ âœ“ å¯é€‰1æˆ–3   â”‚ ç´¢å¼•1,3å¯ç”¨     â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 9  â”‚ âœ—âœ“âœ—      â”‚ é0 (inactive)  â”‚ [å¥‡æ•°(1),å¶æ•°(2),å¥‡æ•°(3)]â”‚ âœ“ ä½¿ç”¨ç´¢å¼•2  â”‚ ç´¢å¼•2å¯ç”¨       â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 10 â”‚ âœ—âœ—âœ“      â”‚ é0 (inactive)  â”‚ [å¥‡æ•°(1),å¥‡æ•°(2),å¶æ•°(3)]â”‚ âœ“ ä½¿ç”¨ç´¢å¼•3  â”‚ ç´¢å¼•3å¯ç”¨       â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®ç†è§£ï¼ˆé‡è¦ä¿®æ­£ï¼ï¼‰:
  â€¢ ActiveStateTree: ç”±æœ€åä¸€ä¸ª âœ“ å†³å®šï¼ˆåŒä¸€ stateIdx è¦†ç›–å¼æ›´æ–°ï¼‰
  â€¢ DeactivateTree: æ‰€æœ‰æ¶ˆæ¯éƒ½è¿½åŠ åˆ°ä¸åŒç´¢å¼•ï¼ˆè¿½åŠ å¼å­˜å‚¨ï¼‰
  â€¢ ç”¨æˆ·å¯ä»å¤šä¸ªå¶æ•°æ•°æ®ä¸­é€‰æ‹©ä»»æ„ä¸€ä¸ªè¿›è¡Œ AddNewKey
  â€¢ nullifier æœºåˆ¶: ç¡®ä¿æ— è®ºé€‰æ‹©å“ªä¸ªï¼Œéƒ½åªèƒ½ addNewKey ä¸€æ¬¡
    nullifier = Hash(oldPrivKey, CONST) â† ä¸é€‰æ‹©å“ªä¸ª deactivate leaf æ— å…³
```

#### å¤šä¸ª Deactivate Leaf çš„è®¾è®¡ä¼˜åŠ¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ä¸ºä»€ä¹ˆ DeactivateTree é‡‡ç”¨è¿½åŠ å¼è€Œéè¦†ç›–å¼å­˜å‚¨ï¼Ÿ          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ 1. çµæ´»æ€§ - å®¹é”™è®¾è®¡                                         â”‚
â”‚    åœºæ™¯: âœ“âœ—âœ“ (åºå·8)                                         â”‚
â”‚    â€¢ DeactivateTree[1] = å¶æ•° âœ“                              â”‚
â”‚    â€¢ DeactivateTree[2] = å¥‡æ•° âœ—                              â”‚
â”‚    â€¢ DeactivateTree[3] = å¶æ•° âœ“                              â”‚
â”‚    â†’ ç”¨æˆ·å¯ä»¥é€‰æ‹©ç´¢å¼•1 æˆ– ç´¢å¼•3ï¼Œå¢åŠ äº†é€‰æ‹©ä½™åœ°              â”‚
â”‚                                                              â”‚
â”‚ 2. éšç§æ€§ - æ— æ³•è¿½è¸ªç”¨æˆ·çš„é€‰æ‹©                               â”‚
â”‚    â€¢ è§‚å¯Ÿè€…çœ‹åˆ°å¤šä¸ª deactivate leaf                          â”‚
â”‚    â€¢ æ— æ³•ç¡®å®šç”¨æˆ·ä¼šä½¿ç”¨å“ªä¸€ä¸ªè¿›è¡Œ AddNewKey                  â”‚
â”‚    â€¢ å¢åŠ äº†é“¾ä¸Šè¿½è¸ªçš„éš¾åº¦                                    â”‚
â”‚                                                              â”‚
â”‚ 3. å®‰å…¨æ€§ - Nullifier æœºåˆ¶é˜²æ­¢æ»¥ç”¨                           â”‚
â”‚    â€¢ nullifier = Hash(oldPrivKey, 1444992409218394441042n)   â”‚
â”‚    â€¢ ä¸é€‰æ‹©å“ªä¸ª deactivate leaf æ— å…³                         â”‚
â”‚    â€¢ æ— è®ºæœ‰å¤šå°‘ä¸ªå¯ç”¨çš„ leafï¼Œåªèƒ½ addNewKey ä¸€æ¬¡            â”‚
â”‚                                                              â”‚
â”‚ 4. å®ç°ç®€æ´                                                  â”‚
â”‚    â€¢ operator.ts ä¸­é€’å¢ç´¢å¼•: deactivateIndex + i            â”‚
â”‚    â€¢ æ— éœ€å¤æ‚çš„æŸ¥æ‰¾/è¦†ç›–é€»è¾‘                                 â”‚
â”‚    â€¢ æ¯ä¸ªæ¶ˆæ¯ç‹¬ç«‹å¤„ç†ï¼Œäº’ä¸å½±å“                              â”‚
â”‚                                                              â”‚
â”‚ 5. å®¹é”™æ€§å¼º                                                  â”‚
â”‚    â€¢ å³ä½¿ä¸­é—´æœ‰å¤±è´¥çš„æ¶ˆæ¯ï¼Œä¸å½±å“å‰åæˆåŠŸçš„è®°å½•              â”‚
â”‚    â€¢ å¦‚: âœ“âœ—âœ“âœ—âœ“ â†’ ç´¢å¼•1/3/5éƒ½å¯ç”¨                            â”‚
â”‚    â€¢ å¢å¼ºäº†ç³»ç»Ÿçš„å¥å£®æ€§                                      â”‚
â”‚                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯¹æ¯”: å¦‚æœé‡‡ç”¨è¦†ç›–å¼å­˜å‚¨                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åœºæ™¯: âœ“âœ— (ç¬¬ä¸€æ¬¡æˆåŠŸï¼Œç¬¬äºŒæ¬¡å¤±è´¥)                           â”‚
â”‚   è¦†ç›–å¼: åªå‰©å¥‡æ•°æ•°æ® â†’ æ— æ³• AddNewKey âŒ                   â”‚
â”‚   è¿½åŠ å¼: å¶æ•°+å¥‡æ•°éƒ½ä¿ç•™ â†’ å¯ç”¨ç´¢å¼•1 âœ“                     â”‚
â”‚                                                              â”‚
â”‚ ç»“è®º: è¿½åŠ å¼å­˜å‚¨å¤§å¤§æé«˜äº†ç³»ç»Ÿçš„å¯ç”¨æ€§ï¼                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä»£ç éªŒè¯:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// operator.ts: processDeactivateMessages

const deactivateIndex0 = this.processedDMsgCount;  // â† èµ·å§‹ç´¢å¼•

for (let i = 0; i < batchSize; i++) {
  // å…³é”®: æ¯ä¸ªæ¶ˆæ¯å æ® deactivateIndex0 + i
  deactivateLeavesPathElements[i] = this.deactivateTree.pathElementOf(
    deactivateIndex0 + i  // â† é€’å¢çš„ç´¢å¼•ï¼Œä¸æ˜¯å›ºå®šçš„ stateIdx
  );
  
  // æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½æ’å…¥åˆ°æ–°ç´¢å¼•
  this.deactivateTree.updateLeaf(
    deactivateIndex0 + i,  // â† è¿½åŠ ï¼Œä¸æ˜¯è¦†ç›–
    poseidon(dLeaf)
  );
}

// voter.ts: genAddKeyInput

// ç”¨æˆ·å¯ä»¥ä»æ‰€æœ‰ deactivate leaves ä¸­æŸ¥æ‰¾
const deactivateIdx = deactivates.findIndex(
  (d) => d[4] === sharedKeyHash  // â† æ‰¾åˆ°å±äºè‡ªå·±çš„æ‰€æœ‰è®°å½•
);

// å¦‚æœæœ‰å¤šä¸ªåŒ¹é…ï¼ŒfindIndex è¿”å›ç¬¬ä¸€ä¸ª
// ä½†ç”¨æˆ·å¯ä»¥é€šè¿‡ä¿®æ”¹æŸ¥æ‰¾é€»è¾‘æ¥é€‰æ‹©ä»»æ„ä¸€ä¸ªå¶æ•°çš„
```

#### å…¸å‹åœºæ™¯åˆ†æ

```
åœºæ™¯ 1: ç¬¬ä¸€æ¬¡ä¸Šä¼ é”™è¯¯ï¼Œç¬¬äºŒæ¬¡ä¸Šä¼ æ­£ç¡® (åºå·5: âœ—âœ“)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

åˆå§‹çŠ¶æ€:
  User (stateIdx=5):
    ActiveStateTree[5] = 0 (active)
    d1/d2 = [0, 0] (active)

ç¬¬ä¸€æ¬¡ä¸Šä¼ ï¼ˆç­¾åé”™è¯¯ï¼‰:
  âŒ checkDeactivateCommand è¿”å› 'signature error'
  âŒ ç”Ÿæˆå¥‡æ•° c1/c2
  âŒ ä¸æ›´æ–° ActiveStateTree
  âŒ æ›´æ–° DeactivateTree[0] = hash(å¥‡æ•° c1c2)

  ç»“æœ:
    ActiveStateTree[5] = 0 (ä»ç„¶ active) âœ“
    DeactivateTree[0] = hash(å¥‡æ•°æ•°æ®) âœ—

ç¬¬äºŒæ¬¡ä¸Šä¼ ï¼ˆç­¾åæ­£ç¡®ï¼‰:
  âœ… checkDeactivateCommand è¿”å› nullï¼ˆæ— é”™è¯¯ï¼‰
  âœ… ç”Ÿæˆå¶æ•° c1/c2
  âœ… æ›´æ–° ActiveStateTree[5] = é0 (inactive)
  âœ… æ›´æ–° DeactivateTree[1] = hash(å¶æ•° c1c2)

  ç»“æœ:
    ActiveStateTree[5] = é0 (inactive) âœ“
    DeactivateTree[1] = hash(å¶æ•°æ•°æ®) âœ“

æœ€ç»ˆçŠ¶æ€:
  âœ… ç”¨æˆ·æˆåŠŸ deactivated
  âœ… å¯ä»¥ä½¿ç”¨ DeactivateTree[1] çš„æ•°æ®è¿›è¡Œ AddNewKey
  âš ï¸ DeactivateTree[0] çš„å¥‡æ•°æ•°æ®ä¸å¯ç”¨ï¼ˆä¼šè¢«å¿½ç•¥ï¼‰

åœºæ™¯ 2: ç¬¬ä¸€æ¬¡æ­£ç¡®ï¼Œç¬¬äºŒæ¬¡æ­£ç¡®ï¼Œç¬¬ä¸‰æ¬¡é”™è¯¯ (åºå·8çš„åå‘: âœ“âœ“âœ—)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

åˆå§‹çŠ¶æ€:
  User (stateIdx=5):
    ActiveStateTree[5] = 0 (active)
    d1/d2 = [0, 0] (active)

ç¬¬ä¸€æ¬¡ä¸Šä¼ ï¼ˆæ­£ç¡®ï¼‰:
  âœ… ç”Ÿæˆå¶æ•° c1/c2
  âœ… æ›´æ–° ActiveStateTree[5] = 1 (inactive)
  âœ… æ›´æ–° DeactivateTree[0] = hash(å¶æ•° c1c2)

ç¬¬äºŒæ¬¡ä¸Šä¼ ï¼ˆæ­£ç¡®ï¼‰:
  âš ï¸ checkDeactivateCommand æ£€æµ‹åˆ°è´¦æˆ·å·² deactivated
  âš ï¸ å› ä¸º ActiveStateTree[5] = 1ï¼ˆå·²æ ‡è®° inactiveï¼‰
  
  // å…³é”®ä»£ç 
  const as = this.activeStateTree!.leaf(stateIdx);
  if (as !== 0n) {
    return 'inactive';  // â† è¢«æ‹’ç»
  }
  
  âŒ ç”Ÿæˆå¥‡æ•° c1/c2ï¼ˆå› ä¸ºæœ‰é”™è¯¯ï¼‰
  âŒ ä¸æ›´æ–° ActiveStateTree
  âŒ æ›´æ–° DeactivateTree[1] = hash(å¥‡æ•° c1c2)

  ç»“æœ:
    ActiveStateTree[5] = 1 (ä»ç„¶ inactive) âœ“
    DeactivateTree[1] = hash(å¥‡æ•°æ•°æ®) âœ—

ç¬¬ä¸‰æ¬¡ä¸Šä¼ ï¼ˆé”™è¯¯ï¼Œä¾‹å¦‚ç­¾åé”™è¯¯ï¼‰:
  âŒ ç”Ÿæˆå¥‡æ•° c1/c2
  âŒ ä¸æ›´æ–° ActiveStateTree
  âŒ æ›´æ–° DeactivateTree[2] = hash(å¥‡æ•° c1c2)

  ç»“æœ:
    ActiveStateTree[5] = 1 (ä»ç„¶ inactive) âœ“
    DeactivateTree[2] = hash(å¥‡æ•°æ•°æ®) âœ—

æœ€ç»ˆçŠ¶æ€:
  âœ… ç”¨æˆ·æˆåŠŸ deactivatedï¼ˆç¬¬ä¸€æ¬¡å°±æˆåŠŸäº†ï¼‰
  âš ï¸ DeactivateTree[0] = å¶æ•° âœ“ï¼ˆå¯ç”¨ï¼‰
  âš ï¸ DeactivateTree[1] = å¥‡æ•° âœ—ï¼ˆä¸å¯ç”¨ï¼‰
  âš ï¸ DeactivateTree[2] = å¥‡æ•° âœ—ï¼ˆä¸å¯ç”¨ï¼‰
  âœ… ç”¨æˆ·å¯ä»¥ä½¿ç”¨ DeactivateTree[0] çš„æ•°æ®è¿›è¡Œ AddNewKey

âœ… è®¾è®¡ä¼˜åŠ¿ï¼š
  è¿½åŠ å¼å­˜å‚¨çš„å¥½å¤„åœ¨è¿™ä¸ªåœºæ™¯ä½“ç°å¾—éå¸¸æ˜æ˜¾ï¼š
  - ç¬¬ä¸€æ¬¡æˆåŠŸçš„å¶æ•°æ•°æ®æ°¸ä¹…ä¿ç•™åœ¨ DeactivateTree[0]
  - åç»­å¤±è´¥çš„æ¶ˆæ¯åªæ˜¯è¿½åŠ åˆ°æ–°ç´¢å¼•ï¼Œä¸ä¼šç ´åä¹‹å‰çš„æ•°æ®
  - ç”¨æˆ·å¯ä»¥å®‰å…¨åœ°é€‰æ‹©ç´¢å¼•0çš„æ•°æ®è¿›è¡Œ AddNewKey
  - å¦‚æœæ˜¯è¦†ç›–å¼å­˜å‚¨ï¼Œç¬¬ä¸‰æ¬¡çš„å¥‡æ•°æ•°æ®ä¼šè¦†ç›–æ‰å¯ç”¨æ•°æ® âŒ

åœºæ™¯ 3: è¿ç»­å¤šæ¬¡æ­£ç¡®ä¸Šä¼  (åºå·7: âœ“âœ“âœ“)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ æ³¨æ„: è¿™ä¸ªåœºæ™¯å®é™…ä¸Šä¸å¯èƒ½å‘ç”Ÿï¼
å› ä¸ºç¬¬ä¸€æ¬¡ deactivate æˆåŠŸåï¼Œåç»­æ¶ˆæ¯ä¼šå› ä¸º 'inactive' é”™è¯¯è¢«æ‹’ç»ã€‚

ä½†å¦‚æœå‡è®¾è¿ç»­ä¸‰æ¬¡éƒ½æ˜¯ç‹¬ç«‹çš„æ­£ç¡®æ¶ˆæ¯ï¼ˆç»•è¿‡ inactive æ£€æŸ¥ï¼‰ï¼Œåˆ™ï¼š

åˆå§‹çŠ¶æ€:
  User (stateIdx=5):
    ActiveStateTree[5] = 0 (active)

ç¬¬ä¸€æ¬¡ä¸Šä¼ ï¼ˆæ­£ç¡®ï¼‰:
  âœ… æ›´æ–° ActiveStateTree[5] = 1
  âœ… æ›´æ–° DeactivateTree[0] = hash(å¶æ•° c1c2_1)

ç¬¬äºŒæ¬¡ä¸Šä¼ ï¼ˆå‡è®¾ä¹Ÿæ­£ç¡®ï¼‰:
  âœ… æ›´æ–° ActiveStateTree[5] = 2ï¼ˆè¦†ç›–ï¼‰
  âœ… æ›´æ–° DeactivateTree[1] = hash(å¶æ•° c1c2_2)ï¼ˆè¿½åŠ ï¼‰

ç¬¬ä¸‰æ¬¡ä¸Šä¼ ï¼ˆå‡è®¾ä¹Ÿæ­£ç¡®ï¼‰:
  âœ… æ›´æ–° ActiveStateTree[5] = 3ï¼ˆè¦†ç›–ï¼‰
  âœ… æ›´æ–° DeactivateTree[2] = hash(å¶æ•° c1c2_3)ï¼ˆè¿½åŠ ï¼‰

æœ€ç»ˆçŠ¶æ€:
  âœ… DeactivateTree[0] = å¶æ•° âœ“ï¼ˆå¯ç”¨ï¼‰
  âœ… DeactivateTree[1] = å¶æ•° âœ“ï¼ˆå¯ç”¨ï¼‰
  âœ… DeactivateTree[2] = å¶æ•° âœ“ï¼ˆå¯ç”¨ï¼‰
  ğŸ¯ ç”¨æˆ·å¯ä»¥é€‰æ‹©ä»»æ„ä¸€ä¸ªï¼ˆ0/1/2ï¼‰è¿›è¡Œ AddNewKey
  ğŸ”’ ä½† nullifier ç¡®ä¿åªèƒ½æˆåŠŸä¸€æ¬¡

ç°å®æƒ…å†µ:
  ç¬¬ä¸€æ¬¡ä¸Šä¼ ï¼ˆæ­£ç¡®ï¼‰:
    âœ… æ›´æ–° ActiveStateTree[5] = 1
    âœ… æ›´æ–° DeactivateTree[0] = hash(å¶æ•° c1c2_1)

  ç¬¬äºŒæ¬¡ä¸Šä¼ ï¼ˆä¼šè¢«æ‹’ç»ï¼‰:
    âŒ checkDeactivateCommand è¿”å› 'inactive'
    âŒ ç”Ÿæˆå¥‡æ•° c1/c2
    âŒ è¿½åŠ  DeactivateTree[1] = hash(å¥‡æ•° c1c2_2)

  ç¬¬ä¸‰æ¬¡ä¸Šä¼ ï¼ˆä¼šè¢«æ‹’ç»ï¼‰:
    âŒ checkDeactivateCommand è¿”å› 'inactive'
    âŒ ç”Ÿæˆå¥‡æ•° c1/c2
    âŒ è¿½åŠ  DeactivateTree[2] = hash(å¥‡æ•° c1c2_3)

æœ€ç»ˆçŠ¶æ€:
  âœ… ActiveStateTree[5] = 1 (inactive)
  âŒ DeactivateTree[2] = hash(å¥‡æ•°æ•°æ®)
  
  ç»“è®º:
    - ç¬¬ä¸€æ¬¡å°±æˆåŠŸäº†
    - åç»­çš„"æ­£ç¡®"æ¶ˆæ¯å®é™…ä¸Šè¢«è§†ä¸ºé”™è¯¯ï¼ˆå› ä¸ºå·² deactivatedï¼‰
    - DeactivateTree[0] çš„å¶æ•°æ•°æ®æ°¸ä¹…ä¿ç•™ï¼Œå¯ç”¨äº AddNewKey
```

#### æ ¸å¿ƒç»“è®ºæ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         DeactivateTree è¿½åŠ å¼å­˜å‚¨ vs è¦†ç›–å¼å­˜å‚¨å¯¹æ¯”           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ è¿½åŠ å¼å­˜å‚¨ï¼ˆå½“å‰å®ç°ï¼‰âœ…                                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ â€¢ æ¯ä¸ªæ¶ˆæ¯å æ®é€’å¢ç´¢å¼•: deactivateIndex + i                 â”‚
â”‚ â€¢ æ‰€æœ‰æˆåŠŸçš„è®°å½•éƒ½ä¿ç•™                                       â”‚
â”‚ â€¢ ç”¨æˆ·å¯ä»¥ä»å¤šä¸ªæœ‰æ•ˆ leaf ä¸­é€‰æ‹©                            â”‚
â”‚ â€¢ nullifier ç¡®ä¿åªèƒ½ add ä¸€æ¬¡                                â”‚
â”‚ â€¢ å®¹é”™æ€§å¼ºï¼šâœ“âœ—âœ“ â†’ ç´¢å¼•1å’Œ3éƒ½å¯ç”¨                            â”‚
â”‚                                                              â”‚
â”‚ è¦†ç›–å¼å­˜å‚¨ï¼ˆå‡è®¾ï¼‰âŒ                                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ â€¢ æ‰€æœ‰æ¶ˆæ¯æ›´æ–°åŒä¸€ä½ç½®                                       â”‚
â”‚ â€¢ æœ€åä¸€ä¸ªæ¶ˆæ¯è¦†ç›–å‰é¢çš„                                     â”‚
â”‚ â€¢ âœ“âœ— â†’ å¥‡æ•°è¦†ç›–å¶æ•° â†’ æ— æ³• AddNewKey âŒ                     â”‚
â”‚ â€¢ å®¹é”™æ€§å·®ï¼šä¸€ä¸ªå¤±è´¥æ¶ˆæ¯å°±ç ´åäº†å¯ç”¨æ•°æ®                     â”‚
â”‚                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      Nullifier æœºåˆ¶                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ nullifier = Hash(oldPrivKey, 1444992409218394441042n)        â”‚
â”‚                                                              â”‚
â”‚ ç‰¹ç‚¹:                                                        â”‚
â”‚ â€¢ ä¸é€‰æ‹©å“ªä¸ª deactivate leaf æ— å…³                           â”‚
â”‚ â€¢ åªä¾èµ–äº oldPrivKey                                        â”‚
â”‚ â€¢ ç›¸åŒç§é’¥æ°¸è¿œäº§ç”Ÿç›¸åŒ nullifier                             â”‚
â”‚ â€¢ åˆçº¦å­˜å‚¨æ‰€æœ‰ä½¿ç”¨è¿‡çš„ nullifier                             â”‚
â”‚                                                              â”‚
â”‚ å®‰å…¨æ€§:                                                      â”‚
â”‚ â€¢ å³ä½¿æœ‰ N ä¸ªå¯ç”¨çš„ deactivate leaf                          â”‚
â”‚ â€¢ åªèƒ½æˆåŠŸ addNewKey ä¸€æ¬¡                                    â”‚
â”‚ â€¢ ç¬¬äºŒæ¬¡ä¼šè¢«æ‹’ç»: ContractError::NewKeyExist                â”‚
â”‚                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    å®é™…å·¥ä½œæµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ 1. ç”¨æˆ·æäº¤ deactivate (å¯èƒ½å¤šæ¬¡)                           â”‚
â”‚    â”œâ”€ Message 1: âœ“ â†’ DeactivateTree[n+0] = å¶æ•°             â”‚
â”‚    â”œâ”€ Message 2: âœ— â†’ DeactivateTree[n+1] = å¥‡æ•°             â”‚
â”‚    â””â”€ Message 3: âœ“ â†’ DeactivateTree[n+2] = å¶æ•°             â”‚
â”‚                                                              â”‚
â”‚ 2. Operator å¤„ç†å¹¶ç”Ÿæˆ DeactivateTree                       â”‚
â”‚    â””â”€ æ‰€æœ‰æ¶ˆæ¯éƒ½ä¿ç•™åœ¨ä¸åŒç´¢å¼•                               â”‚
â”‚                                                              â”‚
â”‚ 3. ç”¨æˆ·å‡†å¤‡ AddNewKey                                        â”‚
â”‚    â”œâ”€ ä» DeactivateTree ä¸­æ‰¾åˆ°æ‰€æœ‰å±äºè‡ªå·±çš„ leaf           â”‚
â”‚    â”œâ”€ ç­›é€‰å‡ºå¶æ•°çš„ï¼ˆå¯ç”¨çš„ï¼‰                                 â”‚
â”‚    â”œâ”€ å¯é€‰ç´¢å¼• n+0 æˆ– n+2                                    â”‚
â”‚    â””â”€ ç”Ÿæˆ nullifier = Hash(oldPrivKey, CONST)              â”‚
â”‚                                                              â”‚
â”‚ 4. æäº¤ AddNewKey proof                                     â”‚
â”‚    â”œâ”€ ç¬¬ä¸€æ¬¡: nullifier æœªä½¿ç”¨ â†’ æˆåŠŸ âœ“                     â”‚
â”‚    â””â”€ ç¬¬äºŒæ¬¡: nullifier å·²å­˜åœ¨ â†’ å¤±è´¥ âœ—                     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### èƒ½å¦æ’¤é”€ Deactivateï¼Ÿ

```
ç­”æ¡ˆ: ä¸èƒ½ç›´æ¥æ’¤é”€ï¼Œä½†å¯ä»¥é€šè¿‡ AddNewKey é‡æ–°æ¿€æ´»
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ä¸ºä»€ä¹ˆä¸èƒ½æ’¤é”€:
  1. ActiveStateTree çš„è®¾è®¡
     - ä¸€æ—¦æ ‡è®°ä¸º inactiveï¼ˆé0å€¼ï¼‰
     - æ²¡æœ‰æœºåˆ¶å°†å…¶æ”¹å› 0
     - processDeactivateMessages ä¸æ”¯æŒ"æ¿€æ´»"æ“ä½œ

  2. StateTree.d1/d2 ä¸å˜
     - deactivate ä¸ä¿®æ”¹ StateTree
     - d1/d2 ä¿æŒåŸå€¼
     - æ— æ³•é€šè¿‡ä¿®æ”¹ d1/d2 æ¥"æ¢å¤"

  3. æ¶ˆæ¯éªŒè¯é€»è¾‘
     - checkDeactivateCommand ä¼šæ£€æµ‹è´¦æˆ·çŠ¶æ€
     - å¦‚æœ ActiveStateTree â‰  0ï¼Œè¿”å› 'inactive'
     - å†æ¬¡å‘é€æ¶ˆæ¯ä¼šè¢«è§†ä¸ºé”™è¯¯

å”¯ä¸€çš„"æ¿€æ´»"æ–¹å¼: AddNewKey
  1. ä½¿ç”¨ deactivate ç”Ÿæˆçš„å¶æ•° c1/c2
  2. åˆ›å»ºæ–°çš„è´¦æˆ·ï¼ˆæ–°çš„ stateIdxï¼‰
  3. æ–°è´¦æˆ·çš„ ActiveStateTree = 0 (active)
  4. æ–°è´¦æˆ·å¯ä»¥æ­£å¸¸æŠ•ç¥¨

å¯¹æ¯”:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ“ä½œ           â”‚ æ—§è´¦æˆ·       â”‚ æ–°è´¦æˆ·         â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ stateIdx       â”‚ ä¿æŒä¸å˜     â”‚ æ–°çš„ç´¢å¼•       â”‚
  â”‚ pubKey         â”‚ ä¿æŒä¸å˜     â”‚ æ–°çš„å…¬é’¥       â”‚
  â”‚ ActiveStateTreeâ”‚ é0(inactive)â”‚ 0 (active) âœ“   â”‚
  â”‚ d1/d2          â”‚ ä¿æŒå¶æ•°     â”‚ ç»§æ‰¿å¶æ•°       â”‚
  â”‚ balance        â”‚ ä¿æŒä¸å˜     â”‚ ç»§æ‰¿           â”‚
  â”‚ voTree         â”‚ ä¿æŒä¸å˜     â”‚ ç»§æ‰¿           â”‚
  â”‚ èƒ½æŠ•ç¥¨         â”‚ âŒ ä¸èƒ½      â”‚ âœ… èƒ½          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æœ€ä½³å®è·µå»ºè®®

```
å»ºè®® 1: åªå‘é€ä¸€æ¬¡ deactivate æ¶ˆæ¯
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… æ¨èåšæ³•:
  1. ä»”ç»†éªŒè¯æ¶ˆæ¯å‚æ•°
  2. ç¡®ä¿ç­¾åæ­£ç¡®
  3. å‘é€ä¸€æ¬¡åç­‰å¾…ç¡®è®¤
  4. æŸ¥è¯¢ ActiveStateTree ç¡®è®¤æˆåŠŸ

âŒ ä¸æ¨è:
  - ç›²ç›®å‘é€å¤šæ¬¡æ¶ˆæ¯
  - ä¸ç¡®è®¤å°±ç»§ç»­å‘é€
  - ä¸è®°å½•æˆåŠŸçš„ DeactivateTree ç´¢å¼•

å»ºè®® 2: å‘é€åç«‹å³éªŒè¯
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const result = await sendDeactivateMessage(...);

// ç­‰å¾… coordinator å¤„ç†
await sleep(5000);

// éªŒè¯æ˜¯å¦æˆåŠŸ
const activeState = await queryActiveState(stateIdx);

if (activeState !== 0n) {
  console.log('âœ… Deactivate æˆåŠŸ');
  console.log('DeactivateTree ç´¢å¼•:', deactivateTreeIndex);
  // è®°å½•è¿™ä¸ªç´¢å¼•ï¼ï¼ï¼
} else {
  console.log('âŒ Deactivate å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¹¶é‡è¯•');
}

å»ºè®® 3: è®°å½•æˆåŠŸçš„ DeactivateTree ç´¢å¼•
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åœ¨å®¢æˆ·ç«¯å­˜å‚¨
const deactivateRecord = {
  oldStateIdx: 5,
  deactivateTreeIdx: 0,  // â† ç¬¬ä¸€æ¬¡æˆåŠŸçš„ç´¢å¼•
  timestamp: Date.now(),
  activeStateBefore: 0n,
  activeStateAfter: 1n,
  txHash: '0x...'
};

localStorage.setItem(
  `deactivate_${oldStateIdx}`,
  JSON.stringify(deactivateRecord)
);

// AddNewKey æ—¶ä½¿ç”¨
const record = JSON.parse(
  localStorage.getItem(`deactivate_${oldStateIdx}`)
);

const deactivateData = await queryDeactivateTree(
  record.deactivateTreeIdx  // â† ä½¿ç”¨è®°å½•çš„ç´¢å¼•
);

å»ºè®® 4: å®ç°å¹‚ç­‰æ€§æ£€æŸ¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function safeDeactivate(stateIdx) {
  // æ£€æŸ¥æ˜¯å¦å·²ç» deactivated
  const activeState = await queryActiveState(stateIdx);
  
  if (activeState !== 0n) {
    console.log('âš ï¸ è´¦æˆ·å·²ç» deactivated');
    console.log('å¦‚éœ€é‡æ–°æ¿€æ´»ï¼Œè¯·ä½¿ç”¨ AddNewKey');
    return { alreadyDeactivated: true };
  }
  
  // æ‰§è¡Œ deactivate
  const result = await sendDeactivateMessage(stateIdx);
  
  return result;
}
```

#### æ•…éšœæ¢å¤ç­–ç•¥

```
åœºæ™¯: å‘é€äº†å¤šä¸ª deactivate æ¶ˆæ¯ï¼Œä¸ç¡®å®šå“ªä¸ªæˆåŠŸäº†
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç­–ç•¥ 1: æŸ¥è¯¢ ActiveStateTree ç¡®å®šæ˜¯å¦æˆåŠŸ
  const activeState = await queryActiveState(oldStateIdx);
  
  if (activeState !== 0n) {
    console.log('âœ… è‡³å°‘æœ‰ä¸€ä¸ªæ¶ˆæ¯æˆåŠŸäº†');
  } else {
    console.log('âŒ æ‰€æœ‰æ¶ˆæ¯éƒ½å¤±è´¥äº†');
  }

ç­–ç•¥ 2: éå† DeactivateTree æŸ¥æ‰¾å¶æ•°æ•°æ®ï¼ˆéœ€è¦ coordinator æƒé™ï¼‰
  // ä»… coordinator å¯ä»¥æ‰§è¡Œï¼ˆéœ€è¦ç§é’¥è§£å¯†ï¼‰
  for (let i = startIdx; i < endIdx; i++) {
    const deactivateLeaf = await queryDeactivateTree(i);
    
    if (deactivateLeaf) {
      const decrypted = decrypt(coordPrivKey, {
        c1: { x: deactivateLeaf[0], y: deactivateLeaf[1] },
        c2: { x: deactivateLeaf[2], y: deactivateLeaf[3] },
        xIncrement: 0n
      });
      
      if (decrypted % 2n === 0n) {
        console.log(`âœ… æ‰¾åˆ°å¯ç”¨çš„æ•°æ®åœ¨ç´¢å¼• ${i}`);
        return { index: i, data: deactivateLeaf };
      }
    }
  }

ç­–ç•¥ 3: å¦‚æœä¸ç¡®å®šï¼Œé‡æ–° deactivateï¼ˆä»…å½“ ActiveStateTree = 0 æ—¶ï¼‰
  const activeState = await queryActiveState(oldStateIdx);
  
  if (activeState === 0n) {
    console.log('è´¦æˆ·ä»ç„¶ activeï¼Œå¯ä»¥é‡æ–°å‘é€');
    await sendDeactivateMessage(oldStateIdx);
  } else {
    console.log('è´¦æˆ·å·² deactivatedï¼Œä½¿ç”¨ç°æœ‰æ•°æ®æˆ–è”ç³»ç®¡ç†å‘˜');
  }
```

#### è®¾è®¡è€ƒè™‘

```
ä¸ºä»€ä¹ˆå…è®¸å¤šæ¬¡æäº¤ï¼Ÿ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ä¼˜ç‚¹:
  âœ… ç”¨æˆ·ä½“éªŒå‹å¥½
     - å¦‚æœç¬¬ä¸€æ¬¡å¤±è´¥ï¼Œå¯ä»¥é‡è¯•
     - ä¸éœ€è¦å¤æ‚çš„"æ’¤å›"æœºåˆ¶
  
  âœ… ç½‘ç»œå®¹é”™
     - æ¶ˆæ¯å¯èƒ½åœ¨ä¼ è¾“ä¸­ä¸¢å¤±
     - å…è®¸é‡å‘æé«˜å¯é æ€§
  
  âœ… ç®€åŒ–åˆçº¦é€»è¾‘
     - ä¸éœ€è¦ç»´æŠ¤"å·²æäº¤"çŠ¶æ€
     - å¤„ç†é€»è¾‘ç»Ÿä¸€

ä¸ºä»€ä¹ˆæœ€åä¸€ä¸ªæ¶ˆæ¯å†³å®š DeactivateTreeï¼Ÿ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è®¾è®¡é€‰æ‹©:
  â€¢ ç®€åŒ–å®ç°ï¼šè¦†ç›–è€Œä¸æ˜¯è¿½åŠ 
  â€¢ èŠ‚çœç©ºé—´ï¼šæ¯ä¸ªè´¦æˆ·åªæœ‰ä¸€ä¸ª deactivate è®°å½•
  â€¢ æ˜ç¡®è¯­ä¹‰ï¼šæœ€æ–°çš„æ¶ˆæ¯ä»£è¡¨æœ€ç»ˆæ„å›¾

æ½œåœ¨é—®é¢˜:
  âš ï¸ å¦‚æœç”¨æˆ·ä¸çŸ¥é“å·² deactivated
     â†’ å†æ¬¡å‘é€ä¼šç”Ÿæˆå¥‡æ•°æ•°æ®
     â†’ è¦†ç›–åŸæœ¬å¯ç”¨çš„å¶æ•°æ•°æ®
  
  è§£å†³æ–¹æ¡ˆ:
     âœ… å®¢æˆ·ç«¯æ£€æŸ¥ ActiveStateTree
     âœ… è®°å½•ç¬¬ä¸€æ¬¡æˆåŠŸçš„ç´¢å¼•
     âœ… æä¾›æ¸…æ™°çš„ç”¨æˆ·æç¤º

æ”¹è¿›å»ºè®®ï¼ˆæœªæ¥ç‰ˆæœ¬ï¼‰:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1. åœ¨åˆçº¦å±‚æ·»åŠ å¹‚ç­‰æ€§æ£€æŸ¥
   - å¦‚æœ ActiveStateTree â‰  0ï¼Œæ‹’ç»æ¶ˆæ¯
   - é˜²æ­¢ç”¨æˆ·æ„å¤–è¦†ç›–

2. DeactivateTree ä½¿ç”¨è¿½åŠ æ¨¡å¼
   - æ¯ä¸ªè´¦æˆ·å¯ä»¥æœ‰å¤šä¸ª deactivate è®°å½•
   - ç”¨æˆ·é€‰æ‹©ä½¿ç”¨å“ªä¸ª

3. æä¾›æŸ¥è¯¢æ¥å£
   - è¿”å›æŸä¸ªè´¦æˆ·çš„æ‰€æœ‰ deactivate è®°å½•
   - æ ‡æ³¨å“ªäº›æ˜¯å¶æ•°ï¼ˆå¯ç”¨ï¼‰
```

#### æ€»ç»“è¡¨æ ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å¤šæ¬¡ Deactivate æ ¸å¿ƒè§„åˆ™                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. å¯ä»¥å‘é€å¤šæ¬¡ deactivate æ¶ˆæ¯                                â”‚
â”‚ 2. æ¯ä¸ªæ¶ˆæ¯ç‹¬ç«‹éªŒè¯ï¼ˆç­¾åã€nonceã€çŠ¶æ€ï¼‰                       â”‚
â”‚ 3. é”™è¯¯æ¶ˆæ¯ç”Ÿæˆå¥‡æ•° c1/c2ï¼Œä¸æ›´æ–° ActiveStateTree             â”‚
â”‚ 4. æ­£ç¡®æ¶ˆæ¯ç”Ÿæˆå¶æ•° c1/c2ï¼Œæ›´æ–° ActiveStateTree               â”‚
â”‚ 5. ActiveStateTree ç”±æœ€åä¸€ä¸ªæœ‰æ•ˆæ¶ˆæ¯å†³å®š                      â”‚
â”‚ 6. DeactivateTree ç”±æœ€åä¸€ä¸ªæ¶ˆæ¯å†³å®šï¼ˆæ— è®ºæ­£ç¡®ä¸å¦ï¼‰          â”‚
â”‚ 7. ä¸èƒ½æ’¤é”€ deactivateï¼Œåªèƒ½é€šè¿‡ AddNewKey é‡æ–°æ¿€æ´»           â”‚
â”‚ 8. å»ºè®®åªå‘é€ä¸€æ¬¡ï¼Œå¹¶éªŒè¯æˆåŠŸ                                  â”‚
â”‚ 9. è®°å½•æˆåŠŸçš„ DeactivateTree ç´¢å¼•ä»¥ä¾¿ AddNewKey ä½¿ç”¨          â”‚
â”‚ 10. å®ç°å¹‚ç­‰æ€§æ£€æŸ¥é¿å…æ„å¤–è¦†ç›–                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®‰å…¨ä¿éšœ:
  âœ… é”™è¯¯æ¶ˆæ¯ä¸ä¼šç ´åè´¦æˆ·çŠ¶æ€
  âœ… ActiveStateTree åªåœ¨æ¶ˆæ¯æœ‰æ•ˆæ—¶æ›´æ–°
  âœ… å¥‡æ•° c1/c2 è‡ªåŠ¨éš”ç¦»ï¼Œæ— æ³•åˆ›å»ºå¯ç”¨è´¦æˆ·
  âœ… æœ€å¤šåªæœ‰ä¸€ä¸ªè´¦æˆ·å¯ç”¨ï¼ˆold æˆ– newï¼Œä¸ä¼šåŒæ—¶ï¼‰
```

---

## é™„å½•

### ç›¸å…³æ–‡ä»¶æ¸…å•

```
æ–‡æ¡£:
  â”œâ”€â”€ AMACI-ProcessMessages-Analysis.md
  â”œâ”€â”€ AMACI-Tree-Structure-Analysis.md  
  â”œâ”€â”€ AMACI-Deactivate-Detection-Flow.md
  â”œâ”€â”€ AMACI-AddNewKey-Security-Analysis.md
  â”œâ”€â”€ AMACI-AddNewKey-State-Transition.md
  â”œâ”€â”€ AMACI-ProcessMessages-Tests-Summary.md
  â””â”€â”€ AMACI_DEACTIVATE_COMPLETE_GUIDE.md (æœ¬æ–‡æ¡£)

ç”µè·¯:
  â”œâ”€â”€ packages/circuits/circom/amaci/power/processMessages.circom
  â”œâ”€â”€ packages/circuits/circom/amaci/power/stateLeafTransformer.circom
  â”œâ”€â”€ packages/circuits/circom/amaci/power/processDeactivate.circom
  â””â”€â”€ packages/circuits/circom/amaci/addNewKey.circom

SDK:
  â”œâ”€â”€ packages/sdk/src/operator.ts
  â”œâ”€â”€ packages/sdk/src/voter.ts
  â””â”€â”€ packages/sdk/src/crypto.ts

åˆçº¦:
  â”œâ”€â”€ contracts/amaci/src/contract.rs
  â”œâ”€â”€ contracts/amaci/src/state.rs
  â””â”€â”€ contracts/amaci/src/msg.rs

æµ‹è¯•:
  â”œâ”€â”€ packages/circuits/ts/__tests__/ProcessMessagesAmaci.test.ts
  â”œâ”€â”€ packages/circuits/ts/__tests__/DeactivateStatusDetection.test.ts
  â”œâ”€â”€ packages/circuits/ts/__tests__/ProcessMessagesAmaciIntegration.test.ts
  â”œâ”€â”€ packages/circuits/ts/__tests__/ProcessMessagesAmaciEdgeCases.test.ts
  â”œâ”€â”€ packages/circuits/ts/__tests__/ProcessMessagesAmaciSecurity.test.ts
  â””â”€â”€ packages/circuits/ts/__tests__/ProcessMessagesAmaciSync.test.ts
```

### å…³é”®å¸¸é‡

```typescript
// Nullifier salt
const NULLIFIER_SALT = 1444992409218394441042n;

// genStaticRandomKey salt
const GEN_RANDOM_SALT = 20040n;

// åˆå§‹ active çŠ¶æ€ hash
const INITIAL_ACTIVE_HASH = poseidon5([0n, 0n, 0n, 0n, 0n]);
// = 14655542659562014735865511769057053982292279840403315552050801315682099828156n

// Tree depths
const STATE_TREE_DEPTH = 10;  // æ”¯æŒ 5^10 = 9,765,625 ä¸ªç”¨æˆ·
const VOTE_OPTION_TREE_DEPTH = 4;  // æ”¯æŒ 5^4 = 625 ä¸ªé€‰é¡¹
```

### æ€§èƒ½æŒ‡æ ‡

```
ç”µè·¯çº¦æŸæ•°é‡ (ä¼°ç®—):
  ProcessMessages (AMACI):  ~2.5M çº¦æŸ
  ProcessDeactivate:        ~1.2M çº¦æŸ
  AddNewKey:                ~800K çº¦æŸ

Proof ç”Ÿæˆæ—¶é—´:
  ProcessMessages:  ~30-60 ç§’
  ProcessDeactivate: ~15-30 ç§’
  AddNewKey:        ~10-20 ç§’

Gas æ¶ˆè€— (Ethereum):
  signup:           ~150K gas
  add_new_key:      ~200K gas
  verify_proof:     ~300K gas
```

---

## æ€»ç»“

AMACI é€šè¿‡ä»¥ä¸‹åˆ›æ–°å®ç°åŒ¿åå¯†é’¥æ›´æ¢ï¼š

1. **10å­—æ®µ StateLeaf** - æ·»åŠ  ElGamal åŠ å¯†å­—æ®µ
2. **ActiveStateTree** - å¿«é€ŸçŠ¶æ€æŸ¥è¯¢
3. **DeactivateTree** - å®‰å…¨çš„æ•°æ®ä¼ é€’
4. **åŒå±‚éªŒè¯** - ActiveTree + d1/d2 æ£€æŸ¥
5. **Nullifier** - é˜²é‡æ”¾æ”»å‡»
6. **ECDH ç»‘å®š** - é˜²æ­¢æ•°æ®ç›—ç”¨
7. **å¥‡å¶æ€§ç¼–ç ** - ä¼˜é›…çš„é”™è¯¯å¤„ç† â­

### å…³é”®å®‰å…¨ç‰¹æ€§

```
å®¹é”™æœºåˆ¶:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… é”™è¯¯æ¶ˆæ¯ä¸ä¼šç ´ååŸè´¦æˆ·
   - ActiveStateTree ä¿æŒä¸å˜
   - d1/d2 ä¿æŒåŸå€¼
   - ç”¨æˆ·å¯ä»¥ç»§ç»­ä½¿ç”¨

âœ… ä¸å¯èƒ½åŒæ—¶æ‹¥æœ‰ä¸¤ä¸ªå¯ç”¨è´¦æˆ·
   - æ­£ç¡® deactivate: old ä¸å¯ç”¨ï¼Œnew å¯ç”¨
   - é”™è¯¯ deactivate: old å¯ç”¨ï¼Œnew ä¸å¯ç”¨
   - æ•°å­¦è¯æ˜ï¼šæœ€å¤šä¸€ä¸ªè´¦æˆ·å¯ç”¨

âœ… å¥‡æ•° d1/d2 è´¦æˆ·ä¸å¯ä¿®å¤
   - æ— æ³•æŠ•ç¥¨
   - æ— æ³• deactivate
   - æ— æ³•åˆ›å»ºå¯ç”¨çš„åä»£è´¦æˆ·
   - é˜²æ­¢ Sybil æ”»å‡»

é˜²å¾¡çºµæ·±:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Layer 1: ActiveStateTree æ£€æŸ¥
  âœ å¿«é€Ÿè¯†åˆ« deactivated ç”¨æˆ·

Layer 2: d1/d2 è§£å¯†æ£€æŸ¥
  âœ é˜²å¾¡æ•°æ®æŸåå’Œç¯¡æ”¹

Layer 3: å¥‡å¶æ€§ä¼ é€’
  âœ é”™è¯¯æ•°æ®æ°¸ä¹…éš”ç¦»

Layer 4: Circuit çº¦æŸ
  âœ æ‰€æœ‰æ“ä½œç»è¿‡ ZK éªŒè¯
```

è¿™äº›æœºåˆ¶å…±åŒä¿è¯äº†ï¼š
- âœ… éšç§ä¿æŠ¤
- âœ… å®‰å…¨æ€§
- âœ… é˜²ç¯¡æ”¹
- âœ… å¯éªŒè¯æ€§
- âœ… å®¹é”™æ€§ â­
- âœ… é˜² Sybil æ”»å‡» â­

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.5  
**æœ€åæ›´æ–°**: 2024-12-23  
**æ›´æ–°å†…å®¹**: 
  - v1.5 (2024-12-23): æ·»åŠ  Q9 å’Œ Q10 å¸¸è§é—®é¢˜ â­ é‡è¦
    * Q9: ç”¨æˆ·èƒ½å¦åœ¨å®¢æˆ·ç«¯æ£€æŸ¥ c1/c2 å¥‡å¶æ€§ï¼ˆçº¦400è¡Œï¼‰
      - è§£é‡Šä¸ºä»€ä¹ˆç”¨æˆ·æ— æ³•æ£€æŸ¥ï¼ˆæ—¶é—´å·®ã€ä¾èµ–ã€éœ€è¦ç§é’¥ï¼‰
      - æä¾›å®Œæ•´çš„å‘é€å‰/å‘é€åéªŒè¯ä»£ç ç¤ºä¾‹
      - åŒ…å«æœ€ä½³å®è·µã€æ•…éšœæ’æŸ¥ã€è®¾è®¡å“²å­¦è¯´æ˜
      - å¯¹æ¯”ç”¨æˆ· vs Coordinator çš„èƒ½åŠ›
    * Q10: å¤šæ¬¡æäº¤ deactivate message çš„æ‰€æœ‰å¯èƒ½æ€§ï¼ˆçº¦500è¡Œï¼‰
      - 10ç§æ¶ˆæ¯åºåˆ—ç»„åˆçš„å®Œæ•´çŸ©é˜µ
      - 3ä¸ªå…¸å‹åœºæ™¯çš„è¯¦ç»†åˆ†æ
      - èƒ½å¦æ’¤é”€ deactivate çš„æ·±å…¥è§£ç­”
      - æœ€ä½³å®è·µå»ºè®®ï¼ˆ4æ¡ï¼‰å’Œæ•…éšœæ¢å¤ç­–ç•¥ï¼ˆ3æ¡ï¼‰
      - è®¾è®¡è€ƒè™‘å’Œæ”¹è¿›å»ºè®®
  - v1.4 (2024-12-23): æ·»åŠ "çŠ¶æ€ç»„åˆè¯¦è§£"ç« èŠ‚ â­ é‡è¦
    * è¯¦ç»†åˆ†æå››ç§ d1/d2 ä¸ ActiveStateTree çš„ç»„åˆçŠ¶æ€
    * è¯´æ˜æ¯ç§çŠ¶æ€çš„äº§ç”Ÿæ–¹å¼ã€äº¤äº’æµç¨‹å’Œå®‰å…¨å«ä¹‰
    * æ·»åŠ å®Œæ•´çš„çŠ¶æ€è½¬æ¢å›¾ï¼ˆåŒ…å«æ‰€æœ‰4ç§çŠ¶æ€ï¼‰
    * æä¾›ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µå»ºè®®
    * é˜è¿°åŒå±‚æ£€æŸ¥æœºåˆ¶å¦‚ä½•ä¿æŠ¤ç³»ç»Ÿå®‰å…¨
  - v1.3 (2024-12-22): ä¿®å¤ DeactivateTree çš„æè¿°é”™è¯¯ â­ é‡è¦
    * æ¾„æ¸… DeactivateTree å­˜å‚¨çš„æ˜¯ Operator ç”Ÿæˆçš„ c1/c2ï¼ˆç¬¬ä¸€æ¬¡åŠ å¯†ï¼‰
    * æ˜ç¡®é‡éšæœºåŒ–å‘ç”Ÿåœ¨ AddNewKey æ—¶ï¼ˆç”¨æˆ·ä¾§ï¼‰ï¼Œä¸æ˜¯ processDeactivateMessages
    * è¯´æ˜ d1/d2 æ˜¯é‡éšæœºåŒ–çš„ç»“æœï¼Œå­˜åœ¨ StateTree leaf ä¸­
    * æ·»åŠ å®Œæ•´çš„æ•°æ®æµç¨‹è¯´æ˜
  - v1.2 (2024-12-22): ä¿®å¤ genStaticRandomKey å’Œ newActiveState çš„æè¿°é”™è¯¯
    * ä¿®æ­£ newActiveState çš„å®é™…å«ä¹‰ï¼ˆé€’å¢è®¡æ•°å™¨ï¼Œé hash ç»“æœï¼‰
    * æ·»åŠ å®Œæ•´çš„æ•°å€¼ç¤ºä¾‹å’Œä¸‰æ£µæ ‘çš„å¯è§†åŒ–
    * æ·»åŠ è¯¦ç»†çš„æ•°æ®æµå›¾ç¤º
    * è¡¥å……é”™è¯¯æ¶ˆæ¯å¤„ç†çš„å®Œæ•´ç¤ºä¾‹
  - v1.1 (2024-12-21): æ·»åŠ é”™è¯¯æ¶ˆæ¯å¤„ç†å’Œå®‰å…¨åˆ†æ (Q7, Q8, å®‰å…¨æœºåˆ¶ç¬¬5èŠ‚)
**ä½œè€…**: AMACI Team  
**è®¸å¯**: MIT

