# SDK Pack/Unpack é›†æˆæµ‹è¯•æ–‡æ¡£

## ğŸ“‹ æ¦‚è§ˆ

æœ¬æ–‡æ¡£æè¿°äº†åœ¨ `UnpackElement.test.ts` ä¸­æ–°å¢çš„ SDK é›†æˆæµ‹è¯•å¥—ä»¶ï¼Œç”¨äºéªŒè¯ SDK çš„ `packElement`/`unpackElement` å‡½æ•°ä¸ç”µè·¯çš„ `UnpackElement` æ¨¡æ¿ä¹‹é—´çš„å…¼å®¹æ€§ã€‚

## ğŸ¯ æµ‹è¯•ç›®æ ‡

éªŒè¯ç«¯åˆ°ç«¯çš„æ•°æ®æµï¼š
```
SDK packElement â†’ ç”µè·¯ UnpackElement â†’ SDK unpackElement
```

## ğŸ“¦ æ•°æ®æ ¼å¼

### SDK Pack æ ¼å¼ (pack.ts)
```typescript
packed = nonce + (stateIdx << 32) + (voIdx << 64) + (newVotes << 96) + (salt << 192)
```

### ç”µè·¯ Unpack æ ¼å¼ (UnpackElement(6))
```
out[5] = nonce         (bits 0-31)
out[4] = stateIdx      (bits 32-63)
out[3] = voIdx         (bits 64-95)
out[2] = newVotes[0]   (bits 96-127)
out[1] = newVotes[1]   (bits 128-159)
out[0] = newVotes[2]   (bits 160-191)
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ä½æ•° | èŒƒå›´ | è¯´æ˜ |
|------|------|------|------|
| `nonce` | 32 bits | 0 ~ 2^32-1 | æ¶ˆæ¯éšæœºæ•°ï¼Œé˜²æ­¢é‡æ”¾æ”»å‡» |
| `stateIdx` | 32 bits | 0 ~ 2^32-1 | æŠ•ç¥¨è€…åœ¨çŠ¶æ€æ ‘ä¸­çš„ç´¢å¼• |
| `voIdx` | 32 bits | 0 ~ 2^32-1 | æŠ•ç¥¨é€‰é¡¹ç´¢å¼• |
| `newVotes` | 96 bits | 0 ~ 2^96-1 | æ–°çš„æŠ•ç¥¨æƒé‡ï¼ˆUint96ï¼‰ |
| `salt` | 56 bits | 0 ~ 2^56-1 | ç›å€¼ï¼ˆå¯é€‰ï¼Œç”¨äºéšæœºåŒ–ï¼‰ |

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### 1. åŸºç¡€å…¼å®¹æ€§æµ‹è¯•
**æ–‡ä»¶**: `UnpackElement.test.ts:563-621`

æµ‹è¯•ç®€å•å€¼çš„æ‰“åŒ…å’Œè§£åŒ…ï¼š
```typescript
nonce: 1, stateIdx: 5, voIdx: 2, newVotes: 100
```

**éªŒè¯ç‚¹**ï¼š
- âœ… SDK æ­£ç¡®æ‰“åŒ…æ•°æ®
- âœ… ç”µè·¯æ­£ç¡®è§£åŒ…æ•°æ®
- âœ… å„å­—æ®µå€¼åŒ¹é…åŸå§‹è¾“å…¥

### 2. è¾¹ç•Œå€¼æµ‹è¯•
**æ–‡ä»¶**: `UnpackElement.test.ts:623-657`

æµ‹è¯•æœ€å¤§ 32 ä½å€¼ï¼š
```typescript
nonce: 0xFFFFFFFF, stateIdx: 0xFFFFFFFF, voIdx: 0xFFFFFFFF, newVotes: 0xFFFFFFFF
```

**éªŒè¯ç‚¹**ï¼š
- âœ… å¤„ç†æœ€å¤§ 32 ä½å€¼
- âœ… æ— æº¢å‡ºé—®é¢˜
- âœ… è¾¹ç•Œå€¼æ­£ç¡®è§£åŒ…

### 3. å¤§æ•°å€¼æµ‹è¯•
**æ–‡ä»¶**: `UnpackElement.test.ts:659-700`

æµ‹è¯•å¤§çš„ `newVotes` å€¼ï¼ˆ96 ä½ï¼‰ï¼š
```typescript
newVotes: 1,000,000,000,000 (1 ä¸‡äº¿)
```

**éªŒè¯ç‚¹**ï¼š
- âœ… æ­£ç¡®å¤„ç†è·¨å¤šä¸ª 32 ä½å—çš„å€¼
- âœ… 96 ä½å€¼æ­£ç¡®é‡æ„
- âœ… é«˜ä½å’Œä½ä½æ­£ç¡®åˆ†ç¦»

### 4. æœ€å¤§ 96 ä½å€¼æµ‹è¯•
**æ–‡ä»¶**: `UnpackElement.test.ts:702-743`

æµ‹è¯•æœ€å¤§ Uint96 å€¼ï¼š
```typescript
newVotes: 2^96 - 1 = 79,228,162,514,264,337,593,543,950,335
```

**éªŒè¯ç‚¹**ï¼š
- âœ… å¤„ç†æœ€å¤§ 96 ä½å€¼
- âœ… æ‰€æœ‰ 3 ä¸ª 32 ä½å—éƒ½æ˜¯ 0xFFFFFFFF
- âœ… æ­£ç¡®é‡æ„å®Œæ•´å€¼

### 5. ç›å€¼æµ‹è¯•
**æ–‡ä»¶**: `UnpackElement.test.ts:745-781`

æµ‹è¯•éé›¶ç›å€¼ä¸å½±å“è§£åŒ…ï¼š
```typescript
salt: 0x12345678ABCD (éšæœº 56 ä½ç›)
```

**éªŒè¯ç‚¹**ï¼š
- âœ… ç›å€¼ä¸å¹²æ‰°å‰ 192 ä½
- âœ… è§£åŒ…ç»“æœä¸å—ç›å€¼å½±å“
- âœ… SDK unpack æ­£ç¡®å¿½ç•¥ç›å€¼

### 6. å¾€è¿”ä¸€è‡´æ€§æµ‹è¯•
**æ–‡ä»¶**: `UnpackElement.test.ts:783-836`

æµ‹è¯•å¤šç»„æ•°æ®çš„å®Œæ•´å¾€è¿”ï¼š
```typescript
æµ‹è¯•ç”¨ä¾‹é›†: [
  { nonce: 0, stateIdx: 0, voIdx: 0, newVotes: 0 },
  { nonce: 1, stateIdx: 1, voIdx: 1, newVotes: 1 },
  { nonce: 255, stateIdx: 255, voIdx: 255, newVotes: 255 },
  { nonce: 1000, stateIdx: 2000, voIdx: 3000, newVotes: 4000 },
  { nonce: 65535, stateIdx: 65535, voIdx: 65535, newVotes: 65535 }
]
```

**éªŒè¯ç‚¹**ï¼š
- âœ… SDK pack â†’ circuit unpack â†’ SDK unpack ä¿æŒä¸€è‡´
- âœ… ç”µè·¯è¾“å‡ºåŒ¹é… SDK unpack è¾“å‡º
- âœ… æœ€ç»ˆå€¼åŒ¹é…åŸå§‹è¾“å…¥
- âœ… å¤šç»„æµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡

### 7. é›¶å€¼æµ‹è¯•
**æ–‡ä»¶**: `UnpackElement.test.ts:838-871`

æµ‹è¯•æ‰€æœ‰å­—æ®µä¸ºé›¶çš„è¾¹ç•Œæƒ…å†µï¼š
```typescript
nonce: 0, stateIdx: 0, voIdx: 0, newVotes: 0, salt: 0
```

**éªŒè¯ç‚¹**ï¼š
- âœ… packed å€¼ä¸º 0
- âœ… æ‰€æœ‰è¾“å‡ºä¸º 0
- âœ… é›¶å€¼æ­£ç¡®å¤„ç†

## ğŸ”„ æ•°æ®æµç¤ºä¾‹

### ç¤ºä¾‹ 1: ç®€å•æŠ•ç¥¨å‘½ä»¤

```typescript
// è¾“å…¥æ•°æ®
const input = {
  nonce: 1,
  stateIdx: 5,
  voIdx: 2,
  newVotes: 100,
  salt: 0n
};

// SDK æ‰“åŒ…
const packed = packElement(input);
// packed = 1 + (5 << 32) + (2 << 64) + (100 << 96) + (0 << 192)
// packed = 0x0000000000000064000000000000000200000005_00000001

// ç”µè·¯è§£åŒ… (UnpackElement(6))
// out[5] = 0x00000001 = 1          (nonce)
// out[4] = 0x00000005 = 5          (stateIdx)
// out[3] = 0x00000002 = 2          (voIdx)
// out[2] = 0x00000064 = 100        (newVotes low)
// out[1] = 0x00000000 = 0          (newVotes mid)
// out[0] = 0x00000000 = 0          (newVotes high)

// SDK è§£åŒ…éªŒè¯
const unpacked = unpackElement(packed);
// unpacked = { nonce: 1n, stateIdx: 5n, voIdx: 2n, newVotes: 100n }
```

### ç¤ºä¾‹ 2: å¤§æ•°å€¼æŠ•ç¥¨

```typescript
// è¾“å…¥æ•°æ®
const input = {
  nonce: 10,
  stateIdx: 20,
  voIdx: 30,
  newVotes: 1_000_000_000_000, // 1 ä¸‡äº¿ = 0xE8D4A51000
  salt: 0n
};

// SDK æ‰“åŒ…
const packed = packElement(input);

// ç”µè·¯è§£åŒ…
// out[5] = 0x0000000A = 10
// out[4] = 0x00000014 = 20
// out[3] = 0x0000001E = 30
// out[2] = 0xD4A51000 (newVotes çš„ä½ 32 ä½)
// out[1] = 0x000000E8 (newVotes çš„ä¸­ 32 ä½)
// out[0] = 0x00000000 (newVotes çš„é«˜ 32 ä½)

// é‡æ„ newVotes
const newVotes = out[2] | (out[1] << 32n) | (out[0] << 64n);
// newVotes = 1_000_000_000_000 âœ…
```

## ğŸ” å…³é”®æŠ€æœ¯ç‚¹

### 1. ä½åºåè½¬
ç”µè·¯çš„ `UnpackElement` è¾“å‡ºé¡ºåºä¸ SDK çš„é€»è¾‘é¡ºåºç›¸åï¼š
- **SDK**: ä½ä½åœ¨å‰ï¼Œé«˜ä½åœ¨åï¼ˆå°ç«¯åºï¼‰
- **ç”µè·¯**: é«˜ä½åœ¨å‰ï¼Œä½ä½åœ¨åï¼ˆå¤§ç«¯åºè¾“å‡ºï¼‰

```
SDK è§†è§’:  [ä½ä½ â†’ é«˜ä½]
           nonce | stateIdx | voIdx | newVotes

ç”µè·¯è§†è§’:  [é«˜ä½ â†’ ä½ä½]
           out[0] | out[1] | ... | out[5]
```

### 2. 96 ä½å€¼å¤„ç†
`newVotes` æ˜¯ 96 ä½ï¼ˆUint96ï¼‰ï¼Œéœ€è¦è·¨ 3 ä¸ª 32 ä½å—ï¼š

```typescript
// æ‰“åŒ… (SDK)
packed |= (newVotes << 96n)

// è§£åŒ… (ç”µè·¯)
out[2] = bits[96..127]   // ä½ 32 ä½
out[1] = bits[128..159]  // ä¸­ 32 ä½
out[0] = bits[160..191]  // é«˜ 32 ä½

// é‡æ„ (æµ‹è¯•)
reconstructed = out[2] | (out[1] << 32n) | (out[0] << 64n)
```

### 3. ç›å€¼éš”ç¦»
ç›å€¼å­˜å‚¨åœ¨ bits[192..247]ï¼Œä¸å½±å“å‰ 6 ä¸ªè¾“å‡ºï¼š

```
[nonce][stateIdx][voIdx][newVotes ......][salt ....]
 0-31   32-63     64-95   96-191           192-247
 out[5] out[4]    out[3]  out[2-0]         (ignored)
```

## ğŸš€ è¿è¡Œæµ‹è¯•

```bash
# è¿›å…¥ circuits ç›®å½•
cd packages/circuits

# è¿è¡Œæ‰€æœ‰ UnpackElement æµ‹è¯•
npm test -- --grep "UnpackElement"

# åªè¿è¡Œ SDK é›†æˆæµ‹è¯•
npm test -- --grep "SDK Integration"

# è¿è¡Œå•ä¸ªæµ‹è¯•
npm test -- --grep "should correctly unpack SDK-packed data"
```

## âœ… æµ‹è¯•è¦†ç›–ç‡

| æµ‹è¯•ç±»åˆ« | æµ‹è¯•æ•°é‡ | è¦†ç›–èŒƒå›´ |
|---------|---------|---------|
| åŸºç¡€åŠŸèƒ½ | 1 | ç®€å•å€¼æ‰“åŒ…/è§£åŒ… |
| è¾¹ç•Œå€¼ | 2 | æœ€å¤§ 32 ä½ã€æœ€å¤§ 96 ä½ |
| å¤§æ•°å€¼ | 1 | è·¨å—çš„å¤§æ•°å€¼ |
| ç‰¹æ®Šæƒ…å†µ | 2 | ç›å€¼ã€é›¶å€¼ |
| å¾€è¿”æµ‹è¯• | 1 | å®Œæ•´æµç¨‹éªŒè¯ |
| **æ€»è®¡** | **7** | **å®Œæ•´ç«¯åˆ°ç«¯éªŒè¯** |

## ğŸ”— ç›¸å…³æ–‡ä»¶

- **æµ‹è¯•æ–‡ä»¶**: `packages/circuits/ts/__tests__/UnpackElement.test.ts`
- **SDK Pack**: `packages/sdk/src/libs/crypto/pack.ts`
- **ç”µè·¯æ–‡ä»¶**: `packages/circuits/circom/utils/unpackElement.circom`
- **ä½¿ç”¨ç¤ºä¾‹**: `packages/circuits/circom/utils/messageToCommand.circom`

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç±»å‹è½¬æ¢**: æµ‹è¯•ä¸­ SDK å‡½æ•°æ¥å— `number` ç±»å‹ï¼Œä½†åœ¨å¤„ç†å¤§å€¼æ—¶éœ€è¦è½¬æ¢ä¸º `bigint`

2. **ä½åºç†è§£**: ç†è§£ç”µè·¯è¾“å‡ºé¡ºåºï¼ˆé«˜ä½ä¼˜å…ˆï¼‰ä¸ SDK é€»è¾‘é¡ºåºï¼ˆä½ä½ä¼˜å…ˆï¼‰çš„å·®å¼‚

3. **Uint96 é™åˆ¶**: `newVotes` æœ€å¤§ä¸º 2^96-1ï¼Œè¶…è¿‡æ­¤å€¼ä¼šå¯¼è‡´é”™è¯¯

4. **ç›å€¼èŒƒå›´**: ç›å€¼ä¸º 56 ä½ï¼Œç¡®ä¿ä¸è¶…è¿‡ 2^56-1

## ğŸ“ æ€»ç»“

è¿™å¥—é›†æˆæµ‹è¯•å…¨é¢éªŒè¯äº† SDK å’Œç”µè·¯ä¹‹é—´çš„æ•°æ®æ ¼å¼å…¼å®¹æ€§ï¼Œç¡®ä¿ï¼š

âœ… ç«¯åˆ°ç«¯çš„æ•°æ®å®Œæ•´æ€§
âœ… è¾¹ç•Œæ¡ä»¶çš„æ­£ç¡®å¤„ç†
âœ… å¤§æ•°å€¼çš„æ­£ç¡®åˆ†å—å’Œé‡æ„
âœ… ç‰¹æ®Šæƒ…å†µçš„å¥å£®æ€§
âœ… SDK å’Œç”µè·¯çš„å®Œå…¨äº’æ“ä½œæ€§

è¿™ä¸º MACI/aMACI æŠ•ç¥¨ç³»ç»Ÿçš„æ•°æ®å±‚æä¾›äº†å¯é çš„è´¨é‡ä¿è¯ã€‚

