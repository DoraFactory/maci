<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MACI Bridge ç®€å•æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .console-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <h1>ğŸš€ MACI Bridge ç®€å•æµ‹è¯•</h1>

    <div id="status" class="status info">æ­£åœ¨åŠ è½½ MACI Bridge...</div>

    <div>
        <button onclick="testBasicFunctions()">æµ‹è¯•åŸºç¡€åŠŸèƒ½</button>
        <button onclick="testInitialize()">æµ‹è¯•åˆå§‹åŒ–</button>
        <button onclick="clearConsole()">æ¸…é™¤æ§åˆ¶å°</button>
    </div>

    <h3>æ§åˆ¶å°è¾“å‡ºï¼š</h3>
    <div id="console" class="console-output">ç­‰å¾…æµ‹è¯•...</div>

    <script src="./dist/maci-bridge.js"></script>
    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            console.textContent += logEntry;
            console.scrollTop = console.scrollHeight;

            // ä¹Ÿè¾“å‡ºåˆ°æµè§ˆå™¨æ§åˆ¶å°
            if (type === 'error') {
                console.error(message);
            } else {
                console.log(message);
            }
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function clearConsole() {
            document.getElementById('console').textContent = '';
        }

        // ç­‰å¾…MaciBridgeåŠ è½½å®Œæˆ
        function waitForMaciBridge() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // æœ€å¤šç­‰å¾…5ç§’

                function check() {
                    if (window.MaciBridge && typeof window.MaciBridge.initialize === 'function') {
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('MaciBridgeåŠ è½½è¶…æ—¶'));
                    } else {
                        attempts++;
                        setTimeout(check, 100);
                    }
                }

                check();
            });
        }

        // æµ‹è¯•åŸºç¡€åŠŸèƒ½
        async function testBasicFunctions() {
            try {
                log('å¼€å§‹æµ‹è¯•åŸºç¡€åŠŸèƒ½...');

                await waitForMaciBridge();
                log('âœ… MaciBridge å·²åŠ è½½');

                // æ£€æŸ¥å¯ç”¨æ–¹æ³•
                const methods = Object.keys(window.MaciBridge);
                log(`ğŸ“‹ å¯ç”¨æ–¹æ³•: ${methods.join(', ')}`);

                // æµ‹è¯•æ–¹æ³•æ˜¯å¦å­˜åœ¨
                const requiredMethods = ['initialize', 'getMaciKeypair', 'getMaciPubkey'];
                for (const method of requiredMethods) {
                    if (typeof window.MaciBridge[method] === 'function') {
                        log(`âœ… ${method} æ–¹æ³•å­˜åœ¨`);
                    } else {
                        log(`âŒ ${method} æ–¹æ³•ä¸å­˜åœ¨`, 'error');
                    }
                }

                updateStatus('âœ… åŸºç¡€åŠŸèƒ½æµ‹è¯•å®Œæˆ', 'success');

            } catch (error) {
                log(`âŒ åŸºç¡€åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus('âŒ åŸºç¡€åŠŸèƒ½æµ‹è¯•å¤±è´¥', 'error');
            }
        }

        // æµ‹è¯•åˆå§‹åŒ–
        async function testInitialize() {
            try {
                log('å¼€å§‹æµ‹è¯•åˆå§‹åŒ–...');

                await waitForMaciBridge();

                const config = {
                    network: 'testnet'
                };

                log('ğŸ”§ æ­£åœ¨åˆå§‹åŒ– MACI å®¢æˆ·ç«¯...');
                await window.MaciBridge.initialize(config);

                log('âœ… MACI å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');

                // æµ‹è¯•è·å–å¯†é’¥å¯¹
                log('ğŸ”‘ æ­£åœ¨è·å– MACI å¯†é’¥å¯¹...');
                const keypair = await window.MaciBridge.getMaciKeypair();
                log(`âœ… å¯†é’¥å¯¹: ${JSON.stringify(keypair, null, 2)}`);

                // æµ‹è¯•è·å–å…¬é’¥
                log('ğŸ”‘ æ­£åœ¨è·å– MACI å…¬é’¥...');
                const pubkey = await window.MaciBridge.getMaciPubkey();
                log(`âœ… å…¬é’¥: ${pubkey}`);

                updateStatus('âœ… åˆå§‹åŒ–æµ‹è¯•å®Œæˆ', 'success');

            } catch (error) {
                log(`âŒ åˆå§‹åŒ–æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus('âŒ åˆå§‹åŒ–æµ‹è¯•å¤±è´¥', 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥
        window.addEventListener('load', async function () {
            try {
                log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥ MaciBridge...');

                await waitForMaciBridge();

                log('âœ… MaciBridge åŠ è½½æˆåŠŸ');
                updateStatus('âœ… MACI Bridge å·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•', 'success');

            } catch (error) {
                log(`âŒ MaciBridge åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                updateStatus('âŒ MACI Bridge åŠ è½½å¤±è´¥', 'error');
            }
        });

        // ç›‘å¬å…¨å±€é”™è¯¯
        window.addEventListener('error', function (event) {
            log(`âŒ å…¨å±€é”™è¯¯: ${event.error?.message || event.message}`, 'error');
        });

        // ç›‘å¬æœªå¤„ç†çš„Promiseæ‹’ç»
        window.addEventListener('unhandledrejection', function (event) {
            log(`âŒ æœªå¤„ç†çš„Promiseæ‹’ç»: ${event.reason}`, 'error');
        });
    </script>
</body>

</html>