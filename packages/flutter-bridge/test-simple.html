<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MACI Bridge 简单测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .console-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <h1>🚀 MACI Bridge 简单测试</h1>

    <div id="status" class="status info">正在加载 MACI Bridge...</div>

    <div>
        <button onclick="testBasicFunctions()">测试基础功能</button>
        <button onclick="testInitialize()">测试初始化</button>
        <button onclick="clearConsole()">清除控制台</button>
    </div>

    <h3>控制台输出：</h3>
    <div id="console" class="console-output">等待测试...</div>

    <script src="./dist/maci-bridge.js"></script>
    <script>
        // 日志函数
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            console.textContent += logEntry;
            console.scrollTop = console.scrollHeight;

            // 也输出到浏览器控制台
            if (type === 'error') {
                console.error(message);
            } else {
                console.log(message);
            }
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function clearConsole() {
            document.getElementById('console').textContent = '';
        }

        // 等待MaciBridge加载完成
        function waitForMaciBridge() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 最多等待5秒

                function check() {
                    if (window.MaciBridge && typeof window.MaciBridge.initialize === 'function') {
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('MaciBridge加载超时'));
                    } else {
                        attempts++;
                        setTimeout(check, 100);
                    }
                }

                check();
            });
        }

        // 测试基础功能
        async function testBasicFunctions() {
            try {
                log('开始测试基础功能...');

                await waitForMaciBridge();
                log('✅ MaciBridge 已加载');

                // 检查可用方法
                const methods = Object.keys(window.MaciBridge);
                log(`📋 可用方法: ${methods.join(', ')}`);

                // 测试方法是否存在
                const requiredMethods = ['initialize', 'getMaciKeypair', 'getMaciPubkey'];
                for (const method of requiredMethods) {
                    if (typeof window.MaciBridge[method] === 'function') {
                        log(`✅ ${method} 方法存在`);
                    } else {
                        log(`❌ ${method} 方法不存在`, 'error');
                    }
                }

                updateStatus('✅ 基础功能测试完成', 'success');

            } catch (error) {
                log(`❌ 基础功能测试失败: ${error.message}`, 'error');
                updateStatus('❌ 基础功能测试失败', 'error');
            }
        }

        // 测试初始化
        async function testInitialize() {
            try {
                log('开始测试初始化...');

                await waitForMaciBridge();

                const config = {
                    network: 'testnet'
                };

                log('🔧 正在初始化 MACI 客户端...');
                await window.MaciBridge.initialize(config);

                log('✅ MACI 客户端初始化成功');

                // 测试获取密钥对
                log('🔑 正在获取 MACI 密钥对...');
                const keypair = await window.MaciBridge.getMaciKeypair();
                log(`✅ 密钥对: ${JSON.stringify(keypair, null, 2)}`);

                // 测试获取公钥
                log('🔑 正在获取 MACI 公钥...');
                const pubkey = await window.MaciBridge.getMaciPubkey();
                log(`✅ 公钥: ${pubkey}`);

                updateStatus('✅ 初始化测试完成', 'success');

            } catch (error) {
                log(`❌ 初始化测试失败: ${error.message}`, 'error');
                updateStatus('❌ 初始化测试失败', 'error');
            }
        }

        // 页面加载完成后检查
        window.addEventListener('load', async function () {
            try {
                log('页面加载完成，检查 MaciBridge...');

                await waitForMaciBridge();

                log('✅ MaciBridge 加载成功');
                updateStatus('✅ MACI Bridge 已就绪，可以开始测试', 'success');

            } catch (error) {
                log(`❌ MaciBridge 加载失败: ${error.message}`, 'error');
                updateStatus('❌ MACI Bridge 加载失败', 'error');
            }
        });

        // 监听全局错误
        window.addEventListener('error', function (event) {
            log(`❌ 全局错误: ${event.error?.message || event.message}`, 'error');
        });

        // 监听未处理的Promise拒绝
        window.addEventListener('unhandledrejection', function (event) {
            log(`❌ 未处理的Promise拒绝: ${event.reason}`, 'error');
        });
    </script>
</body>

</html>