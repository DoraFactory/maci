# Registry åˆçº¦

Registry åˆçº¦æ˜¯ MACI ç³»ç»Ÿçš„æ³¨å†Œä¸­å¿ƒï¼Œè´Ÿè´£ç®¡ç† Operatorã€åˆ›å»ºæŠ•ç¥¨è½®æ¬¡å’Œé…ç½®ç³»ç»Ÿå‚æ•°ã€‚

## æ ¸å¿ƒåŠŸèƒ½

### 1. Operator ç®¡ç†

Registry ç»´æŠ¤ä¸€ä¸ª Operator ç³»ç»Ÿç½‘ç»œï¼Œç”¨æˆ·åªéœ€è¦é€‰æ‹©å·²æ³¨å†Œçš„ Operator å³å¯åˆ›å»ºæŠ•ç¥¨è½®æ¬¡ã€‚

#### Operator æ³¨å†Œ

```rust
// æ³¨å†Œæˆä¸º Operator
ExecuteMsg::SetMaciOperator {
    operator: Addr,
}
```

**æ³¨å†Œæµç¨‹ï¼š**

```mermaid
sequenceDiagram
    participant Op as Operator
    participant Registry as Registry åˆçº¦
    participant Storage as é“¾ä¸Šå­˜å‚¨
    Op->>Registry: SetMaciOperator
    Registry->>Registry: éªŒè¯æƒé™
    Registry->>Storage: æ·»åŠ åˆ° Operator é›†åˆ
    Registry-->>Op: æ³¨å†ŒæˆåŠŸ
    Note over Op: ç°åœ¨å¯ä»¥è®¾ç½®å…¬é’¥å’Œèº«ä»½
```

**ç¤ºä¾‹ä»£ç ï¼š**

```typescript
// ä½¿ç”¨ CosmJS æ³¨å†Œ Operator
const msg = {
  set_maci_operator: {
    operator: 'dora1operator...'
  }
};

const result = await client.execute(
  registryAddress,
  msg,
  'auto'
);
```

#### è®¾ç½® Operator å…¬é’¥

æ¯ä¸ª Operator éœ€è¦è®¾ç½®è‡ªå·±çš„å…¬é’¥ç”¨äºæŠ•ç¥¨åŠ å¯†ï¼š

```rust
ExecuteMsg::SetMaciOperatorPubkey {
    pubkey: PubKey,  // { x: String, y: String }
}
```

**å…¬é’¥æ ¼å¼ï¼š**

```typescript
interface PubKey {
  x: string;  // Baby Jubjub æ›²çº¿ç‚¹çš„ x åæ ‡ï¼ˆåå…­è¿›åˆ¶ï¼‰
  y: string;  // Baby Jubjub æ›²çº¿ç‚¹çš„ y åæ ‡ï¼ˆåå…­è¿›åˆ¶ï¼‰
}

// ç¤ºä¾‹
const pubkey = {
  x: "0x1234567890abcdef...",
  y: "0xfedcba0987654321..."
};
```

#### è®¾ç½® Operator èº«ä»½ä¿¡æ¯

```rust
ExecuteMsg::SetMaciOperatorIdentity {
    identity: String,
}
```

è¿™å¯ä»¥æ˜¯ Operator çš„åç§°ã€ç½‘ç«™æˆ–å…¶ä»–æ ‡è¯†ä¿¡æ¯ï¼š

```typescript
const msg = {
  set_maci_operator_identity: {
    identity: "DoraHacks Operator | https://dorahacks.io"
  }
};
```

#### æŸ¥è¯¢ Operator ä¿¡æ¯

```rust
// æ£€æŸ¥åœ°å€æ˜¯å¦æ˜¯ Operator
QueryMsg::IsMaciOperator { address }

// è·å– Operator å…¬é’¥
QueryMsg::GetMaciOperatorPubkey { address }

// è·å– Operator èº«ä»½ä¿¡æ¯
QueryMsg::GetMaciOperatorIdentity { address }
```

**ç¤ºä¾‹ï¼š**

```typescript
// æ£€æŸ¥æ˜¯å¦æ˜¯ Operator
const isOperator = await client.queryContractSmart(
  registryAddress,
  { is_maci_operator: { address: 'dora1...' } }
);

// è·å–å…¬é’¥
const pubkey = await client.queryContractSmart(
  registryAddress,
  { get_maci_operator_pubkey: { address: 'dora1...' } }
);

console.log('Operator å…¬é’¥:', pubkey);
```

### 2. Round åˆ›å»º

Registry çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ä¸€é”®åˆ›å»ºæŠ•ç¥¨è½®æ¬¡ã€‚

#### CreateRound æ¶ˆæ¯

```rust
ExecuteMsg::CreateRound {
    operator: Addr,                          // Operator åœ°å€
    max_voter: Uint256,                      // æœ€å¤§æŠ•ç¥¨äººæ•°
    voice_credit_amount: Uint256,            // æ¯äººæŠ•ç¥¨æƒé‡
    vote_option_map: Vec<String>,            // æŠ•ç¥¨é€‰é¡¹
    round_info: RoundInfo,                   // è½®æ¬¡ä¿¡æ¯
    voting_time: VotingTime,                 // æŠ•ç¥¨æ—¶é—´
    whitelist: Option<WhitelistBase>,        // ç™½åå•é…ç½®
    pre_deactivate_root: Uint256,            // é¢„å»æ´»åŒ–æ ¹
    circuit_type: Uint256,                   // ç”µè·¯ç±»å‹
    certification_system: Uint256,           // è®¤è¯ç³»ç»Ÿ
    oracle_whitelist_pubkey: Option<String>, // Oracle å…¬é’¥
    pre_deactivate_coordinator: Option<PubKey>, // é¢„å»æ´»åŒ–åè°ƒè€…
}
```

#### å‚æ•°è¯¦è§£

**åŸºç¡€å‚æ•°ï¼š**

```rust
// Operator åœ°å€
operator: Addr  // å¿…é¡»æ˜¯å·²æ³¨å†Œçš„ Operator

// æœ€å¤§æŠ•ç¥¨äººæ•°
max_voter: Uint256  // ä¾‹å¦‚ï¼šUint256::from(1000u128)

// æ¯äººæŠ•ç¥¨æƒé‡
voice_credit_amount: Uint256  // ä¾‹å¦‚ï¼šUint256::from(100u128)

// æŠ•ç¥¨é€‰é¡¹
vote_option_map: Vec<String>  // ä¾‹å¦‚ï¼š["é€‰é¡¹ A", "é€‰é¡¹ B", "é€‰é¡¹ C"]
```

**è½®æ¬¡ä¿¡æ¯ï¼ˆRoundInfoï¼‰ï¼š**

```rust
pub struct RoundInfo {
    pub title: String,        // æŠ•ç¥¨æ ‡é¢˜
    pub description: String,  // æŠ•ç¥¨æè¿°
    pub link: String,         // ç›¸å…³é“¾æ¥
}
```

**æŠ•ç¥¨æ—¶é—´ï¼ˆVotingTimeï¼‰ï¼š**

```rust
pub struct VotingTime {
    pub start_time: u64,  // å¼€å§‹æ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼‰
    pub end_time: u64,    // ç»“æŸæ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼‰
}
```

**ç™½åå•é…ç½®ï¼ˆWhitelistBaseï¼‰ï¼š**

```rust
pub struct WhitelistBase {
    pub ecosystem: String,            // "cosmoshub" æˆ– "doravota"
    pub snapshot_height: String,      // å¿«ç…§é«˜åº¦ï¼Œ"0" è¡¨ç¤ºå®æ—¶
    pub voting_power_args: VotingPowerArgs,
}

pub struct VotingPowerArgs {
    pub mode: String,      // "slope" æˆ– "threshold"
    pub slope: String,     // Slope æ¨¡å¼çš„é™¤æ•°
    pub threshold: String, // Threshold æ¨¡å¼çš„é˜ˆå€¼
}
```

**ç”µè·¯å’Œè®¤è¯ï¼š**

```rust
// ç”µè·¯ç±»å‹
circuit_type: Uint256
// 0 = 1P1Vï¼ˆä¸€äººä¸€ç¥¨ï¼‰
// 1 = QVï¼ˆäºŒæ¬¡æ–¹æŠ•ç¥¨ï¼‰

// è®¤è¯ç³»ç»Ÿ
certification_system: Uint256
// 0 = Oracleï¼ˆOracle ç™½åå•ï¼‰
// 1 = OnChainï¼ˆé“¾ä¸Šç™½åå•ï¼‰
```

#### åˆ›å»ºæµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Registry as Registry åˆçº¦
    participant CodeId as AMACI Code ID
    participant AMACI as AMACI å®ä¾‹
    User->>Registry: CreateRound(æ‰€æœ‰å‚æ•°)
    Registry->>Registry: 1. éªŒè¯ Operator
    alt Operator æœªæ³¨å†Œ
        Registry-->>User: é”™è¯¯ï¼šOperator æœªæ³¨å†Œ
    end
    Registry->>Registry: 2. éªŒè¯å‚æ•°
    alt å‚æ•°æ— æ•ˆ
        Registry-->>User: é”™è¯¯ï¼šæ— æ•ˆå‚æ•°
    end
    Registry->>Registry: 3. è®¡ç®—è´¹ç”¨
    Registry->>Registry: 4. æ£€æŸ¥æ”¯ä»˜
    alt è´¹ç”¨ä¸è¶³
        Registry-->>User: é”™è¯¯ï¼šè´¹ç”¨ä¸è¶³
    end
    Registry->>CodeId: 5. å®ä¾‹åŒ– AMACI
    CodeId->>AMACI: åˆ›å»ºåˆçº¦
    AMACI->>AMACI: åˆå§‹åŒ–çŠ¶æ€
    AMACI-->>Registry: åˆçº¦åœ°å€
    Registry->>Registry: 6. è®°å½•åˆ›å»ºäº‹ä»¶
    Registry-->>User: è¿”å›åˆçº¦åœ°å€
```

#### å®Œæ•´ç¤ºä¾‹

```typescript
import { MaciClient, MaciCircuitType } from '@dorafactory/maci-sdk';

const client = new MaciClient({ network: 'testnet' });

// åˆ›å»ºæŠ•ç¥¨è½®æ¬¡
const round = await client.createOracleMaciRound({
  signer: wallet,
  
  // Operator å…¬é’¥
  operatorPubkey: '0e752c8f4c4c9f5c4e8a3d2c1b0a9e8d7c6b5a4f3e2d1c0b9a8e7d6c5b4a3f2e',
  
  // æŠ•ç¥¨æ—¶é—´
  startVoting: new Date('2024-01-01T00:00:00Z'),
  endVoting: new Date('2024-01-07T23:59:59Z'),
  
  // è½®æ¬¡ä¿¡æ¯
  title: 'ç¤¾åŒºææ¡ˆæŠ•ç¥¨',
  description: 'æŠ•ç¥¨é€‰æ‹©ä¸‹ä¸€æ­¥å‘å±•æ–¹å‘',
  link: 'https://forum.example.com/proposal-123',
  
  // æŠ•ç¥¨é€‰é¡¹
  voteOptionMap: [
    'ææ¡ˆ A: å¢åŠ ç¤¾åŒºèµ„é‡‘',
    'ææ¡ˆ B: æ”¹è¿›æŠ€æœ¯åŸºç¡€è®¾æ–½',
    'ææ¡ˆ C: æ‰©å¤§å¸‚åœºæ¨å¹¿',
    'ææ¡ˆ D: æ•™è‚²å’ŒåŸ¹è®­',
  ],
  
  // æŠ•ç¥¨ç±»å‹
  circuitType: MaciCircuitType.QV,  // äºŒæ¬¡æ–¹æŠ•ç¥¨
  
  // ç™½åå•é…ç½®
  whitelistEcosystem: 'cosmoshub',
  whitelistSnapshotHeight: '23342001',
  whitelistVotingPowerArgs: {
    mode: 'slope',
    slope: '1000000',  // æ¯ 1 ATOM = 1 voice credit
    threshold: '1000000',
  },
});

console.log('æŠ•ç¥¨è½®æ¬¡åˆ›å»ºæˆåŠŸï¼');
console.log('AMACI åˆçº¦åœ°å€:', round.contractAddress);
```

### 3. Validator ç®¡ç†

Registry è¿˜ç®¡ç† Validator åˆ—è¡¨ï¼Œç”¨äºç³»ç»ŸéªŒè¯ã€‚

#### è®¾ç½® Validator

```rust
ExecuteMsg::SetValidators {
    addresses: ValidatorSet,
}

pub struct ValidatorSet {
    pub validators: Vec<Addr>,
}
```

**ç¤ºä¾‹ï¼š**

```typescript
const msg = {
  set_validators: {
    addresses: {
      validators: [
        'dora1validator1...',
        'dora1validator2...',
        'dora1validator3...',
      ]
    }
  }
};
```

#### ç§»é™¤ Validator

```rust
ExecuteMsg::RemoveValidator {
    address: Addr,
}
```

#### æŸ¥è¯¢ Validator

```rust
// æ£€æŸ¥æ˜¯å¦æ˜¯ Validator
QueryMsg::IsValidator { address }

// è·å–æ‰€æœ‰ Validator
QueryMsg::GetValidators {}

// è·å– Validator å¯¹åº”çš„ Operator
QueryMsg::GetValidatorOperator { address }
```

### 4. Circuit é…ç½®

ç®¡ç† ZK ç”µè·¯çš„è´¹ç”¨é…ç½®ã€‚

#### æ›´æ”¹è´¹ç”¨é…ç½®

```rust
ExecuteMsg::ChangeChargeConfig {
    config: CircuitChargeConfig,
}

pub struct CircuitChargeConfig {
    pub fee_rate: Decimal,  // è´¹ç”¨æ¯”ç‡
}
```

**ç¤ºä¾‹ï¼š**

```typescript
// è®¾ç½®è´¹ç”¨ä¸º 10%
const msg = {
  change_charge_config: {
    config: {
      fee_rate: "0.1"
    }
  }
};
```

#### æŸ¥è¯¢è´¹ç”¨é…ç½®

```rust
QueryMsg::GetCircuitChargeConfig {}
```

### 5. ç³»ç»Ÿç®¡ç†

#### æ›´æ–° AMACI Code ID

å½“æœ‰æ–°ç‰ˆæœ¬çš„ AMACI åˆçº¦æ—¶ï¼Œæ›´æ–° Code IDï¼š

```rust
ExecuteMsg::UpdateAmaciCodeId {
    amaci_code_id: u64,
}
```

**ç¤ºä¾‹ï¼š**

```typescript
const msg = {
  update_amaci_code_id: {
    amaci_code_id: 124  // æ–°çš„ Code ID
  }
};

// ä¹‹ååˆ›å»ºçš„ AMACI å®ä¾‹å°†ä½¿ç”¨æ–°ä»£ç 
```

#### æ›´æ”¹ Operator

æ›´æ”¹ Registry çš„ä¸» Operatorï¼š

```rust
ExecuteMsg::ChangeOperator {
    address: Addr,
}
```

#### æŸ¥è¯¢ç®¡ç†å‘˜

```rust
QueryMsg::Admin {}  // è¿”å›ç®¡ç†å‘˜åœ°å€
QueryMsg::Operator {}  // è¿”å›ä¸» Operator åœ°å€
```

## æƒé™æ§åˆ¶

### æƒé™çŸ©é˜µ

| æ“ä½œ | Admin | Operator | ä»»ä½•äºº |
|------|-------|----------|--------|
| SetMaciOperator | âŒ | âœ… | âŒ |
| SetMaciOperatorPubkey | âŒ | âœ… | âŒ |
| SetMaciOperatorIdentity | âŒ | âœ… | âŒ |
| CreateRound | âŒ | âŒ | âœ… |
| SetValidators | âœ… | âŒ | âŒ |
| RemoveValidator | âœ… | âŒ | âŒ |
| UpdateAmaciCodeId | âœ… | âŒ | âŒ |
| ChangeOperator | âœ… | âŒ | âŒ |
| ChangeChargeConfig | âœ… | âŒ | âŒ |
| Queryï¼ˆæ‰€æœ‰æŸ¥è¯¢ï¼‰ | âœ… | âœ… | âœ… |

### æƒé™éªŒè¯

```rust
// éªŒè¯ Operator æƒé™
fn ensure_operator(
    deps: &DepsMut,
    info: &MessageInfo
) -> Result<(), ContractError> {
    let operator = OPERATOR.load(deps.storage)?;
    if info.sender != operator {
        return Err(ContractError::Unauthorized {});
    }
    Ok(())
}

// éªŒè¯ Admin æƒé™
fn ensure_admin(
    deps: &DepsMut,
    info: &MessageInfo
) -> Result<(), ContractError> {
    let admin = ADMIN.load(deps.storage)?;
    if info.sender != admin.admin {
        return Err(ContractError::Unauthorized {});
    }
    Ok(())
}
```

## äº‹ä»¶å’Œæ—¥å¿—

Registry ä¼šå‘å‡ºå„ç§äº‹ä»¶ç”¨äºè¿½è¸ªï¼š

### Operator æ³¨å†Œäº‹ä»¶

```rust
Response::new()
    .add_attribute("action", "set_maci_operator")
    .add_attribute("operator", operator.to_string())
```

### Round åˆ›å»ºäº‹ä»¶

```rust
Response::new()
    .add_attribute("action", "create_round")
    .add_attribute("operator", operator.to_string())
    .add_attribute("contract_address", amaci_address.to_string())
    .add_attribute("circuit_type", circuit_type.to_string())
```

## è´¹ç”¨è®¡ç®—

åˆ›å»º Round éœ€è¦æ”¯ä»˜è´¹ç”¨ï¼š

```rust
fn calculate_fee(
    config: &CircuitChargeConfig,
    max_voter: Uint256,
    // ... å…¶ä»–å‚æ•°
) -> Uint128 {
    // åŸºç¡€è´¹ç”¨
    let base_fee = Uint128::new(1000000);  // 1 DORA
    
    // æ ¹æ®æŠ•ç¥¨äººæ•°è°ƒæ•´
    let voter_fee = max_voter.multiply_ratio(
        Uint128::new(1000),  // æ¯äºº 0.001 DORA
        Uint128::new(1)
    );
    
    // åº”ç”¨è´¹ç‡
    let total = base_fee + voter_fee;
    let fee = total.multiply_ratio(
        config.fee_rate.numerator(),
        config.fee_rate.denominator()
    );
    
    fee
}
```

## ä¸‹ä¸€æ­¥

ç°åœ¨æ‚¨å·²ç»äº†è§£äº† Registry åˆçº¦çš„åŠŸèƒ½ï¼Œæ¥ä¸‹æ¥å¯ä»¥å­¦ä¹ ï¼š

- ğŸ—³ï¸ [AMACI åˆçº¦](/contracts/amaci) - äº†è§£æŠ•ç¥¨åˆçº¦çš„å®ç°
- ğŸ”„ [å®Œæ•´å·¥ä½œæµç¨‹](/contracts/workflow) - ç†è§£ä»åˆ›å»ºåˆ°ç»“æœçš„å…¨æµç¨‹
- ğŸ’» [SDK ä½¿ç”¨æŒ‡å—](/sdk/create-round) - ä½¿ç”¨ SDK åˆ›å»ºæŠ•ç¥¨è½®æ¬¡
