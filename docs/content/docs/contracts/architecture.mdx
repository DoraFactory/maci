# æ¶æ„æ€»è§ˆ

MACI çš„åˆçº¦ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œé€šè¿‡ Registry åˆçº¦ç»Ÿä¸€ç®¡ç†å¤šä¸ª AMACI æŠ•ç¥¨åˆçº¦å®ä¾‹ã€‚æœ¬èŠ‚ä»‹ç»æ•´ä½“æ¶æ„å’Œè®¾è®¡ç†å¿µã€‚

## ç³»ç»Ÿæ¶æ„

### æ¶æ„å›¾

```mermaid
graph TD
    User[ç”¨æˆ·] --> Registry[Registry åˆçº¦]
    Operator[Operator] --> Registry
    Registry --> OpMgmt[Operator ç®¡ç†]
    Registry --> RoundMgmt[Round ç®¡ç†]
    Registry --> CircuitMgmt[Circuit é…ç½®]
    RoundMgmt -->|å®ä¾‹åŒ–| AMACI1[AMACI åˆçº¦ 1]
    RoundMgmt -->|å®ä¾‹åŒ–| AMACI2[AMACI åˆçº¦ 2]
    RoundMgmt -->|å®ä¾‹åŒ–| AMACI3[AMACI åˆçº¦ N]
    AMACI1 --> Voter1[æŠ•ç¥¨è€… A]
    AMACI1 --> Voter2[æŠ•ç¥¨è€… B]
    AMACI2 --> Voter3[æŠ•ç¥¨è€… C]
    OpMgmt --> OpList[(Operator åˆ—è¡¨)]
    OpMgmt --> ValidatorList[(Validator åˆ—è¡¨)]
```

### ç»„ä»¶è¯´æ˜

**Registry åˆçº¦ï¼ˆæ³¨å†Œä¸­å¿ƒï¼‰**
- ç®¡ç† Operator æ³¨å†Œå’Œé…ç½®
- ç®¡ç† Validator åˆ—è¡¨
- åˆ›å»ºå’Œé…ç½® AMACI åˆçº¦å®ä¾‹
- é…ç½® ZK ç”µè·¯å‚æ•°
- ç®¡ç†è´¹ç”¨é…ç½®

**AMACI åˆçº¦ï¼ˆæŠ•ç¥¨å®ä¾‹ï¼‰**
- å¤„ç†ç”¨æˆ·ç­¾åˆ°ï¼ˆSignupï¼‰
- æ¥æ”¶å’Œå­˜å‚¨åŠ å¯†æŠ•ç¥¨æ¶ˆæ¯
- éªŒè¯é›¶çŸ¥è¯†è¯æ˜
- å‘å¸ƒæŠ•ç¥¨ç»“æœ
- æ¯ä¸ªæŠ•ç¥¨è½®æ¬¡å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ AMACI åˆçº¦å®ä¾‹

## è®¾è®¡ç†å¿µ

### 1. å…³æ³¨ç‚¹åˆ†ç¦»

```mermaid
graph LR
    A[Registry] -->|èŒè´£| B[ç³»ç»Ÿçº§ç®¡ç†]
    C[AMACI] -->|èŒè´£| D[æŠ•ç¥¨çº§é€»è¾‘]
    B --> B1[Operator ç®¡ç†]
    B --> B2[Round åˆ›å»º]
    B --> B3[å…¨å±€é…ç½®]
    D --> D1[ç”¨æˆ·ç­¾åˆ°]
    D --> D2[æŠ•ç¥¨æ¶ˆæ¯]
    D --> D3[ç»“æœç»Ÿè®¡]
```

**Registry å…³æ³¨ï¼š**
- è°å¯ä»¥è¿è¡Œ Operator
- å¦‚ä½•åˆ›å»ºæŠ•ç¥¨è½®æ¬¡
- ç³»ç»Ÿçº§å‚æ•°é…ç½®

**AMACI å…³æ³¨ï¼š**
- ç”¨æˆ·å¦‚ä½•å‚ä¸æŠ•ç¥¨
- æ¶ˆæ¯å¦‚ä½•å­˜å‚¨å’Œå¤„ç†
- ç»“æœå¦‚ä½•éªŒè¯å’Œå‘å¸ƒ

### 2. ä¸€é”®åˆ›å»º

ç”¨æˆ·æ— éœ€æ‰‹åŠ¨éƒ¨ç½² AMACI åˆçº¦ï¼š

```rust
// ç”¨æˆ·åªéœ€è°ƒç”¨ Registry çš„ä¸€ä¸ªå‡½æ•°
ExecuteMsg::CreateRound {
    operator,
    max_voter,
    voice_credit_amount,
    vote_option_map,
    // ... å…¶ä»–å‚æ•°
}

// Registry è‡ªåŠ¨ï¼š
// 1. éªŒè¯ Operator æ˜¯å¦æ³¨å†Œ
// 2. å®ä¾‹åŒ– AMACI åˆçº¦
// 3. é…ç½®åˆå§‹å‚æ•°
// 4. è¿”å›åˆçº¦åœ°å€
```

### 3. æ ‡å‡†åŒ–æ¥å£

æ‰€æœ‰ AMACI åˆçº¦å®ä¾‹å…±äº«ç›¸åŒçš„æ¥å£ï¼š

```rust
// ç»Ÿä¸€çš„æ¶ˆæ¯ç±»å‹
pub enum ExecuteMsg {
    Signup { ... },
    PublishMessage { ... },
    ProcessMessages { ... },
    ProcessTally { ... },
}

// ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£
pub enum QueryMsg {
    GetRoundInfo {},
    GetNumSignups {},
    GetMessage { index },
}
```

### 4. çµæ´»é…ç½®

æ”¯æŒå¤šç§é…ç½®é€‰é¡¹ï¼š

```rust
// æŠ•ç¥¨ç±»å‹
pub enum CircuitType {
    IP1V = 0,  // ä¸€äººä¸€ç¥¨
    QV = 1,    // äºŒæ¬¡æ–¹æŠ•ç¥¨
}

// è®¤è¯ç³»ç»Ÿ
pub enum CertificationSystem {
    Oracle = 0,     // Oracle ç™½åå•
    OnChain = 1,    // é“¾ä¸Šç™½åå•
}

// ç™½åå•é…ç½®
pub struct WhitelistBase {
    ecosystem: String,        // cosmoshub / doravota
    snapshot_height: String,  // å¿«ç…§é«˜åº¦
    voting_power_args: VotingPowerArgs,
}
```

## åˆçº¦å…³ç³»

### åˆ›å»ºæµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Registry as Registry åˆçº¦
    participant CodeId as AMACI Code ID
    participant AMACI as AMACI å®ä¾‹
    User->>Registry: CreateRound(å‚æ•°)
    Registry->>Registry: éªŒè¯ Operator
    Registry->>Registry: è®¡ç®—è´¹ç”¨
    Registry->>CodeId: å®ä¾‹åŒ–åˆçº¦
    CodeId->>AMACI: åˆ›å»ºæ–°å®ä¾‹
    AMACI->>AMACI: åˆå§‹åŒ–çŠ¶æ€
    AMACI-->>Registry: è¿”å›åœ°å€
    Registry-->>User: è¿”å›åˆçº¦åœ°å€
    Note over User,AMACI: ç”¨æˆ·å¯ä»¥å¼€å§‹ä½¿ç”¨ AMACI åˆçº¦
```

### äº¤äº’æ¨¡å¼

```mermaid
graph TD
    A[é˜¶æ®µ 1: åˆ›å»º] --> B[ç”¨æˆ· â†’ Registry]
    B --> C[Registry â†’ AMACI å®ä¾‹]
    D[é˜¶æ®µ 2: æŠ•ç¥¨] --> E[ç”¨æˆ· â†’ AMACI ç›´æ¥]
    F[é˜¶æ®µ 3: å¤„ç†] --> G[Operator â†’ AMACI ç›´æ¥]
    H[é˜¶æ®µ 4: æŸ¥è¯¢] --> I[ä»»ä½•äºº â†’ AMACI ç›´æ¥]
```

**æ³¨æ„ï¼š**
- Registry åªåœ¨åˆ›å»ºæ—¶å‚ä¸
- åˆ›å»ºåï¼Œç”¨æˆ·ç›´æ¥ä¸ AMACI åˆçº¦äº¤äº’
- Registry ä¸å‚ä¸æŠ•ç¥¨è¿‡ç¨‹

## æ•°æ®æµ

### å®Œæ•´æ•°æ®æµå›¾

```mermaid
flowchart TD
    subgraph RegistryLayer [Registry å±‚]
        A[Operator æ³¨å†Œ]
        B[Round åˆ›å»ºè¯·æ±‚]
        C[Circuit é…ç½®]
    end
    subgraph AMACILayer [AMACI å±‚]
        D[ç”¨æˆ·ç­¾åˆ°]
        E[æŠ•ç¥¨æ¶ˆæ¯]
        F[çŠ¶æ€æ ‘]
        G[æ¶ˆæ¯é˜Ÿåˆ—]
    end
    subgraph OperatorLayer [Operator å±‚]
        H[ä¸‹è½½æ¶ˆæ¯]
        I[è§£å¯†å¤„ç†]
        J[ç”Ÿæˆè¯æ˜]
    end
    subgraph Verification [é“¾ä¸ŠéªŒè¯]
        K[éªŒè¯è¯æ˜]
        L[æ›´æ–°çŠ¶æ€]
        M[å‘å¸ƒç»“æœ]
    end
    A --> B
    B --> D
    D --> F
    E --> G
    G --> H
    H --> I
    I --> J
    J --> K
    K --> L
    L --> M
    C -.é…ç½®.-> D
```

## çŠ¶æ€ç®¡ç†

### Registry çŠ¶æ€

```rust
// Registry å­˜å‚¨çš„çŠ¶æ€
pub struct RegistryState {
    // ç®¡ç†å‘˜
    admin: Addr,
    operator: Addr,
    
    // AMACI åˆçº¦ Code ID
    amaci_code_id: u64,
    
    // Operator é›†åˆ
    operator_set: Map<Addr, bool>,
    operator_pubkey: Map<Addr, PubKey>,
    operator_identity: Map<Addr, String>,
    
    // Validator é›†åˆ
    validator_list: Vec<Addr>,
    validator_operator: Map<Addr, Addr>,
    
    // è´¹ç”¨é…ç½®
    circuit_charge_config: CircuitChargeConfig,
}
```

### AMACI çŠ¶æ€

```rust
// AMACI åˆçº¦å­˜å‚¨çš„çŠ¶æ€
pub struct AMACIState {
    // è½®æ¬¡ä¿¡æ¯
    round_info: RoundInfo,
    voting_time: VotingTime,
    
    // Coordinator å…¬é’¥
    coordinator_pub_key: PubKey,
    
    // ç”¨æˆ·æ•°æ®
    num_sign_ups: u64,
    voice_credit_amount: Uint256,
    
    // æ¶ˆæ¯é˜Ÿåˆ—
    messages: Vec<Message>,
    
    // çŠ¶æ€æ ‘
    state_tree_depth: u8,
    state_tree_root: Uint256,
    
    // æŠ•ç¥¨é…ç½®
    max_vote_options: Uint256,
    vote_option_map: Vec<String>,
    
    // ç”µè·¯é…ç½®
    circuit_type: Uint256,
    certification_system: Uint256,
    
    // ç™½åå•
    whitelist: Option<WhitelistBase>,
}
```

## æƒé™ç®¡ç†

### Registry æƒé™

```mermaid
graph TD
    Admin[Admin] -->|å…¨æƒç®¡ç†| Registry
    Operator[Operator] -->|åˆ›å»º Round| Registry
    Admin --> A1[æ›´æ–° AMACI Code ID]
    Admin --> A2[æ›´æ”¹ Operator]
    Admin --> A3[æ›´æ”¹è´¹ç”¨é…ç½®]
    Operator --> O1[æ³¨å†Œä¸º Operator]
    Operator --> O2[è®¾ç½®å…¬é’¥]
    Operator --> O3[è®¾ç½®èº«ä»½ä¿¡æ¯]
    Validator[Validator] -->|éªŒè¯æ“ä½œ| Registry
    Validator --> V1[è¢«æ·»åŠ åˆ°åˆ—è¡¨]
    Validator --> V2[å…³è” Operator]
```

### AMACI æƒé™

```mermaid
graph TD
    Anyone[ä»»ä½•äºº] -->|ç­¾åˆ°| AMACI
    Anyone -->|æŠ•ç¥¨| AMACI
    Anyone -->|æŸ¥è¯¢| AMACI
    Operator[Operator] -->|å¤„ç†| AMACI
    Operator --> O1[ProcessMessages]
    Operator --> O2[ProcessTally]
    Anyone --> A1[Signup]
    Anyone --> A2[PublishMessage]
    Anyone --> A3[GetRoundInfo]
    Anyone --> A4[GetMessages]
```

## å®‰å…¨è®¾è®¡

### 1. åˆçº¦éªŒè¯

```rust
// Registry åˆ›å»º AMACI æ—¶çš„éªŒè¯
fn create_round(
    deps: DepsMut,
    info: MessageInfo,
    operator: Addr,
    // ... å…¶ä»–å‚æ•°
) -> Result<Response, ContractError> {
    // éªŒè¯ 1: Operator å¿…é¡»å·²æ³¨å†Œ
    if !is_maci_operator(deps.storage, &operator)? {
        return Err(ContractError::OperatorNotRegistered {});
    }
    
    // éªŒè¯ 2: å‚æ•°åˆæ³•æ€§
    if max_voter == Uint256::zero() {
        return Err(ContractError::InvalidMaxVoter {});
    }
    
    // éªŒè¯ 3: è´¹ç”¨æ£€æŸ¥
    let required_fee = calculate_fee(&circuit_charge_config);
    if info.funds.amount < required_fee {
        return Err(ContractError::InsufficientFee {});
    }
    
    // é€šè¿‡éªŒè¯ï¼Œåˆ›å»ºåˆçº¦
    instantiate_amaci_contract(deps, operator, ...)
}
```

### 2. çŠ¶æ€éš”ç¦»

```mermaid
graph TD
    R[Registry çŠ¶æ€] --> R1[Operator æ•°æ®]
    R --> R2[é…ç½®æ•°æ®]
    A1[AMACI å®ä¾‹ 1] --> A1S[ç‹¬ç«‹çŠ¶æ€]
    A2[AMACI å®ä¾‹ 2] --> A2S[ç‹¬ç«‹çŠ¶æ€]
    A1S -.ä¸å½±å“.-> A2S
    A2S -.ä¸å½±å“.-> A1S
```

**ç‰¹ç‚¹ï¼š**
- æ¯ä¸ª AMACI å®ä¾‹æœ‰ç‹¬ç«‹çš„çŠ¶æ€
- ä¸€ä¸ªå®ä¾‹çš„é—®é¢˜ä¸å½±å“å…¶ä»–å®ä¾‹
- Registry åªå­˜å‚¨å…¨å±€é…ç½®

### 3. å‡çº§æœºåˆ¶

```rust
// Registry æ”¯æŒæ›´æ–° AMACI Code ID
ExecuteMsg::UpdateAmaciCodeId {
    amaci_code_id: u64,
}

// æ–°åˆ›å»ºçš„ AMACI å®ä¾‹ä½¿ç”¨æ–° Code ID
// å·²å­˜åœ¨çš„å®ä¾‹ä¸å—å½±å“
```

## éƒ¨ç½²æµç¨‹

### éƒ¨ç½² AMACI åˆçº¦ä»£ç 

```bash
# ç¼–è¯‘ AMACI åˆçº¦
cd contracts/amaci
cargo wasm

# ä¼˜åŒ– wasm
docker run --rm -v "$(pwd)":/code \
  cosmwasm/rust-optimizer:0.12.11

# ä¸Šä¼ åˆ°é“¾ä¸Š
dorad tx wasm store artifacts/amaci.wasm \
  --from deployer \
  --gas auto

# è·å¾— Code IDï¼ˆä¾‹å¦‚ï¼š123ï¼‰
```

### éƒ¨ç½² Registry åˆçº¦

```bash
# å®ä¾‹åŒ– Registry
dorad tx wasm instantiate 123 \
  '{
    "admin": "dora1...",
    "operator": "dora1...",
    "amaci_code_id": 123
  }' \
  --from deployer \
  --label "MACI Registry" \
  --gas auto

# è·å¾— Registry åœ°å€ï¼ˆä¾‹å¦‚ï¼šdora1registry...ï¼‰
```

### æ³¨å†Œ Operator

```bash
# Operator æ³¨å†Œ
dorad tx wasm execute dora1registry... \
  '{
    "set_maci_operator": {
      "operator": "dora1operator..."
    }
  }' \
  --from operator \
  --gas auto

# è®¾ç½® Operator å…¬é’¥
dorad tx wasm execute dora1registry... \
  '{
    "set_maci_operator_pubkey": {
      "pubkey": {
        "x": "0x...",
        "y": "0x..."
      }
    }
  }' \
  --from operator \
  --gas auto
```

### åˆ›å»ºæŠ•ç¥¨è½®æ¬¡

ç°åœ¨ç”¨æˆ·å¯ä»¥é€šè¿‡ Registry åˆ›å»º AMACI å®ä¾‹ï¼š

```typescript
// ä½¿ç”¨ SDK
const round = await client.createOracleMaciRound({
  signer: wallet,
  operatorPubkey: '0x...',
  // ... å…¶ä»–å‚æ•°
});

console.log('AMACI åˆçº¦åœ°å€:', round.contractAddress);
```

## ä¼˜åŠ¿

### 1. ç®€åŒ–éƒ¨ç½²

**ä¼ ç»Ÿæ–¹å¼ï¼š**
```
ç”¨æˆ· â†’ ç¼–è¯‘åˆçº¦ â†’ ä¸Šä¼ ä»£ç  â†’ å®ä¾‹åŒ–åˆçº¦ â†’ é…ç½®å‚æ•°
```

**Registry æ–¹å¼ï¼š**
```
ç”¨æˆ· â†’ è°ƒç”¨ CreateRound â†’ å®Œæˆ
```

### 2. ç»Ÿä¸€ç®¡ç†

- æ‰€æœ‰ Operator åœ¨ä¸€ä¸ªåœ°æ–¹æ³¨å†Œ
- ç»Ÿä¸€çš„è´¹ç”¨é…ç½®
- ç»Ÿä¸€çš„ Code ID ç®¡ç†

### 3. å®‰å…¨æ€§

- Registry éªŒè¯ Operator èµ„æ ¼
- æ ‡å‡†åŒ–çš„åˆçº¦åˆ›å»ºæµç¨‹
- å‡å°‘äººä¸ºé”™è¯¯

### 4. å¯å‡çº§æ€§

- æ›´æ–° Code ID åæ–°å®ä¾‹ä½¿ç”¨æ–°ä»£ç 
- æ—§å®ä¾‹ç»§ç»­è¿è¡Œä¸å—å½±å“
- å¹³æ»‘å‡çº§è·¯å¾„

## ä¸‹ä¸€æ­¥

å®Œæˆåï¼Œæ‚¨å¯ä»¥äº†è§£äº†æ•´ä½“æ¶æ„ï¼Œæ¥ä¸‹æ¥å¯ä»¥æ·±å…¥å­¦ä¹ ï¼š

- [Registry åˆçº¦](/docs/contracts/registry) - è¯¦ç»†äº†è§£ Registry çš„åŠŸèƒ½
- ğŸ—³ï¸ [AMACI åˆçº¦](/docs/contracts/amaci) - å­¦ä¹  AMACI çš„æŠ•ç¥¨é€»è¾‘
- ğŸ”„ [å®Œæ•´å·¥ä½œæµç¨‹](/docs/contracts/workflow) - ç†è§£ä»åˆ›å»ºåˆ°ç»“æœçš„å…¨æµç¨‹
