# æ ¸å¿ƒæ¦‚å¿µ

æœ¬èŠ‚æ·±å…¥ä»‹ç» AMACI ç³»ç»Ÿçš„æ ¸å¿ƒæ¦‚å¿µï¼ŒåŒ…æ‹¬ä¸‰ç§æ³¨å†Œæ–¹å¼ã€å‚ä¸è§’è‰²ã€çŠ¶æ€ç®¡ç†å’Œæ•°æ®ç»“æ„ã€‚

## AMACI ä¸‰ç§æ³¨å†Œæ–¹å¼ï¼ˆæ ¸å¿ƒæœºåˆ¶ï¼‰

AMACI çš„æ ¸å¿ƒåˆ›æ–°æ˜¯æä¾›ä¸‰ç§æ³¨å†Œæ–¹å¼ï¼Œè®©ç”¨æˆ·æ ¹æ®éšç§éœ€æ±‚çµæ´»é€‰æ‹©ã€‚

### æ³¨å†Œæ–¹å¼å¯¹æ¯”

| ç‰¹æ€§ | Signup | Add-new-key | Pre-add-new-key |
|------|--------|-------------|-----------------|
| é€Ÿåº¦ | âš¡âš¡âš¡ æœ€å¿« | â±ï¸ éœ€ç­‰å¾… deactivate | âš¡âš¡ å³æ—¶ |
| åŒ¿åæ€§ | â­â­ ä½ | â­â­â­â­â­ é«˜ | â­â­â­â­â­ é«˜ |
| Operatorå¯è¿½è¸ª | âœ… å¯ä»¥ | âŒ ä¸å¯ä»¥ | âŒ ä¸å¯ä»¥ |
| éœ€è¦ZKè¯æ˜ | âŒ å¦ | âœ… æ˜¯ | âœ… æ˜¯ |
| å‰ç½®æ¡ä»¶ | æ—  | éœ€è¦deactivateæ¶ˆæ¯ | éœ€è¦pre-deactivate root |
| é€‚ç”¨åœºæ™¯ | ä¸å…³å¿ƒéšç§ | éœ€è¦å®Œå…¨åŒ¿å | éœ€è¦å¿«é€ŸåŒ¿å |

### 1. Signupï¼ˆæ ‡å‡†æ³¨å†Œï¼‰

**å·¥ä½œåŸç†ï¼š**

æœ€ç®€å•çš„æ³¨å†Œæ–¹å¼ï¼Œç”¨æˆ·ç›´æ¥æäº¤å…¬é’¥åˆ°åˆçº¦ã€‚

**ä»£ç ç¤ºä¾‹ï¼š**

```typescript
// 1. ç”Ÿæˆ MACI å¯†é’¥å¯¹
// ä½¿ç”¨ dora åœ°å€è¡ç”Ÿ EdDSA-Poseidon å¯†é’¥å¯¹
const maciKeypair = await client.genKeypairFromSign({
  signer: wallet,
  address
});

// 2. Signupï¼ˆä»…ç™½åå•åœ°å€å¯ç”¨ï¼‰
await client.signup({
  signer: wallet,
  address,
  contractAddress,
  maciKeypair,
  gasStation: true
});
```

**ç™½åå•éªŒè¯ï¼š**

åˆçº¦ä¼šéªŒè¯å‘é€è€…åœ°å€æ˜¯å¦åœ¨ç™½åå•ä¸­ï¼š
```rust
// åˆçº¦æ£€æŸ¥
if !whitelist.contains(&sender) {
    return Err(ContractError::NotInWhitelist {});
}
```

**åˆçº¦å¤„ç†ï¼š**

```rust
// 1. éªŒè¯åœ°å€åœ¨ç™½åå•ä¸­
// 2. åˆ›å»º State Leaf
StateLeaf {
    pub_key: user_pubkey,           // ç”¨æˆ·å…¬é’¥ï¼ˆä»doraåœ°å€è¡ç”Ÿï¼‰
    voice_credit_balance: amount,   // å›ºå®šæˆ–åŠ¨æ€æŠ•ç¥¨æƒé‡
    vote_option_tree_root: empty,   // ç©ºæŠ•ç¥¨æ ‘
    nonce: 0,                       // åˆå§‹nonce
    d1: [0, 0],                     // æœªä½¿ç”¨
    d2: [0, 0],                     // æœªä½¿ç”¨
}
```

**æŠ•ç¥¨æƒé‡åˆ†é…ï¼š**

ç™½åå•æ¨¡å¼å¯ä»¥æœ‰ä¸¤ç§æƒé‡åˆ†é…æ–¹å¼ï¼š
- **å›ºå®šæƒé‡**ï¼šæ‰€æœ‰ç™½åå•ç”¨æˆ·è·å¾—ç›¸åŒæŠ•ç¥¨æƒé‡ï¼ˆå¦‚ 100ï¼‰
- **åŠ¨æ€æƒé‡**ï¼šåŸºäºä»£å¸æŒæœ‰é‡æˆ–å…¶ä»–é“¾ä¸Šæ•°æ®è®¡ç®—æƒé‡

**é“¾ä¸Šå¯è§ä¿¡æ¯ï¼š**

```typescript
// ä»»ä½•äººï¼ˆåŒ…æ‹¬Operatorï¼‰éƒ½å¯ä»¥çœ‹åˆ°ï¼š
{
  txHash: "0xabc...",
  sender: "dora1abc...",        // é’±åŒ…åœ°å€
  pubkey: { x: "...", y: "..." }, // MACIå…¬é’¥
  stateIndex: 5                  // åˆ†é…çš„ç´¢å¼•
}
```

**éšç§çº§åˆ«ï¼šâ­â­**

Operator å¯ä»¥é€šè¿‡é“¾ä¸Šäº¤æ˜“å…³è”ï¼š
- `é’±åŒ…åœ°å€ dora1abc... â†’ å…¬é’¥ 0x123... â†’ State Index 5`
- ç„¶åé€šè¿‡è§£å¯†çŸ¥é“ï¼š`State Index 5 æŠ•ç»™äº†é€‰é¡¹ A`
- ç»“è®ºï¼š`é’±åŒ… dora1abc... æŠ•ç»™äº†é€‰é¡¹ A`

---

### 2. Add-new-keyï¼ˆåŠ¨æ€æ¢ keyï¼‰

**å·¥ä½œåŸç†ï¼š**

ä½¿ç”¨é›¶çŸ¥è¯†è¯æ˜åˆ›å»ºæ–°èº«ä»½ï¼Œæ–­å¼€ä¸åŸé’±åŒ…åœ°å€çš„å…³è”ã€‚

**æ ¸å¿ƒæœºåˆ¶ï¼š**

è¯æ˜"æˆ‘çŸ¥é“ deactivate æ ‘ä¸­æŸä¸ªæ¡ç›®å¯¹åº”çš„ç§é’¥"ï¼Œä½†ä¸é€éœ²å…·ä½“æ˜¯å“ªä¸ªã€‚

**å®Œæ•´æµç¨‹ï¼š**

**æ­¥éª¤ 1: è€ç”¨æˆ· Deactivate**

```typescript
// è€ç”¨æˆ·æäº¤ deactivate æ¶ˆæ¯
await client.deactivate({
  signer: oldWallet,
  address: oldAddress,
  contractAddress,
  maciKeypair: oldKeypair,
  gasStation: true
});

// è¿™ä¼šç”Ÿæˆä¸€ä¸ªç‰¹æ®Šçš„æŠ•ç¥¨æ¶ˆæ¯ï¼š
// - voIdx = 0
// - newVotes = 0  
// - newPubKey = [0, 0]ï¼ˆè¡¨ç¤ºæœ€åä¸€æ¡æ¶ˆæ¯ï¼‰
```

**æ­¥éª¤ 2: Operator å¤„ç† Deactivate**

```typescript
// Operator æ”¶é›†æ‰€æœ‰ deactivate æ¶ˆæ¯
// ç”Ÿæˆ deactivate tree

await operator.processDeactivateMessages({
  inputSize: 10,
  subStateTreeLength: 1024,
  wasmFile,
  zkeyFile
});

// ç”Ÿæˆçš„ deactivate tree leaf:
// [c1[0], c1[1], c2[0], c2[1], sharedKeyHash]
//
// å…¶ä¸­ï¼š
// - c1, c2 æ˜¯åŠ å¯†çš„"æ˜¯å¦deactivate"æ ‡å¿—
// - sharedKeyHash = hash(ecdh(oldPrivKey, coordPubKey))
//   Operatorç”¨è¿™ä¸ªæ¥è¯†åˆ«æ˜¯å“ªä¸ªç”¨æˆ·deactivateäº†
//   ä½†åœ¨add-new-keyä¸­ï¼Œè¿™ä¸ªä¸ä¼šè¢«å…¬å¼€
```

**æ­¥éª¤ 3: æ–°ç”¨æˆ·è·å– Deactivate æ•°æ®**

```typescript
// æŸ¥è¯¢é“¾ä¸Šçš„ deactivate æ•°æ®
const deactivates = await client.indexer.fetchAllDeactivateLogs(contractAddress);

// è¿”å›çš„æ˜¯ deactivate tree çš„æ‰€æœ‰ leaf
// æ ¼å¼ï¼š[[c1[0], c1[1], c2[0], c2[1], hash], ...]
```

**æ­¥éª¤ 4: æ–°ç”¨æˆ·ç”Ÿæˆ ZK è¯æ˜**

```typescript
// ä½¿ç”¨ VoterClient æˆ– OperatorClient
import { VoterClient } from '@dorafactory/maci-sdk';

const voterClient = new VoterClient({
  network: 'testnet',
  secretKey: oldPrivateKeyHex  // è€ç”¨æˆ·çš„ç§é’¥
});

// ç”Ÿæˆ add-new-key payload
const payload = await voterClient.buildAddNewKeyPayload({
  stateTreeDepth: 10,
  operatorPubkey: operatorPubkey,
  deactivates: deactivates,
  wasmFile,  // addNewKey circuit wasm
  zkeyFile   // addNewKey circuit zkey
});

// payload åŒ…å«ï¼š
// - proof: ZKè¯æ˜
// - d: [d1[0], d1[1], d2[0], d2[1]]ï¼ˆé‡æ–°éšæœºåŒ–çš„å€¼ï¼‰
// - nullifier: é˜²æ­¢é‡å¤ä½¿ç”¨
```

**æ­¥éª¤ 5: æäº¤ Add-new-key**

```typescript
// ä½¿ç”¨æ–°é’±åŒ…æäº¤
const newKeypair = genKeypair();

await client.addNewKey({
  signer: newWallet,         // æ–°é’±åŒ…ï¼
  contractAddress,
  d: payload.d,
  proof: payload.proof,
  nullifier: payload.nullifier,
  newMaciKeypair: newKeypair,  // æ–°çš„MACIå¯†é’¥å¯¹
  fee: 'auto'
});
```

**ZK è¯æ˜å†…å®¹ï¼š**

```
å…¬å¼€è¾“å…¥ï¼ˆOperatorå¯è§ï¼‰ï¼š
- deactivateRoot: deactivateæ ‘çš„æ ¹
- coordPubKeyHash: Operatorå…¬é’¥çš„å“ˆå¸Œ
- nullifier: é˜²é‡æ”¾
- d1[0], d1[1], d2[0], d2[1]: é‡æ–°éšæœºåŒ–çš„å€¼

ç§æœ‰è¾“å…¥ï¼ˆä¸å…¬å¼€ï¼‰ï¼š
- oldPrivateKey: è€ç”¨æˆ·çš„ç§é’¥
- deactivateIndex: æ˜¯deactivateæ ‘ä¸­çš„ç¬¬å‡ ä¸ªï¼ˆå…³é”®ï¼ï¼‰
- deactivateLeaf: å¯¹åº”çš„leafå€¼
- c1, c2: åŸå§‹åŠ å¯†å€¼
- randomVal: é‡æ–°éšæœºåŒ–ç”¨çš„éšæœºæ•°
- deactivateLeafPathElements: Merkleè¯æ˜è·¯å¾„

è¯æ˜å£°ç§°ï¼š
"æˆ‘çŸ¥é“deactivateæ ‘ä¸­æŸä¸ªæ¡ç›®å¯¹åº”çš„ç§é’¥ï¼Œ
 å¹¶ä¸”æˆ‘æ­£ç¡®åœ°é‡æ–°éšæœºåŒ–ç”Ÿæˆäº†d1, d2ï¼Œ
 ä½†æˆ‘ä¸å‘Šè¯‰ä½ æ˜¯ç¬¬å‡ ä¸ªæ¡ç›®"
```

**åˆçº¦å¤„ç†ï¼š**

```rust
// 1. éªŒè¯ nullifier æœªä½¿ç”¨
// 2. éªŒè¯ ZK è¯æ˜
// 3. åˆ›å»ºæ–° State Leaf
StateLeaf {
    pub_key: new_pubkey,      // å…¨æ–°çš„å…¬é’¥
    voice_credit_balance: 100,
    vote_option_tree_root: empty,
    nonce: 0,
    d1: [d[0], d[1]],        // ä»proofä¸­æ¥
    d2: [d[2], d[3]],        // ä»proofä¸­æ¥
}
// 4. åˆ†é…æ–° State Index
```

**éšç§çº§åˆ«ï¼šâ­â­â­â­â­**

Operator èƒ½çœ‹åˆ°ï¼š
- æœ‰äººä½¿ç”¨ add-new-key åˆ›å»ºäº†æ–°èº«ä»½
- æ–°èº«ä»½æ˜¯ deactivate æ ‘ä¸­æŸä¸ªç”¨æˆ·
- æ–°èº«ä»½çš„ State Index æ˜¯ X

Operator æ— æ³•ç¡®å®šï¼š
- æ˜¯ deactivate æ ‘ä¸­çš„ç¬¬å‡ ä¸ªç”¨æˆ·
- å¯¹åº”å“ªä¸ªé’±åŒ…åœ°å€
- ä¸å“ªä¸ªè€èº«ä»½å…³è”

**åŒ¿åé›†å¤§å°ï¼š**
- å¦‚æœ deactivate æ ‘æœ‰ 100 ä¸ªæ¡ç›®
- æ–°ç”¨æˆ·çš„åŒ¿åé›†å¤§å° = 100
- Operator åªèƒ½ç¡®å®š"æ˜¯è¿™100äººä¹‹ä¸€"

---

### 3. Pre-add-new-keyï¼ˆé¢„ç”Ÿæˆæ¨¡å¼ï¼‰â­ æ¨è

**å·¥ä½œåŸç†ï¼š**

å¹³å°é¢„å…ˆä¸ºç”¨æˆ·ç”Ÿæˆ EdDSA-Poseidon å¯†é’¥å¯¹å¹¶åˆ†å‘ï¼Œç”¨æˆ·åœ¨æœ¬åœ°ç”Ÿæˆè¯æ˜å’Œæ–°å¯†é’¥å¯¹ï¼Œç”¨ä»»æ„ dora åœ°å€å‘é€äº¤æ˜“ã€‚

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**
- âœ… **ç«‹å³å¯ç”¨**ï¼šæ— éœ€ç­‰å¾… deactivate å¤„ç†
- âœ… **å®Œå…¨åŒ¿å**ï¼šç”¨æˆ·å¯ä»¥ç”¨ä»»æ„åœ°å€å‘é€äº¤æ˜“
- âœ… **ç”¨æˆ·æ§åˆ¶**ï¼šåœ¨æœ¬åœ°ç”Ÿæˆè¯æ˜å’Œæ–°å¯†é’¥
- âœ… **å¹³å°å‹å¥½**ï¼šé€‚åˆæ‰¹é‡ä¸ºç”¨æˆ·å‡†å¤‡
- âœ… **çµæ´»æ€§é«˜**ï¼šä¸éœ€è¦å…ˆæœ‰è€è´¦æˆ·

**ä¸å…¶ä»–æ–¹å¼çš„å¯¹æ¯”ï¼š**

| ç‰¹æ€§ | Signup | Add-new-key | Pre-add-new-key |
|------|--------|-------------|-----------------|
| éœ€è¦ç™½åå• | âœ… æ˜¯ | âŒ å¦ | âŒ å¦ |
| éœ€è¦è€è´¦æˆ· | âŒ å¦ | âœ… æ˜¯ | âŒ å¦ |
| ç­‰å¾…æ—¶é—´ | ç«‹å³ | éœ€ç­‰å¾… ProcessDeactivate | ç«‹å³ |
| å‘é€åœ°å€ | å¿…é¡»ç™½åå•åœ°å€ | æ–°é’±åŒ… | ä»»æ„é’±åŒ… |
| éšç§çº§åˆ« | â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| é€‚ç”¨åœºæ™¯ | ç®€å•æŠ•ç¥¨ | å·²æœ‰ç”¨æˆ·æ¢èº«ä»½ | â­ æ–°ç”¨æˆ·åŒ¿å |

**å®Œæ•´æµç¨‹ï¼š**

**æ­¥éª¤ 1: å¹³å°é¢„ç”Ÿæˆå¯†é’¥å¯¹**

```typescript
// å¹³å°æå‰ä¸ºç”¨æˆ·ç”Ÿæˆ EdDSA-Poseidon å¯†é’¥å¯¹
import { genKeypair } from 'maci-crypto';

const userPreKeys = [];
for (let i = 0; i < 1000; i++) {
  const keypair = genKeypair();
  userPreKeys.push({
    id: `user_${i}`,
    privateKey: keypair.privateKey.toString(16),
    publicKey: [
      keypair.publicKey[0].toString(16),
      keypair.publicKey[1].toString(16)
    ]
  });
}

// å¹³å°ç”Ÿæˆ pre-deactivate tree
const preDeactivateTree = buildPreDeactivateTree(userPreKeys, platformCoordKeypair);

console.log(`é¢„ç”Ÿæˆ ${userPreKeys.length} ä¸ªå¯†é’¥å¯¹`);
console.log(`Pre-deactivate root: ${preDeactivateTree.root}`);
```

**æ­¥éª¤ 2: åˆ›å»º Round æ—¶é…ç½®**

```typescript
// Round åˆ›å»ºæ—¶é…ç½® pre-deactivate root
await client.createMaciRound({
  signer: creatorWallet,
  operatorPubkey: operatorPubkey,
  
  startVoting: new Date(),
  endVoting: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
  
  title: 'ç¤¾åŒºæŠ•ç¥¨',
  voteOptionMap: ['é€‰é¡¹ A', 'é€‰é¡¹ B', 'é€‰é¡¹ C'],
  
  // é…ç½® pre-deactivate
  preDeactivateRoot: preDeactivateTree.root,
  preDeactivateCoordinator: {
    x: platformCoordKeypair.publicKey[0].toString(16),
    y: platformCoordKeypair.publicKey[1].toString(16)
  },
  
  circuitType: MaciCircuitType.QV
});
```

**æ­¥éª¤ 3: å¹³å°åˆ†å‘å¯†é’¥ç»™ç”¨æˆ·**

å¹³å°é€šè¿‡å®‰å…¨æ¸ é“å°†å¯†é’¥å¯¹åˆ†å‘ç»™ç”¨æˆ·ï¼š

```typescript
// API è¿”å›ç»™ç”¨æˆ·
{
  "privateKey": "0x1234567890abcdef...",
  "publicKey": {
    "x": "0xabcdef...",
    "y": "0x123456..."
  },
  "preDeactivateData": {
    "leaves": [ /* deactivate tree çš„æ‰€æœ‰ leaf */ ],
    "coordinatorPubkey": { "x": "...", "y": "..." }
  }
}
```

**æ­¥éª¤ 4: ç”¨æˆ·åœ¨æœ¬åœ°ç”Ÿæˆè¯æ˜**

```typescript
// ç”¨æˆ·åœ¨æœ¬åœ°ï¼ˆæµè§ˆå™¨æˆ–æœ¬åœ°æœºå™¨ï¼‰
import { VoterClient, genKeypair } from '@dorafactory/maci-sdk';

// ä½¿ç”¨å¹³å°åˆ†å‘çš„ç§é’¥
const voterClient = new VoterClient({
  network: 'mainnet',
  secretKey: receivedPrivateKey  // å¹³å°åˆ†å‘çš„ç§é’¥
});

// â­ ç”¨æˆ·ç”Ÿæˆè‡ªå·±çš„æ–°å¯†é’¥å¯¹ï¼ˆå®Œå…¨ç”±ç”¨æˆ·æ§åˆ¶ï¼‰
const myNewKeypair = genKeypair();  // æ²¡æœ‰äººçŸ¥é“è¿™ä¸ªå¯†é’¥

console.log('âœ… æ–°å¯†é’¥å·²åœ¨æœ¬åœ°ç”Ÿæˆï¼Œåªæœ‰æˆ‘çŸ¥é“');

// ç”Ÿæˆ pre-add-new-key payload
const payload = await voterClient.buildPreAddNewKeyPayload({
  stateTreeDepth: 10,
  coordinatorPubkey: preDeactivateData.coordinatorPubkey,
  deactivates: preDeactivateData.leaves,
  wasmFile,  // circuit wasm
  zkeyFile   // circuit zkey
});

console.log('âœ… ZK è¯æ˜åœ¨æœ¬åœ°ç”Ÿæˆå®Œæˆ');
```

**æ­¥éª¤ 5: ç”¨æˆ·ç”¨ä»»æ„åœ°å€å‘é€äº¤æ˜“**

```typescript
// â­ ç”¨æˆ·å¯ä»¥ç”¨ä»»ä½• dora åœ°å€å‘é€æ­¤äº¤æ˜“
// å¯ä»¥æ˜¯æ–°é’±åŒ…ï¼Œå¯ä»¥æ˜¯æ—§é’±åŒ…ï¼Œå®Œå…¨è‡ªç”±

await client.rawPreAddNewKey({
  signer: anyWallet,  // ä»»æ„é’±åŒ…ï¼
  contractAddress,
  d: payload.d,
  proof: payload.proof,
  nullifier: payload.nullifier,
  newPubkey: {
    x: myNewKeypair.publicKey[0].toString(16),
    y: myNewKeypair.publicKey[1].toString(16)
  },
  gasStation: true
});

console.log('âœ… åŒ¿åæ³¨å†ŒæˆåŠŸ');
console.log('âœ… Operator ä¸çŸ¥é“æ˜¯è°');
console.log('âœ… å¹³å°ä¸çŸ¥é“æ–°å¯†é’¥');
```

**æ­¥éª¤ 6: æŠ•ç¥¨**

```typescript
// ç”¨æˆ·ç”¨è‡ªå·±çš„æ–°å¯†é’¥å¯¹æŠ•ç¥¨
const roundInfo = await client.getRoundInfo({ contractAddress });

await client.vote({
  signer: anyWallet,  // åŒæ ·å¯ä»¥ç”¨ä»»æ„é’±åŒ…
  address: anyAddress,
  contractAddress,
  selectedOptions: [
    { idx: 0, vc: 10 }
  ],
  operatorCoordPubKey: [
    BigInt(roundInfo.coordinatorPubkeyX),
    BigInt(roundInfo.coordinatorPubkeyY)
  ],
  maciKeypair: myNewKeypair,  // åªæœ‰ç”¨æˆ·çŸ¥é“
  gasStation: true
});

console.log('âœ… æŠ•ç¥¨å®Œæˆï¼Œå®Œå…¨åŒ¿å');
```

**éšç§åˆ†æï¼š**

```
å¹³å°çŸ¥é“ï¼š
âœ… é¢„ç”Ÿæˆçš„å¯†é’¥å¯¹ï¼ˆå·²åˆ†å‘ï¼‰
âœ… Pre-deactivate tree
âŒ ç”¨æˆ·çš„æ–°å¯†é’¥å¯¹ï¼ˆç”¨æˆ·æœ¬åœ°ç”Ÿæˆï¼‰
âŒ ç”¨æˆ·ç”¨å“ªä¸ªåœ°å€å‘é€äº¤æ˜“
âŒ ç”¨æˆ·çš„æŠ•ç¥¨å†…å®¹

Operator çŸ¥é“ï¼š
âœ… æœ‰äººç”¨ pre-add-new-key æ³¨å†Œäº†
âœ… æ˜¯ pre-deactivate tree ä¸­çš„æŸä¸€ä¸ª
âŒ å…·ä½“æ˜¯ç¬¬å‡ ä¸ªç”¨æˆ·
âŒ å‘é€äº¤æ˜“çš„åœ°å€æ˜¯è°
âŒ ç”¨æˆ·çš„çœŸå®èº«ä»½

ç”¨æˆ·éšç§ä¿æŠ¤ï¼š
âœ… åŒ¿åé›† = pre-deactivate tree å¤§å°
âœ… å³ä½¿å¹³å°å’Œ Operator ä¸²è°‹ä¹Ÿæ— æ³•ç¡®å®š
âœ… æ–°å¯†é’¥å®Œå…¨ç”±ç”¨æˆ·æ§åˆ¶
âœ… å¯ç”¨ä»»æ„åœ°å€å‘é€ï¼Œæ— æ³•è¿½è¸ª
```

**ä¼˜åŠ¿æ€»ç»“ï¼š**

1. **æ— éœ€ç­‰å¾…**ï¼šç«‹å³å¯ç”¨ï¼Œä¸éœ€è¦ç­‰ deactivate å¤„ç†
2. **å®Œå…¨åŒ¿å**ï¼šå¯ç”¨ä»»æ„åœ°å€å‘é€ï¼Œæ— æ³•è¿½è¸ª
3. **ç”¨æˆ·æ§åˆ¶**ï¼šæ–°å¯†é’¥å®Œå…¨ç”±ç”¨æˆ·æœ¬åœ°ç”Ÿæˆå’Œæ§åˆ¶
4. **å¹³å°å‹å¥½**ï¼šé€‚åˆå¹³å°æ‰¹é‡ä¸ºç”¨æˆ·å‡†å¤‡
5. **å®‰å…¨æ€§é«˜**ï¼šå³ä½¿å¹³å°çŸ¥é“é¢„ç”Ÿæˆå¯†é’¥ï¼Œä¹Ÿä¸çŸ¥é“æ–°å¯†é’¥
6. **çµæ´»æ€§å¼º**ï¼šä¸éœ€è¦å…ˆæœ‰è´¦æˆ·ï¼Œä¸éœ€è¦åœ¨ç™½åå•ä¸­

**é€‚ç”¨åœºæ™¯ï¼š**
- â­â­â­ **æ¨èç”¨äºæ–°ç”¨æˆ·**ï¼šé¦–æ¬¡å‚ä¸æŠ•ç¥¨
- â­â­â­ **å¹³å°è¿è¥**ï¼šå¹³å°å¯ä»¥æ‰¹é‡å‡†å¤‡
- â­â­â­ **ç©ºæŠ•/æ´»åŠ¨**ï¼šä¸ºå‚ä¸è€…é¢„å…ˆåˆ†é…
- â­â­â­ **éšç§æŠ•ç¥¨**ï¼šç”¨æˆ·ä¸æƒ³æš´éœ²èº«ä»½
- â­â­â­ **å¤§è§„æ¨¡åº”ç”¨**ï¼šå¯ä»¥é¢„å…ˆä¸ºå¤§é‡ç”¨æˆ·å‡†å¤‡

**éšç§çº§åˆ«ï¼šâ­â­â­â­â­**
- å®Œå…¨åŒ¿åï¼ŒOperator æ— æ³•ç¡®å®šèº«ä»½
- å¹³å°ä¹Ÿæ— æ³•è·Ÿè¸ªç”¨æˆ·çš„æ–°å¯†é’¥å’ŒæŠ•ç¥¨
- ç”¨æˆ·å¯ä»¥ç”¨ä»»æ„åœ°å€ï¼Œå¢åŠ é¢å¤–åŒ¿åå±‚

---

## ä¸‰ä¸ªå…³é”®è§’è‰²

AMACI ç³»ç»Ÿç”±ä¸‰ä¸ªå…³é”®è§’è‰²ç»„æˆï¼Œæ¯ä¸ªè§’è‰²åœ¨ç³»ç»Ÿä¸­æ‰®æ¼”ä¸åŒçš„èŒè´£ã€‚

### 1. æŠ•ç¥¨è€…ï¼ˆVoterï¼‰

æŠ•ç¥¨è€…æ˜¯å‚ä¸æŠ•ç¥¨çš„ç”¨æˆ·ï¼Œæ‹¥æœ‰è‡ªå·±çš„å¯†é’¥å¯¹å¹¶æäº¤åŠ å¯†çš„æŠ•ç¥¨æ¶ˆæ¯ã€‚

#### å¯†é’¥å¯¹

æ¯ä¸ªæŠ•ç¥¨è€…éƒ½æœ‰ä¸€ä¸ª EdDSA å¯†é’¥å¯¹ï¼š

```typescript
// å¯†é’¥å¯¹ç»“æ„
interface Keypair {
  privateKey: bigint;     // ç§é’¥ï¼ˆä¿å¯†ï¼‰
  publicKey: [bigint, bigint];  // å…¬é’¥ï¼ˆBaby Jubjub æ›²çº¿ä¸Šçš„ç‚¹ï¼‰
}

// ç”Ÿæˆå¯†é’¥å¯¹
const keypair = genKeypair();
```

**å…¬é’¥ï¼ˆPublic Keyï¼‰ï¼š**
- Baby Jubjub æ›²çº¿ä¸Šçš„ä¸€ä¸ªç‚¹ (x, y)
- å…¬å¼€ç»™ç³»ç»Ÿï¼Œç”¨äºéªŒè¯ç­¾å
- å­˜å‚¨åœ¨çŠ¶æ€æ ‘ä¸­

**ç§é’¥ï¼ˆPrivate Keyï¼‰ï¼š**
- ä¸€ä¸ªå¤§æ•´æ•°
- å¿…é¡»ä¿å¯†ï¼Œç”¨äºç­¾åæ¶ˆæ¯
- å¯ä»¥æ›´æ”¹ï¼ˆç”Ÿæˆæ–°å¯†é’¥å¯¹ï¼‰

#### æŠ•ç¥¨è€…çš„æ“ä½œ

**æ³¨å†Œæ–¹å¼é€‰æ‹©ï¼š**

```typescript
// æ–¹å¼ 1: Signupï¼ˆå¿«é€Ÿï¼Œä½éšç§ï¼‰
const maciKeypair = await client.genKeypairFromSign({
  signer: wallet,
  address
});

const certificate = await client.requestOracleCertificate({
  signer: wallet,
  ecosystem: 'cosmoshub',
  address,
  contractAddress
});

await client.signup({
  signer: wallet,
  address,
  contractAddress,
  maciKeypair,
  oracleCertificate: certificate,
  gasStation: true
});
```

```typescript
// æ–¹å¼ 2: Add-new-keyï¼ˆé«˜éšç§ï¼Œéœ€ç­‰å¾…ï¼‰
// è§ä¸Šé¢çš„è¯¦ç»†æµç¨‹

// æ–¹å¼ 3: Pre-add-new-keyï¼ˆé«˜éšç§ï¼Œå³æ—¶ï¼‰
// è§ä¸Šé¢çš„è¯¦ç»†æµç¨‹
```

**æŠ•ç¥¨ï¼ˆVoteï¼‰ï¼š**

```typescript
// æ‰€æœ‰æ³¨å†Œæ–¹å¼åçš„æŠ•ç¥¨æµç¨‹ç›¸åŒ
const roundInfo = await client.getRoundInfo({ contractAddress });

await client.vote({
  signer: wallet,
  address,
  contractAddress,
  selectedOptions: [
    { idx: 0, vc: 5 },
    { idx: 1, vc: 3 },
  ],
  operatorCoordPubKey: [
    BigInt(roundInfo.coordinatorPubkeyX),
    BigInt(roundInfo.coordinatorPubkeyY)
  ],
  maciKeypair,
  gasStation: true
});
```

**Deactivateï¼ˆä¸ºä»–äººåˆ›å»ºåŒ¿åæœºä¼šï¼‰ï¼š**

```typescript
// å¦‚æœæƒ³å¸®åŠ©ä»–äººè·å¾—åŒ¿åèº«ä»½
await client.deactivate({
  signer: wallet,
  address,
  contractAddress,
  maciKeypair,
  gasStation: true
});

// è¿™ä¼šè®©ä½ çš„èº«ä»½è¿›å…¥ deactivate æ ‘
// å…¶ä»–äººå¯ä»¥ä½¿ç”¨ add-new-key åŸºäºè¿™ä¸ªæ ‘åˆ›å»ºæ–°èº«ä»½
```

### 2. Coordinatorï¼ˆåè°ƒè€…/Operatorï¼‰

Coordinator è´Ÿè´£å¤„ç†åŠ å¯†æ¶ˆæ¯ã€ç”Ÿæˆè¯æ˜å¹¶å‘å¸ƒç»“æœã€‚

#### Coordinator çš„èŒè´£

```mermaid
graph TD
    A[Coordinator] --> B[å¯†é’¥ç®¡ç†]
    A --> C[æ¶ˆæ¯å¤„ç†]
    A --> D[è¯æ˜ç”Ÿæˆ]
    A --> E[ç»“æœå‘å¸ƒ]
    B --> B1[ç”Ÿæˆå¯†é’¥å¯¹]
    B --> B2[å…¬å¸ƒå…¬é’¥]
    C --> C1[ä¸‹è½½æ¶ˆæ¯]
    C --> C2[è§£å¯†æ¶ˆæ¯]
    C --> C3[éªŒè¯ç­¾å]
    C --> C4[å¤„ç†æŠ•ç¥¨]
    D --> D1[ProcessMessages è¯æ˜]
    D --> D2[Tally è¯æ˜]
    E --> E1[æäº¤è¯æ˜åˆ°é“¾ä¸Š]
    E --> E2[å‘å¸ƒç»Ÿè®¡ç»“æœ]
```

#### Coordinator å¯†é’¥å¯¹

Coordinator ä¹Ÿæœ‰è‡ªå·±çš„ EdDSA å¯†é’¥å¯¹ï¼š

```typescript
// Coordinator å¯†é’¥å¯¹
interface CoordinatorKeypair {
  privateKey: bigint;            // ç”¨äºè§£å¯†æŠ•ç¥¨æ¶ˆæ¯
  publicKey: [bigint, bigint];   // å…¬å¼€ï¼Œç”¨äºæŠ•ç¥¨è€…åŠ å¯†
}
```

**å…¬é’¥ç”¨é€”ï¼š**
- æŠ•ç¥¨è€…ä½¿ç”¨ Coordinator å…¬é’¥åŠ å¯†æŠ•ç¥¨æ¶ˆæ¯
- å…¬å¸ƒåœ¨æŠ•ç¥¨è½®æ¬¡ä¿¡æ¯ä¸­

**ç§é’¥ç”¨é€”ï¼š**
- Coordinator ä½¿ç”¨ç§é’¥è§£å¯†æŠ•ç¥¨æ¶ˆæ¯
- ä¸¥æ ¼ä¿å¯†ï¼Œä¸èƒ½æ³„éœ²

#### å¤„ç†æµç¨‹

**1. ä¸‹è½½æ¶ˆæ¯**

```typescript
// ä»é“¾ä¸ŠæŸ¥è¯¢æ‰€æœ‰æŠ•ç¥¨æ¶ˆæ¯
const messages = await contract.getMessages();

// æ¶ˆæ¯ç»“æ„
interface Message {
  msgType: bigint;      // æ¶ˆæ¯ç±»å‹
  data: bigint[];       // åŠ å¯†çš„æ¶ˆæ¯æ•°æ®ï¼ˆ10ä¸ªå­—æ®µï¼‰
}
```

**2. è§£å¯†æ¶ˆæ¯**

```typescript
// ä½¿ç”¨ ECDH å…±äº«å¯†é’¥è§£å¯†
const sharedKey = genEcdhSharedKey(
  coordinatorPrivKey,
  voterPubKey
);

const command = decrypt(message.data, sharedKey);

// è§£å¯†åçš„å‘½ä»¤ç»“æ„
interface Command {
  nonce: bigint;          // æ¶ˆæ¯åºå·
  stateIndex: bigint;     // æŠ•ç¥¨è€…çŠ¶æ€ç´¢å¼•
  voteOptionIndex: bigint; // æŠ•ç¥¨é€‰é¡¹ç´¢å¼•
  newVoteWeight: bigint;   // æ–°çš„æŠ•ç¥¨æƒé‡
  newPubKey: [bigint, bigint]; // æ–°å…¬é’¥ï¼ˆå¯èƒ½ä¸å˜ï¼‰
  salt: bigint;           // éšæœºç›å€¼
  signature: Signature;   // EdDSA ç­¾å
}
```

**3. éªŒè¯å’Œå¤„ç†**

```typescript
// éªŒè¯ç­¾å
const isValid = verifySignature(
  command,
  command.signature,
  voterPubKey
);

if (isValid && command.nonce === currentNonce) {
  // æ›´æ–°çŠ¶æ€æ ‘
  updateStateTree(command);
  
  // æ›´æ–°æŠ•ç¥¨é€‰é¡¹æ ‘
  updateVoteOptionTree(command);
}
```

#### é›¶çŸ¥è¯†è¯æ˜çº¦æŸ

Coordinator è™½ç„¶å¯ä»¥çœ‹åˆ°æŠ•ç¥¨å†…å®¹ï¼Œä½†å—åˆ°é›¶çŸ¥è¯†è¯æ˜çš„çº¦æŸï¼š

```mermaid
graph LR
    A[Coordinator å¤„ç†] --> B[ç”Ÿæˆè¯æ˜]
    B --> C{é“¾ä¸ŠéªŒè¯}
    C -->|çº¦æŸ1| D[å¤„ç†æ‰€æœ‰æ¶ˆæ¯]
    C -->|çº¦æŸ2| E[æŒ‰æ­£ç¡®é¡ºåº]
    C -->|çº¦æŸ3| F[æ­£ç¡®æ›´æ–°çŠ¶æ€]
    C -->|çº¦æŸ4| G[æ­£ç¡®ç»Ÿè®¡ç»“æœ]
    D --> H[è¯æ˜é€šè¿‡]
    E --> H
    F --> H
    G --> H
```

**çº¦æŸåŒ…æ‹¬ï¼š**
- å¿…é¡»å¤„ç†æ‰€æœ‰é“¾ä¸Šæ¶ˆæ¯
- å¿…é¡»æŒ‰ Nonce é¡ºåºå¤„ç†
- å¿…é¡»æ­£ç¡®éªŒè¯ç­¾å
- å¿…é¡»æ­£ç¡®æ›´æ–°çŠ¶æ€æ ‘
- å¿…é¡»æ­£ç¡®ç»Ÿè®¡æŠ•ç¥¨ç»“æœ
- ä¸èƒ½ä¼ªé€ æˆ–ä¿®æ”¹æŠ•ç¥¨

### 3. æ™ºèƒ½åˆçº¦

æ™ºèƒ½åˆçº¦å……å½“å¯ä¿¡çš„ä¸­ä»‹ï¼Œå­˜å‚¨æ•°æ®å¹¶éªŒè¯è¯æ˜ã€‚

#### åˆçº¦çš„èŒè´£

**å­˜å‚¨ç®¡ç†ï¼š**
- å­˜å‚¨æŠ•ç¥¨è€…å…¬é’¥
- å­˜å‚¨åŠ å¯†çš„æŠ•ç¥¨æ¶ˆæ¯
- å­˜å‚¨çŠ¶æ€æ ‘æ ¹
- å­˜å‚¨æŠ•ç¥¨ç»“æœ

**éªŒè¯åŠŸèƒ½ï¼š**
- éªŒè¯æŠ•ç¥¨è€…ç­¾å
- éªŒè¯ç™½åå•èµ„æ ¼
- éªŒè¯é›¶çŸ¥è¯†è¯æ˜
- éªŒè¯æŠ•ç¥¨è§„åˆ™

**çŠ¶æ€ç®¡ç†ï¼š**
- ç®¡ç†æŠ•ç¥¨è½®æ¬¡çŠ¶æ€ï¼ˆCreated â†’ Voting â†’ Processing â†’ Talliedï¼‰
- ç®¡ç†æŠ•ç¥¨è€…çŠ¶æ€
- ç®¡ç†æ¶ˆæ¯é˜Ÿåˆ—

#### åˆçº¦çŠ¶æ€

```rust
// è½®æ¬¡çŠ¶æ€
pub enum RoundStatus {
    Created,      // å·²åˆ›å»ºï¼Œç­‰å¾…å¼€å§‹
    Voting,       // æŠ•ç¥¨è¿›è¡Œä¸­
    Processing,   // æ­£åœ¨å¤„ç†æ¶ˆæ¯
    Tallied,      // å·²ç»Ÿè®¡å®Œæˆ
}

// åˆçº¦å­˜å‚¨çš„æ•°æ®
pub struct MaciState {
    coordinator_pubkey: PubKey,           // Coordinator å…¬é’¥
    state_tree_root: Uint256,             // çŠ¶æ€æ ‘æ ¹
    message_tree_root: Uint256,           // æ¶ˆæ¯æ ‘æ ¹
    num_signups: u64,                     // æ³¨å†Œäººæ•°
    messages: Vec<Message>,               // æ¶ˆæ¯é˜Ÿåˆ—
    status: RoundStatus,                  // è½®æ¬¡çŠ¶æ€
    results: Option<Vec<Uint256>>,        // æŠ•ç¥¨ç»“æœ
}
```

## çŠ¶æ€ç®¡ç†

MACI ä½¿ç”¨ Merkle Tree æ¥é«˜æ•ˆç®¡ç†å¤§é‡æ•°æ®ã€‚

### çŠ¶æ€æ ‘ï¼ˆState Treeï¼‰

AMACI çš„çŠ¶æ€æ ‘æ¯” MACI æ›´å¤æ‚ï¼ŒåŒ…å«åŒ¿ååŒ–å­—æ®µã€‚

#### AMACI State Leaf ç»“æ„

æ¯ä¸ªæŠ•ç¥¨è€…åœ¨çŠ¶æ€æ ‘ä¸­å æ®ä¸€ä¸ª Leafï¼š

```typescript
interface AmaciStateLeaf {
  pubKey: [bigint, bigint];    // æŠ•ç¥¨è€…å…¬é’¥
  voiceCreditBalance: bigint;  // å‰©ä½™æŠ•ç¥¨æƒé‡
  voteOptionTreeRoot: bigint;  // æŠ•ç¥¨é€‰é¡¹æ ‘æ ¹
  nonce: bigint;               // å½“å‰ Nonce
  d1: [bigint, bigint];        // ç”¨äºadd-new-keyçš„åŒ¿ååŒ–æ•°æ®
  d2: [bigint, bigint];        // ç”¨äºadd-new-keyçš„åŒ¿ååŒ–æ•°æ®
}
```

**å­—æ®µè¯´æ˜ï¼š**

- **pubKey**ï¼šæŠ•ç¥¨è€…çš„å½“å‰å…¬é’¥
- **voiceCreditBalance**ï¼šå‰©ä½™çš„æŠ•ç¥¨æƒé‡
  - 1P1V æ¨¡å¼ï¼šç›´æ¥æ‰£é™¤æŠ•ç¥¨æƒé‡
  - QV æ¨¡å¼ï¼šæ‰£é™¤æŠ•ç¥¨æƒé‡çš„å¹³æ–¹
- **voteOptionTreeRoot**ï¼šè¯¥æŠ•ç¥¨è€…æŠ•ç¥¨é€‰é¡¹æ ‘çš„ Merkle æ ¹
- **nonce**ï¼šä¸‹ä¸€æ¡æœ‰æ•ˆæ¶ˆæ¯çš„åºå·
- **d1, d2**ï¼šé‡æ–°éšæœºåŒ–çš„å€¼ï¼Œç”¨äº add-new-key çš„ ZK è¯æ˜

**d1, d2 çš„ä½œç”¨ï¼š**

```typescript
// åœ¨ signup æ—¶
d1 = [0, 0]  // æœªä½¿ç”¨
d2 = [0, 0]  // æœªä½¿ç”¨

// åœ¨ add-new-key æ—¶
d1 = [rerandomized_c1_x, rerandomized_c1_y]
d2 = [rerandomized_c2_x, rerandomized_c2_y]

// d1, d2 åŒ…å«äº†ï¼š
// 1. åŠ å¯†çš„å»æ´»åŒ–æ ‡å¿—
// 2. é‡æ–°éšæœºåŒ–åçš„å€¼
// 3. ç”¨äºåç»­çš„ add-new-key éªŒè¯
```

**MACI vs AMACI State Leafï¼š**

```rust
// MACI State Leaf (5ä¸ªå­—æ®µ)
hash = poseidon([pubKey[0], pubKey[1], balance, voTreeRoot, nonce])

// AMACI State Leaf (10ä¸ªå­—æ®µ)
hash = poseidon([
  poseidon([pubKey[0], pubKey[1], balance, voTreeRoot, nonce]),
  poseidon([d1[0], d1[1], d2[0], d2[1], 0])
])
```

#### çŠ¶æ€æ ‘ç»“æ„

```
              State Tree Root
              /             \
            /                 \
          /                     \
    [State 0]              [State 1]
    User A                 User B
    
    pubKey: [x0, y0]       pubKey: [x1, y1]
    balance: 100           balance: 75
    voTree: root0          voTree: root1
    nonce: 2               nonce: 1
```

**ç‰¹ç‚¹ï¼š**
- ä½¿ç”¨ N-ary Merkle Treeï¼ˆå¦‚ 5-aryï¼‰
- æ ‘çš„æ·±åº¦å–å†³äºæœ€å¤§æŠ•ç¥¨è€…æ•°é‡
- æ¯æ¬¡å¤„ç†æ¶ˆæ¯åæ›´æ–°å¯¹åº”çš„ Leaf
- æ ‘æ ¹å­˜å‚¨åœ¨é“¾ä¸Šåˆçº¦ä¸­

#### çŠ¶æ€æ›´æ–°ç¤ºä¾‹

```typescript
// åˆå§‹çŠ¶æ€
const initialLeaf = {
  pubKey: [x, y],
  voiceCreditBalance: 100,
  voteOptionTreeRoot: emptyRoot,
  nonce: 0,
};

// å¤„ç†æŠ•ç¥¨æ¶ˆæ¯å
const updatedLeaf = {
  pubKey: [x, y],              // å…¬é’¥ä¸å˜
  voiceCreditBalance: 91,      // 100 - 9 (3Â²)
  voteOptionTreeRoot: newRoot, // æ›´æ–°åçš„æŠ•ç¥¨æ ‘æ ¹
  nonce: 1,                    // nonce +1
};

// è®¡ç®—æ–°çš„ Leaf å“ˆå¸Œ
const newLeafHash = hash(updatedLeaf);

// æ›´æ–°çŠ¶æ€æ ‘
updateStateTree(stateIndex, newLeafHash);
```

### æŠ•ç¥¨é€‰é¡¹æ ‘ï¼ˆVote Option Treeï¼‰

æ¯ä¸ªæŠ•ç¥¨è€…æœ‰ä¸€ä¸ªæŠ•ç¥¨é€‰é¡¹æ ‘ï¼Œè®°å½•å¯¹å„é€‰é¡¹çš„æŠ•ç¥¨ã€‚

#### æŠ•ç¥¨é€‰é¡¹æ ‘ç»“æ„

```
              VO Tree Root
              /          \
            /              \
          /                  \
    [Option 0]          [Option 1]
    weight: 5           weight: 3
    
        |                   |
    [Option 2]          [Option 3]
    weight: 0           weight: 2
```

**ç‰¹ç‚¹ï¼š**
- Leaf æ•°é‡ = æŠ•ç¥¨é€‰é¡¹æ•°é‡
- æ¯ä¸ª Leaf å­˜å‚¨å¯¹è¯¥é€‰é¡¹çš„æŠ•ç¥¨æƒé‡
- æŠ•ç¥¨æ—¶åªæ›´æ–°ç›¸å…³çš„ Leaf
- æ ‘æ ¹å­˜å‚¨åœ¨ State Leaf ä¸­

#### æŠ•ç¥¨æ›´æ–°ç¤ºä¾‹

```typescript
// åˆå§‹æŠ•ç¥¨ï¼ˆæ‰€æœ‰é€‰é¡¹æƒé‡ä¸º 0ï¼‰
const initialVotes = [0, 0, 0, 0, 0];

// ç¬¬ä¸€æ¬¡æŠ•ç¥¨ï¼šç»™é€‰é¡¹ 0 æŠ• 5 ç¥¨ï¼Œé€‰é¡¹ 2 æŠ• 3 ç¥¨
const vote1 = [
  { idx: 0, weight: 5 },
  { idx: 2, weight: 3 },
];
// ç»“æœï¼š[5, 0, 3, 0, 0]

// ç¬¬äºŒæ¬¡æŠ•ç¥¨ï¼šä¿®æ”¹æŠ•ç¥¨ï¼Œç»™é€‰é¡¹ 1 æŠ• 4 ç¥¨
const vote2 = [
  { idx: 0, weight: 5 },  // ä¿æŒ
  { idx: 1, weight: 4 },  // æ–°å¢
  { idx: 2, weight: 0 },  // å–æ¶ˆ
];
// ç»“æœï¼š[5, 4, 0, 0, 0]
```

### æ¶ˆæ¯æ ‘ï¼ˆMessage Treeï¼‰

æ‰€æœ‰æŠ•ç¥¨æ¶ˆæ¯æŒ‰æäº¤é¡ºåºç»„æˆæ¶ˆæ¯æ ‘ã€‚

#### æ¶ˆæ¯æ ‘ç»“æ„

```
              Message Tree Root
              /               \
            /                   \
          /                       \
    [Message 0]              [Message 1]
    (User A, t=100)          (User B, t=101)
    
    msgType: 1               msgType: 1
    data: [encrypted]        data: [encrypted]
```

**ç‰¹ç‚¹ï¼š**
- æŒ‰æ—¶é—´é¡ºåºæ·»åŠ æ¶ˆæ¯
- ä¸å¯ä¿®æ”¹æˆ–åˆ é™¤
- æ ‘æ ¹ç”¨äºè¯æ˜æ‰€æœ‰æ¶ˆæ¯è¢«å¤„ç†
- å­˜å‚¨åœ¨é“¾ä¸Šåˆçº¦ä¸­

#### æ¶ˆæ¯ç»“æ„

```typescript
interface Message {
  msgType: bigint;      // æ¶ˆæ¯ç±»å‹ï¼ˆ1=æŠ•ç¥¨ï¼Œ2=å¯†é’¥æ›´æ”¹ï¼‰
  data: bigint[];       // åŠ å¯†æ•°æ®ï¼ˆ10ä¸ªå­—æ®µï¼‰
}

// data åŒ…å«åŠ å¯†çš„ Commandï¼š
// [0]: packaged (nonce + stateIdx + voIdx + newVotes + salt)
// [1]: newPubKey.x
// [2]: newPubKey.y
// [3]: signature.R8.x
// [4]: signature.R8.y
// [5]: signature.S
// [6-9]: åŠ å¯† IV å’Œå…¶ä»–æ•°æ®
```

## Nonce æœºåˆ¶

Nonce æ˜¯ MACI ä¸­çš„å…³é”®æœºåˆ¶ï¼Œç¡®ä¿æ¶ˆæ¯æŒ‰æ­£ç¡®é¡ºåºå¤„ç†ã€‚

### Nonce å·¥ä½œåŸç†

```mermaid
sequenceDiagram
    participant Voter as æŠ•ç¥¨è€…
    participant Contract as åˆçº¦
    participant Coord as Coordinator
    Note over Voter: Nonce = 0
    Voter->>Contract: æ¶ˆæ¯1 (nonce=0)
    Note over Contract: å­˜å‚¨æ¶ˆæ¯1
    Note over Voter: Nonce = 0 (æœªæ›´æ–°)
    Voter->>Contract: æ¶ˆæ¯2 (nonce=1)
    Note over Contract: å­˜å‚¨æ¶ˆæ¯2
    Note over Coord: å¤„ç†é˜¶æ®µ
    Coord->>Coord: å¤„ç†æ¶ˆæ¯1 (nonce=0 âœ“)
    Note over Coord: æ›´æ–° Nonce = 1
    Coord->>Coord: å¤„ç†æ¶ˆæ¯2 (nonce=1 âœ“)
    Note over Coord: æ›´æ–° Nonce = 2
```

### Nonce éªŒè¯è§„åˆ™

```typescript
// å¤„ç†æ¶ˆæ¯æ—¶éªŒè¯ Nonce
function processMessage(command: Command, currentState: StateLeaf): boolean {
  // è§„åˆ™ 1: Nonce å¿…é¡»ç­‰äºå½“å‰ Nonce
  if (command.nonce !== currentState.nonce) {
    return false; // æ‹’ç»æ¶ˆæ¯
  }
  
  // è§„åˆ™ 2: éªŒè¯ç­¾å
  if (!verifySignature(command, currentState.pubKey)) {
    return false; // æ‹’ç»æ¶ˆæ¯
  }
  
  // è§„åˆ™ 3: æ£€æŸ¥ä½™é¢
  const cost = calculateCost(command.newVoteWeight);
  if (cost > currentState.voiceCreditBalance) {
    return false; // ä½™é¢ä¸è¶³
  }
  
  // æ¥å—æ¶ˆæ¯å¹¶æ›´æ–° Nonce
  currentState.nonce += 1;
  return true;
}
```

### Nonce ä¸é‡æ–°æŠ•ç¥¨

```typescript
// åœºæ™¯ï¼šç”¨æˆ·æƒ³è¦é‡æ–°æŠ•ç¥¨

// ç¬¬ä¸€æ¬¡æŠ•ç¥¨ï¼ˆNonce = 0ï¼‰
await vote({ nonce: 0, option: 0, weight: 5 });
// é“¾ä¸Š Nonce ä»ç„¶æ˜¯ 0ï¼ˆè¿˜æœªå¤„ç†ï¼‰

// ç¬¬äºŒæ¬¡æŠ•ç¥¨ï¼ˆNonce = 1ï¼‰
await vote({ nonce: 1, option: 1, weight: 5 });
// é“¾ä¸Š Nonce ä»ç„¶æ˜¯ 0

// Coordinator å¤„ç†ï¼š
// - å¤„ç†æ¶ˆæ¯1ï¼šnonce=0 âœ“ï¼Œæ›´æ–°çŠ¶æ€ï¼Œæ–° nonce=1
// - å¤„ç†æ¶ˆæ¯2ï¼šnonce=1 âœ“ï¼Œæ›´æ–°çŠ¶æ€ï¼Œæ–° nonce=2
// ä¸¤æ¬¡æŠ•ç¥¨éƒ½æœ‰æ•ˆï¼Œç¬¬äºŒæ¬¡è¦†ç›–ç¬¬ä¸€æ¬¡
```

### Nonce ä¸å¯†é’¥æ›´æ”¹

```typescript
// åœºæ™¯ï¼šç”¨æˆ·æ›´æ”¹å¯†é’¥ä½¿ä¹‹å‰çš„æŠ•ç¥¨å¤±æ•ˆ

// ä½¿ç”¨å¯†é’¥ K1 æŠ•ç¥¨ï¼ˆNonce = 0ï¼‰
await vote({ 
  keypair: K1,
  nonce: 0, 
  option: 0, 
  weight: 5 
});

// æ›´æ”¹å¯†é’¥ï¼ˆNonce = 1ï¼‰
await changeKey({ 
  keypair: K1,
  nonce: 1, 
  newKeypair: K2 
});

// ä½¿ç”¨å¯†é’¥ K2 é‡æ–°æŠ•ç¥¨ï¼ˆNonce = 2ï¼‰
await vote({ 
  keypair: K2,
  nonce: 2, 
  option: 1, 
  weight: 5 
});

// Coordinator å¤„ç†ï¼š
// - æ¶ˆæ¯1ï¼šnonce=0, signed by K1 âœ“
// - æ¶ˆæ¯2ï¼šnonce=1, signed by K1 âœ“ï¼Œæ›´æ–°å…¬é’¥ä¸º K2
// - æ¶ˆæ¯3ï¼šnonce=2, signed by K2 âœ“
// æœ€ç»ˆåªæœ‰é€‰é¡¹ 1 çš„æŠ•ç¥¨æœ‰æ•ˆ
```

## æ¶ˆæ¯ç±»å‹

MACI æ”¯æŒä¸åŒç±»å‹çš„æ¶ˆæ¯ã€‚

### 1. æŠ•ç¥¨æ¶ˆæ¯ï¼ˆVote Messageï¼‰

```typescript
interface VoteCommand {
  msgType: 1;
  nonce: bigint;
  stateIndex: bigint;
  voteOptionIndex: bigint;  // æŠ•ç¥¨çš„é€‰é¡¹
  newVoteWeight: bigint;    // æ–°çš„æŠ•ç¥¨æƒé‡
  newPubKey: [bigint, bigint];  // é€šå¸¸ä¸å½“å‰å…¬é’¥ç›¸åŒ
  salt: bigint;
}
```

### 2. å¯†é’¥æ›´æ”¹æ¶ˆæ¯ï¼ˆKey Change Messageï¼‰

```typescript
interface KeyChangeCommand {
  msgType: 2;
  nonce: bigint;
  stateIndex: bigint;
  voteOptionIndex: 0;       // ä¸ä½¿ç”¨
  newVoteWeight: 0;         // ä¸ä½¿ç”¨
  newPubKey: [bigint, bigint];  // æ–°çš„å…¬é’¥
  salt: bigint;
}
```

## æ•°æ®æµ

å®Œæ•´çš„æ•°æ®æµç¤ºæ„å›¾ï¼š

```mermaid
graph TD
    A[æŠ•ç¥¨è€…æ³¨å†Œ] --> B[State Leaf]
    B --> C[State Tree]
    D[æŠ•ç¥¨è€…æŠ•ç¥¨] --> E[åŠ å¯†æ¶ˆæ¯]
    E --> F[Message Tree]
    G[Coordinator å¤„ç†] --> H[è§£å¯†æ¶ˆæ¯]
    H --> I[æ›´æ–° State Leaf]
    I --> J[æ›´æ–° VO Tree]
    J --> K[è®¡ç®—æ–° State Root]
    K --> L[ç”Ÿæˆ ZK è¯æ˜]
    L --> M[é“¾ä¸ŠéªŒè¯]
    M --> N[å‘å¸ƒç»“æœ]
```

## ä¸‹ä¸€æ­¥

ç°åœ¨æ‚¨å·²ç»ç†è§£äº† MACI çš„æ ¸å¿ƒæ¦‚å¿µï¼Œæ¥ä¸‹æ¥å¯ä»¥å­¦ä¹ ï¼š

- ğŸ” [å¯†ç å­¦æœºåˆ¶](/docs/protocol/cryptography) - äº†è§£åŠ å¯†å’Œç­¾åçš„å®ç°ç»†èŠ‚
- ğŸ“¨ [æ¶ˆæ¯æµç¨‹](/docs/protocol/message-flow) - æ·±å…¥ç†è§£æ¶ˆæ¯çš„ç”Ÿæˆå’Œå¤„ç†
- ğŸ›¡ï¸ [éšç§ä¿æŠ¤](/docs/protocol/privacy-protection) - æ¢ç´¢éšç§ä¿æŠ¤çš„å„ç§æœºåˆ¶
