# AMACI èº«ä»½åŒ¿ååŒ–æ·±åº¦è§£æ

æœ¬æ–‡æ¡£ä»æŠ€æœ¯è§’åº¦æ·±å…¥åˆ†æ AMACI çš„èº«ä»½åŒ¿ååŒ–æœºåˆ¶ï¼Œç‰¹åˆ«æ˜¯ä» Operator è§†è§’è¯´æ˜ä¸ºä»€ä¹ˆ add-new-key èƒ½å¤Ÿæœ‰æ•ˆä¿æŠ¤éšç§ã€‚

## Operator è§†è§’ï¼šèƒ½çœ‹åˆ°ä»€ä¹ˆ

### åœ¨ MACI ä¸­

Operator æ‹¥æœ‰å®Œæ•´çš„ä¿¡æ¯é“¾ï¼Œå¯ä»¥å…³è”æŠ•ç¥¨è€…èº«ä»½ï¼š

**1. é“¾ä¸Šå…¬å¼€æ•°æ®**

```typescript
// Signup äº¤æ˜“ï¼ˆä»»ä½•äººéƒ½å¯ä»¥æŸ¥è¯¢ï¼‰
{
  txHash: "0xabc123...",
  blockHeight: 12345,
  sender: "dora1abc...",           // é’±åŒ…åœ°å€
  msgType: "signup",
  msgData: {
    pubkey: {
      x: "0x123...",
      y: "0x456..."
    }
  }
}
```

**2. åˆçº¦çŠ¶æ€æŸ¥è¯¢**

```typescript
// Operator æŸ¥è¯¢åˆçº¦
const stateIdx = await contract.query({
  signuped: {
    pubkey: { x: "0x123...", y: "0x456..." }
  }
});
// è¿”å›ï¼šState Index = 5
```

**3. è§£å¯†æŠ•ç¥¨æ¶ˆæ¯**

```typescript
// Operator ä¸‹è½½å¹¶è§£å¯†æ¶ˆæ¯
const messages = await contract.query({ get_messages: {} });

// ä½¿ç”¨ Operator ç§é’¥è§£å¯†
const decrypted = messages.map(msg => {
  const sharedKey = ecdh(operatorPrivKey, msg.encPubKey);
  const command = poseidonDecrypt(msg.data, sharedKey);
  
  return {
    stateIdx: command.stateIdx,       // 5
    voteOptionIdx: command.voIdx,     // 0 (é€‰é¡¹A)
    newVotes: command.newVotes,       // 10
    nonce: command.nonce
  };
});
```

**4. å…³è”ç»“æœ**

```
å®Œæ•´çš„ä¿¡æ¯é“¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ dora1abc...  â”‚ é’±åŒ…åœ°å€ï¼ˆé“¾ä¸Šå…¬å¼€ï¼‰
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ signup äº¤æ˜“
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pubkey 0x123 â”‚ MACIå…¬é’¥ï¼ˆé“¾ä¸Šå…¬å¼€ï¼‰
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ åˆçº¦æ˜ å°„
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚State Index 5 â”‚ çŠ¶æ€ç´¢å¼•
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Operatorè§£å¯†
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æŠ•ç»™é€‰é¡¹A,10ç¥¨â”‚ æŠ•ç¥¨å†…å®¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“è®ºï¼šOperator ç¡®å®šçŸ¥é“
"dora1abc... æŠ•ç»™äº†é€‰é¡¹Aï¼Œ10ç¥¨"
```

**é£é™©ï¼š**
- Operator å¯ä»¥é’ˆå¯¹æ€§è”ç³» `dora1abc...` è¿›è¡Œè´¿èµ‚
- Operator å¯ä»¥å°†ä¿¡æ¯å‡ºå”®ç»™åˆ©ç›Šç›¸å…³æ–¹
- å¯èƒ½å¯¹ç‰¹å®šæŠ•ç¥¨è€…è¿›è¡ŒæŠ¥å¤

---

### åœ¨ AMACI ä¸­ï¼ˆä½¿ç”¨ add-new-keyï¼‰

Operator çš„ä¿¡æ¯é“¾è¢« ZK è¯æ˜æ‰“æ–­ï¼š

**1. é“¾ä¸Šå…¬å¼€æ•°æ®**

```typescript
// Add-new-key äº¤æ˜“
{
  txHash: "0xdef789...",
  blockHeight: 12350,
  sender: "dora1xyz...",           // æ–°é’±åŒ…åœ°å€
  msgType: "add_new_key",
  msgData: {
    pubkey: {
      x: "0x789...",               // æ–°å…¬é’¥
      y: "0xabc..."
    },
    nullifier: "0xnull...",
    d: ["0xd1_0", "0xd1_1", "0xd2_0", "0xd2_1"],
    proof: {                        // ZKè¯æ˜
      a: "0x...",
      b: "0x...",
      c: "0x..."
    }
  }
}
```

**2. ZK è¯æ˜éªŒè¯**

```typescript
// åˆçº¦éªŒè¯ ZK è¯æ˜ï¼ˆOperator å¯ä»¥çœ‹åˆ°éªŒè¯è¿‡ç¨‹ï¼‰
const publicInputs = [
  deactivateRoot,      // deactivateæ ‘çš„æ ¹
  coordPubKeyHash,     // Operatorå…¬é’¥å“ˆå¸Œ
  nullifier,           // é˜²é‡æ”¾
  d[0], d[1], d[2], d[3]
];

// è¯æ˜å£°ç§°ï¼š
// "æˆ‘çŸ¥é“ deactivate æ ‘ä¸­æŸä¸ªæ¡ç›®å¯¹åº”çš„ç§é’¥"
// 
// ä½†ä¸é€éœ²ï¼š
// - æ˜¯ç¬¬å‡ ä¸ªæ¡ç›®
// - ç§é’¥æ˜¯ä»€ä¹ˆ
// - è€èº«ä»½æ˜¯è°
```

**3. Operator å¯ä»¥æ¨æ–­çš„ä¿¡æ¯**

```
Operator çŸ¥é“ï¼š
1. Deactivate æ ‘æœ‰ 100 ä¸ªæ¡ç›®
2. æ–°ç”¨æˆ·æ˜¯è¿™ 100 ä¸ªç”¨æˆ·ä¹‹ä¸€
3. æ–°ç”¨æˆ·çš„ State Index æ˜¯ 8

Operator ä¸çŸ¥é“ï¼š
1. æ–°ç”¨æˆ·æ˜¯ 100 ä¸ªä¸­çš„ç¬¬å‡ ä¸ª
2. å¯¹åº”å“ªä¸ªé’±åŒ…åœ°å€
3. ä¸å“ªä¸ªè€èº«ä»½å…³è”
```

**4. æ–­è£‚çš„ä¿¡æ¯é“¾**

```
Operator çš„ä¿¡æ¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ dora1xyz...  â”‚ æ–°é’±åŒ…åœ°å€ï¼ˆå¯èƒ½æ˜¯æ–°çš„ï¼‰
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ add-new-key äº¤æ˜“
       â”‚ ï¼ˆåŒ…å« ZK è¯æ˜ï¼‰
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pubkey 0x789 â”‚ æ–°MACIå…¬é’¥
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ åˆçº¦åˆ†é…
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚State Index 8 â”‚ æ–°çŠ¶æ€ç´¢å¼•
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Operatorè§£å¯†
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æŠ•ç»™é€‰é¡¹A,10ç¥¨â”‚ æŠ•ç¥¨å†…å®¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–²
       â”‚
       â”‚ æ— æ³•å…³è”ï¼
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  100ä¸ªç”¨æˆ·   â”‚ Deactivateæ ‘
â”‚  ä¹‹ä¸­çš„ä¸€ä¸ª  â”‚ åŒ¿åé›†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“è®ºï¼šOperator åªçŸ¥é“
"100ä¸ªå·²deactivateç”¨æˆ·ä¸­çš„æŸä¸€ä¸ªæŠ•ç»™äº†é€‰é¡¹A"
ä½†ä¸çŸ¥é“å…·ä½“æ˜¯è°
```

**éšç§æå‡ï¼š**
- âœ… æ— æ³•è¿›è¡Œé’ˆå¯¹æ€§è´¿èµ‚ï¼ˆä¸çŸ¥é“æ‰¾è°ï¼‰
- âœ… æ— æ³•è¿›è¡Œé’ˆå¯¹æ€§æŠ¥å¤ï¼ˆä¸çŸ¥é“æ˜¯è°ï¼‰
- âœ… ä¿¡æ¯å¯¹å¤–å‡ºå”®ä»·å€¼ä½ï¼ˆä¸çŸ¥é“èº«ä»½ï¼‰
- âœ… æ— æ³•ä¸é“¾å¤–æ•°æ®å…³è”

---

## Add-new-key ZK ç”µè·¯è¯¦è§£

### ç”µè·¯è¾“å…¥

```circom
template AddNewKey(stateTreeDepth) {
    // å…¬å¼€è¾“å…¥ï¼ˆOperator å¯è§ï¼‰
    signal input inputHash;  // ä¸‹é¢æ‰€æœ‰è¾“å…¥çš„å“ˆå¸Œ
    signal input coordPubKey[2];
    signal input deactivateRoot;
    signal input nullifier;
    signal input d1[2];
    signal input d2[2];
    
    // ç§æœ‰è¾“å…¥ï¼ˆä¸å…¬å¼€ï¼‰
    signal input oldPrivateKey;      // è€ç”¨æˆ·çš„ç§é’¥
    signal input deactivateIndex;    // åœ¨æ ‘ä¸­çš„ä½ç½®ï¼ˆå…³é”®ï¼ï¼‰
    signal input deactivateLeaf;
    signal input c1[2];
    signal input c2[2];
    signal input randomVal;          // éšæœºåŒ–ç”¨çš„éšæœºæ•°
    signal input deactivateLeafPathElements[...];  // Merkleè¯æ˜è·¯å¾„
    
    // ... éªŒè¯é€»è¾‘
}
```

### ç”µè·¯éªŒè¯æ­¥éª¤

**æ­¥éª¤ 1: éªŒè¯ Nullifier**

```circom
// é˜²æ­¢åŒä¸€ä¸ªè€èº«ä»½é‡å¤ä½¿ç”¨ add-new-key
component nullifierHasher = HashLeftRight();
nullifierHasher.left <== oldPrivateKey;
nullifierHasher.right <== 1444992409218394441042;  // å¸¸é‡ "NULLIFIER"
nullifierHasher.hash === nullifier;

// Operator çœ‹åˆ° nullifierï¼Œä½†æ— æ³•åæ¨ oldPrivateKey
```

**æ­¥éª¤ 2: éªŒè¯ Deactivate Leaf**

```circom
// è®¡ç®— sharedKeyHash
component ecdh = Ecdh();
ecdh.privKey <== oldPrivateKey;
ecdh.pubKey <== coordPubKey;

component sharedKeyHasher = HashLeftRight();
sharedKeyHasher.left <== ecdh.sharedKey[0];
sharedKeyHasher.right <== ecdh.sharedKey[1];

// éªŒè¯ deactivate leaf æ ¼å¼
component deactivateLeafHasher = Hasher5();
deactivateLeafHasher.in[0] <== c1[0];
deactivateLeafHasher.in[1] <== c1[1];
deactivateLeafHasher.in[2] <== c2[0];
deactivateLeafHasher.in[3] <== c2[1];
deactivateLeafHasher.in[4] <== sharedKeyHasher.hash;

deactivateLeafHasher.hash === deactivateLeaf;
```

**æ­¥éª¤ 3: éªŒè¯ Merkle è·¯å¾„**

```circom
// è¯æ˜ deactivateLeaf åœ¨ deactivateRoot æ ‘ä¸­
component deactivateQie = QuinLeafExists(deactivateTreeDepth);
deactivateQie.leaf <== deactivateLeaf;
deactivateQie.root <== deactivateRoot;
deactivateQie.path_index <== deactivateIndex;  // ç§æœ‰ï¼ä¸å…¬å¼€
deactivateQie.path_elements <== deactivateLeafPathElements;

// è¿™ä¸€æ­¥è¯æ˜ï¼š
// "æˆ‘çŸ¥é“æ ‘ä¸­æŸä¸ªä½ç½®çš„leafï¼Œå¹¶ä¸”æˆ‘çŸ¥é“å»é‚£é‡Œçš„è·¯å¾„"
// ä½†ä¸å…¬å¼€å…·ä½“æ˜¯ç¬¬å‡ ä¸ªä½ç½®
```

**æ­¥éª¤ 4: é‡æ–°éšæœºåŒ–**

```circom
// ä½¿ç”¨éšæœºå€¼é‡æ–°éšæœºåŒ– c1, c2
component rerandomize = ElGamalReRandomize();
rerandomize.c1 <== c1;
rerandomize.c2 <== c2;
rerandomize.randomVal <== randomVal;  // ç§æœ‰ï¼
rerandomize.pubKey <== coordPubKey;

// éªŒè¯è¾“å‡ºçš„ d1, d2 æ˜¯æ­£ç¡®çš„é‡æ–°éšæœºåŒ–ç»“æœ
rerandomize.d1 === d1;
rerandomize.d2 === d2;

// d1, d2 ä¸ c1, c2 åœ¨æ•°å­¦ä¸Šç›¸å…³ï¼Œä½†çœ‹èµ·æ¥å®Œå…¨ä¸åŒ
// Operator æ— æ³•ä» d1, d2 æ¨æ–­å‡ºæ˜¯å“ªä¸ª c1, c2
```

**æ­¥éª¤ 5: éªŒè¯å…¬å¼€è¾“å…¥å“ˆå¸Œ**

```circom
component inputHasher = AddNewKeyInputHasher();
inputHasher.deactivateRoot <== deactivateRoot;
inputHasher.coordPubKey <== coordPubKey;
inputHasher.nullifier <== nullifier;
inputHasher.d1 <== d1;
inputHasher.d2 <== d2;

inputHasher.hash === inputHash;

// ç¡®ä¿å…¬å¼€è¾“å…¥æ²¡æœ‰è¢«ç¯¡æ”¹
```

### ä¸ºä»€ä¹ˆ Operator æ— æ³•è¿½è¸ª

**æ•°å­¦å±‚é¢ï¼š**

```
ç»™å®šï¼š
- deactivateRootï¼ˆNä¸ªleafçš„Merkleæ ¹ï¼‰
- d1, d2ï¼ˆé‡æ–°éšæœºåŒ–åçš„å€¼ï¼‰

Operator æƒ³è¦ç¡®å®šï¼š
- æ–°ç”¨æˆ·æ˜¯Nä¸ªç”¨æˆ·ä¸­çš„ç¬¬å‡ ä¸ª

é—®é¢˜ï¼š
1. d1 = c1 + r * G
   d2 = c2 + r * H
   å…¶ä¸­ r æ˜¯éšæœºæ•°ï¼ˆç§æœ‰ï¼‰
   
2. ä» d1, d2 åæ¨ c1, c2 éœ€è¦ï¼š
   c1 = d1 - r * G
   ä½† Operator ä¸çŸ¥é“ r
   
3. æš´åŠ›æšä¸¾æ‰€æœ‰å¯èƒ½ï¼š
   - éœ€è¦æšä¸¾ N ä¸ªå¯èƒ½çš„åŸå§‹æ¡ç›®
   - å¯¹æ¯ä¸ªæ¡ç›®è®¡ç®—æ‰€æœ‰å¯èƒ½çš„ r å€¼
   - r çš„ç©ºé—´æ˜¯ 2^256ï¼Œè®¡ç®—ä¸Šä¸å¯è¡Œ
   
4. å³ä½¿çŸ¥é“æ–°æ—§ç”¨æˆ·å¯èƒ½ç›¸å…³ï¼š
   - æ— æ³•è¯æ˜å…³è”å…³ç³»
   - æ— æ³•ç¡®å®šå…·ä½“å¯¹åº”å…³ç³»
```

**ä¿¡æ¯è®ºå±‚é¢ï¼š**

```
Operator çš„ä¿¡æ¯ç†µï¼š
- åœ¨ MACI ä¸­ï¼šH = 0ï¼ˆç¡®å®šæ€§çŸ¥é“ï¼‰
- åœ¨ AMACI ä¸­ï¼šH = logâ‚‚(N)ï¼ˆN æ˜¯åŒ¿åé›†å¤§å°ï¼‰

ä¾‹å¦‚ï¼š
- N = 100: H = 6.64 bitsï¼ˆOperatoréœ€è¦çŒœæµ‹ï¼‰
- N = 1000: H = 9.97 bitsï¼ˆæ›´éš¾çŒœæµ‹ï¼‰
- N = 10000: H = 13.29 bitsï¼ˆå‡ ä¹ä¸å¯èƒ½ï¼‰
```

## Deactivate æ ‘çš„æ„å»º

### Operator ç”Ÿæˆ Deactivate Leaf

å½“ Operator å¤„ç† deactivate æ¶ˆæ¯æ—¶ï¼š

```typescript
// å¯¹æ¯ä¸ª deactivate æ¶ˆæ¯
for (let i = 0; i < deactivateMessages.length; i++) {
  const msg = deactivateMessages[i];
  
  // 1. è§£å¯†æ¶ˆæ¯è·å¾— stateIdx
  const command = decrypt(msg, operatorPrivKey);
  const stateIdx = command.stateIdx;
  
  // 2. è·å–ç”¨æˆ·å…¬é’¥
  const userPubKey = stateTree.getLeaf(stateIdx).pubKey;
  
  // 3. è®¡ç®— shared key hash
  const sharedKey = ecdh(operatorPrivKey, userPubKey);
  const sharedKeyHash = poseidon(sharedKey);
  
  // 4. ç”ŸæˆåŠ å¯†çš„å»æ´»åŒ–æ ‡å¿—
  const randomVal = deterministicRandom(operatorPrivKey, i);
  const encrypted = encryptDeactivateFlag(
    true,  // è¯¥ç”¨æˆ·å·² deactivate
    operatorPubKey,
    randomVal
  );
  
  // 5. æ„å»º deactivate leaf
  const leaf = [
    encrypted.c1[0],
    encrypted.c1[1],
    encrypted.c2[0],
    encrypted.c2[1],
    sharedKeyHash    // Operator ç”¨è¿™ä¸ªè¯†åˆ«æ˜¯å“ªä¸ªç”¨æˆ·
  ];
  
  deactivateLeaves.push(leaf);
}

// 6. æ„å»º Merkle æ ‘
const deactivateTree = new MerkleTree(deactivateLeaves);
const deactivateRoot = deactivateTree.root;
```

**Operator çŸ¥é“çš„æ˜ å°„ï¼š**

```typescript
// Operator å†…éƒ¨è®°å½•ï¼ˆä¸å…¬å¼€ï¼‰
const mapping = {
  // sharedKeyHash â†’ åŸå§‹ç”¨æˆ·ä¿¡æ¯
  "0xhash1...": {
    stateIdx: 3,
    walletAddress: "dora1aaa...",
    pubkey: "0xpub1..."
  },
  "0xhash2...": {
    stateIdx: 7,
    walletAddress: "dora1bbb...",
    pubkey: "0xpub2..."
  },
  // ... 100 ä¸ªæ¡ç›®
};
```

### ç”¨æˆ·ä½¿ç”¨ Add-new-key

å½“ç”¨æˆ·ä½¿ç”¨ add-new-key æ—¶ï¼š

```typescript
// ç”¨æˆ·ï¼ˆæ¯”å¦‚ dora1aaa...ï¼‰çŸ¥é“è‡ªå·±çš„ oldPrivateKey
// ç”¨æˆ·è®¡ç®—è‡ªå·±çš„ sharedKeyHash
const mySharedKeyHash = poseidon(ecdh(oldPrivateKey, operatorPubKey));

// ç”¨æˆ·åœ¨ deactivate æ ‘ä¸­æ‰¾åˆ°è‡ªå·±çš„ leaf
const myIndex = deactivateLeaves.findIndex(
  leaf => leaf[4] === mySharedKeyHash
);
// å‡è®¾ myIndex = 23

// ç”¨æˆ·ç”Ÿæˆ ZK è¯æ˜ï¼Œè¯æ˜çŸ¥é“ç¬¬ 23 ä¸ªæ¡ç›®çš„ç§é’¥
// ä½†è¯æ˜ä¸­ä¸å…¬å¼€ myIndex = 23
const proof = generateZKProof({
  deactivateIndex: 23,  // ç§æœ‰è¾“å…¥
  deactivateLeaf: deactivateLeaves[23],
  oldPrivateKey,
  // ...
});

// ç”¨æˆ·ç”¨æ–°é’±åŒ…æäº¤
await newWallet.execute({
  add_new_key: {
    pubkey: newPubKey,  // å…¨æ–°çš„å…¬é’¥
    proof,
    nullifier,
    d
  }
});
```

**Operator æ”¶åˆ° add-new-key åï¼š**

```typescript
// Operator çœ‹åˆ°ï¼š
{
  sender: "dora1xyz...",      // æ–°é’±åŒ…ï¼ˆå¯èƒ½å®Œå…¨é™Œç”Ÿï¼‰
  newPubkey: "0x999...",      // æ–°å…¬é’¥
  nullifier: "0xnull...",     // åªæ˜¯ä¸ªå“ˆå¸Œ
  d: [d1, d2],                // é‡æ–°éšæœºåŒ–çš„å€¼
  proof: {...}                // ZKè¯æ˜ï¼ˆå·²éªŒè¯é€šè¿‡ï¼‰
}

// Operator å°è¯•åˆ†æï¼š
// 1. æŸ¥çœ‹ nullifierï¼šåªæ˜¯ä¸ªå“ˆå¸Œï¼Œæ— æ³•åæ¨ç§é’¥
// 2. æŸ¥çœ‹ d1, d2ï¼šé‡æ–°éšæœºåŒ–çš„å€¼ï¼Œæ— æ³•åæ¨åŸå§‹ c1, c2
// 3. æŸ¥çœ‹ proofï¼šå·²é€šè¿‡éªŒè¯ï¼Œä½†ä¸åŒ…å«ç§æœ‰è¾“å…¥
// 4. æŸ¥çœ‹ senderï¼šdora1xyz... å¯èƒ½æ˜¯æ–°é’±åŒ…ï¼Œæ²¡æœ‰å†å²è®°å½•

// Operator åªèƒ½çŸ¥é“ï¼š
// "è¿™æ˜¯ deactivate æ ‘ä¸­ 100 ä¸ªç”¨æˆ·ä¹‹ä¸€"
// "ä½†å…·ä½“æ˜¯ç¬¬å‡ ä¸ªï¼Œå®Œå…¨ä¸çŸ¥é“"

// Operator çš„æ˜ å°„è¡¨æ— æ³•ä½¿ç”¨ï¼š
mapping = {
  "0xhash1...": { stateIdx: 3, wallet: "dora1aaa..." },
  "0xhash2...": { stateIdx: 7, wallet: "dora1bbb..." },
  // ...
  // æ–°ç”¨æˆ·å¯èƒ½æ˜¯ä»»æ„ä¸€ä¸ªï¼Œæ— æ³•ç¡®å®š
};
```

**ä¿¡æ¯æ–­è£‚ï¼š**

```
Operator çš„ä¿¡æ¯é“¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ dora1xyz...  â”‚ æ–°é’±åŒ…åœ°å€
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ add-new-keyï¼ˆZKè¯æ˜ï¼‰
       â–¼
       â•³  <-- ä¿¡æ¯é“¾åœ¨è¿™é‡Œæ–­è£‚ï¼
       â•³  <-- ZK è¯æ˜ä¸é€éœ²åŸå§‹èº«ä»½
       â•³
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚State Index 8 â”‚ æ–°çŠ¶æ€ç´¢å¼•
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Operatorè§£å¯†
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æŠ•ç»™é€‰é¡¹A,10ç¥¨â”‚ æŠ•ç¥¨å†…å®¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–²
       â”‚ å¯èƒ½æ¥è‡ª 100 ä¸ªç”¨æˆ·ä¹‹ä¸€
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ dora1aaa... (3%)     â”‚
â”‚ dora1bbb... (3%)     â”‚
â”‚ dora1ccc... (3%)     â”‚
â”‚ ... 97 other (91%)   â”‚ åŒ¿åé›† = 100
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Operator æ— æ³•ç¡®å®šå…·ä½“æ˜¯è°
```

## éšç§æ€§é‡åŒ–åˆ†æ

### åŒ¿åé›†å¤§å°çš„å½±å“

```typescript
// è®¡ç®— Operator ç¡®å®šèº«ä»½çš„æ¦‚ç‡

// Deactivate æ ‘å¤§å° = 10
const anonymitySet10 = 10;
const probability10 = 1 / anonymitySet10;
console.log('Operator çŒœå¯¹æ¦‚ç‡:', probability10);  // 10%

// Deactivate æ ‘å¤§å° = 100
const anonymitySet100 = 100;
const probability100 = 1 / anonymitySet100;
console.log('Operator çŒœå¯¹æ¦‚ç‡:', probability100);  // 1%

// Deactivate æ ‘å¤§å° = 1000
const anonymitySet1000 = 1000;
const probability1000 = 1 / anonymitySet1000;
console.log('Operator çŒœå¯¹æ¦‚ç‡:', probability1000);  // 0.1%
```

**å®é™…æ„ä¹‰ï¼š**

```
åŒ¿åé›† = 10:
- Operator æœ‰ 10% æ¦‚ç‡çŒœå¯¹
- ä»æœ‰ä¸€å®šé£é™©

åŒ¿åé›† = 100:
- Operator åªæœ‰ 1% æ¦‚ç‡çŒœå¯¹
- åŸºæœ¬å®‰å…¨

åŒ¿åé›† = 1000:
- Operator åªæœ‰ 0.1% æ¦‚ç‡çŒœå¯¹
- éå¸¸å®‰å…¨ï¼Œå³ä½¿ Operator æƒ³æ”»å‡»ä¹Ÿæ— ä»ä¸‹æ‰‹
```

### æ”»å‡»æˆæœ¬åˆ†æ

å‡è®¾ Operator æƒ³é€šè¿‡è´¿èµ‚å½±å“æŠ•ç¥¨ï¼š

**MACI ä¸­ï¼š**
```
æˆæœ¬æ¨¡å‹ï¼š
- ç¡®å®šç›®æ ‡ï¼šO(1)ï¼Œç›´æ¥çŸ¥é“
- å•ä¸ªè´¿èµ‚ï¼š$1000
- æ€»æˆæœ¬ï¼š$1000 Ã— ç›®æ ‡äººæ•°

ä¾‹å¦‚è¦å½±å“ 10 ä¸ªäººï¼š
- æ€»æˆæœ¬ï¼š$10,000
- æˆåŠŸç‡ï¼šæ¥è¿‘ 100%ï¼ˆèƒ½ç¡®å®šè”ç³»è°ï¼‰
```

**AMACI ä¸­ï¼š**
```
æˆæœ¬æ¨¡å‹ï¼š
- ç¡®å®šç›®æ ‡ï¼šä¸å¯èƒ½ï¼ˆåŒ¿åé›† = 1000ï¼‰
- ç›²ç›®è´¿èµ‚ï¼šéœ€è¦è”ç³»åŒ¿åé›†ä¸­æ‰€æœ‰äºº
- å•ä¸ªè´¿èµ‚ï¼š$1000
- æ€»æˆæœ¬ï¼š$1000 Ã— åŒ¿åé›†å¤§å°

ä¾‹å¦‚åŒ¿åé›† = 1000ï¼Œæƒ³å½±å“å…¶ä¸­ 10 ä¸ªäººï¼š
- éœ€è¦ç›²ç›®è´¿èµ‚æ‰€æœ‰ 1000 äººæ‰èƒ½ç¡®ä¿è¦†ç›–
- æ€»æˆæœ¬ï¼š$1,000,000
- æˆåŠŸç‡ï¼šä¸ç¡®å®šï¼ˆæ— æ³•éªŒè¯ï¼‰

ç»“è®ºï¼šç»æµä¸Šä¸å¯è¡Œ
```

## Operator çš„èƒ½åŠ›è¾¹ç•Œ

### Operator èƒ½åšä»€ä¹ˆ

**æŠ€æœ¯ä¸Šå¯ä»¥ï¼š**
- âœ… è§£å¯†æ‰€æœ‰æŠ•ç¥¨æ¶ˆæ¯å†…å®¹
- âœ… çœ‹åˆ°æ¯ä¸ª State Index çš„æŠ•ç¥¨
- âœ… ç»Ÿè®¡æŠ•ç¥¨ç»“æœ
- âœ… ç”Ÿæˆé›¶çŸ¥è¯†è¯æ˜

**æŠ€æœ¯ä¸Šä¸èƒ½ï¼ˆAMACI ä¿æŠ¤ï¼‰ï¼š**
- âŒ ç¡®å®š State Index å¯¹åº”çš„é’±åŒ…åœ°å€ï¼ˆadd-new-key ç”¨æˆ·ï¼‰
- âŒ å…³è”æ–°æ—§èº«ä»½
- âŒ ä» ZK è¯æ˜ä¸­æå–ç§æœ‰è¾“å…¥
- âŒ ä» d1, d2 åæ¨åŸå§‹ c1, c2
- âŒ ä» nullifier åæ¨ oldPrivateKey

### Operator çš„è¯šå®æ€§ä¿è¯

å³ä½¿ Operator æƒ³ä½œæ¶ï¼š

**1. æ— æ³•ç¯¡æ”¹æŠ•ç¥¨ï¼ˆZK è¯æ˜çº¦æŸï¼‰**
```
å¦‚æœ Operator ä¿®æ”¹æŠ•ç¥¨ï¼š
- çŠ¶æ€æ ‘æ ¹ä¼šæ”¹å˜
- æ— æ³•ç”Ÿæˆæœ‰æ•ˆçš„ ZK è¯æ˜
- é“¾ä¸ŠéªŒè¯ä¼šå¤±è´¥
- Operator æ— æ³•è·å¾—è´¹ç”¨
```

**2. æ— æ³•é’ˆå¯¹æ€§æ”»å‡»ï¼ˆèº«ä»½åŒ¿åï¼‰**
```
å¦‚æœ Operator æƒ³è´¿èµ‚ç‰¹å®šæŠ•ç¥¨è€…ï¼š
- ä¸çŸ¥é“æ˜¯è°
- æ— æ³•è”ç³»ç›®æ ‡
- æ”»å‡»æ— ä»ä¸‹æ‰‹
```

**3. ä¿¡æ¯æ³„éœ²ä»·å€¼ä½**
```
å¦‚æœ Operator æƒ³å‡ºå”®ä¿¡æ¯ï¼š
- èƒ½å–çš„ä¿¡æ¯ï¼š"æŸäººæŠ•äº†é€‰é¡¹A"
- ä½†ä¹°å®¶æ— æ³•ç¡®å®šæ˜¯è°
- ä¿¡æ¯ä»·å€¼å¾ˆä½
```

## æç«¯åœºæ™¯åˆ†æ

### åœºæ™¯ 1: Operator å’Œç”¨æˆ·ä¸²è°‹

**é—®é¢˜ï¼š** ç”¨æˆ·ä¸»åŠ¨å‘Šè¯‰ Operator è‡ªå·±çš„èº«ä»½

```
ç”¨æˆ·è¯´ï¼š"æˆ‘æ˜¯ dora1abc...ï¼Œç”¨äº† add-new-key"

Operator ä»ç„¶æ— æ³•éªŒè¯ï¼š
1. æ— æ³•è¯æ˜è¯¥ç”¨æˆ·çš„ add-new-key äº¤æ˜“æ˜¯å“ªä¸ª
2. æ— æ³•å…³è”åˆ°å…·ä½“çš„ State Index  
3. é™¤éç”¨æˆ·æä¾› oldPrivateKeyï¼ˆä½†è¿™è¿èƒŒäº†åŒ¿ååˆè¡·ï¼‰

ç»“è®ºï¼šå³ä½¿ç”¨æˆ·ä¸»åŠ¨æ³„éœ²ï¼ŒOperator ä¹Ÿéš¾ä»¥ç¡®è®¤
```

### åœºæ™¯ 2: é“¾ä¸Šæ•°æ®åˆ†æ

**é—®é¢˜ï¼š** é€šè¿‡æ—¶é—´ã€é‡‘é¢ç­‰é“¾ä¸Šæ•°æ®åˆ†æå…³è”

**AMACI æŠµæŠ—ï¼š**
```
é“¾ä¸Šå¯è§ï¼š
- Time T1: dora1old... deactivate
- Time T2: dora1new... add-new-key
- Timeå·®å¾ˆå°ï¼Œå¯èƒ½ç›¸å…³ï¼Ÿ

ä½†æ˜¯ï¼š
1. Deactivate æ ‘æœ‰ 1000 ä¸ªç”¨æˆ·
2. å¯èƒ½åŒæ—¶æœ‰å¾ˆå¤šäºº deactivate
3. Add-new-key å¯ä»¥åœ¨ä»»ä½•æ—¶é—´ä½¿ç”¨
4. ä½¿ç”¨æ–°é’±åŒ…ï¼Œä¸è€é’±åŒ…æ— èµ„é‡‘å¾€æ¥

ç»“è®ºï¼šæ—¶é—´å…³è”ä¸å¯é 
```

### åœºæ™¯ 3: Sybil æ”»å‡»

**é—®é¢˜ï¼š** æ”»å‡»è€…åˆ›å»ºå¤§é‡å‡èº«ä»½æ±¡æŸ“åŒ¿åé›†

**AMACI é˜²æŠ¤ï¼š**
```
1. Deactivate éœ€è¦å…ˆ signup
2. Signup éœ€è¦æ»¡è¶³ç™½åå•æ¡ä»¶ï¼š
   - Oracle è¯ä¹¦
   - ä»£å¸æŒæœ‰é‡
   - å…¶ä»–å‡†å…¥æ¡ä»¶
   
3. åˆ›å»ºå¤§é‡å‡èº«ä»½çš„æˆæœ¬é«˜
4. å³ä½¿åˆ›å»ºï¼Œä¹Ÿæ‰©å¤§äº†åŒ¿åé›†ï¼ˆåè€Œæœ‰åˆ©ï¼‰

ç»“è®ºï¼šSybil æ”»å‡»æˆæœ¬é«˜ä¸”æ•ˆæœæœ‰é™
```

## æœ€ä½³å®è·µ

### ä¸ºæŠ•ç¥¨è€…

**é«˜éšç§åœºæ™¯ï¼š**
```typescript
// 1. ä½¿ç”¨å…¨æ–°é’±åŒ…
const newWallet = await DirectSecp256k1Wallet.generate();

// 2. ä½¿ç”¨ add-new-key
await client.addNewKey({
  signer: newWallet,
  // ...
});

// 3. é¿å…é“¾ä¸Šå…³è”
// - ä¸è¦ä»è€é’±åŒ…è½¬è´¦åˆ°æ–°é’±åŒ…
// - ä¸è¦åœ¨ç›¸åŒæ—¶é—´æ“ä½œ
// - ä½¿ç”¨ä¸åŒçš„ IP/ç½‘ç»œ
```

**ä¸­ç­‰éšç§åœºæ™¯ï¼š**
```typescript
// ç›´æ¥ä½¿ç”¨ signupï¼Œä½†æ³¨æ„ï¼š
// - Operator ä¼šçŸ¥é“ä½ çš„èº«ä»½
// - é€‚åˆå¯ä¿¡çš„ Operator
```

### ä¸º Operator

**âœ“ ä¸ä¿ç•™èº«ä»½æ˜ å°„**
```typescript
// å¤„ç†å®Œæˆååˆ é™¤æ˜ å°„
// ä¸ä¿å­˜ sharedKeyHash â†’ wallet çš„å…³ç³»
// é™ä½æ•°æ®æ³„éœ²é£é™©
```

**âœ“ æœ€å°åŒ–æ—¥å¿—**
```typescript
// åªè®°å½•å¿…è¦çš„å¤„ç†æ—¥å¿—
// ä¸è®°å½•æ•æ„Ÿçš„èº«ä»½ä¿¡æ¯
```

## æ€»ç»“

### AMACI éšç§ä¼˜åŠ¿

**å¯¹æ¯” MACIï¼š**

| éšç§æ–¹é¢ | MACI | AMACI |
|---------|------|-------|
| æŠ•ç¥¨å†…å®¹ | âœ… åŠ å¯† | âœ… åŠ å¯† |
| æŠ•ç¥¨è€…èº«ä»½ï¼ˆå¯¹å…¬ä¼—ï¼‰ | âœ… ä¸å¯è§ | âœ… ä¸å¯è§ |
| æŠ•ç¥¨è€…èº«ä»½ï¼ˆå¯¹Operatorï¼‰ | âŒ å¯å…³è” | âœ… ä¸å¯å…³è” |
| é˜²é’ˆå¯¹æ€§æ”»å‡» | âš ï¸ å¼± | âœ… å¼º |
| ä¿¡æ¯æ³„éœ²é£é™© | âš ï¸ ä¸­ | âœ… ä½ |

### åŒ¿åæ€§ä¿è¯

```
AMACI çš„åŒ¿åæ€§ âˆ Deactivate æ ‘å¤§å°

å»ºè®®çš„åŒ¿åé›†å¤§å°ï¼š
- ä½é£é™©æŠ•ç¥¨ï¼šâ‰¥ 10 äºº
- ä¸­é£é™©æŠ•ç¥¨ï¼šâ‰¥ 100 äºº
- é«˜é£é™©æŠ•ç¥¨ï¼šâ‰¥ 1000 äºº

å®é™…ä¸Šï¼Œéšç€ç³»ç»Ÿä½¿ç”¨ï¼Œdeactivate æ ‘ä¼šè‡ªç„¶å¢é•¿ï¼Œ
åŒ¿åæ€§ä¼šè¶Šæ¥è¶Šå¼º
```

## ä¸‹ä¸€æ­¥

æ·±å…¥äº†è§£ AMACI éšç§æœºåˆ¶åï¼Œæ‚¨å¯ä»¥ï¼š

- ğŸ”‘ [æ ¸å¿ƒæ¦‚å¿µ](/docs/protocol/core-concepts) - å­¦ä¹ ä¸‰ç§æ³¨å†Œæ–¹å¼çš„è¯¦ç»†å®ç°
- ğŸ“¨ [æ¶ˆæ¯æµç¨‹](/docs/protocol/message-flow) - ç†è§£ deactivate æ¶ˆæ¯çš„å¤„ç†
- ğŸ’» [SDK ä½¿ç”¨](/docs/sdk/voting-guide) - ä½¿ç”¨ add-new-key åˆ›å»ºåŒ¿åæŠ•ç¥¨
- ğŸ—ï¸ [åˆçº¦å®ç°](/docs/contracts/amaci) - äº†è§£åˆçº¦å¦‚ä½•éªŒè¯ ZK è¯æ˜
