# åˆ›å»ºæŠ•ç¥¨è½®æ¬¡

å­¦ä¹ å¦‚ä½•ä½¿ç”¨ SDK åˆ›å»º MACI æŠ•ç¥¨è½®æ¬¡ã€‚

## ä¸¤ç§åˆ›å»ºæ–¹å¼

AMACI æ”¯æŒä¸¤ç§ Round åˆ›å»ºæ–¹å¼ï¼š

1. **ç™½åå•åˆ—è¡¨æ¨¡å¼** - ç®€å•ç›´æ¥ï¼Œé€‚åˆå·²çŸ¥ç”¨æˆ·åˆ—è¡¨
2. **Pre-add-new-key æ¨¡å¼** - å®Œå…¨åŒ¿åï¼Œé€‚åˆå¹³å°æ‰¹é‡å‡†å¤‡

---

## æ–¹å¼ 1: ç™½åå•åˆ—è¡¨æ¨¡å¼

### åŸºç¡€ç”¨æ³•

åˆ›å»ºä¸€ä¸ªä½¿ç”¨ç™½åå•åœ°å€åˆ—è¡¨çš„æŠ•ç¥¨è½®æ¬¡ï¼š

```typescript
import { MaciClient, MaciCircuitType } from '@dorafactory/maci-sdk';

const client = new MaciClient({ network: 'testnet' });

// æ­¥éª¤ 1: æŸ¥è¯¢ Operator åˆ—è¡¨
const operators = await client.indexer.getOperators();
const activeOperators = operators.filter(op => op.status === 'Active');
const selectedOperator = activeOperators[0];  // é€‰æ‹©ç¬¬ä¸€ä¸ªæ´»è·ƒçš„ Operator

console.log('é€‰æ‹©çš„ Operator:', selectedOperator.identity);
console.log('Operator åœ°å€:', selectedOperator.address);

// æ­¥éª¤ 2: åˆ›å»º AMACI Round
const round = await client.createAMaciRound({
  signer: wallet,
  operator: selectedOperator.address,  // Operator åœ°å€
  
  // æŠ•ç¥¨æ—¶é—´
  startVoting: new Date('2024-02-01T00:00:00Z'),
  endVoting: new Date('2024-02-07T23:59:59Z'),
  
  // è½®æ¬¡ä¿¡æ¯
  title: 'ç¤¾åŒºææ¡ˆæŠ•ç¥¨',
  description: 'æŠ•ç¥¨å†³å®šç¤¾åŒºä¸‹ä¸€æ­¥å‘å±•æ–¹å‘',
  link: 'https://forum.example.com/proposal',
  
  // æŠ•ç¥¨é€‰é¡¹
  voteOptionMap: [
    'ææ¡ˆ A: å¢åŠ ç¤¾åŒºèµ„é‡‘',
    'ææ¡ˆ B: æ”¹è¿›æŠ€æœ¯åŸºç¡€è®¾æ–½',
    'ææ¡ˆ C: æ‰©å¤§å¸‚åœºæ¨å¹¿'
  ],
  
  // æŠ•ç¥¨ç±»å‹
  circuitType: MaciCircuitType.QV,  // äºŒæ¬¡æ–¹æŠ•ç¥¨
  
  // Round é…ç½®
  maxVoter: 1000,  // æœ€å¤§æŠ•ç¥¨äººæ•°
  voiceCreditAmount: '100',  // æ¯ä¸ªç”¨æˆ·çš„æŠ•ç¥¨æƒé‡
  
  // ç™½åå•åœ°å€åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
  whitelist: {
    addresses: [
      'dora1abc...',
      'dora1def...',
      'dora1ghi...'
    ]
  }
});

console.log('âœ… AMACI Round åˆ›å»ºæˆåŠŸï¼');
console.log('åˆçº¦åœ°å€:', round.contractAddress);
```

### ç™½åå•é…ç½®è¯´æ˜

**whitelist (string[])**

ç™½åå•åœ°å€åˆ—è¡¨ï¼Œåªæœ‰è¿™äº›åœ°å€å¯ä»¥ signupï¼š

```typescript
whitelist: [
  'dora1user1...',
  'dora1user2...',
  'dora1user3...'
  // å¯ä»¥æœ‰ä»»æ„æ•°é‡çš„åœ°å€
]
```

**voiceCreditsPerUser (number)**

æ¯ä¸ªç™½åå•ç”¨æˆ·çš„æŠ•ç¥¨æƒé‡ï¼š

```typescript
// å›ºå®šæƒé‡æ¨¡å¼ï¼šæ‰€æœ‰ç”¨æˆ·ç›¸åŒæƒé‡
voiceCreditsPerUser: 100  // æ¯äºº100æŠ•ç¥¨æƒé‡

// æˆ–è€…åŸºäºå…¶ä»–é€»è¾‘ï¼ˆéœ€è¦åˆçº¦æ”¯æŒï¼‰
voiceCreditsPerUser: 50   // æ¯äºº50æŠ•ç¥¨æƒé‡
```

---

## æ–¹å¼ 2: Pre-add-new-key æ¨¡å¼

### åŸºç¡€ç”¨æ³•

åˆ›å»ºä¸€ä¸ªä½¿ç”¨é¢„ç”Ÿæˆå¯†é’¥å¯¹çš„åŒ¿åæŠ•ç¥¨è½®æ¬¡ï¼š

```typescript
import { MaciClient, MaciCircuitType } from '@dorafactory/maci-sdk';

const client = new MaciClient({ network: 'testnet' });

// æ­¥éª¤ 1: æŸ¥è¯¢å¹¶é€‰æ‹© Operator
const operators = await client.indexer.getOperators();
const selectedOperator = operators.filter(op => op.status === 'Active')[0];

// æ­¥éª¤ 2: å‰æ - å¹³å°å·²ç»é¢„ç”Ÿæˆäº†å¯†é’¥å¯¹å’Œ deactivate tree
const round = await client.createAMaciRound({
  signer: wallet,
  operator: selectedOperator.address,
  
  // æŠ•ç¥¨æ—¶é—´
  startVoting: new Date('2024-02-01T00:00:00Z'),
  endVoting: new Date('2024-02-07T23:59:59Z'),
  
  // è½®æ¬¡ä¿¡æ¯
  title: 'åŒ¿åç¤¾åŒºæŠ•ç¥¨',
  description: 'å®Œå…¨åŒ¿åçš„æŠ•ç¥¨è½®æ¬¡',
  link: 'https://forum.example.com/proposal',
  
  // æŠ•ç¥¨é€‰é¡¹
  voteOptionMap: [
    'é€‰é¡¹ A',
    'é€‰é¡¹ B',
    'é€‰é¡¹ C'
  ],
  
  // æŠ•ç¥¨ç±»å‹
  circuitType: MaciCircuitType.QV,
  
  // Round é…ç½®
  maxVoter: 1000,
  voiceCreditAmount: '100',
  
  // Pre-add-new-key é…ç½®
  preDeactivateRoot: '0x1234567890abcdef...',  // é¢„ç”Ÿæˆçš„ root
  preDeactivateCoordinator: [
    BigInt('0xabcd...'),  // å¹³å° coordinator å…¬é’¥ x
    BigInt('0x1234...')   // å¹³å° coordinator å…¬é’¥ y
  ]
});

console.log('åŒ¿å Round åˆ›å»ºæˆåŠŸï¼');
console.log('åˆçº¦åœ°å€:', round.contractAddress);
```

### é¢„ç”Ÿæˆæµç¨‹

å¹³å°éœ€è¦æå‰ç”Ÿæˆå¯†é’¥å¯¹å’Œ deactivate treeï¼š

```typescript
import { genKeypair } from 'maci-crypto';
import { buildPreDeactivateTree } from '@dorafactory/maci-sdk';

// æ­¥éª¤ 1: ç”Ÿæˆå¯†é’¥å¯¹
const userCount = 1000;
const userPreKeys = [];

for (let i = 0; i < userCount; i++) {
  const keypair = genKeypair();
  userPreKeys.push({
    id: `user_${i}`,
    privateKey: keypair.privateKey.toString(16),
    publicKey: [
      keypair.publicKey[0].toString(16),
      keypair.publicKey[1].toString(16)
    ]
  });
}

// æ­¥éª¤ 2: ç”Ÿæˆ deactivate tree
const platformCoordKeypair = genKeypair();  // å¹³å°çš„ coordinator å¯†é’¥å¯¹

const preDeactivateTree = buildPreDeactivateTree(
  userPreKeys,
  platformCoordKeypair
);

console.log('é¢„ç”Ÿæˆå®Œæˆ:');
console.log('- ç”¨æˆ·æ•°é‡:', userCount);
console.log('- Root:', preDeactivateTree.root);
console.log('- Coordinator:', platformCoordKeypair.publicKey);

// æ­¥éª¤ 3: å°†å¯†é’¥å¯¹åˆ†å‘ç»™ç”¨æˆ·
// æ­¥éª¤ 4: ä½¿ç”¨ root å’Œ coordinator åˆ›å»º Round
```

---

## å‚æ•°è¯¦è§£

### å¿…éœ€å‚æ•°

#### signer (Wallet)

ç­¾åäº¤æ˜“çš„é’±åŒ…ï¼š

```typescript
import { DirectSecp256k1Wallet } from '@cosmjs/proto-signing';

const wallet = await DirectSecp256k1Wallet.fromKey(
  Buffer.from(privateKey, 'hex'),
  'dora'
);
```

#### operator (string)

Operator çš„åœ°å€ã€‚ä» Registry åˆçº¦æŸ¥è¯¢æ´»è·ƒçš„ Operatorï¼š

```typescript
const operators = await client.indexer.getOperators();
const activeOperators = operators.filter(op => op.status === 'Active');

// é€‰æ‹©è¯„åˆ†æœ€é«˜çš„ Operator
const bestOperator = activeOperators.sort((a, b) => b.score - a.score)[0];

console.log('é€‰æ‹© Operator:', bestOperator.identity);
console.log('Operator åœ°å€:', bestOperator.address);
```

#### startVoting & endVoting (Date)

æŠ•ç¥¨çš„å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼š

```typescript
// ç«‹å³å¼€å§‹ï¼Œ7 å¤©åç»“æŸ
startVoting: new Date(),
endVoting: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)

// æŒ‡å®šå…·ä½“æ—¶é—´
startVoting: new Date('2024-02-01T00:00:00Z'),
endVoting: new Date('2024-02-07T23:59:59Z')
```

#### title, description, link (string)

è½®æ¬¡çš„åŸºæœ¬ä¿¡æ¯ï¼š

```typescript
title: 'ç¤¾åŒºææ¡ˆæŠ•ç¥¨',
description: 'è¯¦ç»†æè¿°æŠ•ç¥¨çš„ç›®çš„å’Œè§„åˆ™',
link: 'https://forum.example.com/proposal-123'
```

#### voteOptionMap (string[])

æŠ•ç¥¨é€‰é¡¹åˆ—è¡¨ï¼š

```typescript
voteOptionMap: [
  'é€‰é¡¹ 1: æè¿°',
  'é€‰é¡¹ 2: æè¿°',
  'é€‰é¡¹ 3: æè¿°'
  // å¯ä»¥æœ‰ä»»æ„æ•°é‡çš„é€‰é¡¹
]
```

#### maxVoter (number)

æœ€å¤§æŠ•ç¥¨äººæ•°ï¼š

```typescript
maxVoter: 1000  // å…è®¸æœ€å¤š 1000 äººæŠ•ç¥¨
```

#### voiceCreditAmount (string)

æ¯ä¸ªç”¨æˆ·çš„æŠ•ç¥¨æƒé‡ï¼ˆvoice creditsï¼‰ï¼š

```typescript
voiceCreditAmount: '100'  // æ¯äºº 100 æŠ•ç¥¨æƒé‡
```

#### circuitType (MaciCircuitType)

æŠ•ç¥¨ç±»å‹ï¼š

```typescript
import { MaciCircuitType } from '@dorafactory/maci-sdk';

// ä¸€äººä¸€ç¥¨
circuitType: MaciCircuitType.IP1V

// äºŒæ¬¡æ–¹æŠ•ç¥¨
circuitType: MaciCircuitType.QV
```

---

## æŠ•ç¥¨ç±»å‹å¯¹æ¯”

### 1P1Vï¼ˆä¸€äººä¸€ç¥¨ï¼‰

æ¯ä¸ª voice credit ç›´æ¥è®¡ä¸º 1 ç¥¨ï¼š

```typescript
circuitType: MaciCircuitType.IP1V

// ç”¨æˆ·æœ‰ 100 voice credits
// æŠ•ç¥¨ï¼š[{ idx: 0, vc: 50 }, { idx: 1, vc: 30 }]
// ç»“æœï¼šé€‰é¡¹ 0 è·å¾— 50 ç¥¨ï¼Œé€‰é¡¹ 1 è·å¾— 30 ç¥¨
// æ¶ˆè€—ï¼š80 voice credits
```

### QVï¼ˆäºŒæ¬¡æ–¹æŠ•ç¥¨ï¼‰

voice credit çš„å¹³æ–¹ä½œä¸ºæ¶ˆè€—ï¼š

```typescript
circuitType: MaciCircuitType.QV

// ç”¨æˆ·æœ‰ 100 voice credits
// æŠ•ç¥¨ï¼š[{ idx: 0, vc: 8 }, { idx: 1, vc: 6 }]
// ç»“æœï¼šé€‰é¡¹ 0 è·å¾— 8 ç¥¨ï¼Œé€‰é¡¹ 1 è·å¾— 6 ç¥¨
// æ¶ˆè€—ï¼š8Â² + 6Â² = 64 + 36 = 100 voice credits
```

---

## å®Œæ•´ç¤ºä¾‹

### åˆ›å»ºç™½åå• 1P1V æŠ•ç¥¨

```typescript
// æŸ¥è¯¢ Operator
const operators = await client.indexer.getOperators();
const operator = operators.filter(op => op.status === 'Active')[0];

const round1p1v = await client.createAMaciRound({
  signer: wallet,
  operator: operator.address,
  
  startVoting: new Date(),
  endVoting: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
  
  title: 'DAO ææ¡ˆæŠ•ç¥¨ï¼ˆä¸€äººä¸€ç¥¨ï¼‰',
  description: 'æ¯ä¸ªæˆå‘˜ä¸€ç¥¨ï¼Œå¤šæ•°è·èƒœ',
  link: 'https://dao.example.com',
  
  voteOptionMap: ['èµæˆ', 'åå¯¹', 'å¼ƒæƒ'],
  
  circuitType: MaciCircuitType.IP1V,
  
  maxVoter: 100,
  voiceCreditAmount: '1',  // æ¯äºº1ç¥¨
  
  // ç™½åå•åˆ—è¡¨
  whitelist: {
    addresses: [
      'dora1member1...',
      'dora1member2...',
      'dora1member3...'
    ]
  }
});
```

### åˆ›å»ºç™½åå• QV æŠ•ç¥¨

```typescript
// æŸ¥è¯¢ Operator
const operators = await client.indexer.getOperators();
const operator = operators.filter(op => op.status === 'Active')[0];

const roundQV = await client.createAMaciRound({
  signer: wallet,
  operator: operator.address,
  
  startVoting: new Date(),
  endVoting: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000),
  
  title: 'å…¬å…±ç‰©å“èµ„é‡‘åˆ†é…ï¼ˆäºŒæ¬¡æ–¹æŠ•ç¥¨ï¼‰',
  description: 'ä½¿ç”¨äºŒæ¬¡æ–¹æŠ•ç¥¨åˆ†é…èµ„é‡‘',
  link: 'https://gitcoin.example.com',
  
  voteOptionMap: [
    'é¡¹ç›® A: DeFi å·¥å…·',
    'é¡¹ç›® B: æ•™è‚²å†…å®¹',
    'é¡¹ç›® C: åŸºç¡€è®¾æ–½',
    'é¡¹ç›® D: ç¤¾åŒºæ´»åŠ¨'
  ],
  
  circuitType: MaciCircuitType.QV,
  
  maxVoter: 500,
  voiceCreditAmount: '100',
  
  // ç™½åå•åˆ—è¡¨
  whitelist: {
    addresses: whitelistAddresses  // ä»å¤–éƒ¨å¯¼å…¥
  }
});
```

### åˆ›å»ºåŒ¿å Pre-add-new-key æŠ•ç¥¨

```typescript
// å®Œæ•´çš„å¹³å°å‡†å¤‡æµç¨‹
import { genKeypair } from 'maci-crypto';
import { buildPreDeactivateTree } from '@dorafactory/maci-sdk';

// 1. å¹³å°ç”Ÿæˆå¯†é’¥å¯¹
const userPreKeys = [];
for (let i = 0; i < 500; i++) {
  const keypair = genKeypair();
  userPreKeys.push({
    id: `user_${i}`,
    privateKey: keypair.privateKey.toString(16),
    publicKey: [
      keypair.publicKey[0].toString(16),
      keypair.publicKey[1].toString(16)
    ]
  });
}

// 2. ç”Ÿæˆ deactivate tree
const platformCoordKeypair = genKeypair();
const preDeactivateTree = buildPreDeactivateTree(
  userPreKeys,
  platformCoordKeypair
);

// 3. æŸ¥è¯¢å¹¶é€‰æ‹© Operator
const operators = await client.indexer.getOperators();
const operator = operators.filter(op => op.status === 'Active')[0];

// 4. åˆ›å»º Round
const roundAnonymous = await client.createAMaciRound({
  signer: wallet,
  operator: operator.address,
  
  startVoting: new Date(),
  endVoting: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000),
  
  title: 'åŒ¿åç¤¾åŒºæŠ•ç¥¨',
  description: 'å®Œå…¨åŒ¿åçš„æŠ•ç¥¨ï¼Œç”¨æˆ·ç”¨ä»»æ„åœ°å€å‘é€äº¤æ˜“',
  link: 'https://vote.example.com',
  
  voteOptionMap: [
    'æ–¹æ¡ˆ A',
    'æ–¹æ¡ˆ B',
    'æ–¹æ¡ˆ C'
  ],
  
  circuitType: MaciCircuitType.QV,
  
  maxVoter: 500,
  voiceCreditAmount: '100',
  
  // Pre-add-new-key é…ç½®
  preDeactivateRoot: preDeactivateTree.root,
  preDeactivateCoordinator: [
    platformCoordKeypair.publicKey[0],
    platformCoordKeypair.publicKey[1]
  ]
});

console.log('âœ… åŒ¿å Round åˆ›å»ºæˆåŠŸ');
console.log('åˆçº¦åœ°å€:', roundAnonymous.contractAddress);

// 4. å°†å¯†é’¥å¯¹åˆ†å‘ç»™ç”¨æˆ·ï¼ˆé€šè¿‡å®‰å…¨æ¸ é“ï¼‰
// userPreKeys éœ€è¦åˆ†å‘ç»™æ¯ä¸ªç”¨æˆ·
```

---

## é”™è¯¯å¤„ç†

```typescript
try {
  const round = await client.createAMaciRound({
    // ... å‚æ•°
  });
  console.log('âœ… åˆ›å»ºæˆåŠŸ:', round.contractAddress);
} catch (error) {
  if (error.message.includes('Operator not found')) {
    console.error('âŒ Operator ä¸å­˜åœ¨');
  } else if (error.message.includes('Operator not active')) {
    console.error('âŒ Operator æœªæ¿€æ´»');
  } else if (error.message.includes('Insufficient funds')) {
    console.error('âŒ ä½™é¢ä¸è¶³');
  } else if (error.message.includes('Invalid whitelist')) {
    console.error('âŒ ç™½åå•æ ¼å¼é”™è¯¯');
  } else {
    console.error('âŒ åˆ›å»ºå¤±è´¥:', error);
  }
}
```

---

## éªŒè¯åˆ›å»º

åˆ›å»ºåéªŒè¯ Round ä¿¡æ¯ï¼š

```typescript
const roundInfo = await client.getRoundInfo({ 
  contractAddress: round.contractAddress 
});

console.log('Round éªŒè¯:');
console.log('- æ ‡é¢˜:', roundInfo.title);
console.log('- çŠ¶æ€:', roundInfo.status);
console.log('- å¼€å§‹æ—¶é—´:', new Date(roundInfo.votingTime.startTime * 1000));
console.log('- ç»“æŸæ—¶é—´:', new Date(roundInfo.votingTime.endTime * 1000));
console.log('- é€‰é¡¹æ•°é‡:', roundInfo.voteOptionMap.length);
```

---

## æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | ç™½åå•åˆ—è¡¨æ¨¡å¼ | Pre-add-new-key æ¨¡å¼ |
|------|--------------|-------------------|
| é…ç½®å¤æ‚åº¦ | â­ ç®€å• | â­â­â­ éœ€è¦é¢„ç”Ÿæˆ |
| ç”¨æˆ·æ³¨å†Œ | ç™½åå•åœ°å€ signup | ä»»æ„åœ°å€å‘é€äº¤æ˜“ |
| éšç§çº§åˆ« | â­â­ ä½ | â­â­â­â­â­ æœ€é«˜ |
| Operator çŸ¥é“èº«ä»½ | âœ… æ˜¯ | âŒ å¦ |
| é€‚ç”¨åœºæ™¯ | å·²çŸ¥ç”¨æˆ·åˆ—è¡¨ | åŒ¿åæŠ•ç¥¨ï¼Œå¹³å°è¿è¥ |
| çµæ´»æ€§ | ä¸­ | é«˜ |

---

## ä¸‹ä¸€æ­¥

Round åˆ›å»ºæˆåŠŸåï¼š

- ğŸ“ [å‚ä¸æŠ•ç¥¨](/docs/sdk/voting-guide) - å­¦ä¹ å¦‚ä½•æŠ•ç¥¨
- ğŸ” [æŸ¥è¯¢ä¿¡æ¯](/docs/sdk/query-api) - æŸ¥è¯¢ Round ä¿¡æ¯
- ğŸ’¡ [æŸ¥çœ‹ç¤ºä¾‹](/docs/examples/pre-addnewkey-round) - å®Œæ•´ç¤ºä¾‹ä»£ç 
