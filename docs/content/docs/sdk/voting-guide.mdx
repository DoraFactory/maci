# æŠ•ç¥¨æ“ä½œæŒ‡å—

å®Œæ•´çš„æŠ•ç¥¨æµç¨‹åˆ†ä¸ºä¸¤ç§æ–¹å¼ï¼šç™½åå•æ¨¡å¼ï¼ˆ3æ­¥ï¼‰å’Œ Pre-add-new-key åŒ¿åæ¨¡å¼ï¼ˆ4æ­¥ï¼‰ã€‚

---

## æ–¹å¼ 1: ç™½åå•æ¨¡å¼æŠ•ç¥¨

é€‚ç”¨äºå·²åœ¨ç™½åå•ä¸­çš„ç”¨æˆ·ã€‚

### å®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant SDK as MACI SDK
    participant Contract as AMACI åˆçº¦
    User->>SDK: 1. ç”Ÿæˆ MACI è´¦æˆ·
    SDK-->>User: è¿”å›å¯†é’¥å¯¹
    User->>Contract: 2. ç­¾åˆ°ï¼ˆSignupï¼‰
    Contract-->>User: æˆåŠŸ
    User->>Contract: 3. æŠ•ç¥¨
    Contract-->>User: æˆåŠŸ
```

### æ­¥éª¤ 1: ç”Ÿæˆ MACI è´¦æˆ·

```typescript
import { MaciClient } from '@dorafactory/maci-sdk';

const client = new MaciClient({ network: 'testnet' });

// ä» dora åœ°å€è¡ç”Ÿ EdDSA-Poseidon å¯†é’¥å¯¹
const maciKeypair = await client.genKeypairFromSign({
  signer: wallet,
  address
});

console.log('âœ… MACI è´¦æˆ·ç”ŸæˆæˆåŠŸ');
```

### æ­¥éª¤ 2: ç­¾åˆ°ï¼ˆä»…ç™½åå•åœ°å€å¯ç”¨ï¼‰

```typescript
await client.signup({
  signer: wallet,
  address: userAddress,
  contractAddress: amaciContractAddress,
  maciKeypair: maciKeypair,
  gasStation: true  // ä½¿ç”¨ Gas Station
});

console.log('âœ… ç­¾åˆ°æˆåŠŸï¼ˆåœ°å€å¿…é¡»åœ¨ç™½åå•ä¸­ï¼‰');
```

### æ­¥éª¤ 3: æŠ•ç¥¨

```typescript
// è·å– Coordinator å…¬é’¥
const roundInfo = await client.getRoundInfo({ contractAddress });

const coordinatorPubKey = [
  BigInt(roundInfo.coordinatorPubkeyX),
  BigInt(roundInfo.coordinatorPubkeyY)
];

// æäº¤æŠ•ç¥¨
await client.vote({
  signer: wallet,
  address: userAddress,
  contractAddress: amaciContractAddress,
  selectedOptions: [
    { idx: 0, vc: 5 },  // ç»™é€‰é¡¹ 0 æŠ• 5 ç¥¨
    { idx: 1, vc: 3 },  // ç»™é€‰é¡¹ 1 æŠ• 3 ç¥¨
  ],
  operatorCoordPubKey: coordinatorPubKey,
  maciKeypair: maciKeypair,
  gasStation: true
});

console.log('âœ… æŠ•ç¥¨æˆåŠŸ');
```

---

## æ–¹å¼ 2: Pre-add-new-key åŒ¿åæ¨¡å¼

é€‚ç”¨äºè·å¾—å¹³å°åˆ†å‘å¯†é’¥å¯¹çš„ç”¨æˆ·ï¼Œæä¾›æœ€é«˜éšç§çº§åˆ«ã€‚

### å®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    participant Platform as å¹³å°
    participant User as ç”¨æˆ·
    participant SDK as MACI SDK
    participant Contract as AMACI åˆçº¦
    Platform->>User: 0. åˆ†å‘é¢„ç”Ÿæˆå¯†é’¥å¯¹
    User->>SDK: 1. æœ¬åœ°ç”Ÿæˆè¯æ˜
    SDK-->>User: è¿”å› payload
    User->>Contract: 2. Pre-add-new-keyï¼ˆä»»æ„åœ°å€ï¼‰
    Contract-->>User: æˆåŠŸ
    User->>Contract: 3. æŠ•ç¥¨
    Contract-->>User: æˆåŠŸ
```

### æ­¥éª¤ 0: è·å–å¹³å°åˆ†å‘çš„å¯†é’¥å¯¹

å¹³å°é€šè¿‡å®‰å…¨æ¸ é“åˆ†å‘ï¼š

```json
{
  "privateKey": "0x1234567890abcdef...",
  "publicKey": {
    "x": "0xabcdef...",
    "y": "0x123456..."
  },
  "preDeactivateData": {
    "leaves": [ /* deactivate tree æ•°æ® */ ],
    "coordinatorPubkey": { "x": "...", "y": "..." }
  }
}
```

### æ­¥éª¤ 1: æœ¬åœ°ç”Ÿæˆè¯æ˜å’Œæ–°å¯†é’¥

```typescript
import { VoterClient, genKeypair } from '@dorafactory/maci-sdk';

// ä½¿ç”¨å¹³å°åˆ†å‘çš„ç§é’¥
const voterClient = new VoterClient({
  network: 'mainnet',
  secretKey: receivedPrivateKey  // å¹³å°åˆ†å‘çš„
});

// â­ ç”¨æˆ·ç”Ÿæˆè‡ªå·±çš„æ–°å¯†é’¥å¯¹ï¼ˆå®Œå…¨ç”±ç”¨æˆ·æ§åˆ¶ï¼‰
const myNewKeypair = genKeypair();

console.log('âœ… æ–°å¯†é’¥å·²åœ¨æœ¬åœ°ç”Ÿæˆï¼Œåªæœ‰æˆ‘çŸ¥é“');

// ç”Ÿæˆ pre-add-new-key payload
const payload = await voterClient.buildPreAddNewKeyPayload({
  stateTreeDepth: 10,
  coordinatorPubkey: preDeactivateData.coordinatorPubkey,
  deactivates: preDeactivateData.leaves,
  wasmFile: '/path/to/addNewKey.wasm',
  zkeyFile: '/path/to/addNewKey.zkey'
});

console.log('âœ… ZK è¯æ˜åœ¨æœ¬åœ°ç”Ÿæˆå®Œæˆ');
```

### æ­¥éª¤ 2: å‘é€ Pre-add-new-key äº¤æ˜“

```typescript
// â­ å¯ä»¥ç”¨ä»»æ„ dora åœ°å€å‘é€æ­¤äº¤æ˜“
await client.rawPreAddNewKey({
  signer: anyWallet,  // ä»»æ„é’±åŒ…ï¼
  contractAddress,
  d: payload.d,
  proof: payload.proof,
  nullifier: payload.nullifier,
  newPubkey: {
    x: myNewKeypair.publicKey[0].toString(16),
    y: myNewKeypair.publicKey[1].toString(16)
  },
  gasStation: true
});

console.log('âœ… åŒ¿åæ³¨å†ŒæˆåŠŸ');
console.log('âœ… Operator ä¸çŸ¥é“æ˜¯è°');
```

### æ­¥éª¤ 3: æŠ•ç¥¨

```typescript
// ç”¨æ–°å¯†é’¥å¯¹æŠ•ç¥¨
const roundInfo = await client.getRoundInfo({ contractAddress });

await client.vote({
  signer: anyWallet,  // å¯ä»¥ç”¨ä»»æ„é’±åŒ…
  address: anyAddress,
  contractAddress,
  selectedOptions: [
    { idx: 0, vc: 8 },
    { idx: 1, vc: 6 }
  ],
  operatorCoordPubKey: [
    BigInt(roundInfo.coordinatorPubkeyX),
    BigInt(roundInfo.coordinatorPubkeyY)
  ],
  maciKeypair: myNewKeypair,  // åªæœ‰ç”¨æˆ·çŸ¥é“
  gasStation: true
});

console.log('âœ… æŠ•ç¥¨å®Œæˆï¼Œå®Œå…¨åŒ¿å');
```

---

## Gas Station å¤„ç†

### æ£€æŸ¥ Gas Station çŠ¶æ€

```typescript
async function waitForGasStation(
  client: MaciClient,
  address: string,
  contractAddress: string
): Promise<boolean> {
  let hasFeegrant = false;
  let attempts = 0;
  const maxAttempts = 30;  // æœ€å¤šç­‰å¾… 1 åˆ†é’Ÿ

  while (!hasFeegrant && attempts < maxAttempts) {
    hasFeegrant = await client.hasFeegrant({
      address,
      contractAddress
    });

    if (!hasFeegrant) {
      console.log(`ç­‰å¾… Gas Station (${attempts + 1}/${maxAttempts})...`);
      await new Promise(resolve => setTimeout(resolve, 2000));
      attempts++;
    }
  }

  return hasFeegrant;
}

// ä½¿ç”¨
const hasGasStation = await waitForGasStation(client, address, contractAddress);

if (hasGasStation) {
  console.log('âœ… Gas Station å·²å¯ç”¨');
} else {
  console.log('âš ï¸  Gas Station æœªå¯ç”¨ï¼Œå°†ä½¿ç”¨è‡ªå·±çš„ Gas');
}
```

---

## æŠ•ç¥¨è§„åˆ™

### 1P1V æ¨¡å¼

voice credit ç›´æ¥ä½œä¸ºç¥¨æ•°ï¼š

```typescript
// å‡è®¾ç”¨æˆ·æœ‰ 100 voice credits
selectedOptions: [
  { idx: 0, vc: 50 },  // 50 ç¥¨
  { idx: 1, vc: 30 },  // 30 ç¥¨
  { idx: 2, vc: 20 },  // 20 ç¥¨
]
// æ€»æ¶ˆè€— = 50 + 30 + 20 = 100 voice credits
```

### QV æ¨¡å¼

voice credit çš„å¹³æ–¹ä½œä¸ºæ¶ˆè€—ï¼š

```typescript
// å‡è®¾ç”¨æˆ·æœ‰ 100 voice credits
selectedOptions: [
  { idx: 0, vc: 8 },  // 8 ç¥¨ï¼Œæ¶ˆè€— 64 credits (8Â²)
  { idx: 1, vc: 6 },  // 6 ç¥¨ï¼Œæ¶ˆè€— 36 credits (6Â²)
]
// æ€»æ¶ˆè€— = 64 + 36 = 100 voice credits
```

---

## é‡æ–°æŠ•ç¥¨

ç”¨æˆ·å¯ä»¥å¤šæ¬¡æŠ•ç¥¨ï¼Œåé¢çš„æŠ•ç¥¨ä¼šè¦†ç›–å‰é¢çš„ï¼š

```typescript
// ç¬¬ä¸€æ¬¡æŠ•ç¥¨
await client.vote({
  selectedOptions: [{ idx: 0, vc: 5 }],
  // ... å…¶ä»–å‚æ•°
});

console.log('ç¬¬ä¸€æ¬¡æŠ•ç¥¨å®Œæˆ');

// æ”¹å˜ä¸»æ„ï¼Œé‡æ–°æŠ•ç¥¨
await client.vote({
  selectedOptions: [{ idx: 1, vc: 5 }],  // æ”¹æŠ•é€‰é¡¹ 1
  // ... å…¶ä»–å‚æ•°
});

console.log('é‡æ–°æŠ•ç¥¨å®Œæˆ');
// æœ€ç»ˆåªæœ‰ç¬¬äºŒæ¬¡æŠ•ç¥¨ï¼ˆé€‰é¡¹ 1ï¼‰æœ‰æ•ˆ
```

---

## å®Œæ•´ç¤ºä¾‹å‡½æ•°

### ç™½åå•æ¨¡å¼å®Œæ•´æµç¨‹

```typescript
async function whitelistVoting(
  client: MaciClient,
  wallet: any,
  address: string,
  contractAddress: string,
  voteOptions: { idx: number; vc: number }[]
) {
  try {
    // æ­¥éª¤ 1: ç”Ÿæˆè´¦æˆ·
    console.log('1/3 ç”Ÿæˆ MACI è´¦æˆ·...');
    const maciKeypair = await client.genKeypairFromSign({ 
      signer: wallet, 
      address 
    });
    
    // æ­¥éª¤ 2: ç­¾åˆ°
    console.log('2/3 ç­¾åˆ°ä¸­ï¼ˆéœ€è¦åœ¨ç™½åå•ä¸­ï¼‰...');
    await client.signup({
      signer: wallet,
      address,
      contractAddress,
      maciKeypair,
      gasStation: true
    });
    
    // æ­¥éª¤ 3: æŠ•ç¥¨
    console.log('3/3 æŠ•ç¥¨ä¸­...');
    const roundInfo = await client.getRoundInfo({ contractAddress });
    
    await client.vote({
      signer: wallet,
      address,
      contractAddress,
      selectedOptions: voteOptions,
      operatorCoordPubKey: [
        BigInt(roundInfo.coordinatorPubkeyX),
        BigInt(roundInfo.coordinatorPubkeyY)
      ],
      maciKeypair,
      gasStation: true
    });
    
    console.log('âœ… æŠ•ç¥¨æµç¨‹å®Œæˆï¼');
    return true;
  } catch (error) {
    console.error('âŒ æŠ•ç¥¨å¤±è´¥:', error);
    return false;
  }
}
```

### Pre-add-new-key åŒ¿åæ¨¡å¼å®Œæ•´æµç¨‹

```typescript
async function anonymousVoting(
  client: MaciClient,
  receivedPrivateKey: string,
  preDeactivateData: any,
  anyWallet: any,
  anyAddress: string,
  contractAddress: string,
  voteOptions: { idx: number; vc: number }[]
) {
  try {
    // æ­¥éª¤ 1: æœ¬åœ°ç”Ÿæˆè¯æ˜
    console.log('1/3 æœ¬åœ°ç”Ÿæˆ ZK è¯æ˜...');
    
    const voterClient = new VoterClient({
      network: 'mainnet',
      secretKey: receivedPrivateKey
    });
    
    const myNewKeypair = genKeypair();
    
    const payload = await voterClient.buildPreAddNewKeyPayload({
      stateTreeDepth: 10,
      coordinatorPubkey: preDeactivateData.coordinatorPubkey,
      deactivates: preDeactivateData.leaves,
      wasmFile,
      zkeyFile
    });
    
    console.log('âœ… è¯æ˜ç”Ÿæˆå®Œæˆ');
    
    // æ­¥éª¤ 2: Pre-add-new-key
    console.log('2/3 åŒ¿åæ³¨å†Œä¸­ï¼ˆç”¨ä»»æ„åœ°å€ï¼‰...');
    await client.rawPreAddNewKey({
      signer: anyWallet,
      contractAddress,
      d: payload.d,
      proof: payload.proof,
      nullifier: payload.nullifier,
      newPubkey: {
        x: myNewKeypair.publicKey[0].toString(16),
        y: myNewKeypair.publicKey[1].toString(16)
      },
      gasStation: true
    });
    
    console.log('âœ… åŒ¿åæ³¨å†ŒæˆåŠŸ');
    
    // æ­¥éª¤ 3: æŠ•ç¥¨
    console.log('3/3 æŠ•ç¥¨ä¸­...');
    const roundInfo = await client.getRoundInfo({ contractAddress });
    
    await client.vote({
      signer: anyWallet,
      address: anyAddress,
      contractAddress,
      selectedOptions: voteOptions,
      operatorCoordPubKey: [
        BigInt(roundInfo.coordinatorPubkeyX),
        BigInt(roundInfo.coordinatorPubkeyY)
      ],
      maciKeypair: myNewKeypair,
      gasStation: true
    });
    
    console.log('âœ… åŒ¿åæŠ•ç¥¨æµç¨‹å®Œæˆï¼');
    return true;
  } catch (error) {
    console.error('âŒ æŠ•ç¥¨å¤±è´¥:', error);
    return false;
  }
}
```

---

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•è®¡ç®—æˆ‘èƒ½æŠ•å¤šå°‘ç¥¨ï¼Ÿ

**A:** å–å†³äºæŠ•ç¥¨æ¨¡å¼å’Œæ‚¨çš„ voice creditsï¼š

```typescript
// 1P1V æ¨¡å¼
const maxVotes = voiceCredits;  // 100 credits = 100 ç¥¨

// QV æ¨¡å¼  
const maxVotes = Math.floor(Math.sqrt(voiceCredits));  // 100 credits = 10 ç¥¨
```

### Q: ç™½åå•æ¨¡å¼å’ŒåŒ¿åæ¨¡å¼å¦‚ä½•é€‰æ‹©ï¼Ÿ

**A:** æ ¹æ®éšç§éœ€æ±‚ï¼š

- **ç™½åå•æ¨¡å¼**ï¼šç®€å•å¿«é€Ÿï¼Œä½† Operator çŸ¥é“ä½ çš„èº«ä»½
- **åŒ¿åæ¨¡å¼**ï¼šå®Œå…¨åŒ¿åï¼ŒOperator ä¸çŸ¥é“å…·ä½“æ˜¯è°ï¼Œæ¨èç”¨äºéšç§æŠ•ç¥¨

### Q: æŠ•ç¥¨å¤±è´¥äº†æ€ä¹ˆåŠï¼Ÿ

**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

1. æ˜¯å¦åœ¨æŠ•ç¥¨æœŸå†…
2. ç™½åå•æ¨¡å¼ï¼šåœ°å€æ˜¯å¦åœ¨ç™½åå•ä¸­
3. åŒ¿åæ¨¡å¼ï¼šæ˜¯å¦æœ‰å¹³å°åˆ†å‘çš„å¯†é’¥
4. voice credits æ˜¯å¦è¶³å¤Ÿ
5. Gas Station æ˜¯å¦å·²å¯ç”¨ï¼ˆå¦‚æœä½¿ç”¨ï¼‰

### Q: å¯ä»¥åŒæ—¶æŠ•ç»™å¤šä¸ªé€‰é¡¹å—ï¼Ÿ

**A:** å¯ä»¥ï¼åœ¨ `selectedOptions` æ•°ç»„ä¸­æ·»åŠ å¤šä¸ªé€‰é¡¹ï¼š

```typescript
selectedOptions: [
  { idx: 0, vc: 5 },
  { idx: 1, vc: 3 },
  { idx: 2, vc: 2 }
]
```

### Q: å¦‚ä½•æ’¤é”€æŠ•ç¥¨ï¼Ÿ

**A:** é‡æ–°æŠ•ç¥¨å¹¶å°†æ‰€æœ‰æƒé‡è®¾ä¸º 0ï¼Œæˆ–æŠ•ç»™å…¶ä»–é€‰é¡¹ã€‚

---

## éšç§çº§åˆ«å¯¹æ¯”

| æ¨¡å¼ | Operator çŸ¥é“èº«ä»½ | é“¾ä¸Šè¿½è¸ªéš¾åº¦ | éšç§çº§åˆ« | é€‚ç”¨åœºæ™¯ |
|------|----------------|------------|---------|---------|
| ç™½åå• Signup | âœ… æ˜¯ | å®¹æ˜“ | â­â­ | ç®€å•æŠ•ç¥¨ |
| Pre-add-new-key | âŒ å¦ | æéš¾ | â­â­â­â­â­ | åŒ¿åæŠ•ç¥¨ |

---

## ä¸‹ä¸€æ­¥

å®ŒæˆæŠ•ç¥¨åï¼Œæ‚¨å¯ä»¥ï¼š

- ğŸ” [æŸ¥è¯¢ API](/docs/sdk/query-api) - æŸ¥è¯¢æŠ•ç¥¨ä¿¡æ¯å’Œç»“æœ
- ğŸ’¡ [æŸ¥çœ‹ç¤ºä¾‹](/docs/examples/basic-voting) - å®Œæ•´çš„æŠ•ç¥¨ç¤ºä¾‹
- ğŸš€ [äº†è§£é«˜çº§åŠŸèƒ½](/docs/sdk/advanced) - æ¢ç´¢æ›´å¤šåŠŸèƒ½
