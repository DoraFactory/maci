# æŸ¥è¯¢ API

MACI SDK æä¾›äº†ä¸°å¯Œçš„æŸ¥è¯¢åŠŸèƒ½æ¥è·å–å„ç§ä¿¡æ¯ã€‚

## Round æŸ¥è¯¢

### é€šè¿‡ ID æŸ¥è¯¢ Round

```typescript
// æ–¹å¼1ï¼šä½¿ç”¨ getRoundInfoï¼ˆæ¨èï¼Œè¿”å›å®Œæ•´çš„ Round ä¿¡æ¯ï¼‰
const round = await client.getRoundInfo({ contractAddress: 'dora1contractaddress...' });

// æ–¹å¼2ï¼šä½¿ç”¨ indexer æŸ¥è¯¢
const round = await client.indexer.getRoundById('dora1contractaddress...');

console.log('Round ä¿¡æ¯:', {
  title: round.title,
  description: round.description,
  status: round.status,
  coordinatorPubkey: round.coordinatorPubkey,
  numSignups: round.numSignups,
  votingTime: round.votingTime,
  voteOptionMap: round.voteOptionMap
});
```

### è·å– Round åˆ—è¡¨

```typescript
const rounds = await client.getRounds('first', 10);

rounds.forEach(round => {
  console.log(`- ${round.title} (${round.status})`);
});
```

### æŒ‰çŠ¶æ€æŸ¥è¯¢

```typescript
// æŸ¥è¯¢æ‰€æœ‰è¿›è¡Œä¸­çš„æŠ•ç¥¨
const activeRounds = await client.indexer.getRoundsByStatus(
  'Voting',
  'first',
  10
);

// å¯ç”¨çŠ¶æ€ï¼š'Created', 'Voting', 'Processing', 'Tallied'
```

### æŒ‰ Operator æŸ¥è¯¢

```typescript
const operatorRounds = await client.indexer.getRoundsByOperator(
  'dora1operator...',
  'first',
  10
);
```

### æŒ‰ç”µè·¯ç±»å‹æŸ¥è¯¢

```typescript
// æŸ¥è¯¢æ‰€æœ‰ QV æŠ•ç¥¨
const qvRounds = await client.indexer.getRoundsByCircuitName(
  'amaci-qv',
  'first',
  10
);

// æŸ¥è¯¢æ‰€æœ‰ 1P1V æŠ•ç¥¨
const p1vRounds = await client.indexer.getRoundsByCircuitName(
  'amaci-1p1v',
  'first',
  10
);
```

## Operator æŸ¥è¯¢

### é€šè¿‡åœ°å€æŸ¥è¯¢ Operator

```typescript
const operator = await client.indexer.getOperatorByAddress('dora1operator...');

console.log('Operator ä¿¡æ¯:', {
  address: operator.address,
  pubkey: operator.pubkey,
  identity: operator.identity,
  isActive: operator.isActive
});
```

### è·å– Operator åˆ—è¡¨

```typescript
const operators = await client.indexer.getOperators('first', 10);

operators.forEach(op => {
  console.log(`- ${op.identity || op.address}`);
});
```

## Circuit æŸ¥è¯¢

### é€šè¿‡åç§°æŸ¥è¯¢ Circuit

```typescript
const circuit = await client.indexer.getCircuitByName('amaci-qv');

console.log('Circuit ä¿¡æ¯:', {
  name: circuit.name,
  type: circuit.type,
  description: circuit.description
});
```

### è·å–æ‰€æœ‰ Circuits

```typescript
const circuits = await client.indexer.getCircuits();

circuits.forEach(circuit => {
  console.log(`- ${circuit.name}: ${circuit.description}`);
});
```

## äº¤æ˜“æŸ¥è¯¢

### é€šè¿‡å“ˆå¸ŒæŸ¥è¯¢äº¤æ˜“

```typescript
const tx = await client.indexer.getTransactionByHash('ABCD1234...');

console.log('äº¤æ˜“ä¿¡æ¯:', {
  hash: tx.hash,
  height: tx.height,
  success: tx.success,
  gasUsed: tx.gasUsed,
  timestamp: tx.timestamp
});
```

### æŒ‰åˆçº¦åœ°å€æŸ¥è¯¢äº¤æ˜“

```typescript
const transactions = await client.indexer.getTransactionsByContractAddress(
  'dora1contract...',
  'first',
  10
);

transactions.forEach(tx => {
  console.log(`- ${tx.type} at block ${tx.height}`);
});
```

### è·å–äº¤æ˜“åˆ—è¡¨

```typescript
const recentTxs = await client.indexer.getTransactions('first', 20);
```

## è¯æ˜æŸ¥è¯¢

### æŸ¥è¯¢è¯æ˜ä¿¡æ¯

```typescript
const proof = await client.indexer.getProofByContractAddress('dora1contract...');

console.log('è¯æ˜ä¿¡æ¯:', {
  contractAddress: proof.contractAddress,
  hasProcessMessagesProof: proof.hasProcessMessagesProof,
  hasTallyProof: proof.hasTallyProof,
  processedAt: proof.processedAt,
  talliedAt: proof.talliedAt
});
```

## ä½™é¢æŸ¥è¯¢

### æŸ¥è¯¢è´¦æˆ·ä½™é¢

```typescript
const balance = await client.indexer.balanceOf('dora1address...');

console.log('ä½™é¢:', {
  amount: balance.amount,
  denom: balance.denom
});
```

## é«˜çº§æŸ¥è¯¢

### åˆ†é¡µæŸ¥è¯¢

æ‰€æœ‰åˆ—è¡¨æŸ¥è¯¢éƒ½æ”¯æŒåˆ†é¡µï¼š

```typescript
// ç¬¬ä¸€é¡µ
const page1 = await client.getRounds('first', 10);

// ä¸‹ä¸€é¡µï¼ˆä½¿ç”¨æœ€åä¸€ä¸ªé¡¹ç›®çš„ IDï¼‰
const lastId = page1[page1.length - 1].id;
const page2 = await client.getRounds('after', 10, lastId);

// ä¸Šä¸€é¡µ
const page0 = await client.getRounds('before', 10, page1[0].id);
```

### ç»„åˆæŸ¥è¯¢ç¤ºä¾‹

```typescript
async function findActiveQVRounds(client: MaciClient) {
  // 1. è·å–æ‰€æœ‰ QV ç”µè·¯çš„æŠ•ç¥¨
  const qvRounds = await client.indexer.getRoundsByCircuitName('amaci-qv', 'first', 100);
  
  // 2. è¿‡æ»¤å‡ºè¿›è¡Œä¸­çš„æŠ•ç¥¨
  const activeRounds = qvRounds.filter(round => {
    const now = Date.now() / 1000;
    return (
      round.votingTime.startTime <= now &&
      round.votingTime.endTime >= now &&
      round.status === 'Voting'
    );
  });
  
  // 3. æŒ‰å‚ä¸äººæ•°æ’åº
  activeRounds.sort((a, b) => b.numSignups - a.numSignups);
  
  return activeRounds;
}

// ä½¿ç”¨
const popularRounds = await findActiveQVRounds(client);
console.log(`æ‰¾åˆ° ${popularRounds.length} ä¸ªæ´»è·ƒçš„ QV æŠ•ç¥¨`);
```

### ç›‘å¬ Round çŠ¶æ€

```typescript
async function waitForRoundToFinish(
  client: MaciClient,
  contractAddress: string
): Promise<void> {
  console.log('ç­‰å¾…æŠ•ç¥¨ç»“æŸ...');
  
  while (true) {
    const round = await client.getRoundInfo({ contractAddress });
    
    if (round.status === 'Tallied') {
      console.log('âœ… æŠ•ç¥¨å·²å®Œæˆï¼');
      break;
    }
    
    console.log(`å½“å‰çŠ¶æ€: ${round.status}`);
    
    // ç­‰å¾… 10 ç§’åå†æ¬¡æ£€æŸ¥
    await new Promise(resolve => setTimeout(resolve, 10000));
  }
}

// ä½¿ç”¨
await waitForRoundToFinish(client, 'dora1contract...');
```

## é”™è¯¯å¤„ç†

```typescript
async function safeQuery<T>(
  queryFn: () => Promise<T>
): Promise<T | null> {
  try {
    return await queryFn();
  } catch (error) {
    console.error('æŸ¥è¯¢å¤±è´¥:', error);
    return null;
  }
}

// ä½¿ç”¨
const round = await safeQuery(() => 
  client.getRoundInfo({ contractAddress: 'dora1contract...' })
);

if (round) {
  console.log('Round:', round.title);
} else {
  console.log('Round ä¸å­˜åœ¨æˆ–æŸ¥è¯¢å¤±è´¥');
}
```

## ç¼“å­˜æŸ¥è¯¢

å¯¹äºé¢‘ç¹æŸ¥è¯¢çš„æ•°æ®ï¼Œå¯ä»¥å®ç°ç®€å•çš„ç¼“å­˜ï¼š

```typescript
class CachedMaciClient {
  private cache = new Map<string, { data: any; expiry: number }>();
  private cacheDuration = 60000;  // 1 åˆ†é’Ÿ
  
  constructor(private client: MaciClient) {}
  
  async getRoundById(contractAddress: string) {
    const key = `round:${contractAddress}`;
    const cached = this.cache.get(key);
    
    if (cached && cached.expiry > Date.now()) {
      console.log('ä½¿ç”¨ç¼“å­˜æ•°æ®');
      return cached.data;
    }
    
    console.log('ä»é“¾ä¸ŠæŸ¥è¯¢');
    const data = await this.client.getRoundInfo({ contractAddress });
    
    this.cache.set(key, {
      data,
      expiry: Date.now() + this.cacheDuration
    });
    
    return data;
  }
}

// ä½¿ç”¨
const cachedClient = new CachedMaciClient(client);
const round1 = await cachedClient.getRoundById('dora1...');  // é“¾ä¸ŠæŸ¥è¯¢
const round2 = await cachedClient.getRoundById('dora1...');  // ä½¿ç”¨ç¼“å­˜
```

## ä¸‹ä¸€æ­¥

äº†è§£æŸ¥è¯¢ API åï¼Œæ‚¨å¯ä»¥ï¼š

- ğŸš€ [æ¢ç´¢é«˜çº§åŠŸèƒ½](/docs/sdk/advanced) - äº†è§£æ›´å¤š SDK åŠŸèƒ½
- ğŸ’¡ [æŸ¥çœ‹ç¤ºä¾‹](/docs/examples/basic-voting) - å®Œæ•´çš„åº”ç”¨ç¤ºä¾‹
- ğŸ“– [å›åˆ°æ¦‚è§ˆ](/docs/sdk/installation) - SDK æ–‡æ¡£é¦–é¡µ
