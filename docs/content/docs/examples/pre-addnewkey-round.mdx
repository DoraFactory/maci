# Pre-add-new-key åŒ¿åæŠ•ç¥¨ç¤ºä¾‹

æœ¬ç¤ºä¾‹å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Pre-add-new-key æ¨¡å¼åˆ›å»ºå®Œå…¨åŒ¿åçš„æŠ•ç¥¨è½®æ¬¡ï¼ŒåŒ…æ‹¬å¹³å°é¢„ç”Ÿæˆã€å¯†é’¥åˆ†å‘å’Œç”¨æˆ·åŒ¿åæŠ•ç¥¨çš„å®Œæ•´æµç¨‹ã€‚

## å®Œæ•´ä»£ç 

### å¹³å°ç«¯ï¼šé¢„ç”Ÿæˆå’Œåˆ›å»º Round

```typescript
import { MaciClient, MaciCircuitType } from '@dorafactory/maci-sdk';
import { DirectSecp256k1Wallet } from '@cosmjs/proto-signing';
import { genKeypair } from 'maci-crypto';
import { buildPreDeactivateTree } from '@dorafactory/maci-sdk';
import fs from 'fs';

async function platformPrepareRound() {
  console.log('=== å¹³å°ç«¯ï¼šé¢„ç”Ÿæˆå¯†é’¥å¯¹å’Œåˆ›å»º Round ===\n');
  
  const client = new MaciClient({ network: 'testnet' });
  
  // åˆ›å»ºå¹³å°é’±åŒ…
  const platformWallet = await DirectSecp256k1Wallet.fromKey(
    Buffer.from(process.env.PLATFORM_PRIVATE_KEY!, 'hex'),
    'dora'
  );
  
  // === æ­¥éª¤ 1: ç”Ÿæˆå¯†é’¥å¯¹ ===
  console.log('æ­¥éª¤ 1: ä¸ºç”¨æˆ·ç”Ÿæˆå¯†é’¥å¯¹...');
  
  const userCount = 100;  // ä¸º100ä¸ªç”¨æˆ·é¢„ç”Ÿæˆ
  const userPreKeys = [];
  
  for (let i = 0; i < userCount; i++) {
    const keypair = genKeypair();
    userPreKeys.push({
      id: `user_${i}`,
      privateKey: keypair.privateKey.toString(16),
      publicKey: {
        x: keypair.publicKey[0].toString(16),
        y: keypair.publicKey[1].toString(16)
      }
    });
  }
  
  console.log(`âœ… å·²ç”Ÿæˆ ${userCount} ä¸ªå¯†é’¥å¯¹\n`);
  
  // === æ­¥éª¤ 2: ç”Ÿæˆ pre-deactivate tree ===
  console.log('æ­¥éª¤ 2: ç”Ÿæˆ pre-deactivate tree...');
  
  const platformCoordKeypair = genKeypair();
  const preDeactivateTree = buildPreDeactivateTree(
    userPreKeys,
    platformCoordKeypair
  );
  
  console.log('âœ… Pre-deactivate tree ç”ŸæˆæˆåŠŸ');
  console.log('Root:', preDeactivateTree.root);
  console.log('');
  
  // === æ­¥éª¤ 3: æŸ¥è¯¢å¹¶é€‰æ‹© Operator ===
  console.log('æ­¥éª¤ 3: æŸ¥è¯¢ Operator...');
  
  const operators = await client.indexer.getOperators();
  const activeOperators = operators.filter(op => op.status === 'Active');
  const selectedOperator = activeOperators[0];
  
  console.log('âœ… é€‰æ‹© Operator:', selectedOperator.identity);
  console.log('');
  
  // === æ­¥éª¤ 4: åˆ›å»º Round ===
  console.log('æ­¥éª¤ 4: åˆ›å»ºåŒ¿åæŠ•ç¥¨ Round...');
  
  const round = await client.createAMaciRound({
    signer: platformWallet,
    operator: selectedOperator.address,
    
    startVoting: new Date(),
    endVoting: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000),  // 14å¤©
    
    title: 'åŒ¿åç¤¾åŒºæŠ•ç¥¨ç¤ºä¾‹',
    description: 'ä½¿ç”¨ Pre-add-new-key çš„å®Œå…¨åŒ¿åæŠ•ç¥¨',
    link: 'https://forum.example.com/anonymous-vote',
    
    voteOptionMap: [
      'æ–¹æ¡ˆ A: æŠ€æœ¯å‡çº§',
      'æ–¹æ¡ˆ B: ç¤¾åŒºå‘å±•',
      'æ–¹æ¡ˆ C: å¸‚åœºæ¨å¹¿',
      'æ–¹æ¡ˆ D: æ•™è‚²åŸ¹è®­'
    ],
    
    circuitType: MaciCircuitType.QV,
    
    maxVoter: 100,
    voiceCreditAmount: '100',
    
    // Pre-add-new-key é…ç½®
    preDeactivateRoot: preDeactivateTree.root,
    preDeactivateCoordinator: [
      platformCoordKeypair.publicKey[0],
      platformCoordKeypair.publicKey[1]
    ]
  });
  
  console.log('âœ… Round åˆ›å»ºæˆåŠŸï¼');
  console.log('åˆçº¦åœ°å€:', round.contractAddress);
  console.log('');
  
  // === æ­¥éª¤ 5: ä¿å­˜æ•°æ® ===
  console.log('æ­¥éª¤ 5: ä¿å­˜æ•°æ®...');
  
  const dataToSave = {
    contractAddress: round.contractAddress,
    preDeactivateData: {
      root: preDeactivateTree.root,
      leaves: preDeactivateTree.leaves,
      coordinatorPubkey: {
        x: platformCoordKeypair.publicKey[0].toString(16),
        y: platformCoordKeypair.publicKey[1].toString(16)
      }
    },
    userKeys: userPreKeys
  };
  
  fs.writeFileSync('round_data.json', JSON.stringify(dataToSave, null, 2));
  
  console.log('âœ… æ•°æ®å·²ä¿å­˜åˆ° round_data.json');
  console.log('');
  console.log('ä¸‹ä¸€æ­¥ï¼šå°†å¯†é’¥å¯¹åˆ†å‘ç»™ç”¨æˆ·');
  
  return dataToSave;
}

// è¿è¡Œ
platformPrepareRound().catch(console.error);
```

### ç”¨æˆ·ç«¯ï¼šåŒ¿åæ³¨å†Œå’ŒæŠ•ç¥¨

```typescript
import { MaciClient, VoterClient } from '@dorafactory/maci-sdk';
import { DirectSecp256k1Wallet } from '@cosmjs/proto-signing';
import { genKeypair } from 'maci-crypto';
import fs from 'fs';

async function userAnonymousVote(
  userIndex: number,  // ç”¨æˆ·ç¼–å·
  anyWalletPrivateKey: string  // ç”¨æˆ·å¯ä»¥ç”¨ä»»æ„é’±åŒ…
) {
  console.log(`\n=== ç”¨æˆ· ${userIndex}: åŒ¿åæŠ•ç¥¨ ===\n`);
  
  const client = new MaciClient({ network: 'testnet' });
  
  // === æ­¥éª¤ 1: åŠ è½½å¹³å°åˆ†å‘çš„æ•°æ® ===
  console.log('æ­¥éª¤ 1: åŠ è½½å¹³å°åˆ†å‘çš„æ•°æ®...');
  
  const roundData = JSON.parse(fs.readFileSync('round_data.json', 'utf-8'));
  const contractAddress = roundData.contractAddress;
  const preDeactivateData = roundData.preDeactivateData;
  
  // è·å–è¯¥ç”¨æˆ·çš„å¯†é’¥å¯¹
  const myPreKey = roundData.userKeys[userIndex];
  console.log(`âœ… å·²åŠ è½½ç”¨æˆ· ${myPreKey.id} çš„æ•°æ®`);
  console.log('');
  
  // === æ­¥éª¤ 2: æœ¬åœ°ç”Ÿæˆè¯æ˜å’Œæ–°å¯†é’¥ ===
  console.log('æ­¥éª¤ 2: æœ¬åœ°ç”Ÿæˆ ZK è¯æ˜å’Œæ–°å¯†é’¥...');
  
  const voterClient = new VoterClient({
    network: 'testnet',
    secretKey: myPreKey.privateKey  // å¹³å°åˆ†å‘çš„ç§é’¥
  });
  
  // â­ ç”¨æˆ·ç”Ÿæˆè‡ªå·±çš„æ–°å¯†é’¥å¯¹ï¼ˆå®Œå…¨ç”±ç”¨æˆ·æ§åˆ¶ï¼‰
  const myNewKeypair = genKeypair();
  console.log('âœ… æ–°å¯†é’¥å·²åœ¨æœ¬åœ°ç”Ÿæˆï¼Œåªæœ‰æˆ‘çŸ¥é“');
  
  // ç”Ÿæˆ pre-add-new-key payload
  const payload = await voterClient.buildPreAddNewKeyPayload({
    stateTreeDepth: 10,
    coordinatorPubkey: preDeactivateData.coordinatorPubkey,
    deactivates: preDeactivateData.leaves,
    wasmFile: './circuits/addNewKey.wasm',
    zkeyFile: './circuits/addNewKey.zkey'
  });
  
  console.log('âœ… ZK è¯æ˜ç”Ÿæˆå®Œæˆ');
  console.log('');
  
  // === æ­¥éª¤ 3: ç”¨ä»»æ„åœ°å€å‘é€ Pre-add-new-key ===
  console.log('æ­¥éª¤ 3: åŒ¿åæ³¨å†Œï¼ˆç”¨ä»»æ„åœ°å€ï¼‰...');
  
  // â­ ç”¨æˆ·å¯ä»¥ç”¨ä»»æ„é’±åŒ…
  const anyWallet = await DirectSecp256k1Wallet.fromKey(
    Buffer.from(anyWalletPrivateKey, 'hex'),
    'dora'
  );
  const [anyAccount] = await anyWallet.getAccounts();
  
  console.log('ä½¿ç”¨åœ°å€:', anyAccount.address);
  
  await client.rawPreAddNewKey({
    signer: anyWallet,
    contractAddress,
    d: payload.d,
    proof: payload.proof,
    nullifier: payload.nullifier,
    newPubkey: {
      x: myNewKeypair.publicKey[0].toString(16),
      y: myNewKeypair.publicKey[1].toString(16)
    },
    gasStation: true
  });
  
  console.log('âœ… åŒ¿åæ³¨å†ŒæˆåŠŸ');
  console.log('âœ… Operator ä¸çŸ¥é“å…·ä½“æ˜¯è°');
  console.log('');
  
  // === æ­¥éª¤ 4: æŠ•ç¥¨ ===
  console.log('æ­¥éª¤ 4: æŠ•ç¥¨...');
  
  const roundInfo = await client.getRoundInfo({ contractAddress });
  
  // éšæœºé€‰æ‹©æŠ•ç¥¨é€‰é¡¹ï¼ˆæ¨¡æ‹Ÿç”¨æˆ·åå¥½ï¼‰
  const voteOptions = [
    { idx: userIndex % 4, vc: 7 },
    { idx: (userIndex + 1) % 4, vc: 5 }
  ];
  
  await client.vote({
    signer: anyWallet,
    address: anyAccount.address,
    contractAddress,
    selectedOptions: voteOptions,
    operatorCoordPubKey: [
      BigInt(roundInfo.coordinatorPubkeyX),
      BigInt(roundInfo.coordinatorPubkeyY)
    ],
    maciKeypair: myNewKeypair,  // åªæœ‰ç”¨æˆ·çŸ¥é“
    gasStation: true
  });
  
  console.log('âœ… æŠ•ç¥¨å®Œæˆï¼Œå®Œå…¨åŒ¿å');
  console.log('æŠ•ç¥¨è¯¦æƒ…:');
  voteOptions.forEach(opt => {
    const cost = opt.vc * opt.vc;
    console.log(`  - é€‰é¡¹ ${opt.idx}: ${opt.vc} ç¥¨ (æ¶ˆè€— ${cost} credits)`);
  });
}

// === æ¨¡æ‹Ÿå¤šä¸ªç”¨æˆ·æŠ•ç¥¨ ===
async function multipleUsersVote() {
  // ç”¨æˆ· 0 ç”¨é’±åŒ… A æŠ•ç¥¨
  await userAnonymousVote(0, process.env.WALLET_A_KEY!);
  
  // ç”¨æˆ· 1 ç”¨é’±åŒ… B æŠ•ç¥¨
  await userAnonymousVote(1, process.env.WALLET_B_KEY!);
  
  // ç”¨æˆ· 2 ç”¨é’±åŒ… C æŠ•ç¥¨
  await userAnonymousVote(2, process.env.WALLET_C_KEY!);
  
  console.log('\nâœ… æ‰€æœ‰ç”¨æˆ·æŠ•ç¥¨å®Œæˆï¼');
}

// è¿è¡Œ
multipleUsersVote().catch(console.error);
```

---

## ä»£ç è¯´æ˜

### å¹³å°ç«¯èŒè´£

1. **é¢„ç”Ÿæˆå¯†é’¥å¯¹**
   - ä¸ºå¤§é‡ç”¨æˆ·æ‰¹é‡ç”Ÿæˆ EdDSA-Poseidon å¯†é’¥å¯¹
   - ä¿å­˜å¯†é’¥å¯¹æ•°æ®

2. **ç”Ÿæˆ pre-deactivate tree**
   - ä½¿ç”¨é¢„ç”Ÿæˆçš„å¯†é’¥å¯¹æ„å»º deactivate tree
   - ç”Ÿæˆ root å’Œ coordinator å…¬é’¥

3. **æŸ¥è¯¢å¹¶é€‰æ‹© Operator**
   - ä» Registry æŸ¥è¯¢æ´»è·ƒçš„ Operator åˆ—è¡¨
   - é€‰æ‹©è¯„åˆ†é«˜ã€ä¿¡èª‰å¥½çš„ Operator

4. **åˆ›å»º Round**
   - ä½¿ç”¨ `createAMaciRound` API
   - é…ç½® `operator` åœ°å€
   - é…ç½® `preDeactivateRoot` å’Œ `preDeactivateCoordinator`
   - Round åˆ›å»ºåç«‹å³å¯ç”¨

5. **åˆ†å‘å¯†é’¥**
   - é€šè¿‡å®‰å…¨æ¸ é“å°†å¯†é’¥å¯¹åˆ†å‘ç»™ç”¨æˆ·
   - å¯ä»¥é€šè¿‡ APIã€åŠ å¯†é‚®ä»¶ç­‰æ–¹å¼

### ç”¨æˆ·ç«¯æµç¨‹

1. **æ¥æ”¶å¯†é’¥**
   - ä»å¹³å°è·å–é¢„ç”Ÿæˆçš„å¯†é’¥å¯¹
   - è·å– pre-deactivate æ•°æ®

2. **æœ¬åœ°ç”Ÿæˆè¯æ˜**
   - ä½¿ç”¨å¹³å°åˆ†å‘çš„ç§é’¥
   - ç”Ÿæˆè‡ªå·±çš„æ–°å¯†é’¥å¯¹ï¼ˆå®Œå…¨ç”±ç”¨æˆ·æ§åˆ¶ï¼‰
   - ç”Ÿæˆ ZK è¯æ˜

3. **åŒ¿åæ³¨å†Œ**
   - å¯ä»¥ç”¨ä»»æ„ dora åœ°å€å‘é€äº¤æ˜“
   - Operator æ— æ³•ç¡®å®šå…·ä½“æ˜¯è°

4. **æŠ•ç¥¨**
   - ä½¿ç”¨è‡ªå·±çš„æ–°å¯†é’¥å¯¹æŠ•ç¥¨
   - ä¿æŒå®Œå…¨åŒ¿å

---

## ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# å¹³å°ç«¯
PLATFORM_PRIVATE_KEY=your_platform_private_key

# ç”¨æˆ·ç«¯ï¼ˆå¯ä»¥æ˜¯ä»»æ„é’±åŒ…ï¼‰
WALLET_A_KEY=user_wallet_a_key
WALLET_B_KEY=user_wallet_b_key
WALLET_C_KEY=user_wallet_c_key
```

æ³¨æ„ï¼šä¸å†éœ€è¦ `OPERATOR_PUBKEY`ï¼Œè€Œæ˜¯é€šè¿‡ SDK æŸ¥è¯¢ Operator åˆ—è¡¨å¹¶é€‰æ‹©ã€‚

---

## é¢„æœŸè¾“å‡º

### å¹³å°ç«¯è¾“å‡º

```
=== å¹³å°ç«¯ï¼šé¢„ç”Ÿæˆå¯†é’¥å¯¹å’Œåˆ›å»º Round ===

æ­¥éª¤ 1: ä¸ºç”¨æˆ·ç”Ÿæˆå¯†é’¥å¯¹...
âœ… å·²ç”Ÿæˆ 100 ä¸ªå¯†é’¥å¯¹

æ­¥éª¤ 2: ç”Ÿæˆ pre-deactivate tree...
âœ… Pre-deactivate tree ç”ŸæˆæˆåŠŸ
Root: 0x1234567890abcdef...

æ­¥éª¤ 3: æŸ¥è¯¢ Operator...
âœ… é€‰æ‹© Operator: Dora Foundation

æ­¥éª¤ 4: åˆ›å»ºåŒ¿åæŠ•ç¥¨ Round...
âœ… Round åˆ›å»ºæˆåŠŸï¼
åˆçº¦åœ°å€: dora1contract...

æ­¥éª¤ 5: ä¿å­˜æ•°æ®...
âœ… æ•°æ®å·²ä¿å­˜åˆ° round_data.json

ä¸‹ä¸€æ­¥ï¼šå°†å¯†é’¥å¯¹åˆ†å‘ç»™ç”¨æˆ·
```

### ç”¨æˆ·ç«¯è¾“å‡º

```
=== ç”¨æˆ· 0: åŒ¿åæŠ•ç¥¨ ===

æ­¥éª¤ 1: åŠ è½½å¹³å°åˆ†å‘çš„æ•°æ®...
âœ… å·²åŠ è½½ç”¨æˆ· user_0 çš„æ•°æ®

æ­¥éª¤ 2: æœ¬åœ°ç”Ÿæˆ ZK è¯æ˜å’Œæ–°å¯†é’¥...
âœ… æ–°å¯†é’¥å·²åœ¨æœ¬åœ°ç”Ÿæˆï¼Œåªæœ‰æˆ‘çŸ¥é“
âœ… ZK è¯æ˜ç”Ÿæˆå®Œæˆ

æ­¥éª¤ 3: åŒ¿åæ³¨å†Œï¼ˆç”¨ä»»æ„åœ°å€ï¼‰...
ä½¿ç”¨åœ°å€: dora1abc...
âœ… åŒ¿åæ³¨å†ŒæˆåŠŸ
âœ… Operator ä¸çŸ¥é“å…·ä½“æ˜¯è°

æ­¥éª¤ 4: æŠ•ç¥¨...
âœ… æŠ•ç¥¨å®Œæˆï¼Œå®Œå…¨åŒ¿å
æŠ•ç¥¨è¯¦æƒ…:
  - é€‰é¡¹ 0: 7 ç¥¨ (æ¶ˆè€— 49 credits)
  - é€‰é¡¹ 1: 5 ç¥¨ (æ¶ˆè€— 25 credits)

=== ç”¨æˆ· 1: åŒ¿åæŠ•ç¥¨ ===
...

âœ… æ‰€æœ‰ç”¨æˆ·æŠ•ç¥¨å®Œæˆï¼
```

---

## éšç§åˆ†æ

### å¹³å°çŸ¥é“ä»€ä¹ˆ

âœ… é¢„ç”Ÿæˆçš„å¯†é’¥å¯¹ï¼ˆå·²åˆ†å‘ï¼‰  
âœ… Pre-deactivate tree  
âŒ ç”¨æˆ·çš„æ–°å¯†é’¥å¯¹ï¼ˆç”¨æˆ·æœ¬åœ°ç”Ÿæˆï¼‰  
âŒ ç”¨æˆ·ç”¨å“ªä¸ªåœ°å€å‘é€äº¤æ˜“  
âŒ ç”¨æˆ·çš„æŠ•ç¥¨å†…å®¹

### Operator çŸ¥é“ä»€ä¹ˆ

âœ… æœ‰äººç”¨ pre-add-new-key æ³¨å†Œäº†  
âœ… æ˜¯ pre-deactivate tree ä¸­çš„æŸä¸€ä¸ª  
âŒ å…·ä½“æ˜¯ç¬¬å‡ ä¸ªç”¨æˆ·  
âŒ å‘é€äº¤æ˜“çš„åœ°å€æ˜¯è°  
âŒ ç”¨æˆ·çš„çœŸå®èº«ä»½

### ç”¨æˆ·æ§åˆ¶ä»€ä¹ˆ

âœ… æ–°å¯†é’¥å¯¹å®Œå…¨ç”±ç”¨æˆ·æœ¬åœ°ç”Ÿæˆ  
âœ… å¯ä»¥ç”¨ä»»æ„åœ°å€å‘é€äº¤æ˜“  
âœ… Operator å’Œå¹³å°éƒ½æ— æ³•ç¡®å®šèº«ä»½  
âœ… åŒ¿åé›†å¤§å° = pre-deactivate tree ç”¨æˆ·æ•°

---

## å®‰å…¨æœ€ä½³å®è·µ

### å¹³å°ç«¯

1. **å¯†é’¥å­˜å‚¨**
   - åŠ å¯†å­˜å‚¨é¢„ç”Ÿæˆçš„å¯†é’¥å¯¹
   - åˆ†å‘åå¯ä»¥é€‰æ‹©åˆ é™¤ï¼ˆè¿›ä¸€æ­¥å¢å¼ºéšç§ï¼‰

2. **åˆ†å‘æ¸ é“**
   - ä½¿ç”¨åŠ å¯†é€šé“åˆ†å‘å¯†é’¥
   - API è¿”å›æ—¶ä½¿ç”¨ HTTPS
   - å¯ä»¥ä½¿ç”¨ç”¨æˆ·çš„å…¬é’¥åŠ å¯†

3. **æ‰¹é‡ç”Ÿæˆ**
   - é¢„ç”Ÿæˆè¶³å¤Ÿå¤šçš„å¯†é’¥å¯¹
   - è€ƒè™‘é¢„ç•™ä½™é‡

### ç”¨æˆ·ç«¯

1. **æœ¬åœ°æ“ä½œ**
   - è¯æ˜ç”Ÿæˆåœ¨æœ¬åœ°å®Œæˆ
   - æ–°å¯†é’¥å¯¹ä¸è¦æ³„éœ²ç»™ä»»ä½•äºº

2. **é’±åŒ…é€‰æ‹©**
   - å¯ä»¥ä½¿ç”¨æ–°é’±åŒ…å¢åŠ åŒ¿åæ€§
   - å¯ä»¥ä½¿ç”¨æ··å¸æœåŠ¡è¿›ä¸€æ­¥éšè—

3. **ç½‘ç»œå®‰å…¨**
   - ä½¿ç”¨ VPN å¢åŠ ç½‘ç»œå±‚åŒ¿å
   - é¿å…åœ¨ä¸å®‰å…¨çš„ç½‘ç»œç¯å¢ƒæ“ä½œ

---

## æ•°æ®ç»“æ„

### round_data.json

```json
{
  "contractAddress": "dora1contract...",
  "preDeactivateData": {
    "root": "0x1234567890abcdef...",
    "leaves": [
      {
        "leaf": "0xabcd...",
        "path": ["0x...", "0x...", ...]
      },
      ...
    ],
    "coordinatorPubkey": {
      "x": "0xabc...",
      "y": "0xdef..."
    }
  },
  "userKeys": [
    {
      "id": "user_0",
      "privateKey": "0x123...",
      "publicKey": {
        "x": "0xabc...",
        "y": "0xdef..."
      }
    },
    ...
  ]
}
```

---

## ä¸‹ä¸€æ­¥

- ğŸ“ [åŸºç¡€æŠ•ç¥¨ç¤ºä¾‹](/docs/examples/basic-voting) - ç™½åå•æ¨¡å¼ç¤ºä¾‹
- ğŸš€ [SDK æ–‡æ¡£](/docs/sdk/installation) - å­¦ä¹ æ›´å¤š SDK åŠŸèƒ½
- ğŸ“š [éšç§ä¿æŠ¤](/docs/protocol/privacy-protection) - æ·±å…¥ç†è§£ AMACI éšç§æœºåˆ¶
- ğŸ” [Operator è§†è§’](/docs/protocol/amaci-privacy) - ä» Operator è§†è§’ç†è§£åŒ¿åæ€§
