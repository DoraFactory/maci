# æŠ•ç¥¨æ“ä½œæŒ‡å—

å®Œæ•´çš„æŠ•ç¥¨æµç¨‹åŒ…æ‹¬ 5 ä¸ªæ­¥éª¤ï¼šç”Ÿæˆè´¦æˆ·ã€è·å–è¯ä¹¦ã€ç­‰å¾… Gas Stationã€ç­¾åˆ°å’ŒæŠ•ç¥¨ã€‚

## å®Œæ•´æŠ•ç¥¨æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant SDK as MACI SDK
    participant Oracle as Oracle æœåŠ¡
    participant Contract as AMACI åˆçº¦
    User->>SDK: 1. ç”Ÿæˆ MACI è´¦æˆ·
    SDK-->>User: è¿”å›å¯†é’¥å¯¹
    User->>Oracle: 2. è¯·æ±‚è¯ä¹¦
    Oracle-->>User: è¿”å› (amount, signature)
    User->>Contract: 3. æ£€æŸ¥ Gas Station
    Contract-->>User: çŠ¶æ€
    User->>Contract: 4. ç­¾åˆ°
    Contract-->>User: æˆåŠŸ
    User->>Contract: 5. æŠ•ç¥¨
    Contract-->>User: æˆåŠŸ
```

## æ­¥éª¤ 1: ç”Ÿæˆ MACI è´¦æˆ·

```typescript
import { MaciClient } from '@dorafactory/maci-sdk';

const client = new MaciClient({ network: 'testnet' });

// ä»é’±åŒ…ç”Ÿæˆ MACI å¯†é’¥å¯¹
const maciAccount = await client.circom.genKeypairFromSign(
  wallet,
  address
);

console.log('MACI è´¦æˆ·ç”ŸæˆæˆåŠŸ');
// maciAccount åŒ…å« privateKey å’Œ publicKey
```

## æ­¥éª¤ 2: è·å– Oracle è¯ä¹¦

ä»… Oracle ç™½åå•æ¨¡å¼éœ€è¦æ­¤æ­¥éª¤ï¼š

```typescript
const certificate = await client.maci.requestOracleCertificate({
  signer: wallet,
  ecosystem: 'cosmoshub',  // æˆ– 'doravota'
  address: userAddress,
  contractAddress: amaciContractAddress
});

console.log('è¯ä¹¦è·å–æˆåŠŸ');
console.log('æŠ•ç¥¨æƒé‡:', certificate.amount);
console.log('ç­¾å:', certificate.signature);
```

## æ­¥éª¤ 3: ç­‰å¾… Gas Station

æ£€æŸ¥å¹¶ç­‰å¾… Gas Station å¯ç”¨ï¼š

```typescript
async function waitForGasStation(
  client: MaciClient,
  address: string,
  contractAddress: string
): Promise<boolean> {
  let hasFeegrant = false;
  let attempts = 0;
  const maxAttempts = 30;  // æœ€å¤šç­‰å¾… 1 åˆ†é’Ÿ

  while (!hasFeegrant && attempts < maxAttempts) {
    hasFeegrant = await client.maci.hasFeegrant({
      address,
      contractAddress
    });

    if (!hasFeegrant) {
      console.log(`ç­‰å¾… Gas Station (${attempts + 1}/${maxAttempts})...`);
      await new Promise(resolve => setTimeout(resolve, 2000));
      attempts++;
    }
  }

  return hasFeegrant;
}

// ä½¿ç”¨
const hasGasStation = await waitForGasStation(client, address, contractAddress);

if (hasGasStation) {
  console.log('âœ… Gas Station å·²å¯ç”¨');
} else {
  console.log('âš ï¸  Gas Station æœªå¯ç”¨ï¼Œå°†ä½¿ç”¨è‡ªå·±çš„ Gas');
}
```

## æ­¥éª¤ 4: ç­¾åˆ°

```typescript
await client.maci.signup({
  signer: wallet,
  address: userAddress,
  contractAddress: amaciContractAddress,
  maciAccount: maciAccount,
  oracleCertificate: {
    amount: certificate.amount,
    signature: certificate.signature
  },
  gasStation: hasGasStation  // æ˜¯å¦ä½¿ç”¨ Gas Station
});

console.log('âœ… ç­¾åˆ°æˆåŠŸ');
```

## æ­¥éª¤ 5: æŠ•ç¥¨

### è·å– Coordinator å…¬é’¥

```typescript
const roundInfo = await client.getRoundById(contractAddress);

const coordinatorPubKey = [
  BigInt(roundInfo.coordinatorPubkeyX),
  BigInt(roundInfo.coordinatorPubkeyY)
];
```

### æäº¤æŠ•ç¥¨

```typescript
await client.maci.vote({
  signer: wallet,
  address: userAddress,
  contractAddress: amaciContractAddress,
  selectedOptions: [
    { idx: 0, vc: 5 },  // ç»™é€‰é¡¹ 0 æŠ• 5 ç¥¨
    { idx: 1, vc: 3 },  // ç»™é€‰é¡¹ 1 æŠ• 3 ç¥¨
    { idx: 2, vc: 2 },  // ç»™é€‰é¡¹ 2 æŠ• 2 ç¥¨
  ],
  operatorCoordPubKey: coordinatorPubKey,
  maciAccount: maciAccount,
  gasStation: hasGasStation
});

console.log('âœ… æŠ•ç¥¨æˆåŠŸ');
```

## æŠ•ç¥¨è§„åˆ™

### 1P1V æ¨¡å¼

voice credit ç›´æ¥ä½œä¸ºç¥¨æ•°ï¼š

```typescript
// å‡è®¾ç”¨æˆ·æœ‰ 100 voice credits
selectedOptions: [
  { idx: 0, vc: 50 },  // 50 ç¥¨
  { idx: 1, vc: 30 },  // 30 ç¥¨
  { idx: 2, vc: 20 },  // 20 ç¥¨
]
// æ€»æ¶ˆè€— = 50 + 30 + 20 = 100 voice credits
```

### QV æ¨¡å¼

voice credit çš„å¹³æ–¹ä½œä¸ºæ¶ˆè€—ï¼š

```typescript
// å‡è®¾ç”¨æˆ·æœ‰ 100 voice credits
selectedOptions: [
  { idx: 0, vc: 8 },  // 8 ç¥¨ï¼Œæ¶ˆè€— 64 credits (8Â²)
  { idx: 1, vc: 6 },  // 6 ç¥¨ï¼Œæ¶ˆè€— 36 credits (6Â²)
]
// æ€»æ¶ˆè€— = 64 + 36 = 100 voice credits
```

## é‡æ–°æŠ•ç¥¨

ç”¨æˆ·å¯ä»¥å¤šæ¬¡æŠ•ç¥¨ï¼Œåé¢çš„æŠ•ç¥¨ä¼šè¦†ç›–å‰é¢çš„ï¼š

```typescript
// ç¬¬ä¸€æ¬¡æŠ•ç¥¨
await client.maci.vote({
  selectedOptions: [{ idx: 0, vc: 5 }],
  // ... å…¶ä»–å‚æ•°
});

console.log('ç¬¬ä¸€æ¬¡æŠ•ç¥¨å®Œæˆ');

// æ”¹å˜ä¸»æ„ï¼Œé‡æ–°æŠ•ç¥¨
await client.maci.vote({
  selectedOptions: [{ idx: 1, vc: 5 }],  // æ”¹æŠ•é€‰é¡¹ 1
  // ... å…¶ä»–å‚æ•°
});

console.log('é‡æ–°æŠ•ç¥¨å®Œæˆ');
// æœ€ç»ˆåªæœ‰ç¬¬äºŒæ¬¡æŠ•ç¥¨ï¼ˆé€‰é¡¹ 1ï¼‰æœ‰æ•ˆ
```

## å®Œæ•´ç¤ºä¾‹å‡½æ•°

```typescript
async function completeVotingProcess(
  client: MaciClient,
  wallet: any,
  address: string,
  contractAddress: string,
  voteOptions: { idx: number; vc: number }[]
) {
  try {
    // æ­¥éª¤ 1: ç”Ÿæˆè´¦æˆ·
    console.log('1/5 ç”Ÿæˆ MACI è´¦æˆ·...');
    const maciAccount = await client.circom.genKeypairFromSign(wallet, address);
    
    // æ­¥éª¤ 2: è·å–è¯ä¹¦
    console.log('2/5 è·å– Oracle è¯ä¹¦...');
    const certificate = await client.maci.requestOracleCertificate({
      signer: wallet,
      ecosystem: 'cosmoshub',
      address,
      contractAddress
    });
    console.log(`   æŠ•ç¥¨æƒé‡: ${certificate.amount}`);
    
    // æ­¥éª¤ 3: ç­‰å¾… Gas Station
    console.log('3/5 ç­‰å¾… Gas Station...');
    const hasGasStation = await waitForGasStation(client, address, contractAddress);
    
    // æ­¥éª¤ 4: ç­¾åˆ°
    console.log('4/5 ç­¾åˆ°ä¸­...');
    await client.maci.signup({
      signer: wallet,
      address,
      contractAddress,
      maciAccount,
      oracleCertificate: certificate,
      gasStation: hasGasStation
    });
    
    // æ­¥éª¤ 5: æŠ•ç¥¨
    console.log('5/5 æŠ•ç¥¨ä¸­...');
    const roundInfo = await client.getRoundById(contractAddress);
    
    await client.maci.vote({
      signer: wallet,
      address,
      contractAddress,
      selectedOptions: voteOptions,
      operatorCoordPubKey: [
        BigInt(roundInfo.coordinatorPubkeyX),
        BigInt(roundInfo.coordinatorPubkeyY)
      ],
      maciAccount,
      gasStation: hasGasStation
    });
    
    console.log('âœ… æŠ•ç¥¨æµç¨‹å®Œæˆï¼');
    return true;
  } catch (error) {
    console.error('âŒ æŠ•ç¥¨å¤±è´¥:', error);
    return false;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
await completeVotingProcess(
  client,
  wallet,
  address,
  'dora1contractaddress...',
  [
    { idx: 0, vc: 8 },
    { idx: 2, vc: 6 }
  ]
);
```

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•è®¡ç®—æˆ‘èƒ½æŠ•å¤šå°‘ç¥¨ï¼Ÿ

**A:** å–å†³äºæŠ•ç¥¨æ¨¡å¼å’Œæ‚¨çš„ voice creditsï¼š

```typescript
// 1P1V æ¨¡å¼
const maxVotes = voiceCredits;  // 100 credits = 100 ç¥¨

// QV æ¨¡å¼  
const maxVotes = Math.floor(Math.sqrt(voiceCredits));  // 100 credits = 10 ç¥¨
```

### Q: æŠ•ç¥¨å¤±è´¥äº†æ€ä¹ˆåŠï¼Ÿ

**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. æ˜¯å¦åœ¨æŠ•ç¥¨æœŸå†…
2. æ˜¯å¦å·²å®Œæˆç­¾åˆ°
3. voice credits æ˜¯å¦è¶³å¤Ÿ
4. Gas Station æ˜¯å¦å·²å¯ç”¨ï¼ˆå¦‚æœä½¿ç”¨ï¼‰

### Q: å¯ä»¥åŒæ—¶æŠ•ç»™å¤šä¸ªé€‰é¡¹å—ï¼Ÿ

**A:** å¯ä»¥ï¼åœ¨ `selectedOptions` æ•°ç»„ä¸­æ·»åŠ å¤šä¸ªé€‰é¡¹ï¼š

```typescript
selectedOptions: [
  { idx: 0, vc: 5 },
  { idx: 1, vc: 3 },
  { idx: 2, vc: 2 }
]
```

### Q: å¦‚ä½•æ’¤é”€æŠ•ç¥¨ï¼Ÿ

**A:** é‡æ–°æŠ•ç¥¨å¹¶å°†æ‰€æœ‰æƒé‡è®¾ä¸º 0ï¼Œæˆ–æŠ•ç»™å…¶ä»–é€‰é¡¹ã€‚

## ä¸‹ä¸€æ­¥

å®ŒæˆæŠ•ç¥¨åï¼Œæ‚¨å¯ä»¥ï¼š

- ğŸ” [æŸ¥è¯¢ API](/sdk/query-api) - æŸ¥è¯¢æŠ•ç¥¨ä¿¡æ¯å’Œç»“æœ
- ğŸ’¡ [æŸ¥çœ‹ç¤ºä¾‹](/examples/basic-voting) - å®Œæ•´çš„æŠ•ç¥¨ç¤ºä¾‹
- ğŸš€ [äº†è§£é«˜çº§åŠŸèƒ½](/sdk/advanced) - æ¢ç´¢æ›´å¤šåŠŸèƒ½
