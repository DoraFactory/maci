# 隐私保护机制

AMACI 的隐私保护设计。本文从潜在攻击者的角度分析威胁，说明 AMACI 如何防御。

## 攻击者想做什么

### 攻击 1：查看投票内容

**目标：** 知道谁投了什么票。

**方法：** 观察区块链上的投票交易。

**MACI 的防御：** 投票消息用 operator 公钥加密。区块链观察者只能看到加密数据，无法解密。

```typescript
// 链上看到的只是加密数据
{
  encPubKey: [bigint, bigint],
  data: [bigint, bigint, bigint, ...],  // Poseidon 加密
  signature: {...}
}
```

只有 operator 能用私钥解密。但 operator 被零知识证明约束，必须正确处理所有投票，无法作弊。

**限制：** Operator 能看到投票内容。如果担心 operator 泄密，需要额外的身份匿名化（见攻击 3）。

### 攻击 2：贿选

**目标：** 贿赂投票者，要求他们投特定选项，并提供投票证明。

**传统投票的问题：** 投票记录公开，投票者可以提供交易哈希作为证明。贿赂者能验证投票。

**MACI 的防御：** 密钥更改机制。

场景：

```
1. Alice 接受 Bob 的贿赂，要求投给选项 A
2. Alice 用密钥 K1 投给 A，提供证明给 Bob
3. Alice 秘密更改密钥为 K2
4. Alice 用 K2 重新投给 B
5. 最终只有 B 有效
```

投票者的状态中存储当前公钥。更改密钥后，旧密钥签名的消息变为无效。Bob 无法验证 Alice 的最终投票。

**核心原理：** 投票者无法向第三方证明自己的最终投票，因为他随时可以更改。

### 攻击 3：Operator 追踪投票者身份

**目标：** Operator 想知道具体是哪个地址投了票，进行针对性贿赂或报复。

**MACI 的问题：** Operator 可以通过链上 signup 交易关联身份。

```
链上 signup 交易（公开）：
  sender: dora1abc...
  pubkey: 0x123...

合约查询：
  pubkey 0x123... → state index 5

解密投票：
  state index 5 → 投给选项 A

结论：dora1abc... 投给了选项 A
```

Operator 能确定具体是哪个地址投的，可以进行针对性攻击。

**AMACI 的防御：** Add-new-key 机制（身份匿名化）。

核心思想：用零知识证明创建新身份，断开与原地址的关联。

工作原理：

```
1. 老用户提交 deactivate 消息
   - 消息内容加密
   - 放入 deactivate tree

2. Operator 处理 deactivate
   - 构建 deactivate tree（假设有 N 个条目）
   - 发布 tree root

3. 新用户用 ZK 证明注册
   - 证明："我知道 deactivate tree 中某个条目的私钥"
   - 不透露具体是哪个
   - 用新钱包地址发送交易

4. Operator 看到 add-new-key 交易
   - 知道有人用 add-new-key 注册了
   - 但这个人是 N 个 deactivate 用户中的一个
   - 无法确定具体是谁
```

**匿名集大小：** 如果有 100 个用户 deactivate，add-new-key 用户的匿名集就是这 100 人。Operator 只能确定是这 100 人之一，但不知道具体是谁。

**Operator 视角：**

```
MACI:
  State Index 5 → dora1abc...（确定知道）

AMACI (add-new-key):
  State Index 5 → ??? （100 个可能性之一，无法确定）
```

即使 Operator 想贿赂或报复投票者，也找不到目标。

### 攻击 4：强制投票

**目标：** 强制某人投特定选项，例如雇主要求员工投某个提案。

**MACI 的防御：** 可重复投票 + 密钥更改。

```
1. 员工被强制投给 A（用密钥 K1）
2. 员工秘密更改密钥为 K2
3. 员工用 K2 重新投给 B
4. 最终只有 B 有效
```

强制者无法验证最终投票。如果使用 add-new-key，强制者甚至不知道去强制谁。

### 攻击 5：Operator 篡改投票

**目标：** Operator 解密消息后，试图修改投票内容或结果。

**MACI 的防御：** 零知识证明。

Operator 处理投票后，必须生成 ZK 证明，证明：
- 处理了所有消息（message tree root 匹配）
- 按正确顺序处理（nonce）
- 没有修改任何投票内容
- 正确更新了状态树
- 正确统计了结果

```rust
// Operator 提交
ProcessMessages {
  new_state_commitment: "0x...",
  new_state_root: "0x...",
  proof: [...]  // ZK 证明
}
```

合约验证证明。如果 operator 篡改任何投票，证明会验证失败。任何人都可以验证证明有效性。

**限制：** Operator 能看到投票内容，但无法改变内容或结果。

## 隐私保护层次

AMACI 提供三层递进的隐私保护：

### 第一层：投票内容加密

所有人（除 operator 外）看不到投票内容。

适用场景：信任 operator 不泄密的情况。

### 第二层：抗串谋机制

密钥更改 + 可重复投票，防止贿选和强制。

投票者无法向第三方证明最终投票，贿赂和强制变得无意义。

### 第三层：身份匿名化

Operator 也无法确定投票者身份（使用 add-new-key 时）。

即使 operator 想针对性攻击，也找不到目标。

## 三种注册方式的隐私级别

### Signup

防御攻击 1, 2, 4, 5。

Operator 知道你的身份（攻击 3 失效）。

适合：信任 operator 或不关心隐私的场景。

### Add-new-key

防御所有攻击 (1-5)。

Operator 无法确定你的身份。

适合：需要完全隐私的场景。

权衡：需要等待 operator 处理 deactivate（通常几小时）。

### Pre-add-new-key

防御所有攻击 (1-5)，且无需等待。

需要投票组织者预先配置 deactivate tree。

适合：需要即时匿名注册的场景。

## 信任假设

AMACI 的安全性基于以下假设：

**密码学假设：**
- EdDSA 签名不可伪造
- Poseidon 哈希抗碰撞
- ECDH 密钥交换安全
- ZK 证明系统健全

**操作假设：**
- Operator 正确生成密钥对
- Operator 保护私钥安全
- 投票者保护自己的 MACI 私钥

**协议假设：**
- Operator 会处理投票（活性假设）
- 智能合约正确实现协议逻辑
- 区块链不会回滚已确认的交易

**可以不信任的：**
- Operator 不会篡改投票（ZK 证明保证）
- Operator 不会忽略投票（ZK 证明保证）
- Operator 不知道身份（使用 add-new-key 时）

## 隐私 vs 便利性权衡

**Signup：** 最快，但 operator 知道身份
- 注册：立即
- 隐私：低

**Add-new-key：** 最匿名，但需要等待
- 注册：等待 deactivate 处理（~几小时）
- 隐私：高

**Pre-add-new-key：** 兼具匿名和速度
- 注册：立即
- 隐私：高
- 权衡：需要投票组织者预配置

选择哪种方式取决于你的隐私需求和时间预算。

## 实际建议

**公开投票（DAO 提案、社区决策）：** 使用 signup。速度最重要，身份公开无妨。

**敏感投票（利益相关的资金分配）：** 使用 add-new-key。完全匿名，防止针对性攻击。

**大规模公投（需要快速参与）：** 使用 pre-add-new-key。组织者预配置 deactivate tree，用户可以立即匿名注册。

**内部选举（雇主/雇员关系）：** 使用 add-new-key。防止强制投票和报复。

## 下一步

**了解技术细节** - 查看[密码学机制](/docs/protocol/cryptography)学习 EdDSA、Poseidon 等实现。

**理解注册方式** - 阅读[核心概念](/docs/protocol/core-concepts)深入了解三种注册方式的技术细节。

**消息流程** - 查看[消息流程](/docs/protocol/message-flow)理解投票消息的生命周期。
