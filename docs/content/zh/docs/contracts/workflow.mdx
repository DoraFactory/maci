# AMACI å®Œæ•´å·¥ä½œæµç¨‹

æœ¬èŠ‚é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ï¼Œå±•ç¤ºä»åˆ›å»ºæŠ•ç¥¨è½®æ¬¡åˆ°å‘å¸ƒç»“æœçš„æ•´ä¸ª AMACI æµç¨‹ï¼ŒåŒ…æ‹¬å¦‚ä½•ä½¿ç”¨ add-new-key å®ç°åŒ¿åæŠ•ç¥¨ã€‚

## æµç¨‹æ€»è§ˆ

```mermaid
timeline
    title AMACI å®Œæ•´å·¥ä½œæµç¨‹
    section å‡†å¤‡é˜¶æ®µ
        Operatoræ³¨å†Œ : è®¸å¯åˆ¶æ³¨å†Œ : ç”±DoraFactoryç®¡ç†
    section åˆ›å»ºé˜¶æ®µ
        ç”¨æˆ·åˆ›å»ºRound : é€‰æ‹©Operator : AMACIåˆçº¦å®ä¾‹åŒ–
    section æ³¨å†Œé˜¶æ®µ
        æ–¹å¼1Signup : å¿«é€Ÿæ³¨å†Œ : OperatorçŸ¥é“èº«ä»½
        æ–¹å¼2Add-new-key : åŒ¿åæ³¨å†Œ : Operatorä¸çŸ¥èº«ä»½
    section æŠ•ç¥¨é˜¶æ®µ
        æäº¤æŠ•ç¥¨ : åŠ å¯†æ¶ˆæ¯ : å­˜å‚¨åˆ°é“¾ä¸Š
    section å¤„ç†é˜¶æ®µ
        ProcessDeactivate : ç”ŸæˆåŒ¿åé›† : ä¸ºadd-new-keyå‡†å¤‡
        ProcessMessages : å¤„ç†æŠ•ç¥¨ : ç”Ÿæˆè¯æ˜
        ProcessTally : ç»Ÿè®¡ç»“æœ : å‘å¸ƒç»“æœ
```

## é˜¶æ®µ 1: å‡†å¤‡é˜¶æ®µ

### Operator ç½‘ç»œ

Operator ç½‘ç»œç”± Dora Factory å®˜æ–¹ç»´æŠ¤ï¼Œé‡‡ç”¨è®¸å¯åˆ¶ã€‚

**ç”¨æˆ·è§†è§’ï¼š**
- æ— éœ€å…³å¿ƒ Operator å¦‚ä½•æ³¨å†Œ
- ç›´æ¥ä»ç°æˆçš„åˆ—è¡¨ä¸­é€‰æ‹©
- æŸ¥çœ‹åœ°å€ï¼šhttps://vota.dorafactory.org/operators

**æŸ¥è¯¢å¯ç”¨ Operatorï¼š**

```typescript
import { MaciClient } from '@dorafactory/maci-sdk';

const client = new MaciClient({ network: 'mainnet' });

// è·å–æ‰€æœ‰ Operator
const operators = await client.indexer.getOperators('first', 50);

console.log(`å…±æœ‰ ${operators.length} ä¸ª Operator`);

// é€‰æ‹©ä¸€ä¸ªè¡¨ç°å¥½çš„ Operator
const bestOperator = operators
  .filter(op => op.isActive)
  .sort((a, b) => b.successRate - a.successRate)[0];

console.log('é€‰æ‹© Operator:', bestOperator.identity);
console.log('å…¬é’¥:', bestOperator.pubkey);
```

## é˜¶æ®µ 2: åˆ›å»ºæŠ•ç¥¨è½®æ¬¡

### 2.1 å‡†å¤‡å‚æ•°

```typescript
const roundParams = {
  // Operator å…¬é’¥ï¼ˆç”¨äºåŠ å¯†ï¼‰
  operatorPubkey: operatorKeypair.publicKey,
  
  // æŠ•ç¥¨æ—¶é—´
  startVoting: new Date('2024-02-01T00:00:00Z'),
  endVoting: new Date('2024-02-07T23:59:59Z'),
  
  // è½®æ¬¡ä¿¡æ¯
  title: 'ç¤¾åŒºèµ„é‡‘åˆ†é…æŠ•ç¥¨',
  description: 'æŠ•ç¥¨å†³å®šå¦‚ä½•åˆ†é… 100,000 DORA ç¤¾åŒºèµ„é‡‘',
  link: 'https://forum.example.com/proposal',
  
  // æŠ•ç¥¨é€‰é¡¹
  voteOptionMap: [
    'é¡¹ç›® A: DeFi å¼€å‘å·¥å…·',
    'é¡¹ç›® B: å¼€å‘è€…æ•™è‚²è®¡åˆ’',
    'é¡¹ç›® C: å¸‚åœºæ¨å¹¿æ´»åŠ¨',
    'é¡¹ç›® D: ç¤¾åŒºåŸºç¡€è®¾æ–½',
  ],
  
  // æŠ•ç¥¨ç±»å‹ï¼ˆäºŒæ¬¡æ–¹æŠ•ç¥¨ï¼‰
  circuitType: MaciCircuitType.QV,
  
  // ç™½åå•é…ç½®
  whitelistEcosystem: 'cosmoshub',
  whitelistSnapshotHeight: '23342001',
  whitelistVotingPowerArgs: {
    mode: 'slope',
    slope: '1000000',  // æ¯ 1 ATOM = 1 voice credit
    threshold: '0',
  },
};
```

### 2.2 åˆ›å»º Round

```typescript
import { MaciClient, MaciCircuitType } from '@dorafactory/maci-sdk';

const client = new MaciClient({ network: 'mainnet' });

const round = await client.createOracleMaciRound({
  signer: creatorWallet,
  operatorPubkey: bestOperator.pubkey,  // ä½¿ç”¨é€‰æ‹©çš„ Operator
  
  startVoting: new Date('2024-03-01T00:00:00Z'),
  endVoting: new Date('2024-03-07T23:59:59Z'),
  
  title: 'ç¤¾åŒºèµ„é‡‘åˆ†é…æŠ•ç¥¨',
  description: 'æŠ•ç¥¨å†³å®šå¦‚ä½•åˆ†é…ç¤¾åŒºèµ„é‡‘',
  link: 'https://forum.example.com/proposal',
  
  voteOptionMap: [
    'é¡¹ç›® A: DeFi å¼€å‘å·¥å…·',
    'é¡¹ç›® B: å¼€å‘è€…æ•™è‚²',
    'é¡¹ç›® C: å¸‚åœºæ¨å¹¿',
    'é¡¹ç›® D: ç¤¾åŒºåŸºç¡€è®¾æ–½'
  ],
  
  circuitType: MaciCircuitType.QV,
  
  whitelistEcosystem: 'cosmoshub',
  whitelistSnapshotHeight: '0',
  whitelistVotingPowerArgs: {
    mode: 'slope',
    slope: '1000000',
    threshold: '1000000'
  }
});

console.log('Round åˆ›å»ºæˆåŠŸï¼');
console.log('AMACI åˆçº¦åœ°å€:', round.contractAddress);
console.log('äº¤æ˜“å“ˆå¸Œ:', round.transactionHash);
console.log('Operator å°†è‡ªåŠ¨ç›‘æ§æ­¤ Round');
```

### 2.3 éªŒè¯åˆ›å»º

```typescript
// æŸ¥è¯¢ Round ä¿¡æ¯
const roundInfo = await client.getRoundInfo({ contractAddress: round.contractAddress });

console.log('Round ä¿¡æ¯:', {
  title: roundInfo.title,
  status: roundInfo.status,
  coordinatorPubkey: roundInfo.coordinatorPubkey,
  numSignups: roundInfo.numSignups
});
```

## é˜¶æ®µ 3: ç”¨æˆ·æ³¨å†Œå’ŒæŠ•ç¥¨

### 3.1 ç”¨æˆ· Aï¼šä½¿ç”¨ Signupï¼ˆå¿«é€Ÿæ¨¡å¼ï¼‰

```typescript
console.log('=== ç”¨æˆ· A: ä½¿ç”¨ Signupï¼ˆå¿«é€Ÿä½†OperatorçŸ¥é“èº«ä»½ï¼‰===\n');

// ç”Ÿæˆ MACI è´¦æˆ·
const userAKeypair = await client.genKeypairFromSign({
  signer: walletA,
  address: addressA
});

// ç­‰å¾… Gas Station
let hasFeegrant = false;
while (!hasFeegrant) {
  hasFeegrant = await client.hasFeegrant({
    address: addressA,
    contractAddress: round.contractAddress
  });
  if (!hasFeegrant) {
    await new Promise(resolve => setTimeout(resolve, 2000));
  }
}

// Signupï¼ˆä»…ç™½åå•åœ°å€å¯ç”¨ï¼‰
await client.signup({
  signer: walletA,
  address: addressA,
  contractAddress: round.contractAddress,
  maciKeypair: userAKeypair,
  gasStation: true
});

console.log('ç”¨æˆ· A ç­¾åˆ°æˆåŠŸ');
console.log('âš ï¸  æ³¨æ„ï¼šç”¨æˆ· A çš„åœ°å€å¿…é¡»åœ¨ç™½åå•ä¸­');

// æŠ•ç¥¨
const roundInfo = await client.getRoundInfo({ contractAddress: round.contractAddress });

await client.vote({
  signer: walletA,
  address: addressA,
  contractAddress: round.contractAddress,
  selectedOptions: [
    { idx: 0, vc: 8 },  // é¡¹ç›® A: 8 ç¥¨ï¼ˆæ¶ˆè€— 64 creditsï¼‰
    { idx: 2, vc: 6 }   // é¡¹ç›® C: 6 ç¥¨ï¼ˆæ¶ˆè€— 36 creditsï¼‰
  ],
  operatorCoordPubKey: [
    BigInt(roundInfo.coordinatorPubkeyX),
    BigInt(roundInfo.coordinatorPubkeyY)
  ],
  maciKeypair: userAKeypair,
  gasStation: true
});

console.log('ç”¨æˆ· A æŠ•ç¥¨æˆåŠŸ');
console.log('âš ï¸  æ³¨æ„ï¼šOperator å¯ä»¥é€šè¿‡é“¾ä¸Šäº¤æ˜“çŸ¥é“ç”¨æˆ· A çš„èº«ä»½');
```

### 3.2 ç”¨æˆ· Bï¼šä½¿ç”¨ Add-new-keyï¼ˆåŒ¿åæ¨¡å¼ï¼‰

```typescript
console.log('\n=== ç”¨æˆ· B: ä½¿ç”¨ Add-new-keyï¼ˆå®Œå…¨åŒ¿åï¼‰===\n');

// å‰æï¼šç”¨æˆ· B å·²ç»æœ‰ä¸€ä¸ªè€è´¦æˆ·å¹¶å·² deactivate
// æˆ–è€…ç­‰å¾…å…¶ä»–äºº deactivate

// ç­‰å¾… Operator å¤„ç† deactivate
console.log('ç­‰å¾… Operator å¤„ç† deactivate æ¶ˆæ¯...');
// ï¼ˆè¿™ä¸ªç”± Operator è‡ªåŠ¨å®Œæˆï¼‰

// è·å– deactivate æ•°æ®
const deactivates = await client.fetchAllDeactivateLogs(round.contractAddress);
console.log(`Deactivate æ•°æ®è·å–æˆåŠŸï¼ŒåŒ¿åé›†å¤§å°: ${deactivates.length}`);

// ç”Ÿæˆ add-new-key payload
import { VoterClient } from '@dorafactory/maci-sdk';

const voterClient = new VoterClient({
  network: 'mainnet',
  secretKey: oldUserPrivateKey  // è€ç”¨æˆ·çš„ç§é’¥
});

const addKeyPayload = await voterClient.buildAddNewKeyPayload({
  stateTreeDepth: 10,
  operatorPubkey: roundInfo.coordinatorPubkey,
  deactivates,
  wasmFile,  // éœ€è¦ addNewKey circuit
  zkeyFile
});

console.log('ZK è¯æ˜ç”ŸæˆæˆåŠŸ');

// ä½¿ç”¨æ–°é’±åŒ…æäº¤ add-new-key
const newKeypair = genKeypair();

await client.addNewKey({
  signer: newWalletB,  // å…¨æ–°çš„é’±åŒ…ï¼
  contractAddress: round.contractAddress,
  d: addKeyPayload.d,
  proof: addKeyPayload.proof,
  nullifier: addKeyPayload.nullifier,
  newMaciKeypair: newKeypair,
  fee: 'auto'
});

console.log('ç”¨æˆ· B åŒ¿åæ³¨å†ŒæˆåŠŸ');
console.log('Operator æ— æ³•ç¡®å®šç”¨æˆ· B çš„çœŸå®èº«ä»½');

// æŠ•ç¥¨
await client.vote({
  signer: newWalletB,
  address: newAddressB,
  contractAddress: round.contractAddress,
  selectedOptions: [
    { idx: 1, vc: 9 },  // é¡¹ç›® B: 9 ç¥¨
    { idx: 3, vc: 4 }   // é¡¹ç›® D: 4 ç¥¨
  ],
  operatorCoordPubKey: [
    BigInt(roundInfo.coordinatorPubkeyX),
    BigInt(roundInfo.coordinatorPubkeyY)
  ],
  maciKeypair: newKeypair,
  gasStation: true
});

console.log('ç”¨æˆ· B æŠ•ç¥¨æˆåŠŸï¼ˆå®Œå…¨åŒ¿åï¼‰');
```

### 3.3 æŠ•ç¥¨æœŸé—´çš„æŸ¥è¯¢

```typescript
// æŸ¥è¯¢å½“å‰çŠ¶æ€
const currentInfo = await client.getRoundInfo({ contractAddress: round.contractAddress });

console.log('Round å½“å‰çŠ¶æ€:');
console.log('- ç­¾åˆ°äººæ•°:', currentInfo.numSignups);
console.log('- çŠ¶æ€:', currentInfo.status);

// æŸ¥è¯¢æ¶ˆæ¯æ•°é‡
// ï¼ˆéœ€è¦ç›´æ¥æŸ¥è¯¢åˆçº¦æˆ–é€šè¿‡ indexerï¼‰
```

## é˜¶æ®µ 4: Operator è‡ªåŠ¨å¤„ç†ï¼ˆç”¨æˆ·æ— éœ€æ“ä½œï¼‰

æŠ•ç¥¨æœŸç»“æŸåï¼ŒOperator è‡ªåŠ¨å®Œæˆæ‰€æœ‰å¤„ç†å·¥ä½œã€‚

### 4.1 Process Deactivateï¼ˆå¦‚æœæœ‰ï¼‰

å¦‚æœæœ‰ç”¨æˆ·æäº¤äº† deactivate æ¶ˆæ¯ï¼ŒOperator é¦–å…ˆå¤„ç†ï¼š

```typescript
console.log('=== Operator è‡ªåŠ¨å¤„ç†æµç¨‹ ===\n');

// ä¸‹è½½ deactivate æ¶ˆæ¯
const deactivateMessages = await contract.query({
  get_deactivate_messages: {}
});

if (deactivateMessages.length > 0) {
  console.log(`å‘ç° ${deactivateMessages.length} æ¡ deactivate æ¶ˆæ¯`);
  
  // å¤„ç†å¹¶ç”Ÿæˆ deactivate tree
  // ï¼ˆOperator ä½¿ç”¨ä¸“ä¸šå·¥å…·è‡ªåŠ¨å®Œæˆï¼‰
  
  // æäº¤ ProcessDeactivate è¯æ˜
  console.log('ProcessDeactivate å®Œæˆ');
  console.log(`ç”ŸæˆåŒ¿åé›†ï¼Œå¤§å°: ${deactivateMessages.length}`);
}
```

### 4.2 Process Messages

```typescript
// Operator å¤„ç†æŠ•ç¥¨æ¶ˆæ¯
console.log('\nOperator: å¤„ç†æŠ•ç¥¨æ¶ˆæ¯...');

// 1. ä¸‹è½½æ‰€æœ‰æŠ•ç¥¨æ¶ˆæ¯
// 2. ä½¿ç”¨ Operator ç§é’¥è§£å¯†
// 3. éªŒè¯ç­¾åå’Œæœ‰æ•ˆæ€§
// 4. æŒ‰ nonce é¡ºåºå¤„ç†
// 5. æ›´æ–°çŠ¶æ€æ ‘
// 6. ç”Ÿæˆ ProcessMessages ZK è¯æ˜
// 7. æäº¤åˆ°é“¾ä¸ŠéªŒè¯

// ï¼ˆè¿™äº›éƒ½ç”± Operator è‡ªåŠ¨å®Œæˆï¼Œç”¨æˆ·æ— éœ€æ“ä½œï¼‰

console.log('ProcessMessages å®Œæˆ');
```

### 4.3 Process Tally

```typescript
// Operator ç»Ÿè®¡ç»“æœ
console.log('\nOperator: ç»Ÿè®¡æŠ•ç¥¨ç»“æœ...');

// 1. éå†æœ€ç»ˆçŠ¶æ€æ ‘
// 2. ç»Ÿè®¡æ¯ä¸ªé€‰é¡¹çš„ç¥¨æ•°
// 3. ç”Ÿæˆ ProcessTally ZK è¯æ˜
// 4. æäº¤åˆ°é“¾ä¸Š
// 5. å‘å¸ƒç»“æœ

console.log('ProcessTally å®Œæˆ');
console.log('æŠ•ç¥¨ç»“æœå·²å‘å¸ƒï¼');
```

### Operator å¤„ç†æ—¶é—´

**å…¸å‹å¤„ç†æ—¶é—´ï¼š**

```
æŠ•ç¥¨è§„æ¨¡        Process Deactivate   Process Messages   Process Tally   æ€»è®¡
100 äºº          5-10 åˆ†é’Ÿ            30-60 åˆ†é’Ÿ         10-20 åˆ†é’Ÿ      ~1.5å°æ—¶
500 äºº          10-20 åˆ†é’Ÿ           1-2 å°æ—¶           20-40 åˆ†é’Ÿ      ~3å°æ—¶
1000 äºº         20-30 åˆ†é’Ÿ           2-4 å°æ—¶           30-60 åˆ†é’Ÿ      ~5å°æ—¶
```

**ç”¨æˆ·ä½“éªŒï¼š**
- ç”¨æˆ·æ— éœ€ç­‰å¾…ï¼Œå¯ä»¥ç¦»å¼€
- Operator è‡ªåŠ¨åœ¨åå°å¤„ç†
- å¯ä»¥è®¾ç½®é€šçŸ¥ï¼ˆå¦‚æœæ”¯æŒï¼‰
- å®šæœŸæŸ¥è¯¢çŠ¶æ€å³å¯

## é˜¶æ®µ 5: ç»“æœæŸ¥è¯¢å’ŒéªŒè¯

### 5.1 æŸ¥è¯¢æœ€ç»ˆç»“æœ

```typescript
// ä»»ä½•äººéƒ½å¯ä»¥æŸ¥è¯¢ç»“æœ
const finalRound = await client.getRoundInfo({ contractAddress: round.contractAddress });

console.log('\n=== æœ€ç»ˆæŠ•ç¥¨ç»“æœ ===');
console.log('Round:', finalRound.title);
console.log('çŠ¶æ€:', finalRound.status);  // 'Tallied'
console.log('å‚ä¸äººæ•°:', finalRound.numSignups);

console.log('\næŠ•ç¥¨ç»“æœ:');
finalRound.results?.forEach((votes, idx) => {
  console.log(`  ${finalRound.voteOptionMap[idx]}: ${votes} ç¥¨`);
});

// è®¡ç®—è·èƒœé€‰é¡¹
const maxVotes = Math.max(...(finalRound.results || []));
const winnerIdx = finalRound.results?.indexOf(maxVotes);
console.log(`\nè·èƒœé¡¹ç›®: ${finalRound.voteOptionMap[winnerIdx]}`);
```

### 5.2 éšç§åˆ†æ

**ç”¨æˆ· Aï¼ˆä½¿ç”¨ Signupï¼‰ï¼š**
```
å…¬å¼€ä¿¡æ¯ï¼š
- é’±åŒ…åœ°å€: dora1aaa...
- Signup äº¤æ˜“å“ˆå¸Œ: 0xabc...
- State Index: å¯æŸ¥è¯¢

Operator çŸ¥é“ï¼š
- dora1aaa... æŠ•äº†ç¥¨
- æŠ•ç»™äº†å“ªä¸ªé€‰é¡¹
- æŠ•äº†å¤šå°‘ç¥¨

éšç§çº§åˆ«ï¼š
```

**ç”¨æˆ· Bï¼ˆä½¿ç”¨ Add-new-keyï¼‰ï¼š**
```
å…¬å¼€ä¿¡æ¯ï¼š
- æ–°é’±åŒ…åœ°å€: dora1xyz...ï¼ˆå¯èƒ½æ˜¯æ–°çš„ï¼‰
- Add-new-key äº¤æ˜“å“ˆå¸Œ: 0xdef...
- State Index: æ–°åˆ†é…çš„

Operator çŸ¥é“ï¼š
- æœ‰äººæŠ•äº†ç¥¨
- æŠ•ç»™äº†å“ªä¸ªé€‰é¡¹
- æŠ•äº†å¤šå°‘ç¥¨

Operator ä¸çŸ¥é“ï¼š
- æ˜¯ deactivate æ ‘ä¸­å“ªä¸ªç”¨æˆ·
- å¯¹åº”å“ªä¸ªé’±åŒ…åœ°å€
- çœŸå®èº«ä»½æ˜¯è°

éšç§çº§åˆ«ï¼š
```

## å®Œæ•´æ—¶é—´çº¿

```mermaid
gantt
    title AMACI å®Œæ•´æŠ•ç¥¨æ—¶é—´çº¿ç¤ºä¾‹
    dateFormat YYYY-MM-DD HH:mm
    section å‡†å¤‡
    é€‰æ‹©Operator           :done, 2024-01-15 10:00, 10m
    section åˆ›å»º
    åˆ›å»ºRound             :done, 2024-01-15 11:00, 5m
    éªŒè¯åˆ›å»º               :done, 2024-01-15 11:05, 2m
    section æŠ•ç¥¨
    ç”¨æˆ·A SignupæŠ•ç¥¨       :done, 2024-02-01 09:00, 10m
    ç”¨æˆ·B Add-new-key      :done, 2024-02-01 10:00, 15m
    ç”¨æˆ·B æŠ•ç¥¨             :done, 2024-02-01 10:15, 5m
    æ›´å¤šç”¨æˆ·æŠ•ç¥¨           :done, 2024-02-02 00:00, 144h
    æŠ•ç¥¨æœŸç»“æŸ             :milestone, 2024-02-07 23:59, 0d
    section Operatorè‡ªåŠ¨å¤„ç†
    ProcessDeactivate      :active, 2024-02-08 00:10, 30m
    ProcessMessages        :active, 2024-02-08 00:40, 2h
    ProcessTally           :active, 2024-02-08 02:40, 1h
    section ç»“æœ
    ç»“æœå‘å¸ƒ               :milestone, 2024-02-08 03:40, 0d
```

## å®Œæ•´ä»£ç ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç«¯åˆ°ç«¯ç¤ºä¾‹è„šæœ¬ï¼š

```typescript
import { MaciClient, MaciCircuitType } from '@dorafactory/maci-sdk';
import { DirectSecp256k1Wallet } from '@cosmjs/proto-signing';

async function completeVotingRound() {
  const client = new MaciClient({ network: 'testnet' });
  
  // === é˜¶æ®µ 1: åˆ›å»º Round ===
  console.log('\n=== é˜¶æ®µ 1: åˆ›å»ºæŠ•ç¥¨è½®æ¬¡ ===');
  const round = await client.createOracleMaciRound({
    signer: creatorWallet,
    operatorPubkey: operatorPubkey,
    startVoting: new Date(),
    endVoting: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
    title: 'ç¤¾åŒºèµ„é‡‘åˆ†é…',
    description: 'æŠ•ç¥¨å†³å®šèµ„é‡‘ç”¨é€”',
    link: 'https://forum.example.com',
    voteOptionMap: ['é¡¹ç›® A', 'é¡¹ç›® B', 'é¡¹ç›® C', 'é¡¹ç›® D'],
    circuitType: MaciCircuitType.QV,
    whitelistEcosystem: 'cosmoshub',
    whitelistSnapshotHeight: '0',
    whitelistVotingPowerArgs: {
      mode: 'slope',
      slope: '1000000',
      threshold: '0',
    },
  });
  
  console.log('Round åˆ›å»ºæˆåŠŸ:', round.contractAddress);
  
  // === é˜¶æ®µ 2: ç”¨æˆ·æŠ•ç¥¨ ===
  console.log('\n=== é˜¶æ®µ 2: ç”¨æˆ·æŠ•ç¥¨ ===');
  
  // ç”¨æˆ· A æŠ•ç¥¨
  await voteAsUser(client, walletA, addressA, round.contractAddress, [
    { idx: 0, vc: 8 },
    { idx: 2, vc: 6 },
  ]);
  
  // ç”¨æˆ· B æŠ•ç¥¨
  await voteAsUser(client, walletB, addressB, round.contractAddress, [
    { idx: 1, vc: 10 },
  ]);
  
  // === é˜¶æ®µ 3: ç­‰å¾…æŠ•ç¥¨æœŸç»“æŸ ===
  console.log('\n=== é˜¶æ®µ 3: ç­‰å¾…æŠ•ç¥¨æœŸç»“æŸ ===');
  // ... ç­‰å¾…é€»è¾‘
  
  // === é˜¶æ®µ 4: Operator å¤„ç† ===
  console.log('\n=== é˜¶æ®µ 4: å¤„ç†å’Œç»Ÿè®¡ ===');
  const operator = new OperatorClient({
    privateKey: operatorPrivateKey,
    contractAddress: round.contractAddress,
  });
  
  await operator.processAndTally();
  
  // === é˜¶æ®µ 5: æŸ¥è¯¢ç»“æœ ===
  console.log('\n=== é˜¶æ®µ 5: æŸ¥è¯¢ç»“æœ ===');
  const results = await client.getRoundById(round.contractAddress);
  console.log('æœ€ç»ˆç»“æœ:', results);
}

// è¾…åŠ©å‡½æ•°ï¼šSignup æ–¹å¼æŠ•ç¥¨
async function voteWithSignup(
  client: MaciClient,
  wallet: any,
  address: string,
  contractAddress: string,
  options: { idx: number; vc: number }[]
) {
  // ç”Ÿæˆè´¦æˆ·
  const maciKeypair = await client.genKeypairFromSign({
    signer: wallet,
    address
  });
  
  // è·å–è¯ä¹¦
  const certificate = await client.requestOracleCertificate({
    signer: wallet,
    ecosystem: 'cosmoshub',
    address,
    contractAddress
  });
  
  // ç­‰å¾… Gas Station
  await waitForGasStation(client, address, contractAddress);
  
  // Signup
  await client.signup({
    signer: wallet,
    address,
    contractAddress,
    maciKeypair,
    oracleCertificate: certificate,
    gasStation: true
  });
  
  // æŠ•ç¥¨
  const roundInfo = await client.getRoundInfo({ contractAddress });
  
  await client.vote({
    signer: wallet,
    address,
    contractAddress,
    selectedOptions: options,
    operatorCoordPubKey: [
      BigInt(roundInfo.coordinatorPubkeyX),
      BigInt(roundInfo.coordinatorPubkeyY)
    ],
    maciKeypair,
    gasStation: true
  });
  
  console.log(`ç”¨æˆ· ${address} æŠ•ç¥¨æˆåŠŸï¼ˆSignupæ¨¡å¼ï¼‰`);
}

// è¾…åŠ©å‡½æ•°ï¼šAdd-new-key æ–¹å¼æŠ•ç¥¨
async function voteWithAddNewKey(
  client: MaciClient,
  oldPrivateKey: string,
  newWallet: any,
  newAddress: string,
  contractAddress: string,
  options: { idx: number; vc: number }[]
) {
  // è·å– deactivate æ•°æ®
  const deactivates = await client.fetchAllDeactivateLogs(contractAddress);
  
  // ç”Ÿæˆ add-new-key payload
  const voterClient = new VoterClient({
    network: client.network,
    secretKey: oldPrivateKey
  });
  
  const roundInfo = await client.getRoundInfo({ contractAddress });
  
  const payload = await voterClient.buildAddNewKeyPayload({
    stateTreeDepth: 10,
    operatorPubkey: roundInfo.coordinatorPubkey,
    deactivates,
    wasmFile,
    zkeyFile
  });
  
  // Add-new-key
  const newKeypair = genKeypair();
  
  await client.addNewKey({
    signer: newWallet,
    contractAddress,
    d: payload.d,
    proof: payload.proof,
    nullifier: payload.nullifier,
    newMaciKeypair: newKeypair,
    fee: 'auto'
  });
  
  // æŠ•ç¥¨
  await client.vote({
    signer: newWallet,
    address: newAddress,
    contractAddress,
    selectedOptions: options,
    operatorCoordPubKey: [
      BigInt(roundInfo.coordinatorPubkeyX),
      BigInt(roundInfo.coordinatorPubkeyY)
    ],
    maciKeypair: newKeypair,
    gasStation: true
  });
  
  console.log(`ç”¨æˆ· ${newAddress} æŠ•ç¥¨æˆåŠŸï¼ˆåŒ¿åæ¨¡å¼ï¼‰`);
}

// è¿è¡Œ
completeVotingRound().catch(console.error);
```

## æµç¨‹æ€»ç»“

### ç”¨æˆ·éœ€è¦åšçš„

1. **åˆ›å»ºé˜¶æ®µï¼š** é€‰æ‹© Operatorï¼Œé…ç½®å‚æ•°ï¼Œåˆ›å»º Round
2. **æŠ•ç¥¨é˜¶æ®µï¼š** é€‰æ‹©æ³¨å†Œæ–¹å¼ï¼ˆsignup / add-new-keyï¼‰ï¼ŒæŠ•ç¥¨
3. **ç­‰å¾…é˜¶æ®µï¼š** ç­‰å¾… Operator å¤„ç†ï¼ˆæ— éœ€æ“ä½œï¼‰
4. **æŸ¥è¯¢é˜¶æ®µï¼š** æŸ¥è¯¢ç»“æœ

### Operator è‡ªåŠ¨å®Œæˆçš„

1. **ç›‘æ§ï¼š** è‡ªåŠ¨ç›‘æ§ Round çŠ¶æ€
2. **å¤„ç† Deactivateï¼š** å¦‚æœæœ‰ deactivate æ¶ˆæ¯ï¼Œè‡ªåŠ¨å¤„ç†
3. **å¤„ç†æŠ•ç¥¨ï¼š** ä¸‹è½½ã€è§£å¯†ã€éªŒè¯ã€æ›´æ–°çŠ¶æ€
4. **ç”Ÿæˆè¯æ˜ï¼š** ç”Ÿæˆ ProcessMessages å’Œ ProcessTally è¯æ˜
5. **æäº¤é“¾ä¸Šï¼š** å°†è¯æ˜æäº¤åˆ°åˆçº¦éªŒè¯
6. **å‘å¸ƒç»“æœï¼š** ç»“æœè‡ªåŠ¨å‘å¸ƒ

### å…³é”®ä¼˜åŠ¿

**ç”¨æˆ·ä½“éªŒï¼š**
- æ— éœ€è¿è¡Œ Operator è½¯ä»¶
- æ— éœ€å­¦ä¹  ZK ç”µè·¯
- æ— éœ€ç›‘æ§å¤„ç†è¿›åº¦
- åªéœ€ç­‰å¾…ç»“æœ

**éšç§ä¿æŠ¤ï¼š**
- å¯é€‰æ‹©éšç§çº§åˆ«ï¼ˆsignup / add-new-keyï¼‰
- Operator ä¸“ä¸šå¤„ç†
- é›¶çŸ¥è¯†è¯æ˜ä¿è¯æ­£ç¡®æ€§

**ç³»ç»Ÿå¯é æ€§ï¼š**
- ä¸“ä¸š Operator ç½‘ç»œ
- å¥–ç½šæœºåˆ¶çº¦æŸ
- é€æ˜çš„å†å²è®°å½•

## ä¸‹ä¸€æ­¥

å®Œæˆåï¼Œæ‚¨å¯ä»¥ç†è§£äº† AMACI çš„å®Œæ•´å·¥ä½œæµç¨‹ï¼Œæ¥ä¸‹æ¥å¯ä»¥ï¼š

- ğŸ’» [SDK ä½¿ç”¨æŒ‡å—](/docs/sdk/installation) - è¯¦ç»†å­¦ä¹  SDK çš„ä½¿ç”¨
- [AMACI éšç§æœºåˆ¶](/docs/protocol/amaci-privacy) - æ·±å…¥ç†è§£èº«ä»½åŒ¿ååŒ–
- [ç¤ºä¾‹ä»£ç ](/docs/examples/basic-voting) - æŸ¥çœ‹æ›´å¤šç¤ºä¾‹
- [å¿«é€Ÿå¼€å§‹](/docs/introduction/quick-start) - å¿«é€Ÿä¸Šæ‰‹ AMACI
