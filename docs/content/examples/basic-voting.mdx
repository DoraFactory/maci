# åŸºç¡€æŠ•ç¥¨ç¤ºä¾‹

æœ¬ç¤ºä¾‹å±•ç¤ºå¦‚ä½•åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„æŠ•ç¥¨åº”ç”¨ï¼ŒåŒ…æ‹¬åˆ›å»º Roundã€ç”¨æˆ·æŠ•ç¥¨å’ŒæŸ¥è¯¢ç»“æœã€‚

## å®Œæ•´ä»£ç 

```typescript
import { MaciClient, MaciCircuitType } from '@dorafactory/maci-sdk';
import { DirectSecp256k1Wallet } from '@cosmjs/proto-signing';
import dotenv from 'dotenv';

dotenv.config();

async function main() {
  // === åˆå§‹åŒ– ===
  console.log('=== åˆå§‹åŒ– MACI å®¢æˆ·ç«¯ ===\n');
  
  const client = new MaciClient({ network: 'testnet' });
  
  // åˆ›å»ºé’±åŒ…
  const creatorWallet = await DirectSecp256k1Wallet.fromKey(
    Buffer.from(process.env.CREATOR_PRIVATE_KEY!, 'hex'),
    'dora'
  );
  
  const [creatorAccount] = await creatorWallet.getAccounts();
  console.log('åˆ›å»ºè€…åœ°å€:', creatorAccount.address);
  
  // === æ­¥éª¤ 1: åˆ›å»ºæŠ•ç¥¨è½®æ¬¡ ===
  console.log('\n=== æ­¥éª¤ 1: åˆ›å»ºæŠ•ç¥¨è½®æ¬¡ ===\n');
  
  const round = await client.createOracleMaciRound({
    signer: creatorWallet,
    operatorPubkey: process.env.OPERATOR_PUBKEY!,
    
    startVoting: new Date(),
    endVoting: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
    
    title: 'ç¤¾åŒºææ¡ˆæŠ•ç¥¨ç¤ºä¾‹',
    description: 'è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ MACI çš„æŠ•ç¥¨ç¤ºä¾‹',
    link: 'https://example.com',
    
    voteOptionMap: [
      'ææ¡ˆ A: å¢åŠ ç¤¾åŒºèµ„é‡‘',
      'ææ¡ˆ B: æ”¹è¿›æŠ€æœ¯åŸºç¡€è®¾æ–½',
      'ææ¡ˆ C: æ‰©å¤§å¸‚åœºæ¨å¹¿',
      'ææ¡ˆ D: æ•™è‚²å’ŒåŸ¹è®­é¡¹ç›®'
    ],
    
    circuitType: MaciCircuitType.QV,
    
    whitelistEcosystem: 'cosmoshub',
    whitelistSnapshotHeight: '0',
    whitelistVotingPowerArgs: {
      mode: 'slope',
      slope: '1000000',
      threshold: '1000000'
    }
  });
  
  console.log('âœ… Round åˆ›å»ºæˆåŠŸï¼');
  console.log('åˆçº¦åœ°å€:', round.contractAddress);
  console.log('äº¤æ˜“å“ˆå¸Œ:', round.transactionHash);
  
  const contractAddress = round.contractAddress;
  
  // ç­‰å¾…åˆçº¦åˆå§‹åŒ–
  console.log('\nç­‰å¾…åˆçº¦åˆå§‹åŒ–...');
  await new Promise(resolve => setTimeout(resolve, 5000));
  
  // === æ­¥éª¤ 2: ç”¨æˆ· A æŠ•ç¥¨ ===
  console.log('\n=== æ­¥éª¤ 2: ç”¨æˆ· A æŠ•ç¥¨ ===\n');
  
  const voterAWallet = await DirectSecp256k1Wallet.fromKey(
    Buffer.from(process.env.VOTER_A_PRIVATE_KEY!, 'hex'),
    'dora'
  );
  const [voterA] = await voterAWallet.getAccounts();
  
  await voteAsUser(
    client,
    voterAWallet,
    voterA.address,
    contractAddress,
    [
      { idx: 0, vc: 8 },  // ææ¡ˆ A: 8 ç¥¨ (æ¶ˆè€— 64 credits)
      { idx: 2, vc: 6 }   // ææ¡ˆ C: 6 ç¥¨ (æ¶ˆè€— 36 credits)
    ]
  );
  
  // === æ­¥éª¤ 3: ç”¨æˆ· B æŠ•ç¥¨ ===
  console.log('\n=== æ­¥éª¤ 3: ç”¨æˆ· B æŠ•ç¥¨ ===\n');
  
  const voterBWallet = await DirectSecp256k1Wallet.fromKey(
    Buffer.from(process.env.VOTER_B_PRIVATE_KEY!, 'hex'),
    'dora'
  );
  const [voterB] = await voterBWallet.getAccounts();
  
  await voteAsUser(
    client,
    voterBWallet,
    voterB.address,
    contractAddress,
    [
      { idx: 1, vc: 9 },  // ææ¡ˆ B: 9 ç¥¨ (æ¶ˆè€— 81 credits)
      { idx: 3, vc: 4 }   // ææ¡ˆ D: 4 ç¥¨ (æ¶ˆè€— 16 credits)
    ]
  );
  
  // === æ­¥éª¤ 4: ç”¨æˆ· A æ”¹å˜ä¸»æ„ ===
  console.log('\n=== æ­¥éª¤ 4: ç”¨æˆ· A é‡æ–°æŠ•ç¥¨ ===\n');
  
  await revote(
    client,
    voterAWallet,
    voterA.address,
    contractAddress,
    [
      { idx: 1, vc: 10 }  // æ”¹æŠ•ææ¡ˆ B: 10 ç¥¨ (æ¶ˆè€— 100 credits)
    ]
  );
  
  // === æ­¥éª¤ 5: æŸ¥è¯¢å½“å‰çŠ¶æ€ ===
  console.log('\n=== æ­¥éª¤ 5: æŸ¥è¯¢å½“å‰çŠ¶æ€ ===\n');
  
  const roundInfo = await client.getRoundById(contractAddress);
  
  console.log('Round ä¿¡æ¯:');
  console.log('- æ ‡é¢˜:', roundInfo.title);
  console.log('- çŠ¶æ€:', roundInfo.status);
  console.log('- ç­¾åˆ°äººæ•°:', roundInfo.numSignups);
  console.log('- æ¶ˆæ¯æ•°é‡:', roundInfo.numMessages);
  console.log('- é€‰é¡¹:', roundInfo.voteOptionMap);
  
  console.log('\nâœ… ç¤ºä¾‹å®Œæˆï¼');
  console.log('\næ³¨æ„: å®é™…ç»“æœéœ€è¦ç­‰å¾… Operator å¤„ç†å’Œç»Ÿè®¡');
}

async function voteAsUser(
  client: MaciClient,
  wallet: any,
  address: string,
  contractAddress: string,
  options: { idx: number; vc: number }[]
) {
  console.log(`ç”¨æˆ· ${address.slice(0, 10)}... å¼€å§‹æŠ•ç¥¨`);
  
  // 1. ç”Ÿæˆ MACI è´¦æˆ·
  console.log('  1/5 ç”Ÿæˆ MACI è´¦æˆ·...');
  const maciAccount = await client.circom.genKeypairFromSign(wallet, address);
  
  // 2. è·å–è¯ä¹¦
  console.log('  2/5 è·å– Oracle è¯ä¹¦...');
  const certificate = await client.maci.requestOracleCertificate({
    signer: wallet,
    ecosystem: 'cosmoshub',
    address,
    contractAddress
  });
  console.log(`     æŠ•ç¥¨æƒé‡: ${certificate.amount}`);
  
  // 3. ç­‰å¾… Gas Station
  console.log('  3/5 ç­‰å¾… Gas Station...');
  const hasGasStation = await waitForGasStation(client, address, contractAddress);
  
  // 4. ç­¾åˆ°
  console.log('  4/5 ç­¾åˆ°ä¸­...');
  await client.maci.signup({
    signer: wallet,
    address,
    contractAddress,
    maciAccount,
    oracleCertificate: certificate,
    gasStation: hasGasStation
  });
  
  // 5. æŠ•ç¥¨
  console.log('  5/5 æŠ•ç¥¨ä¸­...');
  const roundInfo = await client.getRoundById(contractAddress);
  
  await client.maci.vote({
    signer: wallet,
    address,
    contractAddress,
    selectedOptions: options,
    operatorCoordPubKey: [
      BigInt(roundInfo.coordinatorPubkeyX),
      BigInt(roundInfo.coordinatorPubkeyY)
    ],
    maciAccount,
    gasStation: hasGasStation
  });
  
  console.log(`âœ… ${address.slice(0, 10)}... æŠ•ç¥¨æˆåŠŸï¼`);
  
  // æ˜¾ç¤ºæŠ•ç¥¨è¯¦æƒ…
  console.log('   æŠ•ç¥¨è¯¦æƒ…:');
  options.forEach(opt => {
    const cost = opt.vc * opt.vc;  // QV æ¨¡å¼
    console.log(`   - é€‰é¡¹ ${opt.idx}: ${opt.vc} ç¥¨ (æ¶ˆè€— ${cost} credits)`);
  });
}

async function revote(
  client: MaciClient,
  wallet: any,
  address: string,
  contractAddress: string,
  options: { idx: number; vc: number }[]
) {
  console.log(`ç”¨æˆ· ${address.slice(0, 10)}... é‡æ–°æŠ•ç¥¨`);
  
  // ä½¿ç”¨ä¹‹å‰çš„ MACI è´¦æˆ·
  const maciAccount = await client.circom.genKeypairFromSign(wallet, address);
  
  const roundInfo = await client.getRoundById(contractAddress);
  const hasGasStation = await waitForGasStation(client, address, contractAddress);
  
  await client.maci.vote({
    signer: wallet,
    address,
    contractAddress,
    selectedOptions: options,
    operatorCoordPubKey: [
      BigInt(roundInfo.coordinatorPubkeyX),
      BigInt(roundInfo.coordinatorPubkeyY)
    ],
    maciAccount,
    gasStation: hasGasStation
  });
  
  console.log(`âœ… ${address.slice(0, 10)}... é‡æ–°æŠ•ç¥¨æˆåŠŸï¼`);
}

async function waitForGasStation(
  client: MaciClient,
  address: string,
  contractAddress: string
): Promise<boolean> {
  let hasFeegrant = false;
  let attempts = 0;
  const maxAttempts = 30;
  
  while (!hasFeegrant && attempts < maxAttempts) {
    hasFeegrant = await client.maci.hasFeegrant({
      address,
      contractAddress
    });
    
    if (!hasFeegrant) {
      await new Promise(resolve => setTimeout(resolve, 2000));
      attempts++;
    }
  }
  
  return hasFeegrant;
}

// è¿è¡Œä¸»å‡½æ•°
main().catch(console.error);
```

## ç¯å¢ƒé…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# .env
CREATOR_PRIVATE_KEY=your_creator_private_key_here
VOTER_A_PRIVATE_KEY=voter_a_private_key_here
VOTER_B_PRIVATE_KEY=voter_b_private_key_here
OPERATOR_PUBKEY=operator_public_key_here
```

## è¿è¡Œç¤ºä¾‹

```bash
# å®‰è£…ä¾èµ–
npm install @dorafactory/maci-sdk @cosmjs/proto-signing @cosmjs/stargate dotenv

# è¿è¡Œç¤ºä¾‹
npx ts-node basic-voting.ts
```

## é¢„æœŸè¾“å‡º

```
=== åˆå§‹åŒ– MACI å®¢æˆ·ç«¯ ===

åˆ›å»ºè€…åœ°å€: dora1creator...

=== æ­¥éª¤ 1: åˆ›å»ºæŠ•ç¥¨è½®æ¬¡ ===

âœ… Round åˆ›å»ºæˆåŠŸï¼
åˆçº¦åœ°å€: dora1contract...
äº¤æ˜“å“ˆå¸Œ: ABCD1234...

ç­‰å¾…åˆçº¦åˆå§‹åŒ–...

=== æ­¥éª¤ 2: ç”¨æˆ· A æŠ•ç¥¨ ===

ç”¨æˆ· dora1voter... å¼€å§‹æŠ•ç¥¨
  1/5 ç”Ÿæˆ MACI è´¦æˆ·...
  2/5 è·å– Oracle è¯ä¹¦...
     æŠ•ç¥¨æƒé‡: 100
  3/5 ç­‰å¾… Gas Station...
  4/5 ç­¾åˆ°ä¸­...
  5/5 æŠ•ç¥¨ä¸­...
âœ… dora1voter... æŠ•ç¥¨æˆåŠŸï¼
   æŠ•ç¥¨è¯¦æƒ…:
   - é€‰é¡¹ 0: 8 ç¥¨ (æ¶ˆè€— 64 credits)
   - é€‰é¡¹ 2: 6 ç¥¨ (æ¶ˆè€— 36 credits)

=== æ­¥éª¤ 3: ç”¨æˆ· B æŠ•ç¥¨ ===

...

=== æ­¥éª¤ 5: æŸ¥è¯¢å½“å‰çŠ¶æ€ ===

Round ä¿¡æ¯:
- æ ‡é¢˜: ç¤¾åŒºææ¡ˆæŠ•ç¥¨ç¤ºä¾‹
- çŠ¶æ€: Voting
- ç­¾åˆ°äººæ•°: 2
- æ¶ˆæ¯æ•°é‡: 3
- é€‰é¡¹: [...]

âœ… ç¤ºä¾‹å®Œæˆï¼
```

## ä¸‹ä¸€æ­¥

- ğŸ“– [Oracle è½®æ¬¡ç¤ºä¾‹](/examples/oracle-round) - æ›´è¯¦ç»†çš„ Oracle é…ç½®
- ğŸš€ [SDK æ–‡æ¡£](/sdk/installation) - å­¦ä¹ æ›´å¤š SDK åŠŸèƒ½
- ğŸ“š [åè®®è¯¦è§£](/protocol/overview) - æ·±å…¥ç†è§£ MACI
