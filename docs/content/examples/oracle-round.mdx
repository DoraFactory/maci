# Oracle è½®æ¬¡ç¤ºä¾‹

æœ¬ç¤ºä¾‹è¯¦ç»†å±•ç¤ºå¦‚ä½•é…ç½®å’Œä½¿ç”¨ Oracle ç™½åå•æ¨¡å¼çš„æŠ•ç¥¨è½®æ¬¡ã€‚

## å®Œæ•´ä»£ç 

```typescript
import { MaciClient, MaciCircuitType } from '@dorafactory/maci-sdk';
import { DirectSecp256k1Wallet } from '@cosmjs/proto-signing';

async function createOracleRound() {
  const client = new MaciClient({ network: 'mainnet' });
  
  // åˆ›å»ºé’±åŒ…
  const wallet = await DirectSecp256k1Wallet.fromKey(
    Buffer.from(process.env.PRIVATE_KEY!, 'hex'),
    'dora'
  );
  
  console.log('=== åˆ›å»º Oracle ç™½åå•æŠ•ç¥¨è½®æ¬¡ ===\n');
  
  // é…ç½® 1: Cosmos Hub ç™½åå•ï¼ŒSlope æ¨¡å¼
  const cosmosSlope = await client.createOracleMaciRound({
    signer: wallet,
    operatorPubkey: process.env.OPERATOR_PUBKEY!,
    
    startVoting: new Date('2024-03-01T00:00:00Z'),
    endVoting: new Date('2024-03-07T23:59:59Z'),
    
    title: 'Cosmos Hub ææ¡ˆæŠ•ç¥¨',
    description: 'åŸºäº ATOM æŒæœ‰é‡çš„äºŒæ¬¡æ–¹æŠ•ç¥¨',
    link: 'https://forum.cosmos.network',
    
    voteOptionMap: [
      'ææ¡ˆ 1',
      'ææ¡ˆ 2',
      'ææ¡ˆ 3'
    ],
    
    circuitType: MaciCircuitType.QV,
    
    // Cosmos Hub é…ç½®
    whitelistEcosystem: 'cosmoshub',
    whitelistSnapshotHeight: '23342001',  // ç‰¹å®šé«˜åº¦å¿«ç…§
    whitelistVotingPowerArgs: {
      mode: 'slope',
      slope: '1000000',  // æ¯ 1 ATOM = 1 voice credit
      threshold: '5000000'  // è‡³å°‘ 5 ATOM
    }
  });
  
  console.log('âœ… Cosmos Hub Round åˆ›å»ºæˆåŠŸ');
  console.log('åœ°å€:', cosmosSlope.contractAddress);
  
  // é…ç½® 2: Dora Vota ç™½åå•ï¼ŒThreshold æ¨¡å¼
  const doraThreshold = await client.createOracleMaciRound({
    signer: wallet,
    operatorPubkey: process.env.OPERATOR_PUBKEY!,
    
    startVoting: new Date('2024-03-01T00:00:00Z'),
    endVoting: new Date('2024-03-07T23:59:59Z'),
    
    title: 'Dora Vota ç¤¾åŒºæŠ•ç¥¨',
    description: 'è¾¾åˆ°é˜ˆå€¼å³å¯è·å¾— 1 ç¥¨',
    link: 'https://dorafactory.org',
    
    voteOptionMap: [
      'èµæˆ',
      'åå¯¹',
      'å¼ƒæƒ'
    ],
    
    circuitType: MaciCircuitType.IP1V,
    
    // Dora Vota é…ç½®
    whitelistEcosystem: 'doravota',
    whitelistSnapshotHeight: '0',  // å®æ—¶ä½™é¢
    whitelistVotingPowerArgs: {
      mode: 'threshold',
      slope: '0',
      threshold: '1000000000000000000'  // 1 DORA (18 decimals)
    }
  });
  
  console.log('âœ… Dora Vota Round åˆ›å»ºæˆåŠŸ');
  console.log('åœ°å€:', doraThreshold.contractAddress);
  
  return { cosmosSlope, doraThreshold };
}

// è¿è¡Œ
createOracleRound().catch(console.error);
```

## ç™½åå•é…ç½®è¯¦è§£

### Cosmos Hub é…ç½®

#### Slope æ¨¡å¼ç¤ºä¾‹

```typescript
{
  whitelistEcosystem: 'cosmoshub',
  whitelistSnapshotHeight: '23342001',
  whitelistVotingPowerArgs: {
    mode: 'slope',
    slope: '1000000',    // é™¤æ•°
    threshold: '5000000' // æœ€å°è´¨æŠ¼ 5 ATOM
  }
}

// è®¡ç®—ç¤ºä¾‹ï¼š
// ç”¨æˆ·è´¨æŠ¼ 100 ATOM = 100,000,000 uatom
// voice_credits = 100,000,000 / 1,000,000 = 100
// 
// ç”¨æˆ·è´¨æŠ¼ 10 ATOM = 10,000,000 uatom
// voice_credits = 10,000,000 / 1,000,000 = 10
//
// ç”¨æˆ·è´¨æŠ¼ 3 ATOM = 3,000,000 uatom (ä½äºé˜ˆå€¼)
// voice_credits = 0
```

#### Threshold æ¨¡å¼ç¤ºä¾‹

```typescript
{
  whitelistEcosystem: 'cosmoshub',
  whitelistSnapshotHeight: '23342001',
  whitelistVotingPowerArgs: {
    mode: 'threshold',
    slope: '0',
    threshold: '10000000'  // 10 ATOM
  }
}

// è®¡ç®—ç¤ºä¾‹ï¼š
// ç”¨æˆ·è´¨æŠ¼ >= 10 ATOM â†’ voice_credits = 1
// ç”¨æˆ·è´¨æŠ¼ < 10 ATOM â†’ voice_credits = 0
```

### Dora Vota é…ç½®

#### Slope æ¨¡å¼ç¤ºä¾‹

```typescript
{
  whitelistEcosystem: 'doravota',
  whitelistSnapshotHeight: '0',  // å®æ—¶
  whitelistVotingPowerArgs: {
    mode: 'slope',
    slope: '1000000000000000000',  // 1 DORA (18 decimals)
    threshold: '1000000000000000000'
  }
}

// è®¡ç®—ç¤ºä¾‹ï¼š
// ç”¨æˆ·è´¨æŠ¼ 100 DORA = 100,000,000,000,000,000,000 (18 decimals)
// voice_credits = 100,000,000,000,000,000,000 / 1,000,000,000,000,000,000 = 100
```

## å¿«ç…§é«˜åº¦è¯´æ˜

### ä½¿ç”¨ç‰¹å®šé«˜åº¦

```typescript
whitelistSnapshotHeight: '23342001'

// ä¼˜ç‚¹ï¼š
// - é˜²æ­¢ä¸´æ—¶è½¬è´¦æ“ä½œ
// - å…¬å¹³å›ºå®šçš„æŠ•ç¥¨æƒé‡
// - å¯é¢„æµ‹çš„å‚ä¸æ¡ä»¶

// ç¼ºç‚¹ï¼š
// - éœ€è¦æå‰ç¡®å®šé«˜åº¦
// - ä¸é€‚åˆé•¿æœŸæŠ•ç¥¨
```

### ä½¿ç”¨å®æ—¶ä½™é¢

```typescript
whitelistSnapshotHeight: '0'

// ä¼˜ç‚¹ï¼š
// - åæ˜ å½“å‰è´¨æŠ¼çŠ¶æ€
// - ä¸éœ€è¦æå‰è§„åˆ’
// - é€‚åˆåŠ¨æ€åœºæ™¯

// ç¼ºç‚¹ï¼š
// - å¯èƒ½è¢«ä¸´æ—¶è½¬è´¦å½±å“
// - æŠ•ç¥¨æƒé‡å¯å˜
```

## æŠ•ç¥¨æƒé‡è®¡ç®—å·¥å…·

```typescript
class VotingPowerCalculator {
  // è®¡ç®— voice credits
  static calculate(
    stakedAmount: string,  // æœ€å°å•ä½ï¼ˆå¦‚ uatomï¼‰
    args: VotingPowerArgs
  ): number {
    const amount = BigInt(stakedAmount);
    const threshold = BigInt(args.threshold);
    const slope = BigInt(args.slope);
    
    if (args.mode === 'slope') {
      // ä½äºé˜ˆå€¼è¿”å› 0
      if (amount < threshold) {
        return 0;
      }
      
      // è®¡ç®—ï¼šamount / slopeï¼ˆå‘ä¸‹å–æ•´ï¼‰
      const credits = amount / slope;
      return Number(credits);
      
    } else {  // threshold mode
      // è¾¾åˆ°é˜ˆå€¼è¿”å› 1ï¼Œå¦åˆ™è¿”å› 0
      return amount >= threshold ? 1 : 0;
    }
  }
  
  // æ‰¹é‡è®¡ç®—
  static batchCalculate(
    stakes: Array<{ address: string; amount: string }>,
    args: VotingPowerArgs
  ): Array<{ address: string; voiceCredits: number }> {
    return stakes.map(stake => ({
      address: stake.address,
      voiceCredits: this.calculate(stake.amount, args)
    }));
  }
  
  // ä¼°ç®—éœ€è¦è´¨æŠ¼å¤šå°‘æ‰èƒ½è·å¾—æŒ‡å®š voice credits
  static estimateStake(
    desiredCredits: number,
    args: VotingPowerArgs
  ): string {
    if (args.mode === 'threshold') {
      return args.threshold;
    }
    
    const slope = BigInt(args.slope);
    const credits = BigInt(desiredCredits);
    const required = credits * slope;
    
    return required.toString();
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const args = {
  mode: 'slope' as const,
  slope: '1000000',
  threshold: '5000000'
};

// è®¡ç®— 100 ATOM èƒ½è·å¾—å¤šå°‘ voice credits
const credits = VotingPowerCalculator.calculate(
  '100000000',  // 100 ATOM in uatom
  args
);
console.log('Voice Credits:', credits);  // 100

// ä¼°ç®—è·å¾— 50 voice credits éœ€è¦å¤šå°‘ ATOM
const required = VotingPowerCalculator.estimateStake(50, args);
console.log('Required stake:', required, 'uatom');  // 50000000 (50 ATOM)
```

## æµ‹è¯• Oracle è¯ä¹¦

```typescript
async function testOracleCertificate(
  client: MaciClient,
  wallet: any,
  address: string,
  contractAddress: string
) {
  console.log('æµ‹è¯• Oracle è¯ä¹¦è·å–...\n');
  
  try {
    // å°è¯•è·å–è¯ä¹¦
    const certificate = await client.maci.requestOracleCertificate({
      signer: wallet,
      ecosystem: 'cosmoshub',
      address,
      contractAddress
    });
    
    console.log('âœ… è¯ä¹¦è·å–æˆåŠŸ');
    console.log('æŠ•ç¥¨æƒé‡:', certificate.amount);
    console.log('ç­¾å:', certificate.signature.slice(0, 20) + '...');
    
    // éªŒè¯æƒé‡æ˜¯å¦ç¬¦åˆé¢„æœŸ
    const expectedMinimum = 1;
    const actual = parseInt(certificate.amount);
    
    if (actual >= expectedMinimum) {
      console.log(`âœ… æƒé‡éªŒè¯é€šè¿‡ (${actual} >= ${expectedMinimum})`);
    } else {
      console.log(`âŒ æƒé‡ä¸è¶³ (${actual} < ${expectedMinimum})`);
    }
    
  } catch (error: any) {
    console.error('âŒ è¯ä¹¦è·å–å¤±è´¥:', error.message);
    
    if (error.message.includes('insufficient stake')) {
      console.log('æç¤º: æ‚¨çš„è´¨æŠ¼é‡å¯èƒ½ä½äºæœ€ä½è¦æ±‚');
    } else if (error.message.includes('not whitelisted')) {
      console.log('æç¤º: æ‚¨å¯èƒ½ä¸åœ¨ç™½åå•ä¸­');
    }
  }
}

// è¿è¡Œæµ‹è¯•
testOracleCertificate(
  client,
  wallet,
  address,
  'dora1contract...'
).catch(console.error);
```

## é”™è¯¯å¤„ç†

```typescript
async function safeCreateOracleRound() {
  try {
    const round = await client.createOracleMaciRound({
      // ... å‚æ•°
    });
    
    console.log('âœ… æˆåŠŸ:', round.contractAddress);
    return round;
    
  } catch (error: any) {
    if (error.message.includes('invalid operator')) {
      console.error('âŒ Operator æœªæ³¨å†Œæˆ–æ— æ•ˆ');
    } else if (error.message.includes('invalid snapshot height')) {
      console.error('âŒ å¿«ç…§é«˜åº¦æ— æ•ˆï¼ˆå¿…é¡» >= 23342001 æˆ– = 0ï¼‰');
    } else if (error.message.includes('invalid voting power args')) {
      console.error('âŒ æŠ•ç¥¨æƒé‡å‚æ•°æ— æ•ˆ');
    } else {
      console.error('âŒ åˆ›å»ºå¤±è´¥:', error.message);
    }
    
    throw error;
  }
}
```

## ä¸‹ä¸€æ­¥

- ğŸ“– [åŸºç¡€æŠ•ç¥¨ç¤ºä¾‹](/examples/basic-voting) - ç®€åŒ–çš„æŠ•ç¥¨æµç¨‹
- ğŸš€ [SDK æ–‡æ¡£](/sdk/create-round) - è¯¦ç»†çš„ API æ–‡æ¡£
- ğŸ“š [åˆçº¦è®¾è®¡](/contracts/registry) - äº†è§£åº•å±‚å®ç°
