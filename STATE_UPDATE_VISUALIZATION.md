# State Update 流程可视化

## 五叉树结构可视化（深度3）

```
                                    ROOT [0]
                                       |
                 ┌─────────────────────┼─────────────────────┐
                 |                     |                     |
            [1]  |  [2]  [3]  [4]  [5] |                     |
             |   |                     |                     |
      ┌──────┼──────┐                  |                     |
      |      |      |                  |                     |
    [6]    [7]    [8]    [9]   [10]    |                     |
      |                                |                     |
   ┌──┼──┐                             |                     |
   |  |  |  ...                        |                     |
[31][32][33][34][35]              [36][37][38][39][40]    [41]...
 ↑   ↑   ↑   ↑   ↑                 ↑   ↑   ↑   ↑   ↑
 用  用  用  用  用                 用  用  用  用  用
 户  户  户  户  户                 户  户  户  户  户
 1   2   3   4   5                  6   7   8   9   10
```

---

## 案例 A: AMACI 完整更新 - 用户3注册

### 视觉流程

```
Step 1: 保存叶子节点
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    ROOT [0]
                       |
                    [1]
                       |
                    [6]
                       |
[31]  [32]  [33]✨ [34]  [35]
 ✓     ✓     NEW    ○    ○
 
NODES[33] = Hash(User3_StateLeaf)


Step 2: 更新父节点 [6]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    ROOT [0]
                       |
                    [1]
                       |
                    [6]🔄
                       |
[31]  [32]  [33]  [34]  [35]
 H₁    H₂    H₃   Z₀   Z₀

计算: NODES[6] = Hash5([H₁, H₂, H₃, Z₀, Z₀])
      其中 Z₀ = ZEROS[0] (叶子层零值)


Step 3: 更新第二层 [1]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    ROOT [0]
                       |
                    [1]🔄
                       |
      ┌─────┬────┬────┬────┐
    [6]   [7]  [8]  [9] [10]
     H₆    Z₁   Z₁   Z₁   Z₁

计算: NODES[1] = Hash5([H₆, Z₁, Z₁, Z₁, Z₁])
      其中 Z₁ = ZEROS[1] (第1层零值)


Step 4: 更新根节点 [0]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                  ROOT [0]🔄
                       |
      ┌─────┬────┬────┬────┐
    [1]   [2]  [3]  [4]  [5]
     H₁    Z₂   Z₂   Z₂   Z₂

计算: NODES[0] = Hash5([H₁, Z₂, Z₂, Z₂, Z₂])
      其中 Z₂ = ZEROS[2] (第2层零值)

✅ 根节点已更新！
```

### 更新统计
```
┏━━━━━━━━━━━━━━━┳━━━━━━━━━┓
┃ 更新的节点     ┃ 操作类型 ┃
┡━━━━━━━━━━━━━━━╇━━━━━━━━━┩
│ [33] 叶子      │ SAVE    │
│ [6]  父节点    │ UPDATE  │
│ [1]  第二层    │ UPDATE  │
│ [0]  根节点    │ UPDATE  │
├───────────────┼─────────┤
│ 总计: 4个节点  │ 3次Hash5│
└───────────────┴─────────┘
```

---

## 案例 B: MACI 增量更新 - 用户1到5注册

### 用户1 (leaf_idx=31, 31%5=1)

```
保存叶子:
[31]✨ [32]  [33]  [34]  [35]
 NEW   ○    ○    ○    ○

更新父节点:
     [6]🔄
      |
[31]  [32]  [33]  [34]  [35]
 H₁   Z₀   Z₀   Z₀   Z₀

检查: 31 % 5 = 1 ≠ 0  ❌ 停止向上传播
更新: 仅 [31] 和 [6]

                    [1] ⏸️ 未更新
                     |
                   [6]✓
                     |
                  [31]✓
```

### 用户2 (leaf_idx=32, 32%5=2)

```
     [6]🔄
      |
[31]  [32]✨ [33]  [34]  [35]
 H₁   NEW   ○    ○    ○

NODES[6] = Hash5([H₁, H₂, Z₀, Z₀, Z₀])

检查: 32 % 5 = 2 ≠ 0  ❌ 停止
更新: 仅 [32] 和 [6]

                    [1] ⏸️ 仍未更新
                     |
                   [6]✓ (重新计算)
                     |
                  [32]✓
```

### 用户3 (leaf_idx=33, 33%5=3)

```
     [6]🔄
      |
[31]  [32]  [33]✨ [34]  [35]
 H₁   H₂   NEW   ○    ○

NODES[6] = Hash5([H₁, H₂, H₃, Z₀, Z₀])

检查: 33 % 5 = 3 ≠ 0  ❌ 停止
更新: 仅 [33] 和 [6]
```

### 用户4 (leaf_idx=34, 34%5=4)

```
     [6]🔄
      |
[31]  [32]  [33]  [34]✨ [35]
 H₁   H₂   H₃   NEW   ○

NODES[6] = Hash5([H₁, H₂, H₃, H₄, Z₀])

检查: 34 % 5 = 4 ≠ 0  ❌ 停止
更新: 仅 [34] 和 [6]
```

### 用户5 (leaf_idx=35, 35%5=0) ⭐ 特殊！

```
Step 1: 更新父节点
━━━━━━━━━━━━━━━━━━━━━━━━━━
     [6]🔄
      |
[31]  [32]  [33]  [34]  [35]✨
 H₁   H₂   H₃   H₄   NEW

NODES[6] = Hash5([H₁, H₂, H₃, H₄, H₅])

检查: 35 % 5 = 0 ✅ 继续向上！


Step 2: 继续更新第二层
━━━━━━━━━━━━━━━━━━━━━━━━━━
                    [1]🔄
                     |
      ┌─────┬────┬────┬────┐
    [6]✓  [7]  [8]  [9] [10]
     H₆   Z₁   Z₁   Z₁   Z₁

NODES[1] = Hash5([H₆, Z₁, Z₁, Z₁, Z₁])

检查: 6 % 5 = 1 ≠ 0  ❌ 停止


Step 3: 结果
━━━━━━━━━━━━━━━━━━━━━━━━━━
                  ROOT [0] ⏸️ 仍未更新
                       |
                    [1]✓ 已更新
                     |
                   [6]✓
                     |
                  [35]✓

更新: [35], [6], [1] 共3个节点
根节点: ❌ 未达到（需要 Start Process）
```

---

## 案例 C: 用户注册模式对比

### 25个用户的更新深度统计

```
用户编号 | 叶子索引 | AMACI更新深度 | MACI更新深度 | MACI是否到根
--------|---------|--------------|-------------|-------------
   1    |   31    |      4       |      2      |     ❌
   2    |   32    |      4       |      2      |     ❌
   3    |   33    |      4       |      2      |     ❌
   4    |   34    |      4       |      2      |     ❌
   5    |   35    |      4       |      3      |     ❌
   6    |   36    |      4       |      2      |     ❌
   7    |   37    |      4       |      2      |     ❌
   8    |   38    |      4       |      2      |     ❌
   9    |   39    |      4       |      2      |     ❌
  10    |   40    |      4       |      3      |     ❌
  11    |   41    |      4       |      2      |     ❌
  ...   |   ...   |      4       |     2-3     |     ❌
  25    |   55    |      4       |      4      |     ✅

平均深度:          4             2.2
```

### 可视化热力图

```
AMACI 更新热力图 (所有用户相同):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
层级 0 (根):   [0]🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥 (每次都更新)
层级 1:        [1]🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
层级 2:        [6-10]🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥
层级 3:        [31-55]🔥🔥🔥🔥🔥🔥🔥🔥🔥


MACI 增量更新热力图:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
层级 0 (根):   [0]○○○○○○○○○○○○○○○○○○ (未更新!)
层级 1:        [1]○○○○🔥○○○○🔥○○○○🔥 (5的倍数时)
层级 2:        [6-10]🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥 (每次都更新父节点)
层级 3:        [31-55]🔥🔥🔥🔥🔥🔥🔥🔥🔥 (叶子)

图例: 🔥 更新  ○ 未更新
```

---

## 案例 D: MACI Start Process 完整更新

### 场景: 5个用户注册完成，启动处理

```
Before Start Process:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                  ROOT [0]❓ (状态未知/过时)
                       |
                    [1]✓ (用户5更新过)
                     |
                   [6]✓ (所有用户都更新过)
                     |
          ┌─────┬────┬────┬────┐
        [31] [32][33][34][35]
         ✓   ✓   ✓   ✓   ✓

问题: 根节点不反映最新状态！


Execute: state_update_at(deps, 35, true)  ← full=true
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Step 1: idx=35, full=true
         条件: idx > 0 && (true || ...) ✓
         更新 [6] (已存在，重新计算确认)

Step 2: idx=6, full=true
         条件: idx > 0 && true ✓
         更新 [1] (已存在，重新计算确认)

Step 3: idx=1, full=true ⭐ 关键！
         条件: idx > 0 && true ✓
         
         正常增量模式会在这停止 (1%5≠0)
         但 full=true 强制继续！
         
         更新 [0] ✅

Step 4: idx=0
         停止


After Start Process:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                  ROOT [0]✅ (最新状态!)
                       |
                    [1]✓
                     |
                   [6]✓
                     |
          ┌─────┬────┬────┬────┐
        [31] [32][33][34][35]
         ✓   ✓   ✓   ✓   ✓

现在可以安全计算:
state_root = NODES[0]
CURRENT_STATE_COMMITMENT = Hash2([state_root, 0])
```

---

## 案例 E: 极端案例 - 第25个用户

### 用户25 (leaf_idx=55) 的完整路径

```
叶子索引: 55
层次结构:
  55 → 10 → 1 → 0

检查每一步:

Step 1: idx=55
━━━━━━━━━━━━━━━━━━━━━━━━━
                     [10]
                       |
          ┌─────┬────┬────┬────┐
        [51] [52][53][54][55]✨
         H₅₁ H₅₂ H₅₃ H₅₄ NEW

NODES[10] = Hash5([H₅₁, H₅₂, H₅₃, H₅₄, H₅₅])

检查: 55 % 5 = 0 ✅ 继续!


Step 2: idx=10 ⭐
━━━━━━━━━━━━━━━━━━━━━━━━━
                    [1]
                     |
      ┌─────┬────┬────┬────┐
    [6]  [7]  [8]  [9] [10]✓
     H₆   H₇   H₈   H₉  H₁₀

NODES[1] = Hash5([H₆, H₇, H₈, H₉, H₁₀])

检查: 10 % 5 = 0 ✅ 还能继续! (罕见!)


Step 3: idx=1
━━━━━━━━━━━━━━━━━━━━━━━━━
                  ROOT [0]
                       |
      ┌─────┬────┬────┬────┐
    [1]✓ [2]  [3]  [4]  [5]
     H₁   Z₂   Z₂   Z₂   Z₂

NODES[0] = Hash5([H₁, Z₂, Z₂, Z₂, Z₂])

检查: 1 % 5 = 1 ≠ 0 ❌ 停止

结果: 🎉 用户25在增量模式下也更新到了根! 
      (因为 55 = 5×11 且 10 = 5×2)
```

### 特殊位置分析

```
在5叉树中，某些"魔法数字"会自动传播到根:

深度3树中的魔法叶子索引 (LEAF_IDX_0=31):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

索引 55: 55%5=0, (55-1)/5=10, 10%5=0, (10-1)/5=1 ✅ 到根
索引 80: 80%5=0, (80-1)/5=15, 15%5=0, (15-1)/5=2 ⚠️  到层1

数学规律:
如果 (leaf_idx - LEAF_IDX_0) 是 5^k 的倍数，
则至少更新 k+1 层

例子:
- +0:  31 → 不是特殊位置
- +4:  35 → 5¹ 的倍数 → 更新3层
- +24: 55 → 5¹ 且路径中有 5² → 更新4层(到根)
- +124: 155 → 5² 的倍数 → 更新至少4层
```

---

## 完整对比: 同一场景下的行为差异

### 场景: 3个用户连续注册

```
═══════════════════════════════════════════════════════════════
                     AMACI (完整更新)
═══════════════════════════════════════════════════════════════

用户1注册:                        用户2注册:                        用户3注册:
    [0]🔥                             [0]🔥                             [0]🔥
     ↑                                 ↑                                 ↑
    [1]🔥                             [1]🔥                             [1]🔥
     ↑                                 ↑                                 ↑
    [6]🔥                             [6]🔥                             [6]🔥
     ↑                                 ↑                                 ↑
   [31]🔥                            [32]🔥                            [33]🔥

每次都: 叶子→父→祖父→根              每次都: 叶子→父→祖父→根              每次都: 叶子→父→祖父→根
更新4个节点                        更新4个节点                        更新4个节点

═══════════════════════════════════════════════════════════════
                     MACI (增量更新)
═══════════════════════════════════════════════════════════════

用户1注册:                        用户2注册:                        用户3注册:
    [0]⏸️                             [0]⏸️                             [0]⏸️
     
    [1]⏸️                             [1]⏸️                             [1]⏸️
     
    [6]🔥                             [6]🔥                             [6]🔥
     ↑                                 ↑                                 ↑
   [31]🔥                            [32]🔥                            [33]🔥

停在父节点 (31%5≠0)               停在父节点 (32%5≠0)               停在父节点 (33%5≠0)
更新2个节点                        更新2个节点                        更新2个节点

─────────────────────────────────────────────────────────────────
                Start Process (full=true)
─────────────────────────────────────────────────────────────────

    [0]🔥 ← 强制更新到根
     ↑
    [1]🔥
     ↑
    [6]✓ (已有)
     ↑
   [33]✓ (已有)

完整更新: 确保根节点最新
```

---

## Gas 消耗对比图表

### 25个用户注册的累计成本

```
Gas 消耗 (相对单位)
↑
│                                              ╱ AMACI (线性增长)
│                                          ╱   总成本: 100 单位
│                                      ╱       
│                                  ╱           
100─                            ╱               
│                           ╱                   
│                       ╱                       
│                   ╱                           
│               ╱               ╱─── MACI (增量)
50─         ╱               ╱       总成本: 55 单位
│       ╱               ╱           节省: 45%
│   ╱               ╱               
│╱─────────────╱───────────────────────────────→ 用户数
0  1   5   10   15   20   25

MACI 增量更新在第5、10、15、20、25个用户
处有小幅上升（索引5的倍数）
```

### 单次注册成本分布

```
AMACI - 每个用户成本恒定:
用户: 1  2  3  4  5  6  7  8  9  10 ...
成本: █  █  █  █  █  █  █  █  █  █  ... (每个4单位)


MACI - 成本随索引位置波动:
用户: 1  2  3  4  5  6  7  8  9  10 ...
成本: ▄  ▄  ▄  ▄  ▆  ▄  ▄  ▄  ▄  ▆  ...
      ↑              ↑              ↑
      2单位          3单位          3单位
                   (5的倍数)
```

---

## 总结: 设计哲学的可视化

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                      AMACI 设计                        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│  [注册] ──→ [完整更新] ──→ [根节点✅]                   │
│    ↑          ↓                                        │
│    └──────────┘ (每次重复)                             │
│                                                        │
│  优点: 简单、实时、一致                                 │
│  代价: Gas 高                                          │
└────────────────────────────────────────────────────────┘

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                      MACI 设计                         ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│  [注册阶段]                    [处理阶段]               │
│      ↓                              ↓                  │
│  [增量更新]                  [Start Process]           │
│  (局部更新)                   (完整更新)               │
│      ↓                              ↓                  │
│  [根节点❌]  ──────────→      [根节点✅]               │
│   (延迟)        批处理           (最新)                │
│                                                        │
│  优点: Gas 高效、可扩展                                 │
│  代价: 需要两阶段处理                                  │
└────────────────────────────────────────────────────────┘
```

## 关键要点

1. **AMACI**: "每次都做对" - 实时一致性优先
2. **MACI**: "批量处理" - 效率优先，延迟一致性
3. **5的倍数是关键**: 决定了 MACI 的更新深度
4. **成本不是递增的**: 取决于索引的数学特性，不是用户总数
5. **Start Process 是必须的**: MACI 用这一步来"结算"状态树

