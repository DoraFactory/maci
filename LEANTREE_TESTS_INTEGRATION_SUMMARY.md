# LeanTree æµ‹è¯•æ•´åˆå®Œæˆæ€»ç»“

## å®Œæˆå†…å®¹

å·²å°†ç”µè·¯ä¸€è‡´æ€§æµ‹è¯•æ•´åˆåˆ°ç°æœ‰çš„ `LeanTree.integration.test.ts` æ–‡ä»¶ä¸­ï¼Œé¿å…åˆ›å»ºé¢å¤–çš„æµ‹è¯•æ–‡ä»¶ã€‚

## æµ‹è¯•æ–‡ä»¶ç»“æ„

### âœ… LeanTree.test.ts (321 è¡Œ)
- **ç±»å‹**: å•å…ƒæµ‹è¯•
- **ç›®çš„**: éªŒè¯ SDK åŸºç¡€åŠŸèƒ½
- **ç‹¬ç«‹è¿è¡Œ**: æ˜¯ï¼ˆä¸éœ€è¦ç”µè·¯ï¼‰

### âœ… LeanTree.integration.test.ts (700+ è¡Œ)
**ç±»å‹**: é›†æˆæµ‹è¯• + ç”µè·¯ä¸€è‡´æ€§æµ‹è¯•
**åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†**:

#### Part 1: ç³»ç»Ÿé›†æˆæµ‹è¯• (400+ è¡Œ)
- ä¸äº”å‰æ ‘å¯¹æ¯”
- Active State Tree åœºæ™¯
- å“ˆå¸Œå‡½æ•°éªŒè¯
- äºŒå‰æ ‘å±æ€§
- ç”µè·¯è¾“å…¥æ ¼å¼å‡†å¤‡
- **ç‹¬ç«‹è¿è¡Œ**: æ˜¯ï¼ˆä¸éœ€è¦ç”µè·¯ï¼‰

#### Part 2: ç”µè·¯ä¸€è‡´æ€§æµ‹è¯• (300+ è¡Œ) â­
**æ‚¨çš„æ ¸å¿ƒéœ€æ±‚ï¼šéªŒè¯ SDK â†” ç”µè·¯è®¡ç®—ä¸€è‡´æ€§**

åŒ…å« 5 ä¸ªæµ‹è¯•å¥—ä»¶ï¼š
1. **Root Consistency** - ç›¸åŒæ•°æ®æ ¹ä¸€è‡´æ€§
2. **Merkle Proof Verification** - è¯æ˜éªŒè¯
3. **Dynamic Growth Consistency** - åŠ¨æ€å¢é•¿ä¸€è‡´æ€§
4. **Multiple Updates Consistency** - å¤šæ¬¡æ›´æ–°ä¸€è‡´æ€§
5. **Circuit Components** - ç”µè·¯ç»„ä»¶æµ‹è¯•

- **æ™ºèƒ½è·³è¿‡**: å¦‚æœç”µè·¯æœªç¼–è¯‘ï¼Œè‡ªåŠ¨è·³è¿‡ï¼Œä¸å½±å“ Part 1

## å…³é”®æµ‹è¯•åœºæ™¯

### âœ… åœºæ™¯ 1: ç›¸åŒæ•°æ®ï¼Œæ ¹æ˜¯å¦ä¸€è‡´
```typescript
SDK Tree â†’ insertMany([1,2,3,4]) â†’ SDK Root
Circuit  â†’ verify proof          â†’ Circuit Root
éªŒè¯: SDK Root === Circuit Root âœ“
```

### âœ… åœºæ™¯ 2: æ·»åŠ æ•°æ®åï¼Œæ ¹æ˜¯å¦ä¸€è‡´
```typescript
åˆå§‹: [1,2,3,4] â†’ Root1
æ·»åŠ : insert(5n) â†’ Root2
éªŒè¯: Root1 â‰  Root2, Circuit èƒ½éªŒè¯ Root2 âœ“
```

### âœ… åœºæ™¯ 3: ä¿®æ”¹æ•°æ®åï¼Œæ ¹æ˜¯å¦ä¸€è‡´
```typescript
åˆå§‹: [1,2,3,4] â†’ Root Before
æ›´æ–°: update(1, 20n) â†’ Root After
éªŒè¯: Root Before â‰  Root After, æ‰€æœ‰è¯æ˜å¯éªŒè¯ âœ“
```

## è¿è¡Œæ–¹å¼

### å¿«é€Ÿæµ‹è¯•ï¼ˆä¸éœ€è¦ç”µè·¯ï¼‰
```bash
cd packages/circuits

# è¿è¡Œå•å…ƒæµ‹è¯•
npm test -- LeanTree.test.ts

# è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆPart 1 è‡ªåŠ¨è¿è¡Œï¼ŒPart 2 è‡ªåŠ¨è·³è¿‡ï¼‰
npm test -- LeanTree.integration.test.ts
```

### å®Œæ•´æµ‹è¯•ï¼ˆåŒ…æ‹¬ç”µè·¯éªŒè¯ï¼‰
```bash
cd packages/circuits

# 1. ç¼–è¯‘ç”µè·¯
npm run compile:circuits

# 2. è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test -- LeanTree
```

## ä¼˜åŠ¿

### âœ… æ•´åˆä¼˜åŠ¿
- é¿å…é‡å¤ä»£ç å’Œæµ‹è¯•è®¾ç½®
- ç»Ÿä¸€çš„æµ‹è¯•ç¯å¢ƒå’Œé…ç½®
- æ›´å®¹æ˜“ç»´æŠ¤å’Œæ›´æ–°
- æµ‹è¯•ç”¨ä¾‹ä¹‹é—´å¯ä»¥å…±äº«è¾…åŠ©å‡½æ•°

### âœ… æ™ºèƒ½è·³è¿‡
```typescript
before(async function() {
  try {
    // å°è¯•åŠ è½½ç”µè·¯
    circuit = await circomkitInstance.WitnessTester(...);
  } catch (error) {
    console.warn('âš ï¸  ç”µè·¯æœªç¼–è¯‘ï¼Œè·³è¿‡ç”µè·¯æµ‹è¯•');
    this.skip(); // è‡ªåŠ¨è·³è¿‡
  }
});
```

### âœ… çµæ´»è¿è¡Œ
| åœºæ™¯ | Part 1 é›†æˆæµ‹è¯• | Part 2 ç”µè·¯æµ‹è¯• |
|------|---------------|----------------|
| ç”µè·¯æœªç¼–è¯‘ | âœ… è¿è¡Œ | â­ï¸ è·³è¿‡ |
| ç”µè·¯å·²ç¼–è¯‘ | âœ… è¿è¡Œ | âœ… è¿è¡Œ |

## æµ‹è¯•è¦†ç›–

| æµ‹è¯•ç±»å‹ | ç”¨ä¾‹æ•° | éœ€è¦ç”µè·¯ |
|---------|--------|---------|
| å•å…ƒæµ‹è¯• | 320+ | âŒ |
| é›†æˆæµ‹è¯• (Part 1) | 40+ | âŒ |
| ç”µè·¯ä¸€è‡´æ€§ (Part 2) | 40+ | âœ… |
| **æ€»è®¡** | **400+** | - |

## å…³é”®éªŒè¯ç‚¹

### âœ… æ ¹ä¸€è‡´æ€§
- 4 å¶å­åœºæ™¯
- 8 å¶å­åœºæ™¯
- æ›´æ–°åçš„æ ¹

### âœ… è¯æ˜éªŒè¯
- SDK ç”Ÿæˆ â†’ ç”µè·¯éªŒè¯
- æ‰€æœ‰å¶å­çš„è¯æ˜
- æ— æ•ˆè¯æ˜æ‹’ç»
- BinaryLeafExists ç»„ä»¶

### âœ… åŠ¨æ€æ“ä½œ
- å¢é‡æ’å…¥
- 16 å¶å­ï¼ˆæµ‹è¯•ç”µè·¯æœ€å¤§æ·±åº¦ï¼‰
- å¤šæ¬¡æ›´æ–°

### âœ… å“ˆå¸Œå‡½æ•°
- Poseidon hash2 (PoseidonT3)
- æ‰‹åŠ¨é‡å»ºéªŒè¯
- è¯æ˜é‡æ„éªŒè¯

## æ–‡ä»¶ä½ç½®

- ğŸ“„ `packages/circuits/ts/__tests__/LeanTree.test.ts` - å•å…ƒæµ‹è¯•
- ğŸ“„ `packages/circuits/ts/__tests__/LeanTree.integration.test.ts` - é›†æˆ + ç”µè·¯æµ‹è¯• â­
- ğŸ“„ `packages/circuits/docs/LEANTREE_TESTS_GUIDE.md` - æµ‹è¯•æŒ‡å—

## ä¸‹ä¸€æ­¥

### ç«‹å³å¯åšï¼ˆä¸éœ€è¦ç”µè·¯ï¼‰
```bash
npm test -- LeanTree.test.ts
npm test -- LeanTree.integration.test.ts
```

### å®Œæ•´éªŒè¯ï¼ˆéœ€è¦ç¼–è¯‘ï¼‰
```bash
npm run compile:circuits
npm test -- LeanTree
```

### ç»§ç»­å¼€å‘
- å®Œæˆå‰©ä½™ç”µè·¯æ”¹é€ ï¼ˆProcessDeactivate, AddNewKey, TallyVotesï¼‰
- è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶éªŒè¯è¿ç§»

## æ€»ç»“

âœ… **æµ‹è¯•æ•´åˆå®Œæˆ**
- å°†ç”µè·¯ä¸€è‡´æ€§æµ‹è¯•æ•´åˆåˆ° integration æ–‡ä»¶
- é¿å…äº†å•ç‹¬çš„æµ‹è¯•æ–‡ä»¶
- ä¿æŒäº†æµ‹è¯•çš„çµæ´»æ€§å’Œç‹¬ç«‹æ€§

âœ… **æ ¸å¿ƒåŠŸèƒ½å®ç°**
- éªŒè¯ SDK å’Œç”µè·¯è®¡ç®—ç»“æœä¸€è‡´
- è¦†ç›–æ‰€æœ‰å…³é”®åœºæ™¯ï¼ˆæ·»åŠ ã€ä¿®æ”¹ã€éªŒè¯ï¼‰
- æä¾›æ¸…æ™°çš„æµ‹è¯•æŠ¥å‘Š

âœ… **ç”¨æˆ·å‹å¥½**
- æ™ºèƒ½è·³è¿‡æœªç¼–è¯‘çš„ç”µè·¯æµ‹è¯•
- æ¸…æ™°çš„æ§åˆ¶å°è¾“å‡º
- è¯¦ç»†çš„æµ‹è¯•æ–‡æ¡£

ç°åœ¨æ‚¨æœ‰äº†ä¸€ä¸ªå®Œæ•´ã€æ•´åˆã€æ™ºèƒ½çš„æµ‹è¯•å¥—ä»¶ï¼Œå¯ä»¥ç¡®ä¿ LeanTree çš„ SDK å’Œç”µè·¯å®ç°å®Œå…¨ä¸€è‡´ï¼ğŸ‰
