# MACI 测试性能提升总结报告

**对比时间范围**: 2025-12-11 (旧版本) → 2025-12-14 (新版本)  
**报告生成时间**: 2025-12-14

---

## 📊 测试概览对比

| 指标 | 旧版本 (2025-12-11) | 新版本 (2025-12-14) | 变化 |
|------|---------------------|---------------------|------|
| 测试总数 | 32 | 38 | +6 (+18.8%) |
| 通过测试 | 31 | 38 | +7 |
| 失败测试 | 1 | 0 | -1 |
| 成功率 | 96.9% | 100% | +3.1% |
| 测试耗时 | 415s | 311s | -104s (-25.1%) |

---

## 🚀 核心功能性能提升

### SignUp 操作性能

| 操作 | 旧版本 Gas | 新版本 Gas | 性能提升 | 提升百分比 |
|------|-----------|-----------|----------|-----------|
| SignUp User 1 | 6,056,846 | 195,086 | **-5,861,760** | **-96.8%** |
| SignUp User 2 | 6,058,882 | 197,083 | **-5,861,799** | **-96.7%** |

**关键发现**: SignUp 操作的 gas 消耗降低了 **96.8%**，从约 600 万 gas 降至约 19 万 gas。

### Publish Message 操作性能

| 操作 | 旧版本 Gas | 新版本 Gas | 性能提升 | 提升百分比 |
|------|-----------|-----------|----------|-----------|
| Publish Message | 6,011,769 | 144,728 | **-5,867,041** | **-97.6%** |

**关键发现**: 消息发布操作的 gas 消耗降低了 **97.6%**，从约 600 万 gas 降至约 14 万 gas。

---

## ⚡ Hash 操作性能提升

### Signup Hash 开销对比

| 指标 | 旧版本 | 新版本 | 改进 |
|------|--------|--------|------|
| Baseline (NoHash) | 156,946 gas | 156,946 gas | 无变化 |
| Full Hash | 6,057,528 gas | 195,790 gas | **-5,861,738 gas** |
| Hash Overhead | 5,900,582 gas | 38,844 gas | **-5,861,738 gas** |
| Overhead 百分比 | 97.4% | 19.8% | **-77.6 个百分点** |

**关键发现**: Hash 开销从 590 万 gas 降至 3.8 万 gas，降低了 **99.3%**。

### 单次 Hash 操作性能

| 操作 | 旧版本 Gas | 新版本 Gas | 性能提升 | 提升百分比 |
|------|-----------|-----------|----------|-----------|
| PoseidonHashOnce | 5,981,607 | 120,019 | **-5,861,588** | **-98.0%** |
| Hash2 | 5,976,396 | 114,458 | **-5,861,938** | **-98.1%** |
| Hash5 | 5,982,482 | 119,973 | **-5,862,509** | **-98.0%** |
| HashUint256 | N/A | 113,422 | - | - |
| HashComposed | N/A | 142,562 | - | - |

**关键发现**: 所有单次 Hash 操作的 gas 消耗都降低了约 **98%**。

---

## 📈 HashMultiple 批量操作性能提升

### HashMultiple 性能对比

| 实例数量 | 旧版本 Gas | 新版本 Gas | 性能提升 | 提升百分比 | 平均 Gas/实例 (新) |
|---------|-----------|-----------|----------|-----------|-------------------|
| 1x | 5,981,940 | 120,244 | **-5,861,696** | **-98.0%** | 120,244 |
| 5x | 29,455,822 | 153,183 | **-29,302,639** | **-99.5%** | 30,636 |
| 10x | 58,798,136 | 194,369 | **-58,603,767** | **-99.7%** | 19,436 |
| 20x | **FAILED** | 276,716 | **成功执行** | - | 13,835 |

**关键发现**:
1. 所有批量操作的 gas 消耗降低了 **98-99.7%**
2. **20x 批量操作从失败变为成功执行**，这是一个重要的稳定性改进
3. 批量操作的效率随批量大小增加而提升（平均 gas/实例递减）

### HashMultiple 效率分析

| 实例数量 | 平均 Gas/实例 | 效率提升 (相比 1x) |
|---------|--------------|-------------------|
| 1x | 120,244 | 基准 (100%) |
| 5x | 30,636 | **75% 降低** |
| 10x | 19,436 | **84% 降低** |
| 20x | 13,835 | **88% 降低** |

**关键发现**: 批量操作显著提高了效率，20x 批量时每个实例的 gas 消耗仅为单次操作的 **11.5%**。

---

## 🔧 BatchHash 批量操作性能

### BatchHash 性能分析（新版本新增功能）

| 批量大小 | 操作数 | Gas 消耗 | 平均 Gas/操作 | 效率 |
|---------|--------|----------|--------------|------|
| 1 op | 1 | 207,201 | 207,201 | 基准 |
| 5 ops | 5 | 586,357 | 117,271 | **43% 降低** |
| 10 ops | 10 | 1,137,346 | 113,734 | **45% 降低** |
| 20 ops | 20 | 2,449,252 | 122,462 | **41% 降低** |
| 50 ops | 50 | 7,630,552 | 152,611 | **26% 降低** |
| 100 ops | 100 | 20,653,871 | 206,538 | **0.3% 降低** |

**关键发现**: BatchHash 在中小批量（5-20 ops）时效率最高，相比单次操作可节省 **40-45%** 的 gas。

### BatchHash vs 单次操作对比

| 操作类型 | 单次 Gas | BatchHash (10 ops, 平均) | 节省 |
|---------|---------|-------------------------|------|
| Hash2 | 114,458 | 113,734 | -724 gas |
| Hash5 | 119,973 | 113,734 | -6,239 gas |
| HashUint256 | 113,422 | 113,734 | +312 gas |
| HashComposed | 142,562 | 113,734 | **-28,827 gas** |

**关键发现**: 对于复杂操作（如 HashComposed），BatchHash 可以节省约 **20%** 的 gas。

---

## 💰 成本节省分析

### 单次操作成本对比（基于 gas 价格: 100000000000 peaka）

| 操作 | 旧版本费用 (DORA) | 新版本费用 (DORA) | 节省 |
|------|------------------|------------------|------|
| SignUp | ~0.906 | ~0.026 | **-0.88 DORA** |
| Publish Message | ~0.898 | ~0.019 | **-0.88 DORA** |
| HashOnce | ~0.894 | ~0.015 | **-0.88 DORA** |

### 批量操作成本对比

| 操作 | 批量大小 | 旧版本费用 (DORA) | 新版本费用 (DORA) | 节省 |
|------|---------|------------------|------------------|------|
| HashMultiple | 5x | ~4.415 | ~0.020 | **-4.395 DORA** |
| HashMultiple | 10x | ~8.817 | ~0.026 | **-8.791 DORA** |
| HashMultiple | 20x | **失败** | ~0.039 | **成功执行** |

**关键发现**: 
- 单次操作节省约 **0.88 DORA**（约 97% 成本降低）
- 10x 批量操作节省约 **8.79 DORA**（约 99.7% 成本降低）

---

## 🎯 关键性能指标总结

### 整体性能提升

1. **Gas 消耗降低**: 核心操作 gas 消耗降低 **96-99.7%**
2. **成功率提升**: 从 96.9% 提升至 **100%**
3. **测试速度提升**: 测试耗时减少 **25.1%**
4. **功能完善**: 新增 6 个测试用例，包括 BatchHash 批量操作测试
5. **稳定性提升**: 20x HashMultiple 操作从失败变为成功

### 技术改进亮点

1. **Hash 算法优化**: Hash 开销从 97.4% 降低至 19.8%
2. **批量处理优化**: 批量操作效率显著提升，20x 批量时效率提升 88%
3. **新功能引入**: BatchHash 批量操作功能，在中小批量时效率提升 40-45%
4. **成本优化**: 单次操作成本降低约 97%，批量操作成本降低约 99.7%

---

## 📋 测试覆盖范围对比

### 新增测试用例

新版本新增了以下测试用例：
- Hash2、Hash5、HashUint256（单次 Hash 操作）
- HashOnce（单次 Hash）
- HashMultiple (20x)（之前失败，现在成功）
- BatchHash (1, 5, 10, 20, 50, 100 ops)（全新功能）

### 测试稳定性改进

- **旧版本**: HashMultiple (20x) 测试失败
- **新版本**: HashMultiple (20x) 测试成功，且性能优异

---

## 🔍 部署信息对比

| 项目 | 旧版本 | 新版本 | 变化 |
|------|--------|--------|------|
| Code ID | 197 | 201 | +4 |
| Store Code Gas | 11,612,453 | 12,938,786 | +1,326,333 |
| Store Code Fee (DORA) | 1.739 | 1.938 | +0.199 |
| Instantiate Gas | 264,848 | 264,847 | -1 |

**说明**: 虽然部署时的 gas 略有增加，但运行时性能的大幅提升完全抵消了这一点，整体成本显著降低。

---

## 📝 结论

本次优化实现了**全面的性能提升**：

1. **核心操作性能提升 96-99.7%**: SignUp、Publish Message、Hash 操作等核心功能的 gas 消耗大幅降低
2. **批量处理能力增强**: 批量操作效率显著提升，20x 批量操作从失败变为成功
3. **成本大幅降低**: 单次操作成本降低约 97%，批量操作成本降低约 99.7%
4. **测试覆盖更全面**: 新增 6 个测试用例，测试成功率从 96.9% 提升至 100%
5. **系统稳定性提升**: 所有测试用例均通过，无失败案例

这些改进使得 MACI 合约在实际应用中的**可扩展性和经济性**得到了显著提升，特别是在需要处理大量用户和消息的场景下。

---

**报告生成时间**: 2025年12月14日  
**数据来源**: 
- 旧版本: `old-test-report.md` (2025-12-11)
- 新版本: `test-report-20251214-080323.md` (2025-12-14)
